env CDN_BASE_URL;

http {
    gzip on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_vary on;
    gzip_proxied any;
    gzip_types text/plain text/css application/javascript application/json application/manifest+json image/svg+xml application/xml text/xml text/javascript;

    brotli on;
    brotli_comp_level 5;
    brotli_static on;
    brotli_types text/plain text/css application/javascript application/json application/manifest+json image/svg+xml application/xml text/xml text/javascript;

    types {
        include mime.types;
        application/javascript js mjs;
    }

    log_format csp_report '$time_iso8601 $remote_addr "$http_user_agent" $request_body';

    server {
        listen 80;
        server_name example.com;
        root /var/www/gw2/current;

        set $cdn_base $env_CDN_BASE_URL;
        set $cdn_script_src '';
        set $cdn_style_src '';
        set $cdn_font_src '';
        set $cdn_img_src '';
        set $cdn_connect_src '';
        if ($cdn_base != '') {
            set $cdn_script_src " $cdn_base";
            set $cdn_style_src " $cdn_base";
            set $cdn_font_src " $cdn_base";
            set $cdn_img_src " $cdn_base";
            set $cdn_connect_src " $cdn_base";
        }

        set $csp "default-src 'self'; "
                 "script-src 'self'$cdn_script_src 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://cdn.jsdelivr.net https://www.gstatic.com; "
                 "style-src 'self'$cdn_style_src 'unsafe-inline' https://fonts.googleapis.com; "
                 "font-src 'self'$cdn_font_src https://fonts.gstatic.com; "
                 "img-src 'self'$cdn_img_src data: https://www.google-analytics.com https://www.googletagmanager.com https://stats.g.doubleclick.net https://www.gstatic.com; "
                 "connect-src 'self'$cdn_connect_src https://www.google-analytics.com https://region1.google-analytics.com https://www.googletagmanager.com; "
                 "media-src 'self' data:; "
                 "frame-src 'self' https://www.youtube.com https://youtube.com https://www.youtube-nocookie.com; "
                 "object-src 'none'; "
                 "worker-src 'self'; "
                 "frame-ancestors 'self'; "
                 "form-action 'self'; "
                 "base-uri 'self'; "
                 "report-to default; "
                 "report-uri /csp-report;";

        add_header Report-To '{"group":"default","max_age":10886400,"endpoints":[{"url":"$scheme://$host/csp-report"}]}' always;
        add_header Reporting-Endpoints 'default="$scheme://$host/csp-report"' always;
        # Política aplicada en modo "enforce". Durante despliegues iniciales con
        # periodo de observación, cambia temporalmente esta directiva por la
        # versión `Content-Security-Policy-Report-Only` y purga las cachés
        # externas tras actualizarla.
        add_header Content-Security-Policy $csp always;
        # add_header Content-Security-Policy-Report-Only $csp always;

        # Política de íconos: los íconos se descargan desde la CDN de ArenaNet
        # o pueden servirse desde este servidor ajustando las URLs.

        # Serve web workers without SPA fallback
        location ~ ^/dist/\d+\.\d+\.\d+/js/workers/ {
            try_files $uri =404;
            default_type application/javascript;
            add_header Cache-Control "public, max-age=600, must-revalidate";
        }

        # Serve service worker directly without SPA fallback
        location = /service-worker.min.js {
            try_files $uri =404;
            default_type application/javascript;
        }

        # Serve runtime environment bootstrap without cache to allow env overrides
        location = /runtime-env.js {
            try_files $uri =404;
            default_type application/javascript;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }

        # Cache versioned static assets with strong caching headers
        location ~ ^/dist/\d+\.\d+\.\d+/js/ {
            if ($cdn_base != '') {
                return 302 $cdn_base$uri$is_args$args;
            }
            try_files $uri =404;
            default_type application/javascript;
            add_header Cache-Control "public, s-maxage=3600, stale-while-revalidate=60";
            error_page 404 = @js404;
        }

        location @js404 {
            add_header Content-Type application/javascript;
            return 404 "";
        }

        # Route REST APIs through Node services
        location /recipe-tree/ {
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location ~ ^/backend/api/(itemDetails|dataBundle)\.php$ {
            return 308 /api/legacy/$1.php$is_args$args;
        }

        location /backend/api/ {
            proxy_pass http://127.0.0.1:3300/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/ {
            proxy_pass http://127.0.0.1:3300;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # SPA fallback for other routes
        location / {
            add_header Cache-Control "no-cache";
            try_files $uri $uri/ /index.html;
        }

        location = /csp-report {
            access_log /var/log/nginx/csp-report.log csp_report;
            add_header Content-Type application/json;
            add_header Content-Length 0;
            return 204;
        }
    }
}
