const APP_VERSION="vc6bbed1";const CACHE_VERSION=3;const STATIC_CACHE=`static-${APP_VERSION}-v${CACHE_VERSION}`;const API_CACHE=`api-${APP_VERSION}-v${CACHE_VERSION}`;const DEFAULT_TTL=5*60*1e3;const VIDEO_ASSETS=["img/Secuencia01.mp4","img/Secuencia02.mp4","img/Secuencia03.mp4"];const VERSIONED_DIST_REGEX=/^\d+\.\d+\.\d+$/;const WORKER_PATH_REGEX=/^\/dist\/\d+\.\d+\.\d+\/js\/workers\//;const cacheMetrics={hit:0,miss:0,stale:0,lastUpdated:0};let activeClientLang=null;async function broadcastCacheMetrics(){try{const clients=await self.clients.matchAll({type:"window"});const payload={type:"cache-metrics",metrics:{...cacheMetrics}};clients.forEach(client=>{try{client.postMessage(payload)}catch(err){}})}catch(err){}}function incrementCacheMetric(metric){if(typeof cacheMetrics[metric]!=="number"){cacheMetrics[metric]=0}cacheMetrics[metric]+=1;cacheMetrics.lastUpdated=Date.now();broadcastCacheMetrics()}self.addEventListener("install",event=>{self.skipWaiting();event.waitUntil(caches.open(STATIC_CACHE).then(cache=>cache.addAll(VIDEO_ASSETS)))});self.addEventListener("activate",event=>{event.waitUntil((async()=>{const expectedCaches=[STATIC_CACHE,API_CACHE];let hadOldCaches=false;await Promise.all([caches.keys().then(keys=>Promise.all(keys.filter(k=>/^(static|api)-/.test(k)&&!expectedCaches.includes(k)).map(k=>{hadOldCaches=true;return caches.delete(k)}))),cleanExpired(),purgeWorkerEntries(STATIC_CACHE)]);await self.clients.claim();if(hadOldCaches){const clientList=await self.clients.matchAll({type:"window"});clientList.forEach(c=>c.postMessage({type:"reload"}))}})())});self.addEventListener("fetch",event=>{const{request:request}=event;if(request.method!=="GET")return;const url=new URL(request.url);if(VIDEO_ASSETS.some(asset=>url.pathname==="/"+asset)){event.respondWith(cacheFirst(request,STATIC_CACHE));return}if(WORKER_PATH_REGEX.test(url.pathname)){event.respondWith(fetch(request,{cache:"no-store"}));return}if(isVersionedDistAsset(url.pathname,"js")||url.pathname.startsWith("/css/")){event.respondWith(cacheFirst(request,STATIC_CACHE));return}if(["/backend/api/user.php","/backend/api/favorites.php","/backend/api/comparisons.php"].includes(url.pathname)){event.respondWith(fetch(request,{cache:"no-store"}));return}if(url.pathname.startsWith("/backend/api/")&&!["/backend/api/user.php","/backend/api/favorites.php","/backend/api/comparisons.php"].includes(url.pathname)){event.respondWith((async()=>{const{response:response,fetchPromise:fetchPromise}=await staleWhileRevalidate(request,API_CACHE);event.waitUntil((async()=>{if(fetchPromise)await fetchPromise;await cleanExpired()})());return response})())}});self.addEventListener("message",event=>{const{data:data}=event;if(!data)return;if(data.type==="clean"){event.waitUntil(cleanExpired())}else if(data.type==="invalidate"&&data.url){event.waitUntil(caches.open(API_CACHE).then(c=>c.delete(data.url)))}else if(data.type==="invalidateItem"&&data.id!=null){event.waitUntil(invalidateItem(data.id))}else if(data.type==="invalidateMany"){event.waitUntil(invalidateMany(data))}else if(data.type==="invalidateAll"){event.waitUntil(caches.delete(API_CACHE))}else if(data.type==="setLang"&&typeof data.lang==="string"){const normalized=data.lang.trim().toLowerCase();if(normalized){activeClientLang=normalized}}});async function cacheFirst(req,cacheName){const cache=await caches.open(cacheName);const cached=await cache.match(req);if(cached){return cached}const res=await fetch(req);if(res.ok&&res.status===200){const type=res.headers.get("Content-Type")||"";const isJs=req.destination==="script"||new URL(req.url).pathname.endsWith(".js");if(!isJs||type.includes("javascript")){cache.put(req,res.clone())}}return res}function computeCachePolicy(res){const policy={ttlMs:null,expiresAt:null,snapshotId:null,stale:false};const snapshotId=res.headers.get("X-Snapshot-Id");if(snapshotId){policy.snapshotId=snapshotId}const ttlHeader=res.headers.get("X-Snapshot-TTL");if(ttlHeader!=null){const ttlSeconds=parseInt(ttlHeader,10);if(Number.isFinite(ttlSeconds)){policy.ttlMs=Math.max(0,ttlSeconds*1e3);policy.stale=ttlSeconds<=0}}if(policy.ttlMs==null){const cc=res.headers.get("Cache-Control")||"";const maxAgeMatch=cc.match(/max-age=(\d+)/);if(maxAgeMatch){const ttlSeconds=parseInt(maxAgeMatch[1],10);if(Number.isFinite(ttlSeconds)){policy.ttlMs=Math.max(0,ttlSeconds*1e3)}}}if(policy.ttlMs==null){const legacy=res.headers.get("X-Cache-Ttl");if(legacy){const ttlSeconds=parseInt(legacy,10);if(Number.isFinite(ttlSeconds)){policy.ttlMs=Math.max(0,ttlSeconds*1e3)}}}if(policy.ttlMs==null){policy.ttlMs=DEFAULT_TTL}policy.expiresAt=Date.now()+policy.ttlMs;return policy}async function staleWhileRevalidate(req,cacheName){const cache=await caches.open(cacheName);const cached=await cache.match(req);const now=Date.now();const fetchAndUpdate=async()=>{const netRes=await fetch(req);if(netRes.ok){const policy=computeCachePolicy(netRes);const headers=new Headers(netRes.headers);if(policy.expiresAt!=null){headers.set("X-Cache-Expires",String(policy.expiresAt))}else{headers.delete("X-Cache-Expires")}if(typeof policy.ttlMs==="number"){headers.set("X-Cache-TtlMs",String(policy.ttlMs));const ttlSeconds=Math.max(0,Math.round(policy.ttlMs/1e3));headers.set("X-Snapshot-TTL",String(ttlSeconds))}else{headers.delete("X-Cache-TtlMs");headers.delete("X-Snapshot-TTL")}if(policy.snapshotId){headers.set("X-Cache-Snapshot-Id",policy.snapshotId);headers.set("X-Snapshot-Id",policy.snapshotId)}else{headers.delete("X-Cache-Snapshot-Id");headers.delete("X-Snapshot-Id")}headers.set("X-Cache-Stale",policy.stale?"1":"0");headers.set("X-Snapshot-Stale",policy.stale?"1":"0");headers.set("X-Snapshot-Updated",String(Date.now()));const body=await netRes.clone().blob();const res=new Response(body,{status:netRes.status,statusText:netRes.statusText,headers:headers});await cache.put(req,res.clone());return res.clone()}return netRes};if(cached){const exp=parseInt(cached.headers.get("X-Cache-Expires")||"0",10);const wasStale=cached.headers.get("X-Cache-Stale")==="1"||cached.headers.get("X-Snapshot-Stale")==="1";if(exp&&now<exp&&!wasStale){incrementCacheMetric("hit");return{response:cached,fetchPromise:null}}incrementCacheMetric("hit");incrementCacheMetric("stale");const headers=new Headers(cached.headers);headers.set("X-Cache-Stale","1");headers.set("X-Snapshot-Stale","1");headers.set("X-Snapshot-TTL","0");headers.set("X-Snapshot-Updated",String(Date.now()));const body=await cached.clone().blob();const staleResponse=new Response(body,{status:cached.status,statusText:cached.statusText,headers:headers});return{response:staleResponse,fetchPromise:fetchAndUpdate()}}incrementCacheMetric("miss");const fetchPromise=fetchAndUpdate();return{response:fetchPromise,fetchPromise:null}}async function cleanExpired(){const cache=await caches.open(API_CACHE);const keys=await cache.keys();const now=Date.now();await Promise.all(keys.map(async req=>{const res=await cache.match(req);if(!res){return}const exp=parseInt(res.headers.get("X-Cache-Expires")||"0",10);if(exp&&now>exp){await cache.delete(req);return}if(!exp){const dateHeader=res.headers.get("Date");const created=dateHeader?new Date(dateHeader).getTime():0;if(created&&now-created>DEFAULT_TTL){await cache.delete(req)}}}))}async function invalidateItem(id){const cache=await caches.open(API_CACHE);const keys=await cache.keys();await Promise.all(keys.map(req=>{const url=new URL(req.url);if(url.searchParams.get("itemId")===String(id)||url.pathname.endsWith(`/items/${id}`)||url.searchParams.get("output")===String(id)){return cache.delete(req)}return null}))}async function invalidateMany({urls:urls=[],ids:ids=[],snapshotIds:snapshotIds=[]}={}){const normalizedUrls=new Set((Array.isArray(urls)?urls:[]).map(entry=>{try{return new URL(entry,self.location.origin).href}catch(err){return null}}).filter(value=>value!=null));const normalizedSnapshots=new Set((Array.isArray(snapshotIds)?snapshotIds:[]).map(entry=>{if(entry==null)return null;return String(entry)}).filter(value=>value));if(normalizedUrls.size||normalizedSnapshots.size){const cache=await caches.open(API_CACHE);const keys=await cache.keys();await Promise.all(keys.map(async req=>{let shouldDelete=false;if(normalizedUrls.size&&normalizedUrls.has(req.url)){shouldDelete=true}if(!shouldDelete&&normalizedSnapshots.size){const res=await cache.match(req);if(res){const snapshotId=res.headers.get("X-Snapshot-Id")||res.headers.get("X-Cache-Snapshot-Id");if(snapshotId&&normalizedSnapshots.has(snapshotId)){shouldDelete=true}}}if(shouldDelete){await cache.delete(req)}}))}if(Array.isArray(ids)&&ids.length){await Promise.all(ids.map(value=>invalidateItem(value)))}}async function purgeWorkerEntries(cacheName){const cache=await caches.open(cacheName);const keys=await cache.keys();await Promise.all(keys.map(async req=>{try{const url=new URL(req.url);if(WORKER_PATH_REGEX.test(url.pathname)){await cache.delete(req)}}catch(err){}}))}function isVersionedDistAsset(pathname,typeSegment){const segments=pathname.split("/").filter(Boolean);if(segments.length<3){return false}const[root,version,type]=segments;if(root!=="dist"||!VERSIONED_DIST_REGEX.test(version)){return false}if(typeSegment){return type===typeSegment}return true}