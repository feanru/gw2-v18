var RecipeServiceBundle=function(e){"use strict";const t={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},r="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let n=null;function o(e){r&&r.postMessage({type:"delete",key:e})}const i={API_BASE_URL:"/api",CDN_BASE_URL:"",DEFAULT_LANG:"es",FALLBACK_LANGS:["en"],MARKET_CSV_URL:"https://api.datawars2.ie/gw2/v1/items/csv",GW2_API_KEY:"",priceCacheStrategy:"sessionStorage",FEATURE_USE_PRECOMPUTED:!1,FEATURE_MARKET_CSV_EXTERNAL:!0,FEATURE_MARKET_CSV_EXTERNAL_WORKER:!1,FEATURE_DONES_AGGREGATE:!1,PRECOMPUTED_CANARY_THRESHOLD:1,FETCH_GUARD_MODE:"enforce",FETCH_GUARD_WHITELIST:[],CONNECT_ALLOWLIST:[],FETCH_GUARD_REPORT_URL:null,FEATURE_ITEM_API_ROLLOUT:!1};function a(e,t=!1){if("boolean"==typeof e)return e;if(null==e)return t;if("number"==typeof e)return Number.isNaN(e)?t:0!==e;const r=String(e).trim().toLowerCase();return r?!!["1","true","yes","on"].includes(r)||!["0","false","no","off"].includes(r)&&t:t}function s(e,t){if(t&&"object"==typeof t){if(Object.prototype.hasOwnProperty.call(t,"API_BASE_URL")&&null!=t.API_BASE_URL&&(e.API_BASE_URL=t.API_BASE_URL),Object.prototype.hasOwnProperty.call(t,"CDN_BASE_URL")&&null!=t.CDN_BASE_URL&&(e.CDN_BASE_URL=t.CDN_BASE_URL),Object.prototype.hasOwnProperty.call(t,"DEFAULT_LANG")&&t.DEFAULT_LANG&&(e.DEFAULT_LANG=t.DEFAULT_LANG),Object.prototype.hasOwnProperty.call(t,"LANG")&&t.LANG&&(e.DEFAULT_LANG=t.LANG),Object.prototype.hasOwnProperty.call(t,"MARKET_CSV_URL")&&t.MARKET_CSV_URL&&(e.MARKET_CSV_URL=t.MARKET_CSV_URL),Object.prototype.hasOwnProperty.call(t,"GW2_API_KEY")&&null!=t.GW2_API_KEY&&(e.GW2_API_KEY=t.GW2_API_KEY),Object.prototype.hasOwnProperty.call(t,"priceCacheStrategy")&&t.priceCacheStrategy?e.priceCacheStrategy=t.priceCacheStrategy:Object.prototype.hasOwnProperty.call(t,"PRICE_CACHE_STRATEGY")&&t.PRICE_CACHE_STRATEGY&&(e.priceCacheStrategy=t.PRICE_CACHE_STRATEGY),Object.prototype.hasOwnProperty.call(t,"FEATURE_USE_PRECOMPUTED")&&(e.FEATURE_USE_PRECOMPUTED=t.FEATURE_USE_PRECOMPUTED),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL")?e.FEATURE_MARKET_CSV_EXTERNAL=t.FEATURE_MARKET_CSV_EXTERNAL:Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_INTERNAL")&&(e.FEATURE_MARKET_CSV_EXTERNAL=!a(t.FEATURE_MARKET_CSV_INTERNAL,!0)),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL_WORKER")&&(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=t.FEATURE_MARKET_CSV_EXTERNAL_WORKER),Object.prototype.hasOwnProperty.call(t,"FEATURE_DONES_AGGREGATE")&&(e.FEATURE_DONES_AGGREGATE=t.FEATURE_DONES_AGGREGATE),Object.prototype.hasOwnProperty.call(t,"FEATURE_ITEM_API_ROLLOUT")&&(e.FEATURE_ITEM_API_ROLLOUT=t.FEATURE_ITEM_API_ROLLOUT),Object.prototype.hasOwnProperty.call(t,"PRECOMPUTED_CANARY_THRESHOLD")&&(e.PRECOMPUTED_CANARY_THRESHOLD=t.PRECOMPUTED_CANARY_THRESHOLD),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_MODE")&&"string"==typeof t.FETCH_GUARD_MODE&&(e.FETCH_GUARD_MODE=t.FETCH_GUARD_MODE),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_WHITELIST")){const r=t.FETCH_GUARD_WHITELIST;if(Array.isArray(r))e.FETCH_GUARD_WHITELIST=[...r];else if("string"==typeof r){const t=r.split(",").map(e=>e.trim()).filter(Boolean);e.FETCH_GUARD_WHITELIST=t}}if(Object.prototype.hasOwnProperty.call(t,"CONNECT_ALLOWLIST")&&Array.isArray(t.CONNECT_ALLOWLIST)&&(e.CONNECT_ALLOWLIST=[...t.CONNECT_ALLOWLIST]),Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANGS")){const r=t.FALLBACK_LANGS;Array.isArray(r)?e.FALLBACK_LANGS=[...r]:"string"==typeof r&&(e.FALLBACK_LANGS=r.split(",").map(e=>e.trim()).filter(Boolean))}else if(Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANG")){const r=t.FALLBACK_LANG;"string"==typeof r&&(e.FALLBACK_LANGS=r.split(",").map(e=>e.trim()).filter(Boolean))}if(Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_REPORT_URL")){const r=t.FETCH_GUARD_REPORT_URL;null!=r&&"string"!=typeof r||(e.FETCH_GUARD_REPORT_URL=r)}}}function l(){const e={...i,FETCH_GUARD_WHITELIST:[...i.FETCH_GUARD_WHITELIST],CONNECT_ALLOWLIST:[...i.CONNECT_ALLOWLIST]},t=("undefined"!=typeof globalThis?globalThis.window&&"object"==typeof globalThis.window?globalThis.window:globalThis.self&&"object"==typeof globalThis.self?globalThis.self:globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0)||("undefined"!=typeof globalThis?globalThis:void 0),r=t&&"object"==typeof t.Config?t.Config:null,n=t&&"object"==typeof t.__RUNTIME_CONFIG__?t.__RUNTIME_CONFIG__:null,o=t&&"object"==typeof t.__SECURE_RUNTIME_CONFIG__?t.__SECURE_RUNTIME_CONFIG__:null;s(e,r),s(e,n),s(e,o),e.FEATURE_USE_PRECOMPUTED=a(e.FEATURE_USE_PRECOMPUTED,i.FEATURE_USE_PRECOMPUTED),e.FEATURE_MARKET_CSV_EXTERNAL=a(e.FEATURE_MARKET_CSV_EXTERNAL,i.FEATURE_MARKET_CSV_EXTERNAL),e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=a(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER,i.FEATURE_MARKET_CSV_EXTERNAL_WORKER),e.FEATURE_ITEM_API_ROLLOUT=a(e.FEATURE_ITEM_API_ROLLOUT,i.FEATURE_ITEM_API_ROLLOUT);const l=Number(e.PRECOMPUTED_CANARY_THRESHOLD);e.PRECOMPUTED_CANARY_THRESHOLD=Number.isFinite(l)?Math.min(Math.max(l,0),100):i.PRECOMPUTED_CANARY_THRESHOLD;const c=Array.isArray(e.FALLBACK_LANGS)?e.FALLBACK_LANGS:"string"==typeof e.FALLBACK_LANGS?e.FALLBACK_LANGS.split(","):[];if(null!=e.CDN_BASE_URL&&""!==e.CDN_BASE_URL){const t=String(e.CDN_BASE_URL).trim().replace(/\/$/,"");e.CDN_BASE_URL=t}else e.CDN_BASE_URL="";const u=String(e.DEFAULT_LANG||i.DEFAULT_LANG).trim().toLowerCase();e.FALLBACK_LANGS=[...new Set(c.map(e=>"string"==typeof e?e.trim().toLowerCase():"").filter(e=>e&&e!==u))],e.LANG=e.DEFAULT_LANG||i.DEFAULT_LANG;const f=String(e.LANG||"").trim().toLowerCase();return e.FALLBACK_LANGS=e.FALLBACK_LANGS.filter(e=>e&&e!==f),e}const c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:null,u="__GW2_FETCH_GUARD_INSTALLED__";if(c&&"function"==typeof c.fetch&&!c[u]){const e=c.fetch;let t=f(c)||"http://localhost";const r=()=>{const e=f(c);e&&t!==e&&(t=e);const r=function(){try{return l()}catch{return null}}(),n=function(e){if("string"!=typeof e)return"off";const t=e.trim().toLowerCase();if(!t)return"off";const r=t.replace(/[_\s]+/g,"-");if(["off","disabled","disable","none","0","false"].includes(r))return"off";if(["enforce","block","blocked","deny","enforced","strict","on","true"].includes(r))return"enforce";if(["report-only","report","monitor","monitoring","warn","warning"].includes(r))return"report-only";return"off"}(r?.FETCH_GUARD_MODE),o=function(e){if("string"!=typeof e)return null;const t=e.trim();return t||null}(r?.FETCH_GUARD_REPORT_URL),i=function(e,t){const r=new Set,n=e=>{e&&(Array.isArray(e)?e.forEach(n):r.add(e))},o=e=>{if(e||0===e)if(Array.isArray(e))e.forEach(o);else if("string"!=typeof e)try{const r=p(String(e),t);n(r)}catch{}else e.split(",").forEach(e=>{const r=p(e.trim(),t);n(r)})},i=[e?.API_BASE_URL,e?.MARKET_CSV_URL,"/api","api","/backend/api","backend/api","/recipe-tree","https://api.guildwars2.com","https://api.datawars2.ie"],a=e?.FETCH_GUARD_WHITELIST,s=function(e){if(Array.isArray(e))return e.length>0;if(null==e)return!1;if("string"==typeof e)return e.split(",").some(e=>e.trim());return!0}(a);o(i),o(a),o(e?.fetchGuardWhitelist),o(e?.fetchWhitelist),o(e?.FETCH_WHITELIST),s||o(e?.CONNECT_ALLOWLIST);return Array.from(r)}(r,e);return{mode:n,reportUrl:o,whitelist:i,locationOrigin:e}},n=(e,r,n)=>{if("off"===n.mode)return;const o=`[fetchGuard] ${e}: ${r}`;try{"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(o)}catch{}if(!n.reportUrl)return;let i;try{i=JSON.stringify({source:"fetchGuard",reason:e,targetUrl:r,mode:n.mode,timestamp:Date.now(),locationOrigin:n.locationOrigin})}catch{i=null}if(i){try{if("function"==typeof c.navigator?.sendBeacon)return void c.navigator.sendBeacon(n.reportUrl,i)}catch{}try{if("function"==typeof c.Image){const e=encodeURIComponent(i),r=function(e,t,r){if(!e)return null;try{const n=new URL(e,r);return n.searchParams.append("payload",t),n.href}catch{try{const r=e.includes("?")?"&":"?";return`${e}${r}payload=${t}`}catch{return null}}}(n.reportUrl,e,t);if(!r)return;const o=new c.Image;try{"referrerPolicy"in o&&(o.referrerPolicy="no-referrer")}catch{}const a=function(e){const t="__FETCH_GUARD_REPORT_IMAGES__";if(!e[t])try{Object.defineProperty(e,t,{value:new Set,configurable:!0,enumerable:!1,writable:!1})}catch{e[t]=new Set}return e[t]}(c);a.add(o);const s=()=>a.delete(o);try{o.onload=s,o.onerror=s}catch{}o.src=r}}catch{}}},o=function(o,i){const a=r(),s=function(e,t){if(!e&&""!==e)return null;const r=e=>{try{return new URL(e,t)}catch{return null}};if("undefined"!=typeof URL)try{if(e instanceof URL)return e}catch{}if("undefined"!=typeof Request)try{if(e instanceof Request)return r(e.url)}catch{}if("string"==typeof e)return r(e);if(e&&"string"==typeof e.url)return r(e.url);return null}(o,t);if(!s||"off"===a.mode||function(e,t){if(!e)return!1;const r="string"==typeof e.hostname?e.hostname.toLowerCase():"",n="string"==typeof e.origin?e.origin:"";let o="";if(n&&"null"!==n)try{o=new URL(n).hostname.toLowerCase()}catch{const e=n.toLowerCase(),t=e.indexOf("://");o=t>=0?e.slice(t+3):e}for(const n of t)switch(n.type){case"wildcard":return!0;case"origin":if(e.origin===n.value)return!0;break;case"href":if(e.href.startsWith(n.value))return!0;break;case"hostname":if(r===n.value)return!0;if(o&&o===n.value)return!0;break;case"hostname-pattern":if(E(r,n.value))return!0;if(E(o,n.value))return!0;break;case"pathname":if(e.pathname.startsWith(n.value))return!0}return!1}(s,a.whitelist))return e.call(this,o,i);let l;var c;c=s,l=c?.pathname.includes("/backend/")?"Legacy backend fetch detected":function(e,t){return!!e&&(!!t&&("null"!==e.origin&&e.origin!==t))}(s,a.locationOrigin)?"External fetch detected":"Blocked fetch detected";const u=function(e,t){if(e?.href)return e.href;if("string"==typeof t)return t;if(t&&"string"==typeof t.url)return t.url;return"unknown target"}(s,o);return n(l,u,a),"enforce"===a.mode?Promise.reject(function(e,t){const r=new Error(`[fetchGuard] ${e}: ${t}`);return r.name="FetchGuardError",r.reason=e,r.url=t,r}(l,u)):e.call(this,o,i)};o.originalFetch=e,c.fetch=o,c[u]=!0}function f(e){if(!e||"object"!=typeof e)return;const t=e.location&&"object"==typeof e.location?e.location:null,r=_(t?.origin);if(r)return r;const n=_(e.origin),o=function(e,t){if("string"!=typeof e)return null;const r=e.trim();if(!r)return null;try{return _(new URL(r).origin)}catch{if(!t)return null;try{return _(new URL(r,t).origin)}catch{return null}}}(t?.href,n);return o||(n||void 0)}function _(e){if("string"!=typeof e)return null;const t=e.trim();return t&&"null"!==t.toLowerCase()?t:null}function p(e,t){if(!e)return null;const r=e.trim();if(!r)return null;const n=r.replace(/^['"]|['"]$/g,"");if(!n)return null;const o=n.toLowerCase();if("self"===o){const e=_(t);return e?{type:"origin",value:e}:{type:"pathname",value:"/recipe-tree"}}if("*"===o)return{type:"wildcard"};if(/^\*\.[^*]+/.test(n)){const e=n.slice(2).toLowerCase();return e?{type:"hostname-pattern",value:e}:null}if(n.startsWith("//"))try{return{type:"origin",value:new URL(n,t||"http:").origin}}catch{return null}if(/^[a-zA-Z]+:\/\//.test(n))try{const e=new URL(n);return n.endsWith("/"),{type:"href",value:e.href}}catch{return null}if(n.startsWith("/"))return{type:"pathname",value:n};if(n.includes("://"))try{return{type:"href",value:new URL(n).href}}catch{return null}return n.includes(".")?{type:"hostname",value:n.toLowerCase()}:{type:"pathname",value:n.startsWith("/")?n:`/${n}`}}function E(e,t){if(!e||!t)return!1;const r=e.toLowerCase(),n=t.toLowerCase().replace(/^\.+/,"");return!!n&&(r===n||r.endsWith(`.${n}`))}const A=[];function d(){const e=Date.now()-6e4;for(;A.length&&A[0]<e;)A.shift()}function y(){d();const e=A.length;return e>5?"down":e>0?"slow":"ok"}let R;function T(){if("undefined"==typeof document)return;const e=y();R||(R=document.createElement("div"),R.id="api-status-indicator",R.style.position="fixed",R.style.bottom="10px",R.style.right="10px",R.style.padding="4px 8px",R.style.background="rgba(0,0,0,0.7)",R.style.color="#fff",R.style.borderRadius="4px",R.style.zIndex="10000",R.style.display="none",document.body.appendChild(R)),"ok"===e?R.style.display="none":(R.textContent="slow"===e?"API lenta":"API caída",R.style.display="block")}var h={recordFailure:function(){A.push(Date.now()),d(),T()},recordSuccess:function(){d(),T()},getState:y,getBackoff:function(){const e=y();return"down"===e?5e3:"slow"===e?1e3:0}};async function g(e,t={}){const{timeout:r=8e3,retries:n=3,backoff:o=300,signal:i,...a}=t;for(let t=0;t<=n;t++){const s=new AbortController,l=setTimeout(()=>s.abort(),r);i&&(i.aborted?s.abort():i.addEventListener("abort",()=>s.abort(),{once:!0}));try{const t=await fetch(e,{...a,signal:s.signal});return clearTimeout(l),h.recordSuccess(),t}catch(e){if(clearTimeout(l),h.recordFailure(),i?.aborted||t===n)throw e;const r=o*Math.pow(2,t);await new Promise(e=>setTimeout(e,r))}}}const L=new Map;!function(e){n=e,r&&r.addEventListener("message",({data:e})=>{const{type:t,key:o,entry:i}=e||{};if("request-bundles"!==t)t&&o&&("set"===t&&i?n.set(o,i):"delete"===t&&n.delete(o));else{if(!n)return;n.forEach((e,t)=>{t.startsWith("bundle_")&&r.postMessage({type:"set",key:t,entry:e})})}})}(L),r&&r.postMessage({type:"request-bundles"});const w="undefined"!=typeof localStorage;function S(e){try{return JSON.parse(e)}catch{return null}}function C(e,t){if(w)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:r,lastModified:n,lang:o,source:i,fallback:a}){return JSON.stringify({value:e,expiresAt:t,etag:r,lastModified:n,lang:o,source:i,fallback:a})}(t))}catch{}}function m(e,n,o=void 0,i={}){if(void 0===o){const r=e.split("_")[0];o=t[r]}const a=null==o?null:Date.now()+o,{etag:s=null,lastModified:l=null,lang:c=null,source:u=null,fallback:f=null}=i,_={value:n,expiresAt:a,updatedAt:(new Date).toISOString(),etag:s,lastModified:l,lang:c,source:u,fallback:f};L.set(e,_),C(e,{value:n,expiresAt:a,etag:s,lastModified:l,lang:c,source:u,fallback:f}),function(e,t){r&&r.postMessage({type:"set",key:e,entry:t})}(e,_)}function U(e,t=!1){let r=L.get(e);if(!r){const t=function(e){if(!w)return null;const t=localStorage.getItem(e);if(!t)return null;const r=S(t);return r||(localStorage.removeItem(e),null)}(e);if(t){const{value:n,expiresAt:o=null,etag:i=null,lastModified:a=null,lang:s=null,source:l=null,fallback:c=null}=t;r={value:n,expiresAt:o,updatedAt:(new Date).toISOString(),etag:i,lastModified:a,lang:s,source:l,fallback:c},L.set(e,r)}}return r?r.expiresAt&&Date.now()>r.expiresAt?(L.delete(e),w&&localStorage.removeItem(e),o(e),null):t?r:r.value:null}!function(){if(!w)return;const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t),n=S(localStorage.getItem(r));if(!n)continue;const{expiresAt:o}=n;o&&Date.now()>o&&e.push(r)}e.forEach(e=>{localStorage.removeItem(e),o(e)})}();const b=new Map;function O(e,t={},r=null,n=null,o){const i=b.get(e);i&&i.controller?.abort(),r&&!n&&(n=U(r,!0));const a={...t.headers||{}};n?.etag&&(a["If-None-Match"]=n.etag),n?.lastModified&&(a["If-Modified-Since"]=n.lastModified);const s=o?null:new AbortController,l=o??t.signal??s?.signal;return function(e,t,r){return b.set(e,{promise:t,controller:r}),t.finally(()=>b.delete(e)),t}(e,g(e,{...t,headers:a,signal:l}).then(async e=>304===e.status&&n?new Response(JSON.stringify(n.value),{status:200,headers:{"X-Cache":"HIT",ETag:n.etag||"","Last-Modified":n.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),s).then(e=>e.clone())}const N=Object.prototype.hasOwnProperty;function F(e){return null==e?[]:Array.isArray(e)?e:[e]}function I(e){if(null==e)return{data:null,meta:{errors:[]}};if("object"!=typeof e||e instanceof Response)return{data:e,meta:{errors:[]}};if(Array.isArray(e))return{data:e,meta:{errors:[]}};if(N.call(e,"data")){const t=N.call(e,"meta")&&"object"==typeof e.meta?{...e.meta,errors:F(e.meta?.errors)}:{errors:[]};return{data:e.data,meta:t}}if(N.call(e,"meta")){return{data:null,meta:"object"==typeof e.meta?{...e.meta,errors:F(e.meta?.errors)}:{errors:[]}}}const{errors:t,...r}=e;return{data:r,meta:{errors:F(t)}}}const P=new Map;function D(){return"sessionStorage"===function(){const e=l();return e?.priceCacheStrategy||"sessionStorage"}()}function M(e){return`price_${e}`}function G(e){if(!D()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(M(e));if(!t)return null;try{const{value:r,expires:n}=JSON.parse(t);return n&&Date.now()>n?(sessionStorage.removeItem(M(e)),null):r}catch{return sessionStorage.removeItem(M(e)),null}}async function v(e){if(!Array.isArray(e)||0===e.length)return new Map;const t=l();if("redis"===(t?.priceCacheStrategy||"sessionStorage")){const t=`/backend/api/itemBundle.php?ids=${e.join(",")}`,r=await fetch(t);if(!r.ok)throw new Error("Price fetch failed");const n=await r.json().catch(()=>null),{data:o,meta:i}=I(n),a=Array.isArray(o)?o:[];!Array.isArray(o)&&Array.isArray(i?.errors)&&i.errors.length&&console.warn("itemBundle precios devolvió errores",i.errors);const s=new Map;return a.forEach(e=>{const t=e.market||{};s.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),s}{const r=["id","buy_price","sell_price"].join(","),n=Boolean(t?.FEATURE_MARKET_CSV_EXTERNAL)?t?.MARKET_CSV_URL||"https://api.datawars2.ie/gw2/v1/items/csv":function(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,""),n=String(t).replace(/^\/+/,"");return r?n?`${r}/${n}`:r||"/":n?`/${n}`:"/"}(t?.API_BASE_URL||"/api","/market.csv"),o=new URLSearchParams;o.set("fields",r),o.set("ids",e.join(","));const i=`${n}?${o.toString()}`,a=await fetch(i);if(!a.ok)throw new Error("Price fetch failed");const s=(await a.text()).trim().split("\n"),l=s[0].split(","),c=new Map;for(let e=1;e<s.length;e++){if(!s[e])continue;const t=s[e].split(","),r={};l.forEach((e,n)=>{const o=t[n];r[e]=void 0!==o?isNaN(o)?o:Number(o):null}),null!=r.id&&c.set(r.id,{buy_price:r.buy_price||0,sell_price:r.sell_price||0})}return c}}async function B(e=[]){const t=new Map,r=[];if(e.forEach(e=>{if(e=Number(e),P.has(e))return void t.set(e,P.get(e));const n=G(e);n?(P.set(e,n),t.set(e,n)):r.push(e)}),r.length)try{(await v(r)).forEach((e,r)=>{P.set(r,e),function(e,t){if(D()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(M(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(r,e),t.set(r,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!t.has(e)&&P.has(e)&&t.set(e,P.get(e)),t.has(e)||t.set(e,{buy_price:0,sell_price:0})}),t}const K=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function H(e){if(null==e)return null;const t=Number(e);return Number.isFinite(t)?t:null}function k(e){return K(e)?{...e}:null}function j(e){const t=k(e),r=function(e){const t=H(e?.unitBuyPrice??e?.unit_buy_price),r=H(e?.unitSellPrice??e?.unit_sell_price);return{buy:t??H(e?.buy_price??e?.buyPrice??e?.buys?.unit_price),sell:r??H(e?.sell_price??e?.sellPrice??e?.sells?.unit_price)}}(e||{}),n=function(e){return{buy:H(e?.buy??e?.totalBuy??e?.total_buy),sell:H(e?.sell??e?.totalSell??e?.total_sell),crafted:H(e?.crafted??e?.totalCrafted??e?.total_crafted)}}(e||{}),o=Number.isFinite(r.buy)||Number.isFinite(r.sell),i=Number.isFinite(n.buy)||Number.isFinite(n.sell)||Number.isFinite(n.crafted);return{unit:r,totals:n,raw:t,hasData:Boolean(o||i),source:"string"==typeof e?.source?e.source:null,updatedAt:e?.lastChanged??e?.last_changed??e?.lastUpdated??e?.updatedAt??null}}const W=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function $(e){const t=W(e)?e:{},r=function(e){const t=k(e)||{};return t.stale="boolean"==typeof e?.stale&&e.stale,t.lang="string"==typeof e?.lang?e.lang:"es",t}(t.meta),n=W(t.data)?t.data:t,o=function(e){return Array.isArray(e)?e.filter(K).map(e=>({...e})):K(e)?[{...e}]:[]}(n.recipes??n.recipe??n);return{recipes:o,primary:o.length>0?o[0]:null,meta:r}}function V(e){return j(e)}function x(e,t){if("undefined"==typeof window||!window)return;Array.isArray(window.__bundleFallbacks__)||(window.__bundleFallbacks__=[]);const r=t&&t.message?t.message:String(t||"")||"unknown",n={ids:Array.isArray(e)?e.map(e=>String(e)):[],message:r,timestamp:(new Date).toISOString()};window.__bundleFallbacks__.push(n),window.__bundleFallbacks__.length>50&&window.__bundleFallbacks__.shift(),window.__lastBundleFallback__=n}function X(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,""),n=String(t).replace(/^\/+/,"");return r?n?`${r}/${n}`:r||"/":`/${n}`}function Y(e,t){const{data:r,meta:n}=I(e),o=Array.isArray(r)?r:[];return!Array.isArray(r)&&Array.isArray(n?.errors)&&n.errors.length&&console.warn("dataBundle devolvió errores",n.errors),o.length&&o.forEach(e=>{const r=String(e.id),n={recipe:$({data:e?.recipe??null}),prices:V(e?.market??null)},o={...e,adapters:n};t.set(r,o),m(`bundle_${r}`,o),"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"function"==typeof CustomEvent&&window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:o}))}),o.length>0}async function J(e=[]){if(!Array.isArray(e)||0===e.length)return[];const t=new Map,r=[];if(e.forEach(e=>{const n=String(e),o=U(`bundle_${n}`);o?t.set(n,o):r.push(n)}),r.length>0){const{API_BASE_URL:e,FEATURE_ITEM_API_ROLLOUT:n}=l(),o=Boolean(n);for(let n=0;n<r.length;n+=35){const i=r.slice(n,n+35),a=i.map(e=>`ids[]=${e}`).join("&");let s=!1;if(o){const r=`${X(e,"/items/bundle")}?${a}`;try{const e=await g(r);if(!e.ok)throw new Error(`Respuesta ${e.status} inválida en bundle API`);const n=await e.json().catch(()=>null);if(!n)throw new Error("Payload JSON no válido en bundle API");Y(n,t),s=!0}catch(e){s=!1,console.warn("Fallo en bundle API, usando PHP como fallback",e),x(i,e)}}if(!o||!s)try{const e=await g(`/backend/api/dataBundle.php?${a}`);if(e.ok){Y(await e.json().catch(()=>null),t)}else console.error("Error en getItemBundles: respuesta no válida")}catch(e){console.error("Error en getItemBundles:",e)}i.forEach(e=>{const r=String(e);t.has(r)||t.set(r,null)})}}return e.map(e=>{const r=String(e);return t.get(r)||null})}async function q(e){const t=Array.isArray(e)?e:[e],r=await J(t);if(Array.isArray(e))return r.map(e=>e?.recipe?[e.recipe]:[]);const n=r[0]?.recipe;return n?[n]:[]}async function z(e){const t=`recipe_${e}`,r=U(t,!0);try{const{API_BASE_URL:n}=l(),o=await O(`${n}/recipes/${e}`,{},t,r);if(!o.ok)return null;const i=await o.json();if(!i)return null;i.lastUpdated=(new Date).toISOString();const a=o.headers.get("ETag");return m(t,i,void 0,{etag:a,lastModified:o.headers.get("Last-Modified")}),i}catch(e){return console.error("Error en getRecipeDetails:",e),null}}async function Z(e){if(Array.isArray(e)){return(await J(e)).map(e=>e?.item||null)}const t=await J([e]);return t[0]?.item||null}async function Q(e){if(Array.isArray(e)){const t=await B(e);return e.map(e=>{const r=t.get(e)||{};return{buys:{unit_price:r.buy_price||0},sells:{unit_price:r.sell_price||0}}})}const t=await async function(e){if(e=Number(e),P.has(e))return P.get(e);const t=G(e);return t?(P.set(e,t),t):(await B([e])).get(e)}(e);return{buys:{unit_price:t?.buy_price||0},sells:{unit_price:t?.sell_price||0}}}const ee={getItemBundles:J,getRecipesForItem:q,getRecipeDetails:z,getItemDetails:Z,getItemPrices:Q};function te(e=("undefined"!=typeof window?window:void 0)){if(!e)return ee;const t={...e.RecipeService||{},...ee};return e.RecipeService=t,Object.entries(ee).forEach(([t,r])=>{"function"!=typeof e[t]&&(e[t]=r)}),t}"undefined"!=typeof window&&te(window);return te("undefined"!=typeof window?window:void 0),e.getItemBundles=J,e.getItemDetails=Z,e.getItemPrices=Q,e.getRecipeDetails=z,e.getRecipesForItem=q,e.registerRecipeServiceGlobals=te,e}({});
