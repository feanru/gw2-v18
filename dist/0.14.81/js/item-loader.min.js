import{i as e,u as t,v as r,w as n,x as a,t as o,y as i,z as l,n as s,A as c,B as d,b as u}from"./utils.min.js";import{g as w}from"./config.min.js";import{c as m,d as p,a as f,e as g,f as y,t as _,h as b,m as h}from"./services.min.js";const k=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);let E,A,S,I,R,T,v,P,B,F,j;const C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0;let O;async function U(){return O||(O=Promise.all([import("./items-core.min.js"),import("./utils.min.js").then(function(e){return e._}),import("./services.min.js").then(function(e){return e.r}),import("./utils.min.js").then(function(e){return e.a0})]).then(([e,t,r,n])=>{({prepareIngredientTreeData:E,CraftIngredient:A,setIngredientObjs:S,setTotalsFromAggregate:I,findIngredientsById:R,cancelItemRequests:T,recalcAll:v}=e),({preloadPrices:F,getPrice:j}=t),({getItemBundles:P}=r),({update:B}=n),"undefined"==typeof window||window.RecipeService||console.error("Servicios de recetas no disponibles: window.RecipeService no está definido.")})),O}let D=0,L=null,$=null;function N(){if(L){try{L()}catch(e){console.warn("Error deteniendo actualizador de precios",e)}L=null}}async function H(e){if(!Array.isArray(e)||0===e.length)return[];await U();try{return await P(e)}catch(e){return console.error("Error cargando ítems",e),[]}}async function M(e,t,s,c={}){r(),window.hideError?.();let u=!1;const{bucket:w=null}=c||{},m=()=>n(),p=m();let g=null;const y=L;let b=!1;const h=()=>{if(!b&&(b=!0,y)){try{y()}catch(e){console.warn("Error deteniendo actualizador previo",e)}L===y&&(L=null)}},k=async(r,n,a)=>{if(u)return;u=!0;const i=n?.stale??g?.stale??null;h(),N(),function(e,t=null,r=null,n=null){const a={reason:e||"unknown",meta:t?{...t}:null,stale:Boolean(t?.stale),error:r?String(r?.message||r):void 0,timestamp:(new Date).toISOString()};if("function"==typeof B)try{B("aggregate-fallback",a)}catch(e){console.warn("No se pudo registrar el fallback en el estado",e)}C&&(Array.isArray(C.__aggregateFallbacks__)||(C.__aggregateFallbacks__=[]),C.__aggregateFallbacks__.push(a),C.__lastAggregateFallback__=a),o({type:"aggregateFallback",bucket:n,meta:{stale:a.stale,reason:a.reason},error:a.error})}(r,n,a,w),await q(e,t,s,{bucket:w,fromFallback:!0,fallbackReason:r,stale:i})};try{window.showSkeleton?.(t),$=new AbortController;const r=function(){const e=C?.__TEST_FETCH_ITEM_AGGREGATE__;return"function"==typeof e?e:d}(),n=await r(e,{signal:$.signal}),c=n?.model||_({data:n?.data,meta:n?.meta});if(304===n?.status&&n.fromCache)return g=c?.meta||n?.meta||null,window.hideSkeleton?.(t),a(c?.meta),void o({type:"aggregateNotModified",bucket:w,meta:{stale:c?.meta?.stale??null}});h(),N();const{item:u,market:y,tree:b,meta:E,prices:A}=c;if(g=E||null,s!==D)return;if(!u)return void await k("missing-item",E);if((Array.isArray(E?.errors)?E.errors.filter(Boolean):[]).length)return void await k("meta-errors",E);const R=i(b);S(R?[R]:[]);const T=A?.hasData?A:f(y);I({buy:T?.totals?.buy??y?.buy??null,sell:T?.totals?.sell??y?.sell??null,crafted:T?.totals?.crafted??y?.crafted??null});const v=T?.unit?.buy??R?.buy_price??0,P=T?.unit?.sell??R?.sell_price??0;window._mainBuyPrice=v||0,window._mainSellPrice=P||0,window._mainRecipeOutputCount=R?.recipe?.output_item_count||R?.output||1,await window.initItemUI(u,{buy_price:window._mainBuyPrice,sell_price:window._mainSellPrice}),await(window.safeRenderTable?.()),window.hideSkeleton?.(t),a(E);const B=m()-p;l({bucket:w,stale:E?.stale??null,duration:B}),o({type:"aggregateSuccess",bucket:w,metrics:{durationMs:B},meta:{stale:E?.stale??null}})}catch(e){if("AbortError"===e?.name)return;if(h(),window.hideSkeleton?.(t),console.error("Error cargando agregado de ítem",e),window.showError?.("No se pudo cargar el agregado del ítem."),r(),s!==D)return;o({type:"aggregateError",bucket:w,meta:{stale:g?.stale??null},error:String(e?.message||e)}),await k("aggregate-error",g,e)}}async function q(e,t,n,a={}){await U(),r(),window.hideError?.();let i=null,l=null;const d=function(){const e=C?.__TEST_FETCH_WITH_RETRY__;return"function"==typeof e?e:u}(),{bucket:_=null,fromFallback:I=!1,fallbackReason:T=null,stale:v=null}=a||{};o({type:"legacyLoadStart",bucket:_,meta:{fromFallback:Boolean(I),fallbackReason:T,aggregateStale:v}});try{window.showSkeleton?.(t),$=new AbortController;const{API_BASE_URL:r,FEATURE_ITEM_API_ROLLOUT:a}=w(),u=Boolean(a);let v=null,P=null;if(u){const t=function(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,"");return`${r?`${r}/items`:"/items"}/${String(t).trim()}`}(r,e);try{const e=await d(t,{signal:$.signal});if(404===e.status)console.warn("Item API devolvió 404, usando fallback PHP");else{if(!e.ok)throw new Error(`Error ${e.status} obteniendo detalles del ítem desde API`);{const t=e.headers.get("content-type")||"";if(!t.includes("application/json"))throw new Error(`Respuesta no válida: ${t}`);const r=await e.json().catch(()=>null);if(!r)throw new Error("Payload JSON no válido en item API");v=e,P=r}}}catch(e){if("AbortError"===e?.name)throw e;console.warn("Fallo en item API, usando PHP como fallback",e),v=null,P=null}}if(!v){if(v=await d(`/backend/api/itemDetails.php?itemId=${e}`,{signal:$.signal}),404===v.status)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(t);if(!v.ok)throw new Error(`Error ${v.status} obteniendo detalles del ítem`);const r=v.headers.get("content-type")||"";if(!r.includes("application/json"))throw new Error(`Respuesta no válida: ${r}`);P=await v.json().catch(()=>null)}const{data:F,meta:C}=s(P),O=function(e){const t=k(e)?e:{},r=m(t.meta),n=k(t.data)?t.data:t,a=p(n.item),o=k(n.market)?{...n.market}:null,i=f(o),l=g(n.recipes??n.recipe??null),s=n.nested_recipe&&"object"==typeof n.nested_recipe?{...n.nested_recipe}:null,c=y(n.legacy??null);return{item:a,market:o,prices:i,recipes:l,primaryRecipe:l.length>0?l[0]:null,nestedRecipe:s,legacy:c,meta:r}}({data:F,meta:C});o({type:"legacyLoad",bucket:_,meta:{stale:O?.meta?.stale??null,fromFallback:Boolean(I),fallbackReason:T}});const U=O.item,N=O.primaryRecipe,H=O.nestedRecipe;if(!U){const e=O?.meta?.errors?.[0]||C?.errors?.[0]||"El ítem no existe";return window.showError?.(e),void window.hideSkeleton?.(t)}if(n!==D)return;const M=Array.isArray(O.market)||!O.market?{}:{...O.market};let q=O.prices;if(!q?.hasData)try{const t=await j(e);if(t){const e=b(t);q=h(q,e)}}catch(e){console.warn("No se pudo recuperar el precio de respaldo",e)}const x=q?.hasData?q:f(M);if(l={...M,buy_price:x?.unit?.buy??M.buy_price??0,sell_price:x?.unit?.sell??M.sell_price??0},window._mainBuyPrice=l.buy_price??0,window._mainSellPrice=l.sell_price??0,!N)return S([]),void window.initItemUI(U,l);N&&H&&(N.nested_recipe=H),window._mainRecipeOutputCount=N.output_item_count||1,setTimeout(async()=>{if(n!==D)return;let t;try{t=await E(e,N)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),S([]),void window.initItemUI(U,l)}Array.isArray(t)||(t=[]);const r=Array.isArray(N?.ingredients)&&N.ingredients.length>0&&0===t.length;let a=null;if(r){const e="No se pudo construir el árbol de ingredientes. Mostrando el ítem sin receta.";a="Sin receta disponible (no se pudo procesar la receta).",window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(e,"error"):console.warn(e)}i=new A({id:U.id,name:U.name,icon:U.icon,rarity:U.rarity,count:1,buy_price:l?.buy_price||0,sell_price:l?.sell_price||0,is_craftable:!r,recipe:r?null:N,children:r?[]:t}),i.recalc(window.globalQty||1,null),S([i]),await window.initItemUI(U,l),await(window.safeRenderTable?.()),a&&window.showError?.(a);const o=new Set;!function e(t,r){r.add(t.id),t.children&&t.children.forEach(t=>e(t,r))}(i,o),L&&L();const s=Array.from(o),d=async e=>{if(!document.getElementById("seccion-crafting"))return void requestAnimationFrame(()=>d(e));const t=[];e.forEach((e,r)=>{const n=R(window.ingredientObjs,Number(r));n.length&&n.forEach(r=>{r.buy_price=e.buy_price||0,r.sell_price=e.sell_price||0,r===window.ingredientObjs[0]&&(window._mainBuyPrice=r.buy_price,window._mainSellPrice=r.sell_price),t.push(r)})}),await(window.safeRenderTable?.());const r=window.getTotals?.();r&&(B("totales-crafting-global",r),B("totales-crafting-unit",r)),t.forEach(e=>B(e._uid,e))};L=c(s,d)},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(t),o({type:"legacyError",bucket:_,meta:{fromFallback:Boolean(I),fallbackReason:T},error:String(e?.message||e)})}finally{$=null}}async function x(r,n={}){await U();const a=++D;if($&&($.abort(),$=null),T(),!r)return window.hideSkeleton?.(document.getElementById("item-skeleton")),void window.showError?.("ID de ítem no válido");const o=document.getElementById("item-skeleton"),i=e("usePrecomputed"),{PRECOMPUTED_CANARY_THRESHOLD:l}=w(),s=t(),c=s<l,d=!0===n?.forceLegacy;i&&c&&!d?await M(r,o,a,{bucket:s}):await q(r,o,a,{bucket:s,fromFallback:Boolean(d)})}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),t=parseInt(e.get("id"),10);t?x(t):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{x as loadItem,q as loadItemLegacy,H as loadItems};
