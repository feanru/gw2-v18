import{p as e,g as t,a as n,f as r,s as i,b as a,n as s}from"./utils.min.js";import{g as l}from"./config.min.js";const u=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function o(e){if(null==e)return null;const t=Number(e);return Number.isFinite(t)?t:null}function c(e){return u(e)?{...e}:null}function d(e){const t=c(e)||{};return t.stale="boolean"==typeof e?.stale&&e.stale,t.lang="string"==typeof e?.lang?e.lang:"es",t}function p(e){return u(e)?{...e}:null}function f(e){const t=c(e),n=function(e){const t=o(e?.unitBuyPrice??e?.unit_buy_price),n=o(e?.unitSellPrice??e?.unit_sell_price);return{buy:t??o(e?.buy_price??e?.buyPrice??e?.buys?.unit_price),sell:n??o(e?.sell_price??e?.sellPrice??e?.sells?.unit_price)}}(e||{}),r=function(e){return{buy:o(e?.buy??e?.totalBuy??e?.total_buy),sell:o(e?.sell??e?.totalSell??e?.total_sell),crafted:o(e?.crafted??e?.totalCrafted??e?.total_crafted)}}(e||{}),i=Number.isFinite(n.buy)||Number.isFinite(n.sell),a=Number.isFinite(r.buy)||Number.isFinite(r.sell)||Number.isFinite(r.crafted);return{unit:n,totals:r,raw:t,hasData:Boolean(i||a),source:"string"==typeof e?.source?e.source:null,updatedAt:e?.lastChanged??e?.last_changed??e?.lastUpdated??e?.updatedAt??null}}function y(e,t=null){const n=e=>Number.isFinite(e)?e:null,r=e?.unit||{},i=t?.unit||{},a=e?.totals||{},s=t?.totals||{},l={buy:n(r.buy)??n(i.buy),sell:n(r.sell)??n(i.sell)},u={buy:n(a.buy)??n(s.buy),sell:n(a.sell)??n(s.sell),crafted:n(a.crafted)??n(s.crafted)},o=Number.isFinite(l.buy)||Number.isFinite(l.sell)||Number.isFinite(u.buy)||Number.isFinite(u.sell)||Number.isFinite(u.crafted);return{unit:l,totals:u,raw:e?.raw??t?.raw??null,hasData:o,source:e?.source??t?.source??null,updatedAt:e?.updatedAt??t?.updatedAt??null}}function b(e){return Array.isArray(e)?e.filter(u).map(e=>({...e})):u(e)?[{...e}]:[]}function m(e){return u(e)?{...e}:null}function _(e){const t=u(e)?e:{},n=u(t.data)?t.data:{},r=d(t.meta),i=p(n.item);let a=null;u(n.market)?a={...n.market}:u(n.totals)&&(a={...n.totals});return{item:i,market:a,tree:null!=n.tree?n.tree:null,meta:r,prices:f(a),recipes:b(n.recipes??n.recipe??null),legacy:m(n.legacy??null)}}const w=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function g(e){const t=w(e)?e:{},n=d(t.meta),r=w(t.data)?t.data:t,i=b(r.recipes??r.recipe??r);return{recipes:i,primary:i.length>0?i[0]:null,meta:n}}function A(e){return f(e)}function h(e,t){if("undefined"==typeof window||!window)return;Array.isArray(window.__bundleFallbacks__)||(window.__bundleFallbacks__=[]);const n=t&&t.message?t.message:String(t||"")||"unknown",r={ids:Array.isArray(e)?e.map(e=>String(e)):[],message:n,timestamp:(new Date).toISOString()};window.__bundleFallbacks__.push(r),window.__bundleFallbacks__.length>50&&window.__bundleFallbacks__.shift(),window.__lastBundleFallback__=r}function F(e,t){const n=("string"==typeof e?e.trim():"").replace(/\/+$/,""),r=String(t).replace(/^\/+/,"");return n?r?`${n}/${r}`:n||"/":`/${r}`}function I(e,t){const{data:n,meta:r}=s(e),a=Array.isArray(n)?n:[];return!Array.isArray(n)&&Array.isArray(r?.errors)&&r.errors.length&&console.warn("dataBundle devolvi칩 errores",r.errors),a.length&&a.forEach(e=>{const n=String(e.id),r={recipe:g({data:e?.recipe??null}),prices:A(e?.market??null)},a={...e,adapters:r};t.set(n,a),i(`bundle_${n}`,a),"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"function"==typeof CustomEvent&&window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:a}))}),a.length>0}async function E(e=[]){if(!Array.isArray(e)||0===e.length)return[];const t=new Map,r=[];if(e.forEach(e=>{const i=String(e),a=n(`bundle_${i}`);a?t.set(i,a):r.push(i)}),r.length>0){const{API_BASE_URL:e,FEATURE_ITEM_API_ROLLOUT:n}=l(),i=Boolean(n);for(let n=0;n<r.length;n+=35){const s=r.slice(n,n+35),l=s.map(e=>`ids[]=${e}`).join("&");let u=!1;if(i){const n=`${F(e,"/items/bundle")}?${l}`;try{const e=await a(n);if(!e.ok)throw new Error(`Respuesta ${e.status} inv치lida en bundle API`);const r=await e.json().catch(()=>null);if(!r)throw new Error("Payload JSON no v치lido en bundle API");I(r,t),u=!0}catch(e){u=!1,console.warn("Fallo en bundle API, usando PHP como fallback",e),h(s,e)}}if(!i||!u)try{const e=await a(`/backend/api/dataBundle.php?${l}`);if(e.ok){I(await e.json().catch(()=>null),t)}else console.error("Error en getItemBundles: respuesta no v치lida")}catch(e){console.error("Error en getItemBundles:",e)}s.forEach(e=>{const n=String(e);t.has(n)||t.set(n,null)})}}return e.map(e=>{const n=String(e);return t.get(n)||null})}async function S(e){const t=Array.isArray(e)?e:[e],n=await E(t);if(Array.isArray(e))return n.map(e=>e?.recipe?[e.recipe]:[]);const r=n[0]?.recipe;return r?[r]:[]}async function k(e){const t=`recipe_${e}`,a=n(t,!0);try{const{API_BASE_URL:n}=l(),s=await r(`${n}/recipes/${e}`,{},t,a);if(!s.ok)return null;const u=await s.json();if(!u)return null;u.lastUpdated=(new Date).toISOString();const o=s.headers.get("ETag"),c=s.headers.get("Last-Modified");return i(t,u,void 0,{etag:o,lastModified:c}),u}catch(e){return console.error("Error en getRecipeDetails:",e),null}}async function v(e){if(Array.isArray(e)){return(await E(e)).map(e=>e?.item||null)}const t=await E([e]);return t[0]?.item||null}async function P(n){if(Array.isArray(n)){const t=await e(n);return n.map(e=>{const n=t.get(e)||{};return{buys:{unit_price:n.buy_price||0},sells:{unit_price:n.sell_price||0}}})}const r=await t(n);return{buys:{unit_price:r?.buy_price||0},sells:{unit_price:r?.sell_price||0}}}const N={getItemBundles:E,getRecipesForItem:S,getRecipeDetails:k,getItemDetails:v,getItemPrices:P};function R(e=("undefined"!=typeof window?window:void 0)){if(!e)return N;const t={...e.RecipeService||{},...N};return e.RecipeService=t,Object.entries(N).forEach(([t,n])=>{"function"!=typeof e[t]&&(e[t]=n)}),t}"undefined"!=typeof window&&R(window);var $=Object.freeze({__proto__:null,getItemBundles:E,getItemDetails:v,getItemPrices:P,getRecipeDetails:k,getRecipesForItem:S,registerRecipeServiceGlobals:R});export{f as a,v as b,d as c,p as d,b as e,m as f,E as g,A as h,y as m,$ as r,_ as t};
