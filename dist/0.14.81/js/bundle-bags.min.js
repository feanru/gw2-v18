import{g as e,r as a}from"./utils.min.js";import{g as t,b as n}from"./services.min.js";import{formatGoldColored as i,getRarityClass as r}from"./bundle-utils-1.min.js";import"./config.min.js";const s=e=>({id:"default",name:"Receta estándar",manualIngredients:e}),o=(e,a,t)=>({id:e,name:a,manualIngredients:[{id:82888,name:"Talega de mariscal de 28 casillas",count:1,manualIngredients:[{id:84557,name:"Talega de mariscal de 24 casillas",count:1,manualIngredients:[{id:74525,name:"Caja de equipamiento de 20 casillas del Pacto",count:2,manualIngredients:t},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:82678,name:"Chispa marcada palpitante",count:1}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:82678,name:"Chispa marcada palpitante",count:1}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:82678,name:"Chispa marcada palpitante",count:1}]}),l=(e,a,t)=>({id:e,name:a,manualIngredients:[{id:83737,name:"Armario de mariscal de 28 casillas",count:1,manualIngredients:[{id:83218,name:"Armario de mariscal de 24 casillas",count:1,manualIngredients:[{id:74525,name:"Caja de equipamiento de 20 casillas del Pacto",count:2,manualIngredients:t},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:82582,name:"Triza de forjametal tembloroso",count:10}]}),c=(e,a,t)=>({id:e,name:a,manualIngredients:[{id:84544,name:"Alforja de mariscal de 28 casillas",count:1,manualIngredients:[{id:82237,name:"Alforja de mariscal de 24 casillas",count:1,manualIngredients:[{id:74525,name:"Caja de equipamiento de 20 casillas del Pacto",count:2,manualIngredients:t},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:83757,name:"Putrefacción coagulada",count:100}]}),d=[{id:83995,name:"Alforja de gasa de 32 casillas",variants:[s([{id:83436,name:"Alforja de gasa de 28 casillas",count:1,manualIngredients:[{id:84420,name:"Alforja de gasa de 24 casillas",count:1,manualIngredients:[{id:9571,name:"Saco de gasa de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19746,name:"Haz de gasa",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:83757,name:"Putrefacción coagulada",count:100}])]},{id:85370,name:"Talega de mensajero de 32 casillas",variants:[s([{id:83092,name:"Talega de mensajero de 28 casillas",count:1,manualIngredients:[{id:82901,name:"Talega de mensajero de 24 casillas",count:1,manualIngredients:[{id:9584,name:"Bolsa invisible de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19737,name:"Retal de cuero curado endurecido",count:22},{id:24277,name:"Montón de polvo cristalino",count:3}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:83757,name:"Putrefacción coagulada",count:100}])]},{id:85372,name:"Talega de mariscal de 32 casillas",variants:[o("pacto-lingotes-retales","Caja del Pacto: lingotes de oricalco + 12 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:19685,name:"Lingote de oricalco",count:10},{id:19737,name:"Retal de cuero curado endurecido",count:12}]),o("pacto-tela-polvo-retales","Caja del Pacto: haz de gasa + polvo cristalino + 12 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:19746,name:"Haz de gasa",count:10},{id:24277,name:"Montón de polvo cristalino",count:3},{id:19737,name:"Retal de cuero curado endurecido",count:12}]),o("pacto-polvo-retales","Caja del Pacto: polvo cristalino + 22 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:24277,name:"Montón de polvo cristalino",count:3},{id:19737,name:"Retal de cuero curado endurecido",count:22}])]},{id:83109,name:"Talega de hamaseen de 32 casillas",variants:[s([{id:84686,name:"Talega de hamaseen de 28 casillas",count:1,manualIngredients:[{id:83933,name:"Talega de hamaseen de 24 casillas",count:1,manualIngredients:[{id:9585,name:"Bolsa engrasada de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19737,name:"Retal de cuero curado endurecido",count:10},{id:24358,name:"Hueso antiguo",count:3}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:82678,name:"Chispa marcada palpitante",count:1}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:82678,name:"Chispa marcada palpitante",count:1}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:82678,name:"Chispa marcada palpitante",count:1}])]},{id:83182,name:"Talega de cuero endurecido de 32 casillas",variants:[s([{id:83897,name:"Talega de cuero endurecido de 28 casillas",count:1,manualIngredients:[{id:82511,name:"Talega de cuero endurecido de 24 casillas",count:1,manualIngredients:[{id:9581,name:"Bolsa de cuero endurecido de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19737,name:"Retal de cuero curado endurecido",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:82678,name:"Chispa marcada palpitante",count:1}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:82678,name:"Chispa marcada palpitante",count:1}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:82678,name:"Chispa marcada palpitante",count:1}])]},{id:85371,name:"Armario de oricalco de 32 casillas",variants:[s([{id:83021,name:"Armario de oricalco de 28 casillas",count:1,manualIngredients:[{id:83155,name:"Armario de oricalco de 24 casillas",count:1,manualIngredients:[{id:9591,name:"Caja de oricalco de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19685,name:"Lingote de oricalco",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:82582,name:"Triza de forjametal tembloroso",count:10}])]},{id:83286,name:"Armario de nómada de 32 casillas",variants:[s([{id:84037,name:"Armario de nómada de 28 casillas",count:1,manualIngredients:[{id:84515,name:"Armario de nómada de 24 casillas",count:1,manualIngredients:[{id:9593,name:"Caja de equipamiento de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19685,name:"Lingote de oricalco",count:10},{id:24289,name:"Escama blindada",count:3}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:82582,name:"Triza de forjametal tembloroso",count:10}])]},{id:82277,name:"Armario de mensajero de 32 casillas",variants:[s([{id:84271,name:"Armario de mensajero de 28 casillas",count:1,manualIngredients:[{id:83415,name:"Armario de mensajero de 24 casillas",count:1,manualIngredients:[{id:9594,name:"Caja fuerte de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19685,name:"Lingote de oricalco",count:10},{id:24277,name:"Montón de polvo cristalino",count:3}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:82582,name:"Triza de forjametal tembloroso",count:10}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:82582,name:"Triza de forjametal tembloroso",count:10}])]},{id:83205,name:"Armario de mariscal de 32 casillas",variants:[l("pacto-lingotes-retales","Caja del Pacto: lingotes de oricalco + 12 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:19685,name:"Lingote de oricalco",count:10},{id:19737,name:"Retal de cuero curado endurecido",count:12}]),l("pacto-tela-polvo-retales","Caja del Pacto: haz de gasa + polvo cristalino + 12 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:19746,name:"Haz de gasa",count:10},{id:24277,name:"Montón de polvo cristalino",count:3},{id:19737,name:"Retal de cuero curado endurecido",count:12}]),l("pacto-polvo-retales","Caja del Pacto: polvo cristalino + 22 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:24277,name:"Montón de polvo cristalino",count:3},{id:19737,name:"Retal de cuero curado endurecido",count:22}])]},{id:83186,name:"Armario de Liga Cauri de 32 casillas",variants:[s([{id:84163,name:"Armario de Liga Cauri de 28 casillas",count:1,manualIngredients:[{id:83887,name:"Armario de Liga Cauri de 24 casillas",count:1,manualIngredients:[{id:9572,name:"Saco de artesano de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19746,name:"Haz de gasa",count:10},{id:24358,name:"Hueso antiguo",count:3}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:83757,name:"Putrefacción coagulada",count:100}])]},{id:83435,name:"Alforja de mensajero de 32 casillas",variants:[s([{id:83130,name:"Alforja de mensajero de 28 casillas",count:1,manualIngredients:[{id:83297,name:"Alforja de mensajero de 24 casillas",count:1,manualIngredients:[{id:9574,name:"Saco invisible de 20 casillas",count:2,manualIngredients:[{id:13009,name:"Runa superior de sujeción",count:1},{id:19746,name:"Haz de gasa",count:10},{id:24277,name:"Montón de polvo cristalino",count:3}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:1},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:5},{id:83757,name:"Putrefacción coagulada",count:100}]},{id:83322,name:"Carrete de hilo de Deldrimor",count:4},{id:83410,name:"Runa suprema de sujeción",count:12},{id:83757,name:"Putrefacción coagulada",count:100}])]},{id:83435,name:"Alforja de mariscal de 32 casillas",variants:[c("pacto-lingotes-retales","Caja del Pacto: lingotes de oricalco + 12 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:19685,name:"Lingote de oricalco",count:10},{id:19737,name:"Retal de cuero curado endurecido",count:12}]),c("pacto-tela-polvo-retales","Caja del Pacto: haz de gasa + polvo cristalino + 12 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:19746,name:"Haz de gasa",count:10},{id:24277,name:"Montón de polvo cristalino",count:3},{id:19737,name:"Retal de cuero curado endurecido",count:12}]),c("pacto-polvo-retales","Caja del Pacto: polvo cristalino + 22 retales",[{id:13009,name:"Runa superior de sujeción",count:1},{id:24277,name:"Montón de polvo cristalino",count:3},{id:19737,name:"Retal de cuero curado endurecido",count:22}])]}],u="https://render.guildwars2.com/file/0120CB0368B7953F0D3BD2A0C9100BCF0839FF4D/219035.png";class m{constructor(e,a,t,n=null,i=1,r=null){this.id=e,this.name=a,this.type=t||"material",this.rarity=n,this.count=i||1,this.parent=r||null,this.components=[],this.icon=null,this._buyPrice=0,this._sellPrice=0,this._priceLoaded=!1,this.total_buy=0,this.total_sell=0}addComponent(e){e&&(this.components.push(e),e.parent=this)}get buyPrice(){return this._buyPrice||0}get sellPrice(){return this._sellPrice||0}setPrices(e=0,a=0){const t=Number.isFinite(e)?e:0,n=Number.isFinite(a)?a:0;this._buyPrice=t,this._sellPrice=n,(t>0||n>0)&&(this._priceLoaded=!0)}isPriceLoaded(){return this._priceLoaded}getTotalBuyPrice(){return this.buyPrice*(this.count||1)}getTotalSellPrice(){return this.sellPrice*(this.count||1)}calculateTotals(e=1){const a=e*(this.count||1);if(!Array.isArray(this.components)||0===this.components.length){const e=this.buyPrice*a,t=this.sellPrice*a;return this.total_buy=e,this.total_sell=t,{buy:e,sell:t,isCraftable:this.isPriceLoaded()}}let t=0,n=0,i=!0;for(const e of this.components){const r=e.calculateTotals(a);t+=r.buy,n+=r.sell,r.buy<=0&&r.sell<=0&&(i=!1)}if(i&&t>0&&!this._priceLoaded){const e=t/a,i=n/a;this._buyPrice=e,this._sellPrice=i,this._priceLoaded=!0}const r=this.buyPrice*a,s=this.sellPrice*a;return this.total_buy=r,this.total_sell=s,{buy:r,sell:s,isCraftable:i}}}function h(e){if(!e)return null;if(e.startsWith("http"))return e;const a=e.startsWith("file/")?e.slice(5):e;return`https://render.guildwars2.com/file/${a.startsWith("/")?a.slice(1):a}`}function p(e){return{id:e.id,qty:e.count,buy_price:e.buyPrice>0?e.buyPrice:null,sell_price:e.sellPrice>0?e.sellPrice:null,is_craftable:Array.isArray(e.components)&&e.components.length>0,children:Array.isArray(e.components)?e.components.map(p):[]}}function g(e){e&&(e.count=e.qty,delete e.qty,Array.isArray(e.children)&&e.children.forEach(g))}function y(e,a){if(e&&a&&(a.total_buy=e.total_buy,a.total_sell=e.total_sell,a.total_crafted=e.total_crafted,a.crafted_price=e.crafted_price,Array.isArray(e.children)&&Array.isArray(a.components)))for(let t=0;t<e.children.length&&t<a.components.length;t+=1)y(e.children[t],a.components[t])}class f{constructor({bags:e}){this.bags=Array.isArray(e)?e:[],this.bagsById=new Map(this.bags.map(e=>[String(e.id),e])),this.craftingTreeEl=document.getElementById("craftingTree"),this.skeletonEl=document.getElementById("craftingTreeSkeleton"),this.summaryEl=document.getElementById("summary"),this.summaryBuyEl=document.getElementById("summaryBuyPrice"),this.summarySellEl=document.getElementById("summarySellPrice"),this.buttons=Array.from(document.querySelectorAll(".bag-nav-button")),this.variantContainer=document.getElementById("bagVariantControls"),this.variantSelect=this.variantContainer?.querySelector("select")||null,this.bundleCache=new Map,this.itemDetailsCache=new Map,this.priceCache=new Map,this.workerTotals={totalBuy:0,totalSell:0,totalCrafted:0},this.currentTree=null,this.currentBag=null,this.currentVariantId=null,this.activeButton=null,this.currentRequestId=0,this.variantSelect&&this.variantSelect.addEventListener("change",e=>this.handleVariantChange(e))}init(){this.craftingTreeEl&&(this.registerButtons(),this.buttons.forEach(e=>e.classList.remove("active")),this.activeButton=null,this.showPlaceholderMessage())}registerButtons(){this.buttons.forEach(e=>{e.addEventListener("click",()=>{this.setActiveButton(e);const a=e.getAttribute("data-item-id");a&&this.loadBagById(a)})})}setActiveButton(e){this.buttons.forEach(e=>e.classList.remove("active")),e?(e.classList.add("active"),this.activeButton=e):this.activeButton=null}findBagById(e){if(!e)return null;const a=String(e);return this.bagsById.get(a)||null}findVariant(e,a){const t=Array.isArray(e?.variants)?e.variants:[];if(0===t.length)return{id:"default",name:"Receta estándar",manualIngredients:[]};if(null!=a){const e=t.find(e=>String(e.id)===String(a));if(e)return e}return t[0]}async loadBagById(e,a=null){const t=++this.currentRequestId,n=this.findBagById(e);if(!n)return void this.showError("No se encontró información de esta alforja.");this.currentBag=n,this.resetSummary(),this.setLoading(!0),this.clearTree(),this.clearMessage();const i=this.findVariant(n,a);this.currentVariantId=i.id,this.updateVariantSelector(n,String(i.id));const r={id:n.id,name:n.name,count:1,manualIngredients:Array.isArray(i.manualIngredients)?i.manualIngredients:[]};try{if(await this.preloadManualData(r),this.currentRequestId!==t)return;const e=await this.createIngredientTree(r);if(this.currentRequestId!==t)return;if(this.currentTree=e,await this.updateTotals(),this.currentRequestId!==t)return;await this.renderTree(),this.renderSummary(),this.summaryEl&&(this.summaryEl.classList.remove("hidden"),this.summaryEl.style.display="block")}catch(e){console.error("[BagCraftingApp] Error al cargar el árbol de ingredientes",e),this.currentRequestId===t&&this.showError("No se pudo cargar el detalle de crafteo. Intenta de nuevo más tarde.")}finally{this.currentRequestId===t&&this.setLoading(!1)}}async createIngredientTree(e,a=null){if(!e||!e.id)return null;const t=Number(e.count)||1,n=String(e.id),i=this.bundleCache.get(n)||null;let r=this.itemDetailsCache.get(n)||null;if(!r&&i?.item){const e={...i.item};e.icon&&(e.icon=h(e.icon)),r=e,this.itemDetailsCache.set(n,r)}r||(r=await this.fetchItemDetails(e.id));const s=e.name||r?.name||`Item ${e.id}`,o=new m(e.id,s,r?.type||e.type||null,r?.rarity||null,t,a);r?.icon&&(o.icon=r.icon);let l=this.priceCache.has(n)?this.priceCache.get(n):null;if(!l){const e=this.normalizeMarketData(i?.market);e&&(l=e,this.priceCache.set(n,l))}if(l||(l=await this.fetchItemPrice(e.id)),l){const e=Number.isFinite(l.buy_price)?l.buy_price:l.buys?.unit_price,a=Number.isFinite(l.sell_price)?l.sell_price:l.sells?.unit_price;o.setPrices(e,a)}const c=Array.isArray(e.manualIngredients)?e.manualIngredients:[];if(c.length>0){(await Promise.all(c.map(e=>this.createIngredientTree(e,o)))).filter(Boolean).forEach(e=>o.addComponent(e))}return o}normalizeMarketData(e){if(!e||"object"!=typeof e)return null;const a=e=>{const a=Number(e);return Number.isFinite(a)?a:null},t=[e.buy_price,e.buyPrice,e?.buys?.unit_price],n=[e.sell_price,e.sellPrice,e?.sells?.unit_price],i=t.map(a).find(e=>null!=e),r=n.map(a).find(e=>null!=e);return null==i&&null==r?null:{buy_price:i??null,sell_price:r??null}}collectManualIds(e,a=new Set){if(!e||"object"!=typeof e)return a;if(null!=e.id){const t=Number(e.id);Number.isFinite(t)&&a.add(t)}(Array.isArray(e.manualIngredients)?e.manualIngredients:[]).forEach(e=>this.collectManualIds(e,a));return(Array.isArray(e.variants)?e.variants:[]).forEach(e=>{if(!e||"object"!=typeof e)return;if(null!=e.id){const t=Number(e.id);Number.isFinite(t)&&a.add(t)}(Array.isArray(e.manualIngredients)?e.manualIngredients:[]).forEach(e=>this.collectManualIds(e,a))}),a}async preloadManualData(e){const a=Array.from(this.collectManualIds(e));if(a.length)try{const e=await t(a);if(!Array.isArray(e))return;e.forEach((e,t)=>{const n=a[t];this.storeBundleInCaches(n,e)})}catch(e){console.warn("[BagCraftingApp] No se pudieron precargar los datos de recetas",e)}}storeBundleInCaches(e,a){const t=String(e);this.bundleCache.set(t,a||null);const n=a?.item||null;if(n){const e={...n};e.icon&&(e.icon=h(e.icon)),this.itemDetailsCache.set(t,e)}const i=this.normalizeMarketData(a?.market);i&&this.priceCache.set(t,i)}async fetchItemDetails(e){const a=String(e);if(this.itemDetailsCache.has(a))return this.itemDetailsCache.get(a);const t=this.bundleCache.get(a);if(t?.item){const e={...t.item};return e.icon&&(e.icon=h(e.icon)),this.itemDetailsCache.set(a,e),e}try{const t=await n(e);return t&&t.icon&&(t.icon=h(t.icon)),this.itemDetailsCache.set(a,t||null),t||null}catch(t){return console.warn(`[BagCraftingApp] No se pudo obtener detalles para el ítem ${e}`,t),this.itemDetailsCache.set(a,null),null}}async fetchItemPrice(a){const t=String(a);if(this.priceCache.has(t))return this.priceCache.get(t);const n=this.bundleCache.get(t),i=this.normalizeMarketData(n?.market);if(i)return this.priceCache.set(t,i),i;try{const n=await e(a);return this.priceCache.set(t,n||null),n||null}catch(e){return console.warn(`[BagCraftingApp] No se pudo obtener precio de mercado para el ítem ${a}`,e),this.priceCache.set(t,null),null}}async updateTotals(){if(!this.currentTree)return this.workerTotals={totalBuy:0,totalSell:0,totalCrafted:0},this.workerTotals;try{const e=[p(this.currentTree)];e.forEach(g);const{updatedTree:t,totals:n}=await async function(e,t=1){return await a({ingredientTree:e,globalQty:t})||{updatedTree:null,totals:null}}(e,1);return Array.isArray(t)&&t[0]&&y(t[0],this.currentTree),this.workerTotals=n||{totalBuy:0,totalSell:0,totalCrafted:0},this.workerTotals}catch(e){console.warn("[BagCraftingApp] Worker de costos no disponible, usando cálculo local",e);const a=this.currentTree.calculateTotals();return this.workerTotals={totalBuy:a.buy||0,totalSell:a.sell||0,totalCrafted:a.buy||0},this.workerTotals}}async renderTree(){this.craftingTreeEl&&(this.craftingTreeEl.innerHTML="",this.currentTree&&await this.renderIngredient(this.currentTree,this.craftingTreeEl,0))}async renderIngredient(e,a,t=0){if(!e)return;const n=Array.isArray(e.components)&&e.components.length>0,s=t<2,o=document.createElement("div");o.className="item-wrapper-treeleg";const l=Number.isFinite(e.total_buy)&&e.total_buy>0?e.total_buy:e.getTotalBuyPrice(),c=Number.isFinite(e.total_sell)&&e.total_sell>0?e.total_sell:e.getTotalSellPrice(),d=l>0,m=c>0,h=d||m,p=h?`<div class="price-row"><span class="price-label">Compra:</span><span class="price-amount">${d?i(l):"N/A"}</span></div>\n         <div class="price-row"><span class="price-label">Venta:</span><span class="price-amount">${m?i(c):"N/A"}</span></div>`:'<div class="price-row"><span class="price-label">Precio:</span><span class="price-amount">N/A</span></div>',g=this.getIconUrl(e),y="function"==typeof r?r(e.rarity):"";if(o.innerHTML=`\n      <div class="item-card-treeleg">\n        ${n?`<button class="toggle-children" data-expanded="${s}">${s?"−":"+"}</button>`:'<div style="width: 24px;"></div>'}\n        <img class="item-icon" src="${g}" alt="${e.name||"Item"}" onerror="this.onerror=null;this.src='${u}';">\n        <div class="item-name ${y}">\n          ${e.name||"Item"}\n        </div>\n        <div class="item-details">\n          ${e.count>1?`<span class="item-count">x${Math.round(e.count)}</span>`:""}\n          <div class="item-price-container ${h?"has-price":"no-price"}">\n            ${p}\n          </div>\n        </div>\n      </div>`,a.appendChild(o),n){const n=o.querySelector(".toggle-children"),i=document.createElement("div");i.className="sub-items",i.style.display=s?"block":"none",a.appendChild(i),n&&n.addEventListener("click",e=>{e.stopPropagation();"true"===n.getAttribute("data-expanded")?(i.style.display="none",n.textContent="+",n.setAttribute("data-expanded","false")):(i.style.display="block",n.textContent="−",n.setAttribute("data-expanded","true"))});for(const a of e.components)await this.renderIngredient(a,i,t+1)}}getIconUrl(e){return e&&e.icon?e.icon:u}renderSummary(){if(!(this.summaryEl&&this.summaryBuyEl&&this.summarySellEl&&this.currentTree))return;const e=Number.isFinite(this.workerTotals.totalBuy)&&this.workerTotals.totalBuy>0?this.workerTotals.totalBuy:this.currentTree.getTotalBuyPrice(),a=Number.isFinite(this.workerTotals.totalSell)&&this.workerTotals.totalSell>0?this.workerTotals.totalSell:this.currentTree.getTotalSellPrice();this.summaryBuyEl.innerHTML=e>0?i(e):"N/A",this.summarySellEl.innerHTML=a>0?i(a):"N/A"}resetSummary(){this.summaryBuyEl&&(this.summaryBuyEl.textContent="-"),this.summarySellEl&&(this.summarySellEl.textContent="-")}clearTree(){this.craftingTreeEl&&(this.craftingTreeEl.innerHTML="")}setLoading(e){this.skeletonEl&&this.skeletonEl.classList.toggle("hidden",!e),this.summaryEl&&e&&(this.summaryEl.style.display="none")}showPlaceholderMessage(){this.showMessage("Selecciona una alforja para ver los detalles de crafteo.")}showMessage(e,{type:a="info",hideSummary:t=!0}={}){if(!this.craftingTreeEl)return;const n="error"===a?" error":"";this.craftingTreeEl.innerHTML=`<div class="message${n}">${e}</div>`,t&&this.summaryEl&&(this.summaryEl.style.display="none")}showError(e){this.showMessage(e,{type:"error"})}clearMessage(){this.craftingTreeEl&&(this.craftingTreeEl.innerHTML="")}updateVariantSelector(e,a){if(!this.variantContainer||!this.variantSelect)return;const t=Array.isArray(e?.variants)?e.variants:[];if(t.length<=1)return this.variantContainer.classList.add("hidden"),void(this.variantSelect.innerHTML="");this.variantSelect.innerHTML="",t.forEach(e=>{const a=document.createElement("option");a.value=String(e.id),a.textContent=e.name||"Variante",this.variantSelect.appendChild(a)});const n=Array.from(this.variantSelect.options).find(e=>e.value===String(a));n?this.variantSelect.value=n.value:this.variantSelect.options.length>0&&(this.variantSelect.selectedIndex=0,this.currentVariantId=this.variantSelect.value),this.variantContainer.classList.remove("hidden")}handleVariantChange(e){if(!this.currentBag)return;const a=e?.target;if(!a)return;const t=a.value;t&&String(t)!==String(this.currentVariantId)&&(this.currentVariantId=t,this.loadBagById(this.currentBag.id,t))}}document.addEventListener("DOMContentLoaded",()=>{const e=new f({bags:d});e.init(),"undefined"!=typeof window&&(window.bagCraftingApp=e)});export{m as Ingredient};
