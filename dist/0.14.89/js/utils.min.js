import{g as e}from"./config.min.js";import{g as t,p as r,t as n,a}from"./services.min.js";const o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:null,i="__GW2_FETCH_GUARD_INSTALLED__";if(o&&"function"==typeof o.fetch&&!o[i]){const zt=o.fetch;let Kt=s(o)||"http://localhost";const Vt=()=>{const t=s(o);t&&Kt!==t&&(Kt=t);const r=function(){try{return e()}catch{return null}}(),n=function(e){if("string"!=typeof e)return"off";const t=e.trim().toLowerCase();if(!t)return"off";const r=t.replace(/[_\s]+/g,"-");if(["off","disabled","disable","none","0","false"].includes(r))return"off";if(["enforce","block","blocked","deny","enforced","strict","on","true"].includes(r))return"enforce";if(["report-only","report","monitor","monitoring","warn","warning"].includes(r))return"report-only";return"off"}(r?.FETCH_GUARD_MODE),a=function(e){if("string"!=typeof e)return null;const t=e.trim();return t||null}(r?.FETCH_GUARD_REPORT_URL),i=function(e,t){const r=new Set,n=e=>{e&&(Array.isArray(e)?e.forEach(n):r.add(e))},a=e=>{if(e||0===e)if(Array.isArray(e))e.forEach(a);else if("string"!=typeof e)try{const r=c(String(e),t);n(r)}catch{}else e.split(",").forEach(e=>{const r=c(e.trim(),t);n(r)})},o=[e?.API_BASE_URL,e?.MARKET_CSV_URL,"/api","api","/backend/api","backend/api","/recipe-tree","https://api.guildwars2.com","https://api.datawars2.ie"],i=e?.FETCH_GUARD_WHITELIST,s=function(e){if(Array.isArray(e))return e.length>0;if(null==e)return!1;if("string"==typeof e)return e.split(",").some(e=>e.trim());return!0}(i);a(o),a(i),a(e?.fetchGuardWhitelist),a(e?.fetchWhitelist),a(e?.FETCH_WHITELIST),s||a(e?.CONNECT_ALLOWLIST);return Array.from(r)}(r,t);return{mode:n,reportUrl:a,whitelist:i,locationOrigin:t}},Yt=(e,t,r)=>{if("off"===r.mode)return;const n=`[fetchGuard] ${e}: ${t}`;try{"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(n)}catch{}if(!r.reportUrl)return;let a;try{a=JSON.stringify({source:"fetchGuard",reason:e,targetUrl:t,mode:r.mode,timestamp:Date.now(),locationOrigin:r.locationOrigin})}catch{a=null}if(a){try{if("function"==typeof o.navigator?.sendBeacon)return void o.navigator.sendBeacon(r.reportUrl,a)}catch{}try{if("function"==typeof o.Image){const e=encodeURIComponent(a),t=function(e,t,r){if(!e)return null;try{const n=new URL(e,r);return n.searchParams.append("payload",t),n.href}catch{try{const r=e.includes("?")?"&":"?";return`${e}${r}payload=${t}`}catch{return null}}}(r.reportUrl,e,Kt);if(!t)return;const n=new o.Image;try{"referrerPolicy"in n&&(n.referrerPolicy="no-referrer")}catch{}const i=function(e){const t="__FETCH_GUARD_REPORT_IMAGES__";if(!e[t])try{Object.defineProperty(e,t,{value:new Set,configurable:!0,enumerable:!1,writable:!1})}catch{e[t]=new Set}return e[t]}(o);i.add(n);const s=()=>i.delete(n);try{n.onload=s,n.onerror=s}catch{}n.src=t}}catch{}}},Xt=function(e,t){const r=Vt(),n=function(e,t){if(!e&&""!==e)return null;const r=e=>{try{return new URL(e,t)}catch{return null}};if("undefined"!=typeof URL)try{if(e instanceof URL)return e}catch{}if("undefined"!=typeof Request)try{if(e instanceof Request)return r(e.url)}catch{}if("string"==typeof e)return r(e);if(e&&"string"==typeof e.url)return r(e.url);return null}(e,Kt);if(!n||"off"===r.mode||function(e,t){if(!e)return!1;const r="string"==typeof e.hostname?e.hostname.toLowerCase():"",n="string"==typeof e.origin?e.origin:"";let a="";if(n&&"null"!==n)try{a=new URL(n).hostname.toLowerCase()}catch{const e=n.toLowerCase(),t=e.indexOf("://");a=t>=0?e.slice(t+3):e}for(const n of t)switch(n.type){case"wildcard":return!0;case"origin":if(e.origin===n.value)return!0;break;case"href":if(e.href.startsWith(n.value))return!0;break;case"hostname":if(r===n.value)return!0;if(a&&a===n.value)return!0;break;case"hostname-pattern":if(u(r,n.value))return!0;if(u(a,n.value))return!0;break;case"pathname":if(e.pathname.startsWith(n.value))return!0}return!1}(n,r.whitelist))return zt.call(this,e,t);let a;var o;o=n,a=o?.pathname.includes("/backend/")?"Legacy backend fetch detected":function(e,t){return!!e&&(!!t&&("null"!==e.origin&&e.origin!==t))}(n,r.locationOrigin)?"External fetch detected":"Blocked fetch detected";const i=function(e,t){if(e?.href)return e.href;if("string"==typeof t)return t;if(t&&"string"==typeof t.url)return t.url;return"unknown target"}(n,e);return Yt(a,i,r),"enforce"===r.mode?Promise.reject(function(e,t){const r=new Error(`[fetchGuard] ${e}: ${t}`);return r.name="FetchGuardError",r.reason=e,r.url=t,r}(a,i)):zt.call(this,e,t)};Xt.originalFetch=zt,o.fetch=Xt,o[i]=!0}function s(e){if(!e||"object"!=typeof e)return;const t=e.location&&"object"==typeof e.location?e.location:null,r=l(t?.origin);if(r)return r;const n=l(e.origin),a=function(e,t){if("string"!=typeof e)return null;const r=e.trim();if(!r)return null;try{return l(new URL(r).origin)}catch{if(!t)return null;try{return l(new URL(r,t).origin)}catch{return null}}}(t?.href,n);return a||(n||void 0)}function l(e){if("string"!=typeof e)return null;const t=e.trim();return t&&"null"!==t.toLowerCase()?t:null}function c(e,t){if(!e)return null;const r=e.trim();if(!r)return null;const n=r.replace(/^['"]|['"]$/g,"");if(!n)return null;const a=n.toLowerCase();if("self"===a){const e=l(t);return e?{type:"origin",value:e}:{type:"pathname",value:"/recipe-tree"}}if("*"===a)return{type:"wildcard"};if(/^\*\.[^*]+/.test(n)){const e=n.slice(2).toLowerCase();return e?{type:"hostname-pattern",value:e}:null}if(n.startsWith("//"))try{return{type:"origin",value:new URL(n,t||"http:").origin}}catch{return null}if(/^[a-zA-Z]+:\/\//.test(n))try{const e=new URL(n);return n.endsWith("/"),{type:"href",value:e.href}}catch{return null}if(n.startsWith("/"))return{type:"pathname",value:n};if(n.includes("://"))try{return{type:"href",value:new URL(n).href}}catch{return null}return n.includes(".")?{type:"hostname",value:n.toLowerCase()}:{type:"pathname",value:n.startsWith("/")?n:`/${n}`}}function u(e,t){if(!e||!t)return!1;const r=e.toLowerCase(),n=t.toLowerCase().replace(/^\.+/,"");return!!n&&(r===n||r.endsWith(`.${n}`))}const f=[];function d(){const e=Date.now()-6e4;for(;f.length&&f[0]<e;)f.shift()}function p(){d();const e=f.length;return e>5?"down":e>0?"slow":"ok"}let g;function h(){if("undefined"==typeof document)return;const e=p();g||(g=document.createElement("div"),g.id="api-status-indicator",g.style.position="fixed",g.style.bottom="10px",g.style.right="10px",g.style.padding="4px 8px",g.style.background="rgba(0,0,0,0.7)",g.style.color="#fff",g.style.borderRadius="4px",g.style.zIndex="10000",g.style.display="none",document.body.appendChild(g)),"ok"===e?g.style.display="none":(g.textContent="slow"===e?"API lenta":"API caída",g.style.display="block")}var m={recordFailure:function(){f.push(Date.now()),d(),h()},recordSuccess:function(){d(),h()},getState:p,getBackoff:function(){const e=p();return"down"===e?5e3:"slow"===e?1e3:0}};async function y(e,t={}){const{timeout:r=8e3,retries:n=3,backoff:a=300,signal:o,...i}=t;for(let t=0;t<=n;t++){const s=new AbortController,l=setTimeout(()=>s.abort(),r);o&&(o.aborted?s.abort():o.addEventListener("abort",()=>s.abort(),{once:!0}));try{const t=await fetch(e,{...i,signal:s.signal});return clearTimeout(l),m.recordSuccess(),t}catch(e){if(clearTimeout(l),m.recordFailure(),o?.aborted||t===n)throw e;const r=a*Math.pow(2,t);await new Promise(e=>setTimeout(e,r))}}}const b=Object.prototype.hasOwnProperty;function _(e){return null==e?[]:Array.isArray(e)?e:[e]}function w(e,t){const r=e&&"object"==typeof e&&!Array.isArray(e)?{...e}:{errors:[]};Array.isArray(r.errors)||(r.errors=_(r.errors));const n=function(e,t){if(e&&"string"==typeof e.traceId&&e.traceId)return e.traceId;if(t&&"object"==typeof t&&!Array.isArray(t)){if("string"==typeof t.traceId&&t.traceId)return t.traceId;const e=t.meta&&"object"==typeof t.meta?t.meta.traceId:null;if("string"==typeof e&&e)return e}return null}(r,t);return n?r.traceId=n:b.call(r,"traceId")||(r.traceId=null),r}function S(e,t,r){return{data:e,meta:w(t,r)}}function A(e){if(null==e)return S(null,{errors:[]},e);if("object"!=typeof e||e instanceof Response)return S(e,{errors:[]},e);if(Array.isArray(e))return S(e,{errors:[]},e);if(b.call(e,"data")){const t=b.call(e,"meta")&&"object"==typeof e.meta?{...e.meta,errors:_(e.meta?.errors)}:{errors:[]};return S(e.data,t,e)}if(b.call(e,"meta")){return S(null,"object"==typeof e.meta?{...e.meta,errors:_(e.meta?.errors)}:{errors:[]},e)}const{errors:t,...r}=e;return S(r,{errors:_(t)},e)}var E=Object.freeze({__proto__:null,normalizeApiResponse:A,unwrapApiResponse:function(e){const{data:t}=A(e);return t}});function v(e){const t=Number(e);return Number.isFinite(t)?t:e}async function T(e=[],t={}){if(!Array.isArray(e)||0===e.length)return{priceMap:new Map,iconMap:new Map,rarityMap:new Map,meta:null};const r=new URLSearchParams({ids:e.join(","),lang:"es"}),n=await y(`/api/aggregate/bundle?${r.toString()}`);if(!n.ok)throw new Error(`Error ${n.status} al consultar el agregado de bundle`);if(!(n.headers.get("content-type")||"").includes("application/json"))throw new Error("Respuesta no válida del agregado de bundle");const a=await n.json().catch(()=>null);if(!a||"object"!=typeof a)throw new Error("Datos no válidos del agregado de bundle");const o=new Map,i=new Map,s=new Map;a.priceMap&&"object"==typeof a.priceMap&&Object.entries(a.priceMap).forEach(([e,t])=>{if(t&&"object"==typeof t){const r=v(e);o.set(r,t)}}),a.iconMap&&"object"==typeof a.iconMap&&Object.entries(a.iconMap).forEach(([e,r])=>{if(r){const n=v(e);i.set(n,r),t.iconCache&&"object"==typeof t.iconCache&&(t.iconCache[n]=r)}}),a.rarityMap&&"object"==typeof a.rarityMap&&Object.entries(a.rarityMap).forEach(([e,r])=>{if(r){const n=v(e);s.set(n,r),t.rarityCache&&"object"==typeof t.rarityCache&&(t.rarityCache[n]=r)}});const l=e.map(v),c=Array.isArray(a.errors)?a.errors.length>0:Boolean(a.errors),u=l.filter(e=>!o.has(e)||!i.has(e)||!s.has(e));if(c||u.length>0)throw new Error("Datos incompletos del agregado de bundle");return{priceMap:o,iconMap:i,rarityMap:s,meta:a.meta||null}}const M={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},k="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let I=null;function N(e){k&&k.postMessage({type:"delete",key:e})}const C=new Map;!function(e){I=e,k&&k.addEventListener("message",({data:e})=>{const{type:t,key:r,entry:n}=e||{};if("request-bundles"!==t)t&&r&&("set"===t&&n?I.set(r,n):"delete"===t&&I.delete(r));else{if(!I)return;I.forEach((e,t)=>{t.startsWith("bundle_")&&k.postMessage({type:"set",key:t,entry:e})})}})}(C),k&&k.postMessage({type:"request-bundles"});const L="undefined"!=typeof localStorage,R=new Map;function O(e){try{return JSON.parse(e)}catch{return null}}function U(e,t){if(L)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:r,lastModified:n,lang:a,source:o,fallback:i}){return JSON.stringify({value:e,expiresAt:t,etag:r,lastModified:n,lang:a,source:o,fallback:i})}(t))}catch{}}function j(e,t,r=void 0,n={}){if(void 0===r){const t=e.split("_")[0];r=M[t]}const a=null==r?null:Date.now()+r,{etag:o=null,lastModified:i=null,lang:s=null,source:l=null,fallback:c=null}=n,u={value:t,expiresAt:a,updatedAt:(new Date).toISOString(),etag:o,lastModified:i,lang:s,source:l,fallback:c};C.set(e,u),U(e,{value:t,expiresAt:a,etag:o,lastModified:i,lang:s,source:l,fallback:c}),function(e,t){k&&k.postMessage({type:"set",key:e,entry:t})}(e,u)}function $(e,t=!1){let r=C.get(e);if(!r){const t=function(e){if(!L)return null;const t=localStorage.getItem(e);if(!t)return null;const r=O(t);return r||(localStorage.removeItem(e),null)}(e);if(t){const{value:n,expiresAt:a=null,etag:o=null,lastModified:i=null,lang:s=null,source:l=null,fallback:c=null}=t;r={value:n,expiresAt:a,updatedAt:(new Date).toISOString(),etag:o,lastModified:i,lang:s,source:l,fallback:c},C.set(e,r)}}return r?r.expiresAt&&Date.now()>r.expiresAt?(C.delete(e),L&&localStorage.removeItem(e),N(e),null):t?r:r.value:null}function P(e,t={}){const r=function(e,{method:t="GET",headers:r={}}={}){return`${e}|${t.toUpperCase()}|${JSON.stringify(r)}`}(e,t),n=R.get(r)||y(e,t).finally(()=>R.delete(r));return R.set(r,n),n.then(e=>e.clone())}!function(){if(!L)return;const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t),n=O(localStorage.getItem(r));if(!n)continue;const{expiresAt:a}=n;a&&Date.now()>a&&e.push(r)}e.forEach(e=>{localStorage.removeItem(e),N(e)})}();const D=new Map;function F(){return"sessionStorage"===function(){const t=e();return t?.priceCacheStrategy||"sessionStorage"}()}function x(e){return`price_${e}`}function B(e){if(!F()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(x(e));if(!t)return null;try{const{value:r,expires:n}=JSON.parse(t);return n&&Date.now()>n?(sessionStorage.removeItem(x(e)),null):r}catch{return sessionStorage.removeItem(x(e)),null}}async function W(t){if(!Array.isArray(t)||0===t.length)return new Map;const r=e();if("redis"===(r?.priceCacheStrategy||"sessionStorage")){const e=`/backend/api/itemBundle.php?ids=${t.join(",")}`,r=await fetch(e);if(!r.ok)throw new Error("Price fetch failed");const n=await r.json().catch(()=>null),{data:a,meta:o}=A(n),i=Array.isArray(a)?a:[];!Array.isArray(a)&&Array.isArray(o?.errors)&&o.errors.length&&console.warn("itemBundle precios devolvió errores",o.errors);const s=new Map;return i.forEach(e=>{const t=e.market||{};s.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),s}{const e=["id","buy_price","sell_price"].join(","),n=Boolean(r?.FEATURE_MARKET_CSV_EXTERNAL)?r?.MARKET_CSV_URL||"https://api.datawars2.ie/gw2/v1/items/csv":function(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,""),n=String(t).replace(/^\/+/,"");return r?n?`${r}/${n}`:r||"/":n?`/${n}`:"/"}(r?.API_BASE_URL||"/api","/market.csv"),a=new URLSearchParams;a.set("fields",e),a.set("ids",t.join(","));const o=`${n}?${a.toString()}`,i=await fetch(o);if(!i.ok)throw new Error("Price fetch failed");const s=(await i.text()).trim().split("\n"),l=s[0].split(","),c=new Map;for(let e=1;e<s.length;e++){if(!s[e])continue;const t=s[e].split(","),r={};l.forEach((e,n)=>{const a=t[n];r[e]=void 0!==a?isNaN(a)?a:Number(a):null}),null!=r.id&&c.set(r.id,{buy_price:r.buy_price||0,sell_price:r.sell_price||0})}return c}}async function G(e=[]){const t=new Map,r=[];if(e.forEach(e=>{if(e=Number(e),D.has(e))return void t.set(e,D.get(e));const n=B(e);n?(D.set(e,n),t.set(e,n)):r.push(e)}),r.length)try{(await W(r)).forEach((e,r)=>{D.set(r,e),function(e,t){if(F()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(x(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(r,e),t.set(r,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!t.has(e)&&D.has(e)&&t.set(e,D.get(e)),t.has(e)||t.set(e,{buy_price:0,sell_price:0})}),t}async function H(e){if(e=Number(e),D.has(e))return D.get(e);const t=B(e);if(t)return D.set(e,t),t;return(await G([e])).get(e)}function q(){if(D.clear(),F()&&"undefined"!=typeof sessionStorage)for(let e=sessionStorage.length-1;e>=0;e--){const t=sessionStorage.key(e);t&&t.startsWith("price_")&&sessionStorage.removeItem(t)}}var Q=Object.freeze({__proto__:null,clearCache:q,getPrice:H,preloadPrices:G});const J=new Map;function z(e){return J.get(e)?.promise}function K(e,t,r){return J.set(e,{promise:t,controller:r}),t.finally(()=>J.delete(e)),t}function V(e){const t=J.get(e);t?.controller&&t.controller.abort()}function Y(e,t={},r=null,n=null,a){const o=J.get(e);o&&o.controller?.abort(),r&&!n&&(n=$(r,!0));const i={...t.headers||{}};n?.etag&&(i["If-None-Match"]=n.etag),n?.lastModified&&(i["If-Modified-Since"]=n.lastModified);const s=a?null:new AbortController,l=a??t.signal??s?.signal;return K(e,y(e,{...t,headers:i,signal:l}).then(async e=>304===e.status&&n?new Response(JSON.stringify(n.value),{status:200,headers:{"X-Cache":"HIT",ETag:n.etag||"","Last-Modified":n.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),s).then(e=>e.clone())}var X={fetchWithCache:Y,getRequest:z,setRequest:(e,t)=>K(e,t,null),abortRequest:V},Z=Object.freeze({__proto__:null,abortRequest:V,default:X,fetchWithCache:Y,getRequest:z});const ee=new Set(["1","true","yes","on"]),te=new Set(["0","false","no","off"]);function re(e,t=!1){if("boolean"==typeof e)return e;if(null==e)return t;const r=String(e).trim().toLowerCase();return!!ee.has(r)||!te.has(r)&&t}function ne(e){if(!e)return null;switch(String(e).trim().toLowerCase().replace(/[\-_]/g,"")){case"useprecomputed":case"featureuseprecomputed":case"precomputed":case"precomputedon":return"usePrecomputed";case"donesaggregate":case"featuredonesaggregate":case"donesagg":case"donesaggregated":return"donesAggregate";default:return null}}let ae=null,oe=null,ie=null;function se(){if(null===oe){const{FEATURE_USE_PRECOMPUTED:t}=e();oe=re(t,!1)}return oe}function le(){if(null===ie){const{FEATURE_DONES_AGGREGATE:t}=e();ie=re(t,!1)}return ie}function ce(){if(ae)return ae;const e={usePrecomputed:se(),donesAggregate:le()};let t={};if("undefined"!=typeof window)try{const e=new URLSearchParams(window.location.search||"");t=function(e){if(!e)return{};const t={},r=Array.isArray(e)?e:String(e).split(",");for(const e of r){if(!e)continue;let r=e,n="true";if("string"==typeof e){const t=e.trim();if(!t)continue;if(t.includes(":")){const[e,a]=t.split(":",2).map(e=>e.trim());r=e,n=a}else if(t.includes("=")){const[e,a]=t.split("=",2).map(e=>e.trim());r=e,n=a}else r=t,n="true"}const a=ne(r);a&&(t[a]=re(n,!0))}return t}(e.get("ff"))}catch(e){}return ae={...e,...t},ae}function ue(e){if(!e)return!1;const t=ce();return Boolean(t[e])}const fe=new Map;function de(){try{if("undefined"!=typeof window&&window.sessionStorage)return window.sessionStorage;if("undefined"!=typeof sessionStorage)return sessionStorage}catch(e){console.warn("Sesión de almacenamiento no disponible",e)}return null}function pe(e,r){return`aggregate:item:${"string"==typeof r&&r?r:t()}:${e}`}function ge(e,t){const r=function(e){const t=de();if(t)try{return t.getItem(e)}catch(e){console.warn("No se pudo leer sessionStorage",e)}return fe.get(e)??null}(pe(e,t));if(!r)return null;try{const e=JSON.parse(r);return e&&"object"==typeof e?{etag:"string"==typeof e.etag&&e.etag?e.etag:null,lastModified:"string"==typeof e.lastModified&&e.lastModified?e.lastModified:null,data:e.data??null,meta:e.meta??null}:null}catch(e){return console.warn("No se pudo parsear el cache del agregado",e),null}}function he(e,t,{etag:r=null,lastModified:n=null,data:a=null,meta:o=null}={}){const i={etag:r||null,lastModified:n||null,data:a??null,meta:o??null};!function(e,t){const r=de();if(r)try{null===t?r.removeItem(e):r.setItem(e,t)}catch(e){console.warn("No se pudo escribir en sessionStorage",e)}null===t?fe.delete(e):fe.set(e,t)}(pe(e,t),JSON.stringify(i))}function me(e,t){const r=String(t||"").toLowerCase();if(!e||!e.headers)return null;if("function"==typeof e.headers.get){const n=e.headers.get(t);return n||e.headers.get(r)}const n="function"==typeof e.headers.entries?Array.from(e.headers.entries()):Object.entries(e.headers);for(const[e,t]of n)if(String(e).toLowerCase()===r)return Array.isArray(t)?t[0]:t;return null}async function ye(e,{signal:a}={}){if(!Number.isFinite(Number(e))||Number(e)<=0)throw new Error("ID de ítem inválido");const o=Number(e),i=ge(o,t()),s={};i?.etag&&(s["If-None-Match"]=i.etag),i?.lastModified&&(s["If-Modified-Since"]=i.lastModified);const{url:l,options:c,lang:u}=r(`/api/items/${o}/aggregate`,{signal:a,headers:s}),f=await y(l,c),d=me(f,"ETag"),p=me(f,"Last-Modified");if(304===f.status){if(i?.data){he(o,u,{etag:d||i.etag||null,lastModified:p||i.lastModified||null,data:i.data,meta:i.meta});const e=n({data:i.data,meta:i.meta});return{data:i.data,meta:i.meta,model:e,status:304,fromCache:!0}}throw new Error("Respuesta 304 sin datos en cache")}if(!(me(f,"content-type")||"").toLowerCase().includes("application/json"))throw new Error("Respuesta no válida del agregado");const g=await f.json().catch(()=>null),{data:h,meta:m}=A(g),b=n({data:h,meta:m});return he(o,u,{etag:d,lastModified:p,data:h,meta:m}),{data:h,meta:m,model:b,status:f.status,fromCache:!1}}function be(e){if("string"!=typeof e)return null;const t=e.trim();return t?t.toLowerCase():null}function _e(){return"undefined"==typeof document?null:document.getElementById("freshness-banner")}function we(e={}){const r=_e();if(!r)return;const{stale:n=!1,lastUpdated:a,generatedAt:o,warnings:i=[],errors:s=[],lang:l=null}=e,c=function(e){if(!e)return"";try{const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString()}catch(e){return""}}(a||o),u=["freshness-banner"];n?u.push("freshness-banner--stale"):u.push("freshness-banner--fresh"),r.className=u.join(" ");const f=n?"Datos potencialmente desactualizados":"Datos actualizados",d=c?`Última generación: ${c}`:"",p=be(t()),g=be(l)||p,h=p&&g&&p!==g?`<span class="freshness-banner__lang">Mostrando contenido en ${g.toUpperCase()} (preferido: ${p.toUpperCase()})</span>`:"",m=Array.isArray(i)&&i.length?`<span class="freshness-banner__warnings">Avisos: ${i.join(", ")}</span>`:"",y=Array.isArray(s)&&s.length?`<span class="freshness-banner__errors">Errores: ${s.join(", ")}</span>`:"";r.innerHTML=`\n    <strong>${f}</strong>\n    ${d?`<span class="freshness-banner__timestamp">${d}</span>`:""}\n    ${h}\n    ${m}\n    ${y}\n  `,r.classList.remove("hidden")}function Se(){const e=_e();e&&(e.classList.add("hidden"),e.innerHTML="")}const Ae="undefined"!=typeof window?window:"undefined"!=typeof self?self:globalThis;function Ee(e){Array.isArray(e)&&Te(e,null),Ae.ingredientObjs=e}"undefined"!=typeof window&&(Ae.ingredientObjs=Ae.ingredientObjs||[],Ae.globalQty=Ae.globalQty||1,Ae._mainBuyPrice=Ae._mainBuyPrice||0,Ae._mainSellPrice=Ae._mainSellPrice||0,Ae._mainRecipeOutputCount=Ae._mainRecipeOutputCount||1);class ve{constructor({id:e,name:t,icon:r,rarity:n,count:a,buy_price:o,sell_price:i,is_craftable:s,recipe:l,children:c=[],_parentId:u=null}){this._uid=ve.nextUid++,this.id=e,this.name=t,this.icon=r,this.rarity=n,this.count=a,this.buy_price=o,this.sell_price=i,this.is_craftable=s,this.recipe=l||null,this.children=c,this.mode="buy",this.modeForParentCrafted="buy",this.expanded=!1,this._parentId=u,this._parent=null,this.countTotal=0,this.crafted_price=null,this.total_buy=0,this.total_sell=0,this.total_crafted=0}findRoot(){let e=this;for(;e._parent;)e=e._parent;return e}setMode(e){if(["buy","sell","crafted"].includes(e)){this.modeForParentCrafted=e;this.findRoot().recalc(Ae.globalQty||1,null),"function"==typeof Ae.safeRenderTable&&Ae.safeRenderTable()}}recalc(e=1,t=null,r={}){const{skipCountTotalUpdate:n=!1}=r,a=null==t,o=19675===this.id&&(77===this.count||38===this.count);if(a?this.countTotal=this.count*e:o?this.countTotal=this.count:n||(this.countTotal=t.countTotal*this.count),this.children&&this.children.length>0)if(o){const t=77===this.count?[250,250,250,1500]:[38,38,38,38];this.children.forEach((r,n)=>{r.countTotal=t[n]||0,r.total_buy=(r.buy_price||0)*r.countTotal,r.total_sell=(r.sell_price||0)*r.countTotal,r.recalc(e,this,{skipCountTotalUpdate:!0})})}else this.children.forEach(t=>t.recalc(e,this));a?this.children&&this.children.length>0?(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0)):(this.total_buy=(this.buy_price||0)*this.countTotal,this.total_sell=(this.sell_price||0)*this.countTotal):o?(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0)):(this.total_buy=(this.buy_price||0)*this.countTotal,this.total_sell=(this.sell_price||0)*this.countTotal),this.is_craftable&&this.children.length>0?(this.total_crafted=this.children.reduce((e,t)=>{switch(t.modeForParentCrafted){case"buy":default:return e+(t.total_buy||0);case"sell":return e+(t.total_sell||0);case"crafted":return e+(t.total_crafted||0)}},0),this.crafted_price=this.total_crafted/(this.recipe?.output_item_count||1),a||this.buy_price||this.sell_price||(this.total_buy=this.children.reduce((e,t)=>e+(t.total_buy||0),0),this.total_sell=this.children.reduce((e,t)=>e+(t.total_sell||0),0))):(this.total_crafted=null,this.crafted_price=null)}getBestPrice(){return"number"==typeof this.buy_price&&this.buy_price>0?this.buy_price:"number"==typeof this.crafted_price&&this.crafted_price>0?this.crafted_price:0}}function Te(e,t=null){if(Array.isArray(e))for(const r of e)Object.setPrototypeOf(r,ve.prototype),"number"==typeof r._uid&&ve.nextUid<=r._uid&&(ve.nextUid=r._uid+1),r._parent=t,t&&(r._parentId=t._uid),Array.isArray(r.children)&&r.children.length>0?Te(r.children,r):r.children=[]}function Me(e){Ae.globalQty=e}function ke(e){return e?e.map(e=>({id:e.id,expanded:e.expanded,children:ke(e.children||[])})):[]}function Ie(e,t){if(e&&t)for(let r=0;r<e.length;r++)t[r]&&(e[r].expanded=t[r].expanded,Ie(e[r].children,t[r].children))}ve.nextUid=0;let Ne={totalBuy:0,totalSell:0,totalCrafted:0};function Ce(e){const t=Number(e?.buy??e?.totalBuy??0),r=Number(e?.sell??e?.totalSell??0),n=Number(e?.crafted??e?.totalCrafted??0);Ne={totalBuy:Number.isFinite(t)?t:0,totalSell:Number.isFinite(r)?r:0,totalCrafted:Number.isFinite(n)?n:0}}function Le(e,t){return e?lt({ingredientTree:e,globalQty:t}).then(({updatedTree:t,totals:r})=>{function n(e,t){if(Object.assign(t,e),e.children&&t.children)for(let r=0;r<e.children.length;r++)n(e.children[r],t.children[r])}if(Array.isArray(t)&&Te(t,null),Array.isArray(t))for(let r=0;r<t.length;r++)n(t[r],e[r]);Ne=r||{totalBuy:0,totalSell:0,totalCrafted:0}}):Promise.resolve()}function Re(){return Ne}function Oe(e,t,r){for(const n of e){if(String(n.id)===String(t)&&String(n._parentId)===String(r))return n;if(Array.isArray(n.children)&&n.children.length){const e=Oe(n.children,t,r);if(e)return e}}return null}function Ue(e,t){let r=e,n=null;for(let e=0;e<t.length;e++){const a=t[e];if(n=(r||[]).find(e=>String(e._uid)===String(a)||String(e.id)===String(a)),!n)return null;r=n.children}return n}function je(e,t){for(const r of e){if(String(r._uid)===String(t))return r;if(r.children&&r.children.length){const e=je(r.children,t);if(e)return e}}return null}function $e(e,t){for(const r of e){if(String(r.id)===String(t))return r;if(r.children&&r.children.length){const e=$e(r.children,t);if(e)return e}}return null}function Pe(e,t,r=[]){if(!Array.isArray(e))return r;for(const n of e)String(n.id)===String(t)&&r.push(n),n.children&&n.children.length&&Pe(n.children,t,r);return r}const De=new Set;function Fe(e){return De.add(e),e}function xe(){De.forEach(e=>e.abort()),De.clear(),We&&(We.terminate(),We=null)}async function Be(e){const t=Fe(new AbortController),r=`item_${e}`,n=$(r,!0),a={};n?.etag&&(a["If-None-Match"]=n.etag),n?.lastModified&&(a["If-Modified-Since"]=n.lastModified);try{try{const n=await Y(`/backend/api/itemBundle.php?ids=${e}`,{headers:a,signal:t.signal});if(n.ok){const e=await n.json().catch(()=>null),{data:t,meta:a}=A(e),o=Array.isArray(t)?t[0]:null;if(o&&o.item){const e=o.item;o.nested_recipe&&(e.nested_recipe=o.nested_recipe);const t=n.headers.get("ETag"),i=n.headers.get("Last-Modified"),s=t||i?null:void 0;return e.lastUpdated=(new Date).toISOString(),j(r,e,s,{etag:t,lastModified:i}),Array.isArray(a?.errors)&&a.errors.length&&console.warn("itemBundle devolvió errores",a.errors),e}Array.isArray(a?.errors)&&a.errors.length&&console.warn("itemBundle respondió sin datos",a.errors)}}catch(e){}const o=await Y(`https://api.guildwars2.com/v2/items/${e}?lang=es`,{headers:a,signal:t.signal});if(304===o.status&&n)return n.value;if(!o.ok)throw new Error(`Error ${o.status} obteniendo datos del ítem ${e}`);const i=await o.json();i.lastUpdated=(new Date).toISOString();const s=o.headers.get("ETag"),l=o.headers.get("Last-Modified");return j(r,i,s||l?null:void 0,{etag:s,lastModified:l}),i}finally{De.delete(t)}}let We=null;function Ge(e){if(!e||"object"!=typeof e)return null;let t;try{t="function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))}catch(r){t={...e}}const r=Array.isArray(t.children)?t.children:Array.isArray(t.components)?t.components:[];return t.children=r.map(e=>Ge(e)).filter(e=>null!==e),"components"in t&&delete t.components,t}async function He(e,t){if(!t||!t.ingredients||0===t.ingredients.length)return Ae._mainRecipeOutputCount=t&&t.output_item_count||1,[];if(t.nested_recipe){Ae._mainRecipeOutputCount=t.output_item_count||1;const e=function(e){if(!e)return[];if(Array.isArray(e))return e.map(e=>Ge(e)).filter(e=>null!==e);if("object"==typeof e){if(Array.isArray(e.tree))return e.tree.map(e=>Ge(e)).filter(e=>null!==e);if(Array.isArray(e.children))return e.children.map(e=>Ge(e)).filter(e=>null!==e);if(Array.isArray(e.components))return e.components.map(e=>Ge(e)).filter(e=>null!==e);const t=Ge(e);return t?[t]:[]}return[]}(t.nested_recipe).map(e=>Qe(e,null));return Te(e,null),e.forEach(e=>e.recalc(Ae.globalQty,null)),e}return We&&We.terminate(),We=new Worker(new URL("./workers/ingredientTreeWorker.js",import.meta.url),{type:"module"}),new Promise((r,n)=>{const a=e=>{We.removeEventListener("message",a),We.removeEventListener("error",o);let t=e.data?.tree||[];We=null,Array.isArray(t)||(t=t&&"object"==typeof t?Array.isArray(t.children)?t.children:[t]:[]);const n=t.map(e=>Qe(e,null));Te(n,null),n.forEach(e=>e.recalc(Ae.globalQty,null)),r(n)},o=e=>{We.removeEventListener("message",a),We.removeEventListener("error",o),We=null,console.error("Error en ingredientTreeWorker:",e?.message||e,e);const t="Error procesando ingredientes"+(e?.message?`: ${e.message}`:"");Ae.StorageUtils&&"function"==typeof Ae.StorageUtils.showToast?Ae.StorageUtils.showToast(t,"error"):"function"==typeof alert&&alert(t),n(e)};We.addEventListener("message",a),We.addEventListener("error",o);const i=function(){const e=Ae&&"object"==typeof Ae.__RUNTIME_CONFIG__?Ae.__RUNTIME_CONFIG__:null;if(!e)return null;const t={};return"string"==typeof e.FETCH_GUARD_MODE&&(t.FETCH_GUARD_MODE=e.FETCH_GUARD_MODE),Array.isArray(e.FETCH_GUARD_WHITELIST)?t.FETCH_GUARD_WHITELIST=[...e.FETCH_GUARD_WHITELIST]:"string"==typeof e.FETCH_GUARD_WHITELIST&&(t.FETCH_GUARD_WHITELIST=e.FETCH_GUARD_WHITELIST.split(",").map(e=>e.trim()).filter(Boolean)),Object.prototype.hasOwnProperty.call(e,"FETCH_GUARD_REPORT_URL")&&(t.FETCH_GUARD_REPORT_URL=e.FETCH_GUARD_REPORT_URL),Array.isArray(e.CONNECT_ALLOWLIST)&&(t.CONNECT_ALLOWLIST=[...e.CONNECT_ALLOWLIST]),t}();We.postMessage({type:"runtimeConfig",config:i}),We.postMessage({type:"generateTree",mainItemId:e,mainRecipeData:t})})}async function qe(e){const t=Fe(new AbortController),r=`recipe_${e}`,n=$(r);if(n)return De.delete(t),n;try{const n=await Y(`https://api.guildwars2.com/v2/recipes/search?output=${e}`,{signal:t.signal});if(!n.ok)return null;const a=await n.json();if(!a||0===a.length)return null;const o=a[0],i=await Y(`https://api.guildwars2.com/v2/recipes/${o}?lang=es`,{signal:t.signal});if(!i.ok)throw new Error(`Error ${i.status} obteniendo datos de la receta ${o}`);const s=await i.json();return s.lastUpdated=(new Date).toISOString(),j(r,s),s}finally{De.delete(t)}}function Qe(e,t=null){const r=new ve({id:e.id,name:e.name,icon:e.icon,rarity:e.rarity,count:e.count||1,recipe:e.recipe||null,buy_price:e.buy_price||0,sell_price:e.sell_price||0,is_craftable:e.is_craftable||!1,children:[],_parentId:t});return e.children&&e.children.length>0&&(r.children=e.children.map(e=>Qe(structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e)),r._uid))),r}if("undefined"!=typeof window){void 0===Ae.comparativa&&(Ae.comparativa={});let Zt=null;const er=new Map;function tr(e,t=null){if(!e)return null;const r=new ve({id:e.id,name:e.name,icon:e.icon,rarity:e.rarity,count:Number.isFinite(Number(e.count))?Number(e.count):1,buy_price:Number(e.buy_price||0),sell_price:Number(e.sell_price||0),is_craftable:Boolean(e.is_craftable),recipe:e.recipe||null,children:[],_parentId:t?t._uid:null});r.countTotal=Number(e.countTotal??r.count),r.total_buy=Number(e.total_buy||0),r.total_sell=Number(e.total_sell||0),r.total_crafted=null==e.total_crafted?null:Number(e.total_crafted||0),r.crafted_price=null==e.crafted_price?null:Number(e.crafted_price||0),r.mode=e.mode||"buy",r.modeForParentCrafted=e.modeForParentCrafted||"buy",r.expanded=Boolean(e.expanded),r._parent=t||null;const n=Array.isArray(e.children)?e.children:[];return r.children=n.map(e=>tr(e,r)),r}function rr(){if(!ue("usePrecomputed"))return void Se();const e=Array.from(er.values()).filter(Boolean);if(!e.length)return void Se();let t=null,r=!1;const n=new Set,a=new Set;e.forEach(e=>{if(!e)return;e.stale&&(r=!0),(e.warnings||[]).forEach(e=>n.add(e)),(e.errors||[]).forEach(e=>a.add(e));const o=e.lastUpdated||e.generatedAt;o&&(!t||new Date(o)>new Date(t))&&(t=o)}),we({stale:r,lastUpdated:t,warnings:Array.from(n),errors:Array.from(a)})}function nr(e){const t=Number.isFinite(Number(e))&&Number(e)>0?Number(e):1;let r=0,n=0,a=0;return(Ae.ingredientObjs||[]).forEach(e=>{const t=Number(e?.total_buy||0),o=Number(e?.total_sell||0),i=null==e?.total_crafted?t:Number(e.total_crafted||0);switch(r+=t,n+=o,e?.modeForParentCrafted){case"sell":a+=o;break;case"crafted":a+=i;break;default:a+=t}}),{totalBuy:r*t,totalSell:n*t,totalCrafted:a*t}}function ar(e){null==e?er.clear():er.delete(Number(e)),rr()}async function or(e){const t=await G(e);e.forEach(e=>{const r=t.get(e)||{},n=$e(Ae.ingredientObjs,e);n&&(n.buy_price=r.buy_price||0,n.sell_price=r.sell_price||0,"function"==typeof n.recalc&&n.recalc(Ae.globalQty||1,null))}),"function"==typeof Ae.safeRenderTable&&Ae.safeRenderTable()}function ir(){const e=Ae.ingredientObjs?Ae.ingredientObjs.map(e=>e.id):[];if(Zt&&(clearInterval(Zt),Zt=null),0===e.length)return;const t=()=>or(e);t(),Zt=setInterval(t,6e4)}Ae.comparativa.getPrecomputedTotals=nr,Ae.comparativa.clearComparativaMeta=ar,Ae.comparativa.updateFreshnessBanner=rr,Ae.comparativa.agregarItemPorId=async function(e){if(Ae.ingredientObjs=Ae.ingredientObjs||[],Ae.globalQty=Ae.globalQty||1,Ae.ingredientObjs.some(t=>t.id==e))return;const t=document.getElementById("item-skeleton");if(ue("usePrecomputed")){Zt&&(clearInterval(Zt),Zt=null);try{"function"==typeof Ae.showSkeleton&&Ae.showSkeleton(t);const r=await ye(e),o=r?.model||n({data:r?.data,meta:r?.meta}),{item:i,market:s,tree:l,meta:c,prices:u}=o||{};if(!i)return"function"==typeof Ae.hideSkeleton&&Ae.hideSkeleton(t),Ae.showError?.("No se encontraron datos precomputados para este ítem."),er.delete(Number(e)),void rr();const f=u?.hasData?u:a(s);let d=l?tr(l,null):null;d||(d=new ve({id:i.id,name:i.name,icon:i.icon,rarity:i.rarity,count:1,buy_price:Number(f?.unit?.buy??s?.unitBuyPrice??0),sell_price:Number(f?.unit?.sell??s?.unitSellPrice??0),is_craftable:!1,recipe:null,children:[]}),d.total_buy=Number(f?.totals?.buy??s?.buy??0),d.total_sell=Number(f?.totals?.sell??s?.sell??0),d.total_crafted=Number(f?.totals?.crafted??s?.crafted??0));const p=f?.totals||{};Number.isFinite(Number(p.buy))?d.total_buy=Number(p.buy):s&&Number.isFinite(Number(s.buy))&&(d.total_buy=Number(s.buy)),Number.isFinite(Number(p.sell))?d.total_sell=Number(p.sell):s&&Number.isFinite(Number(s.sell))&&(d.total_sell=Number(s.sell)),Number.isFinite(Number(p.crafted))?d.total_crafted=Number(p.crafted):s&&Number.isFinite(Number(s.crafted))&&(d.total_crafted=Number(s.crafted)),Ae._mainRecipeOutputCount=d?.recipe?.output_item_count||d?.output||1,Ae._mainBuyPrice=f?.unit?.buy??s?.unitBuyPrice??d.buy_price??0,Ae._mainSellPrice=f?.unit?.sell??s?.unitSellPrice??d.sell_price??0,Ae.ingredientObjs.push(d),er.set(Number(d.id),c),rr(),"function"==typeof Ae.safeRenderTable&&Ae.safeRenderTable(Ae._mainBuyPrice,Ae._mainSellPrice),"function"==typeof Ae.hideSkeleton&&Ae.hideSkeleton(t)}catch(e){"function"==typeof Ae.hideSkeleton&&Ae.hideSkeleton(t),console.error("Error agregando ítem precomputado",e),Ae.showError?.("No se pudo cargar el agregado del ítem.")}}else{er.clear(),Se();try{"function"==typeof Ae.showSkeleton&&Ae.showSkeleton(t);const r=await Be(e),n=await qe(e),a=await H(e),o=Array.isArray(n?.ingredients)&&n.ingredients.length>0;let i;if(Ae._mainBuyPrice=a.buy_price||0,Ae._mainSellPrice=a.sell_price||0,n&&o){let t=await He(e,n);Array.isArray(t)||(t=[]);const s=o&&0===t.length;if(s){const e="No se pudo construir el árbol de ingredientes. Mostrando el ítem sin receta.";Ae.StorageUtils&&"function"==typeof Ae.StorageUtils.showToast?Ae.StorageUtils.showToast(e,"error"):console.warn(e)}Ae._mainRecipeOutputCount=n.output_item_count||1,i=new ve({id:r.id,name:r.name,icon:r.icon,rarity:r.rarity,count:1,buy_price:a.buy_price,sell_price:a.sell_price,is_craftable:!s,recipe:s?null:n,children:s?[]:t}),i.recalc(Ae.globalQty||1,null)}else Ae._mainRecipeOutputCount=n&&n.output_item_count||1,i=new ve({id:r.id,name:r.name,icon:r.icon,rarity:r.rarity,count:1,buy_price:a.buy_price,sell_price:a.sell_price,is_craftable:!1,recipe:null,children:[]});Ae.ingredientObjs.push(i),ir(),"function"==typeof Ae.safeRenderTable&&("number"==typeof a.buy_price&&"number"==typeof a.sell_price?Ae.safeRenderTable(a.buy_price,a.sell_price):Ae.safeRenderTable()),"function"==typeof Ae.hideSkeleton&&Ae.hideSkeleton(t)}catch(e){"function"==typeof Ae.hideSkeleton&&Ae.hideSkeleton(t),alert("Error al agregar el ítem: "+(e?.message||e)),console.error("Error al agregar el ítem",e)}}},Ae.comparativa.handleSaveComparativa=async function(){if(!Ae.ingredientObjs||0===Ae.ingredientObjs.length)return void Ae.StorageUtils?.showToast("Agrega al menos un ítem a la comparativa","error");const e={ids:Ae.ingredientObjs.map(e=>e.id),nombres:Ae.ingredientObjs.map(e=>e.name),timestamp:Date.now()};Ae.StorageUtils&&"function"==typeof Ae.StorageUtils.saveComparativa?(await Ae.StorageUtils.saveComparativa(e),Ae.StorageUtils.showToast("Comparativa guardada")):alert("StorageUtils no está disponible.")},Ae.comparativa.loadComparativaFromURL=function(){const e=new URLSearchParams(Ae.location.search).get("ids");if(!e)return;const t=e.split(",").map(e=>parseInt(e,10)).filter(e=>!isNaN(e));if(0===t.length)return;Ae.ingredientObjs=Ae.ingredientObjs||[],Ae.globalQty=Ae.globalQty||1;const r=()=>{Ae.comparativa&&"function"==typeof Ae.comparativa.agregarItemPorId?(async()=>{const e=[];for(const r of t)try{await Ae.comparativa.agregarItemPorId(r)}catch(t){console.error("Error cargando ítem de la URL",r,t),e.push({id:r,error:t})}if(e.length>0){const t=`No se pudieron cargar ${e.length} ítems de la URL.`;Ae.StorageUtils?.showToast?Ae.StorageUtils.showToast(t,"error"):alert(t)}})():setTimeout(r,50)};r()}}function Je(e,t){return!e||!t||isNaN(e)||isNaN(t)||0===t?"-":(e/t*100).toFixed(1)+"%"}function ze(e){return Array.isArray(e)?e.map(e=>Ke(e,null)):[]}function Ke(e,t){const r=new ve(e);return Object.assign(r,e),"number"==typeof e._uid&&(r._uid=e._uid,ve.nextUid<=e._uid&&(ve.nextUid=e._uid+1)),r._parent=t||null,r.children=Array.isArray(e.children)?e.children.map(e=>Ke(e,r)):[],r}function Ve(e,t){e&&e.forEach(e=>{e.recalc(t,null)})}function Ye(e){let t=0,r=0,n=0;for(const a of e||[])switch(t+=a.total_buy||0,r+=a.total_sell||0,a.modeForParentCrafted){case"sell":n+=a.total_sell||0;break;case"crafted":n+=a.total_crafted||0;break;default:n+=a.total_buy||0}return{totalBuy:t,totalSell:r,totalCrafted:n}}function Xe({ingredientTree:e=[],globalQty:t=1}={}){const r=ze(e);Ve(r,t);return{updatedTree:r,totals:Ye(r)}}"undefined"!=typeof window&&(Ae.setIngredientObjs=Ee,Ae.setGlobalQty=Me,Ae.snapshotExpandState=ke,Ae.restoreExpandState=Ie,Ae.recalcAll=Le,Ae.getTotals=Re,Ae.findIngredientByIdAndParent=Oe,Ae.findIngredientByPath=Ue,Ae.findIngredientByUid=je,Ae.findIngredientById=$e,Ae.findIngredientsById=Pe,Ae.calcPercent=Je);const Ze=[];let et=null,tt=null,rt=!1;const nt=(()=>{try{const e=new URL(".",import.meta.url);return new URL("workers/costsWorker.js",e)}catch(e){return new URL("./costsWorker.js",import.meta.url)}})();function at(e){if(e instanceof Error)return e;if(e&&"object"==typeof e){if(e.error instanceof Error)return e.error;if("string"==typeof e.message)return new Error(e.message);if("string"==typeof e.type&&""!==e.type)return new Error(`Worker error: ${e.type}`)}return new Error(String(e??"Worker error"))}function ot(e,t,r){try{t(r)}finally{et=null,st()}}function it(e,t){const r=t?at(t):null;tt&&(tt.terminate(),tt=null),rt=!0;try{const t=Xe(e.payload||{});r&&console.warn("costsWorker no disponible, usando cálculo local",r),ot(0,e.resolve,t)}catch(t){if(r){const n=new Error(`${r.message}; fallback error: ${t?.message||t}`);n.cause={worker:r,fallback:t},ot(0,e.reject,n)}else ot(0,e.reject,at(t))}}function st(){if(et||0===Ze.length)return;const e=Ze.shift();if(rt)return void it(e);let t=null;try{t=function(){if(tt)return tt;if("undefined"==typeof Worker)throw new Error("Web Workers no soportados en este entorno");return tt=new Worker(nt,{type:"module"}),tt}()}catch(t){return void it(e,t)}const r=()=>{t&&(t.removeEventListener("message",n),t.removeEventListener("error",a))},n=t=>{r(),ot(0,e.resolve,t?.data??null)},a=t=>{r(),it(e,t)};t.addEventListener("message",n),t.addEventListener("error",a),et={reject:e.reject};try{t.postMessage(e.payload)}catch(t){r(),it(e,t)}}function lt({ingredientTree:e,globalQty:t}){return r={ingredientTree:e,globalQty:t},new Promise((e,t)=>{Ze.push({payload:r,resolve:e,reject:t}),st()});var r}const ct="item.html",ut=[],ft=new Map;let dt=null;function pt(){return"undefined"!=typeof Date&&"function"==typeof Date.now?Date.now():0}function gt(){dt||(dt=setTimeout(()=>{wt({force:!0})},5e3))}function ht(e,t){if(!e.length)return 0;const r=Math.ceil(e.length*t)-1;return e[Math.min(e.length-1,Math.max(0,r))]}function mt(){for(const e of ft.values())if(e.samples.length>0)return!0;return!1}function yt(){const e=function(){const e="undefined"!=typeof window?window:"undefined"!=typeof globalThis?globalThis:null;return e?(Array.isArray(e.__GW2_TELEMETRY__)||(e.__GW2_TELEMETRY__=[]),e.__GW2_TELEMETRY__):null}();if(e)for(;ut.length;)e.push(ut.shift());else(ut.length||mt())&&gt()}function bt(e={}){const t={view:e.view||ct,bucket:e.bucket??null,type:e.type||"custom",timestamp:e.timestamp||(new Date).toISOString()};return null!=e.meta&&(t.meta=e.meta),null!=e.metrics&&(t.metrics=e.metrics),null!=e.tags&&(t.tags=e.tags),null!=e.error&&(t.error=e.error),function(e){ut.push(e),ut.length>=10?wt():gt()}(t),t}function _t({bucket:e=null,stale:t=null,duration:r}){if(!Number.isFinite(r)||r<0)return;const n=Number.isFinite(e)?Number(e):e,a=null==t?null:Boolean(t),o=`${n??"unknown"}|${null===a?"u":a?"1":"0"}`;let i=ft.get(o);i||(i={bucket:n??null,stale:a,samples:[],lastUpdated:pt()},ft.set(o,i)),i.samples.push(r),i.lastUpdated=pt(),i.samples.length>=10?wt():gt()}function wt({force:e=!1}={}){dt&&(clearTimeout(dt),dt=null),function({force:e=!1}={}){const t=pt(),r=[];for(const n of ft.values()){if(!n.samples.length)continue;if(!(e||n.samples.length>=10||t-n.lastUpdated>=5e3))continue;const a=[...n.samples].sort((e,t)=>e-t),o={view:ct,bucket:n.bucket,type:"aggregatePerformance",timestamp:(new Date).toISOString(),metrics:{count:a.length,p95:ht(a,.95),p99:ht(a,.99)},meta:{stale:n.stale}};r.push(o),n.samples=[],n.lastUpdated=t}r.length&&ut.push(...r)}({force:e}),yt(),e||!ut.length&&!mt()||gt()}function St(){return"undefined"!=typeof performance&&"function"==typeof performance.now?performance.now():pt()}function At(e=[],t,r=6e4){if(!Array.isArray(e)||0===e.length)return()=>{};let n=!1;return async function a(){if(n)return;const o=m.getBackoff();o&&await new Promise(e=>setTimeout(e,o));try{const r=await G(e);"function"==typeof t&&t(r)}catch(e){m.recordFailure()}n||setTimeout(a,r)}(),()=>{n=!0}}const Et="gw2.precomputed.bucket";function vt(){const e="undefined"!=typeof window&&window&&window.localStorage?window.localStorage:"undefined"!=typeof globalThis&&globalThis.localStorage?globalThis.localStorage:null,t=function(e){if(null==e)return null;const t=Number.parseInt(e,10);return Number.isNaN(t)||t<0||t>=100?null:t}(function(e){if(!e)return null;try{return e.getItem(Et)}catch{return null}}(e));if(null!==t)return t;const r=Math.floor(100*Math.random());return function(e,t){if(e)try{e.setItem(Et,String(t))}catch{}}(e,r),r}function Tt(e,t=0){if(null==e)return t;const r=Number(e);return Number.isFinite(r)?r:t}function Mt(e){return e?(t=e)&&"object"==typeof t&&!0===t.__hydrated&&"number"==typeof t._uid?(Te([e],null),e):kt(e,null):null;var t}function kt(e,t){const r=new ve({id:e.id,name:e.name,icon:e.icon,rarity:e.rarity,count:Tt(e.count,1),buy_price:Tt(e.buy_price,0),sell_price:Tt(e.sell_price,0),is_craftable:Boolean(e.is_craftable),recipe:e.recipe||null,children:[],_parentId:t?t._uid:null});r.countTotal=Tt(e.countTotal,r.count),r.total_buy=Tt(e.total_buy,r.buy_price*r.countTotal),r.total_sell=Tt(e.total_sell,r.sell_price*r.countTotal),r.total_crafted=null==e.total_crafted?null:Tt(e.total_crafted,0),r.crafted_price=null==e.crafted_price?null:Tt(e.crafted_price,0),r.mode=e.mode||"buy",r.modeForParentCrafted=e.modeForParentCrafted||"buy",r.expanded=Boolean(e.expanded),r._parent=t||null;const n=Array.isArray(e.children)?e.children:[];return r.children=n.map(e=>kt(e,r)),r}const It=new Map,Nt=new WeakMap,Ct=new Map,Lt="undefined"!=typeof IntersectionObserver?new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target;if(Nt.set(t,e.isIntersecting),e.isIntersecting){const e=t.dataset.stateId||t.dataset.path;if(!e)return;const r=It.get(e);if(!r)return;const n=r.find(e=>e.el===t),a=t._pendingState;n&&a&&(n.renderFn(a),t._pendingState=null)}})}):null;function Rt(e,t,r){const n=String(e);t.dataset.stateId=n;let a=It.get(n);a||(a=[],It.set(n,a)),a.push({el:t,renderFn:r}),Lt?Lt.observe(t):(Nt.set(t,!0),r&&Ct.has(n)&&(r(Ct.get(n)),t._pendingState=null))}function Ot(e,t){const r=String(e);Ct.set(r,t);const n=It.get(r);n&&n.forEach(({el:e,renderFn:r})=>{Lt?Nt.get(e)?r&&r(t):e._pendingState=t:r&&(r(t),e._pendingState=null)})}var Ut=Object.freeze({__proto__:null,register:Rt,update:Ot});function jt(){const e=document.querySelectorAll("img[data-src]");if("undefined"==typeof IntersectionObserver)return void e.forEach(e=>{e.dataset&&e.dataset.src&&(e.src=e.dataset.src)});const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const r=e.target;r.src=r.dataset.src,t.unobserve(r)}})});e.forEach(e=>t.observe(e))}const $t=new Set,Pt=new Map;let Dt=null,Ft=null;function xt(e){const t=Number(e);return Number.isNaN(t)?e:t}function Bt(e){if(!e)return{item:e,meta:null};if(e.data&&e.data.item){const t={...e.data.item},r=e.meta||{};["lang","source","fallback"].forEach(e=>{void 0!==r[e]&&void 0===t[e]&&(t[e]=r[e])});const n={};return void 0!==r.lang&&(n.lang=r.lang),void 0!==r.source&&(n.source=r.source),void 0!==r.fallback&&(n.fallback=r.fallback),{item:t,meta:Object.keys(n).length?n:null}}if(e.meta&&"object"==typeof e.meta){const t={};return void 0!==e.meta.lang&&(t.lang=e.meta.lang),void 0!==e.meta.source&&(t.source=e.meta.source),void 0!==e.meta.fallback&&(t.fallback=e.meta.fallback),{item:e,meta:Object.keys(t).length?t:null}}return{item:e,meta:null}}function Wt(){Dt||(Dt=setTimeout(Ht,50)),$t.size>=200&&(clearTimeout(Dt),Ht())}async function Gt(e,t,{baseUrl:r,signal:n,backoff:a,allowConditional:o}){if(!e.length)return{status:200,items:new Map,missing:[],metaById:new Map};const i=t?`&lang=${t}`:"",s=o?function(e,t){if(1!==e.length)return{};const r=$(`item_${e[0]}`,!0);if(!r)return{};if(r.lang&&t&&r.lang!==t)return{};const n={};return r.etag&&(n["If-None-Match"]=r.etag),r.lastModified&&(n["If-Modified-Since"]=r.lastModified),n}(e,t):{},l=await y(`${r}${e.join(",")}${i}`,{headers:s,signal:n,backoff:a});if(304===l.status)return{status:304};if(!l.ok)throw new Error(`Unexpected response status: ${l.status}`);const c=await l.json();if(!Array.isArray(c))throw new Error("Unexpected response format");const u=l.headers.get("ETag"),f=l.headers.get("Last-Modified"),d=new Map,p=new Map;c.forEach(e=>{const{item:r,meta:n}=Bt(e);if(!r||void 0===r.id)return;const a=xt(r.id);d.set(a,r);const o={etag:u,lastModified:f,lang:t};n&&(void 0!==n.lang&&(o.lang=n.lang),void 0!==n.source&&(o.source=n.source),void 0!==n.fallback&&(o.fallback=n.fallback)),p.set(a,o)});const g=e.filter(e=>!d.has(e));return{status:l.status,items:d,missing:g,metaById:p}}async function Ht(){if(0===$t.size)return void(Dt=null);Dt=null;const t=Array.from($t).slice(0,200);t.forEach(e=>$t.delete(e));try{const r=m.getBackoff();r&&await new Promise(e=>setTimeout(e,r)),Ft=new AbortController;const{API_BASE_URL:n,LANG:a,DEFAULT_LANG:o,FALLBACK_LANGS:i=[]}=e(),s=(a||o||"").trim()||"es",l=Array.isArray(i)?[...new Set(i.filter(e=>e&&e!==s))]:[],c=`${n}/items?ids=`,u=300+r;let f=null;try{if(f=await Gt(t,s,{baseUrl:c,signal:Ft.signal,backoff:u,allowConditional:!0}),304===f.status)return void t.forEach(e=>{const t=Pt.get(e),r=$(`item_${e}`);t&&t.resolve(r),Pt.delete(e)})}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw e;f=null}const d=new Map,p=new Map;let g=[...t];f&&f.items&&(f.items.forEach((e,t)=>{const r=xt(t);d.set(r,e);const n=f.metaById?.get(t);n&&p.set(r,n)}),g=f.missing);for(const e of l){if(!g.length)break;let t=null;try{if(t=await Gt(g,e,{baseUrl:c,signal:Ft.signal,backoff:u,allowConditional:!1}),304===t.status){const t=[];g.forEach(r=>{const n=$(`item_${r}`,!0);n&&n.value?(d.set(r,n.value),p.set(r,{etag:n.etag??null,lastModified:n.lastModified??null,lang:n.lang??e})):t.push(r)}),g=t;continue}}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw e;continue}t&&t.items&&(t.items.forEach((r,n)=>{const a=xt(n);d.set(a,r);const o=t.metaById?.get(n);o?p.set(a,o):p.set(a,{lang:e})}),g=t.missing)}if(g.length){const e=[];await Promise.all(g.map(async t=>{const r=xt(t);try{const a=`${n}/items/${t}?lang=${s}`,o=await y(a,{signal:Ft.signal,backoff:u});if(304===o.status){const t=$(`item_${r}`,!0);return t&&t.value?(d.set(r,t.value),void p.set(r,{etag:t.etag??null,lastModified:t.lastModified??null,lang:t.lang??s,source:t.source??null,fallback:t.fallback??null})):void e.push(r)}if(404===o.status)return void e.push(r);if(!o.ok)return console.warn(`[requestManager] failed to fetch item ${t}: unexpected status ${o.status}`),void e.push(r);const i=async e=>{console.warn(`[requestManager] official API fallback for item ${t}: ${e}`);try{const e=`https://api.guildwars2.com/v2/items/${t}?lang=${s}`,r=await y(e,{signal:Ft.signal,backoff:u});if(!r.ok)return console.warn(`[requestManager] official API fallback failed for item ${t}: unexpected status ${r.status}`),!1;const n=r.headers.get("content-type");if(!n||!String(n).toLowerCase().includes("application/json"))return console.warn(`[requestManager] official API fallback failed for item ${t}: unexpected content-type ${n||"unknown"}`),!1;let a;try{a=await r.json()}catch(e){if(e instanceof SyntaxError)return console.warn(`[requestManager] official API fallback failed for item ${t}: invalid JSON response`,e),!1;throw e}const{item:o,meta:i}=Bt(a);if(!o||void 0===o.id)return console.warn(`[requestManager] official API fallback failed for item ${t}: missing item id`),!1;const l=xt(o.id),c={etag:r.headers.get("ETag"),lastModified:r.headers.get("Last-Modified"),lang:o.lang||i?.lang||s,source:i?.source||"official-api",fallback:i?.fallback||"official-api"};return o.source&&(c.source=o.source),o.fallback&&(c.fallback=o.fallback),d.set(l,o),p.set(l,c),j(`item_${l}`,o,void 0,c),!0}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw e;return console.warn(`[requestManager] official API fallback failed for item ${t}: ${e&&e.message?e.message:e}`),!1}},l=o.headers.get("content-type");if(!l||!String(l).toLowerCase().includes("application/json")){return void(await i(`unexpected content-type ${l||"unknown"}`)||e.push(r))}let c;try{c=await o.json()}catch(t){if(t instanceof SyntaxError){return void(await i("invalid JSON response")||e.push(r))}throw t}const{item:f,meta:g}=Bt(c);if(!f||void 0===f.id)return void e.push(r);const h=xt(f.id),m={etag:o.headers.get("ETag"),lastModified:o.headers.get("Last-Modified"),lang:f.lang||s};g&&(void 0!==g.lang&&(m.lang=g.lang),void 0!==g.source&&(m.source=g.source),void 0!==g.fallback&&(m.fallback=g.fallback)),f.source&&(m.source=f.source),f.fallback&&(m.fallback=f.fallback),d.set(h,f),p.set(h,m),j(`item_${h}`,f,void 0,m)}catch(n){if(n instanceof DOMException&&"AbortError"===n.name)throw n;console.warn(`[requestManager] failed to fetch item ${t}: ${n&&n.message?n.message:n}`),e.push(r)}})),g=e}t.forEach(e=>{const t=xt(e),r=Pt.get(t)||Pt.get(e);if(!r)return;const n=d.get(t);if(n){const e={...p.get(t)||{lang:s}};n&&n.lang&&(e.lang=n.lang),n&&n.source&&(e.source=n.source),n&&n.fallback&&(e.fallback=n.fallback),p.set(t,e),j(`item_${t}`,n,void 0,e),r.resolve(n)}else r.resolve(null);Pt.delete(t),t!==e&&Pt.delete(e)})}catch(e){t.forEach(t=>{const r=Pt.get(t);r&&(e instanceof DOMException&&e.name,r.reject(e),Pt.delete(t))})}$t.size>0&&Wt()}function qt(e=[],t){Ft&&(Ft.abort(),Ft=null),t&&t.addEventListener("abort",()=>Ft&&Ft.abort(),{once:!0});const r=e.map(e=>{const t=xt(e),r=$(`item_${t}`);if(r)return Promise.resolve(r);if(Pt.has(t))return Pt.get(t).promise;const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),Pt.set(t,n),$t.add(t),Wt(),n.promise});return Promise.all(r)}!function(){if("undefined"!=typeof localStorage)for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t.startsWith("item_")&&$(t)}}();const Qt="img/item-placeholder.svg";function Jt(){return Qt}"undefined"!=typeof module&&module.exports&&(module.exports.ITEM_ICON_PLACEHOLDER_PATH=Qt,module.exports.getItemIconPlaceholderPath=Jt,module.exports.default=Qt);export{Ut as $,At as A,ye as B,Rt as C,Ot as D,jt as E,qt as F,Jt as G,Xe as H,ze as I,Ve as J,Ye as K,Ee as L,ve as M,Ce as N,Oe as O,Ue as P,$e as Q,Pe as R,xe as S,Be as T,He as U,qe as V,Qe as W,Je as X,E as Y,Q as Z,Z as _,$ as a,y as b,T as c,q as d,P as e,Y as f,H as g,Te as h,ue as i,je as j,Me as k,Le as l,ke as m,A as n,Ie as o,G as p,Re as q,lt as r,j as s,bt as t,vt as u,Se as v,St as w,we as x,Mt as y,_t as z};
