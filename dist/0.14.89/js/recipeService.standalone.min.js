var RecipeServiceBundle=function(e){"use strict";const t={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},r="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let n=null;function o(e){r&&r.postMessage({type:"delete",key:e})}const i={API_BASE_URL:"/api",CDN_BASE_URL:"",DEFAULT_LANG:"es",FALLBACK_LANGS:["en"],MARKET_CSV_URL:"https://api.datawars2.ie/gw2/v1/items/csv",GW2_API_KEY:"",priceCacheStrategy:"sessionStorage",FEATURE_USE_PRECOMPUTED:!1,FEATURE_MARKET_CSV_EXTERNAL:!0,FEATURE_MARKET_CSV_EXTERNAL_WORKER:!1,FEATURE_DONES_AGGREGATE:!1,PRECOMPUTED_CANARY_THRESHOLD:1,FETCH_GUARD_MODE:"enforce",FETCH_GUARD_WHITELIST:[],CONNECT_ALLOWLIST:[],FETCH_GUARD_REPORT_URL:null,FEATURE_ITEM_API_ROLLOUT:!1};function a(e,t=!1){if("boolean"==typeof e)return e;if(null==e)return t;if("number"==typeof e)return Number.isNaN(e)?t:0!==e;const r=String(e).trim().toLowerCase();return r?!!["1","true","yes","on"].includes(r)||!["0","false","no","off"].includes(r)&&t:t}function s(e,t){if(t&&"object"==typeof t){if(Object.prototype.hasOwnProperty.call(t,"API_BASE_URL")&&null!=t.API_BASE_URL&&(e.API_BASE_URL=t.API_BASE_URL),Object.prototype.hasOwnProperty.call(t,"CDN_BASE_URL")&&null!=t.CDN_BASE_URL&&(e.CDN_BASE_URL=t.CDN_BASE_URL),Object.prototype.hasOwnProperty.call(t,"DEFAULT_LANG")&&t.DEFAULT_LANG&&(e.DEFAULT_LANG=t.DEFAULT_LANG),Object.prototype.hasOwnProperty.call(t,"LANG")&&t.LANG&&(e.DEFAULT_LANG=t.LANG),Object.prototype.hasOwnProperty.call(t,"MARKET_CSV_URL")&&t.MARKET_CSV_URL&&(e.MARKET_CSV_URL=t.MARKET_CSV_URL),Object.prototype.hasOwnProperty.call(t,"GW2_API_KEY")&&null!=t.GW2_API_KEY&&(e.GW2_API_KEY=t.GW2_API_KEY),Object.prototype.hasOwnProperty.call(t,"priceCacheStrategy")&&t.priceCacheStrategy?e.priceCacheStrategy=t.priceCacheStrategy:Object.prototype.hasOwnProperty.call(t,"PRICE_CACHE_STRATEGY")&&t.PRICE_CACHE_STRATEGY&&(e.priceCacheStrategy=t.PRICE_CACHE_STRATEGY),Object.prototype.hasOwnProperty.call(t,"FEATURE_USE_PRECOMPUTED")&&(e.FEATURE_USE_PRECOMPUTED=t.FEATURE_USE_PRECOMPUTED),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL")?e.FEATURE_MARKET_CSV_EXTERNAL=t.FEATURE_MARKET_CSV_EXTERNAL:Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_INTERNAL")&&(e.FEATURE_MARKET_CSV_EXTERNAL=!a(t.FEATURE_MARKET_CSV_INTERNAL,!0)),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL_WORKER")&&(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=t.FEATURE_MARKET_CSV_EXTERNAL_WORKER),Object.prototype.hasOwnProperty.call(t,"FEATURE_DONES_AGGREGATE")&&(e.FEATURE_DONES_AGGREGATE=t.FEATURE_DONES_AGGREGATE),Object.prototype.hasOwnProperty.call(t,"FEATURE_ITEM_API_ROLLOUT")&&(e.FEATURE_ITEM_API_ROLLOUT=t.FEATURE_ITEM_API_ROLLOUT),Object.prototype.hasOwnProperty.call(t,"PRECOMPUTED_CANARY_THRESHOLD")&&(e.PRECOMPUTED_CANARY_THRESHOLD=t.PRECOMPUTED_CANARY_THRESHOLD),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_MODE")&&"string"==typeof t.FETCH_GUARD_MODE&&(e.FETCH_GUARD_MODE=t.FETCH_GUARD_MODE),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_WHITELIST")){const r=t.FETCH_GUARD_WHITELIST;if(Array.isArray(r))e.FETCH_GUARD_WHITELIST=[...r];else if("string"==typeof r){const t=r.split(",").map(e=>e.trim()).filter(Boolean);e.FETCH_GUARD_WHITELIST=t}}if(Object.prototype.hasOwnProperty.call(t,"CONNECT_ALLOWLIST")&&Array.isArray(t.CONNECT_ALLOWLIST)&&(e.CONNECT_ALLOWLIST=[...t.CONNECT_ALLOWLIST]),Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANGS")){const r=t.FALLBACK_LANGS;Array.isArray(r)?e.FALLBACK_LANGS=[...r]:"string"==typeof r&&(e.FALLBACK_LANGS=r.split(",").map(e=>e.trim()).filter(Boolean))}else if(Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANG")){const r=t.FALLBACK_LANG;"string"==typeof r&&(e.FALLBACK_LANGS=r.split(",").map(e=>e.trim()).filter(Boolean))}if(Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_REPORT_URL")){const r=t.FETCH_GUARD_REPORT_URL;null!=r&&"string"!=typeof r||(e.FETCH_GUARD_REPORT_URL=r)}}}function l(){const e={...i,FETCH_GUARD_WHITELIST:[...i.FETCH_GUARD_WHITELIST],CONNECT_ALLOWLIST:[...i.CONNECT_ALLOWLIST]},t=("undefined"!=typeof globalThis?globalThis.window&&"object"==typeof globalThis.window?globalThis.window:globalThis.self&&"object"==typeof globalThis.self?globalThis.self:globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0)||("undefined"!=typeof globalThis?globalThis:void 0),r=t&&"object"==typeof t.Config?t.Config:null,n=t&&"object"==typeof t.__RUNTIME_CONFIG__?t.__RUNTIME_CONFIG__:null,o=t&&"object"==typeof t.__SECURE_RUNTIME_CONFIG__?t.__SECURE_RUNTIME_CONFIG__:null,l=function({legacy:e,runtime:t,secureRuntime:r,globalScope:n}){const o=[r&&(r.DEBUG_RUNTIME??r.DEBUG),t&&(t.DEBUG_RUNTIME??t.DEBUG),e&&(e.DEBUG_RUNTIME??e.DEBUG),n&&(n.__RUNTIME_DEBUG__??n.__DEBUG__)];for(const e of o)if(void 0!==e)return a(e,!1);if(n&&n.location&&"string"==typeof n.location.search){const e=String(n.location.search||"");if(e)try{const t=new URLSearchParams(e.startsWith("?")?e.slice(1):e),r=["debugRuntime","runtimeDebug","debug-config"];for(const e of r)if(t.has(e)){const r=t.get(e);return a(null==r||r,!0)}}catch(t){if(/[?&](debugRuntime|runtimeDebug|debug-config)(?:=|&|$)/i.test(e))return!0}}return!1}({legacy:r,runtime:n,secureRuntime:o,globalScope:t});s(e,r),s(e,n),s(e,o),e.FEATURE_USE_PRECOMPUTED=a(e.FEATURE_USE_PRECOMPUTED,i.FEATURE_USE_PRECOMPUTED),e.FEATURE_MARKET_CSV_EXTERNAL=a(e.FEATURE_MARKET_CSV_EXTERNAL,i.FEATURE_MARKET_CSV_EXTERNAL),e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=a(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER,i.FEATURE_MARKET_CSV_EXTERNAL_WORKER),e.FEATURE_ITEM_API_ROLLOUT=a(e.FEATURE_ITEM_API_ROLLOUT,i.FEATURE_ITEM_API_ROLLOUT);const c=Number(e.PRECOMPUTED_CANARY_THRESHOLD);e.PRECOMPUTED_CANARY_THRESHOLD=Number.isFinite(c)?Math.min(Math.max(c,0),100):i.PRECOMPUTED_CANARY_THRESHOLD;const u=Array.isArray(e.FALLBACK_LANGS)?e.FALLBACK_LANGS:"string"==typeof e.FALLBACK_LANGS?e.FALLBACK_LANGS.split(","):[];if(null!=e.CDN_BASE_URL&&""!==e.CDN_BASE_URL){const t=String(e.CDN_BASE_URL).trim().replace(/\/$/,"");e.CDN_BASE_URL=t}else e.CDN_BASE_URL="";const f=String(e.DEFAULT_LANG||i.DEFAULT_LANG).trim().toLowerCase();e.FALLBACK_LANGS=[...new Set(u.map(e=>"string"==typeof e?e.trim().toLowerCase():"").filter(e=>e&&e!==f))],e.LANG=e.DEFAULT_LANG||i.DEFAULT_LANG;const _=String(e.LANG||"").trim().toLowerCase();return e.FALLBACK_LANGS=e.FALLBACK_LANGS.filter(e=>e&&e!==_),function({debugMode:e,legacy:t,runtime:r,secureRuntime:n}){if(!e||"undefined"==typeof console||null===console)return;const o=new Date,i={legacyConfig:Boolean(t),runtimeConfig:Boolean(r),secureRuntimeConfig:Boolean(n),runtimeLoadedAt:r&&Object.prototype.hasOwnProperty.call(r,"__loadedAt")?r.__loadedAt:null,configInitializedAt:o.toISOString()};if(!r)return void console.warn("[runtime-config][debug] runtime-env.js was not available during config initialization.",i);if(!Object.prototype.hasOwnProperty.call(r,"__loadedAt"))return void console.warn('[runtime-config][debug] runtime-env.js missing "__loadedAt" marker; verify load order.',i);const a="string"==typeof r.__loadedAt?Date.parse(r.__loadedAt):Number.isFinite(r.__loadedAt)?Number(r.__loadedAt):Number.NaN;if(Number.isNaN(a))return void console.warn('[runtime-config][debug] runtime-env.js has an invalid "__loadedAt" timestamp.',i);const s=o.getTime()-a;i.runtimeLoadedDeltaMs=s,s<-50?console.warn("[runtime-config][debug] runtime-env.js appears to have executed after config.js. Ensure /runtime-env.js loads first.",i):console.info("[runtime-config][debug] runtime configuration applied successfully.",{...i,lang:r.LANG,flags:r.FLAGS})}({debugMode:l,legacy:r,runtime:n,secureRuntime:o}),e}const c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:null,u="__GW2_FETCH_GUARD_INSTALLED__";if(c&&"function"==typeof c.fetch&&!c[u]){const e=c.fetch;let t=f(c)||"http://localhost";const r=()=>{const e=f(c);e&&t!==e&&(t=e);const r=function(){try{return l()}catch{return null}}(),n=function(e){if("string"!=typeof e)return"off";const t=e.trim().toLowerCase();if(!t)return"off";const r=t.replace(/[_\s]+/g,"-");if(["off","disabled","disable","none","0","false"].includes(r))return"off";if(["enforce","block","blocked","deny","enforced","strict","on","true"].includes(r))return"enforce";if(["report-only","report","monitor","monitoring","warn","warning"].includes(r))return"report-only";return"off"}(r?.FETCH_GUARD_MODE),o=function(e){if("string"!=typeof e)return null;const t=e.trim();return t||null}(r?.FETCH_GUARD_REPORT_URL),i=function(e,t){const r=new Set,n=e=>{e&&(Array.isArray(e)?e.forEach(n):r.add(e))},o=e=>{if(e||0===e)if(Array.isArray(e))e.forEach(o);else if("string"!=typeof e)try{const r=p(String(e),t);n(r)}catch{}else e.split(",").forEach(e=>{const r=p(e.trim(),t);n(r)})},i=[e?.API_BASE_URL,e?.MARKET_CSV_URL,"/api","api","/backend/api","backend/api","/recipe-tree","https://api.guildwars2.com","https://api.datawars2.ie"],a=e?.FETCH_GUARD_WHITELIST,s=function(e){if(Array.isArray(e))return e.length>0;if(null==e)return!1;if("string"==typeof e)return e.split(",").some(e=>e.trim());return!0}(a);o(i),o(a),o(e?.fetchGuardWhitelist),o(e?.fetchWhitelist),o(e?.FETCH_WHITELIST),s||o(e?.CONNECT_ALLOWLIST);return Array.from(r)}(r,e);return{mode:n,reportUrl:o,whitelist:i,locationOrigin:e}},n=(e,r,n)=>{if("off"===n.mode)return;const o=`[fetchGuard] ${e}: ${r}`;try{"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(o)}catch{}if(!n.reportUrl)return;let i;try{i=JSON.stringify({source:"fetchGuard",reason:e,targetUrl:r,mode:n.mode,timestamp:Date.now(),locationOrigin:n.locationOrigin})}catch{i=null}if(i){try{if("function"==typeof c.navigator?.sendBeacon)return void c.navigator.sendBeacon(n.reportUrl,i)}catch{}try{if("function"==typeof c.Image){const e=encodeURIComponent(i),r=function(e,t,r){if(!e)return null;try{const n=new URL(e,r);return n.searchParams.append("payload",t),n.href}catch{try{const r=e.includes("?")?"&":"?";return`${e}${r}payload=${t}`}catch{return null}}}(n.reportUrl,e,t);if(!r)return;const o=new c.Image;try{"referrerPolicy"in o&&(o.referrerPolicy="no-referrer")}catch{}const a=function(e){const t="__FETCH_GUARD_REPORT_IMAGES__";if(!e[t])try{Object.defineProperty(e,t,{value:new Set,configurable:!0,enumerable:!1,writable:!1})}catch{e[t]=new Set}return e[t]}(c);a.add(o);const s=()=>a.delete(o);try{o.onload=s,o.onerror=s}catch{}o.src=r}}catch{}}},o=function(o,i){const a=r(),s=function(e,t){if(!e&&""!==e)return null;const r=e=>{try{return new URL(e,t)}catch{return null}};if("undefined"!=typeof URL)try{if(e instanceof URL)return e}catch{}if("undefined"!=typeof Request)try{if(e instanceof Request)return r(e.url)}catch{}if("string"==typeof e)return r(e);if(e&&"string"==typeof e.url)return r(e.url);return null}(o,t);if(!s||"off"===a.mode||function(e,t){if(!e)return!1;const r="string"==typeof e.hostname?e.hostname.toLowerCase():"",n="string"==typeof e.origin?e.origin:"";let o="";if(n&&"null"!==n)try{o=new URL(n).hostname.toLowerCase()}catch{const e=n.toLowerCase(),t=e.indexOf("://");o=t>=0?e.slice(t+3):e}for(const n of t)switch(n.type){case"wildcard":return!0;case"origin":if(e.origin===n.value)return!0;break;case"href":if(e.href.startsWith(n.value))return!0;break;case"hostname":if(r===n.value)return!0;if(o&&o===n.value)return!0;break;case"hostname-pattern":if(d(r,n.value))return!0;if(d(o,n.value))return!0;break;case"pathname":if(e.pathname.startsWith(n.value))return!0}return!1}(s,a.whitelist))return e.call(this,o,i);let l;var c;c=s,l=c?.pathname.includes("/backend/")?"Legacy backend fetch detected":function(e,t){return!!e&&(!!t&&("null"!==e.origin&&e.origin!==t))}(s,a.locationOrigin)?"External fetch detected":"Blocked fetch detected";const u=function(e,t){if(e?.href)return e.href;if("string"==typeof t)return t;if(t&&"string"==typeof t.url)return t.url;return"unknown target"}(s,o);return n(l,u,a),"enforce"===a.mode?Promise.reject(function(e,t){const r=new Error(`[fetchGuard] ${e}: ${t}`);return r.name="FetchGuardError",r.reason=e,r.url=t,r}(l,u)):e.call(this,o,i)};o.originalFetch=e,c.fetch=o,c[u]=!0}function f(e){if(!e||"object"!=typeof e)return;const t=e.location&&"object"==typeof e.location?e.location:null,r=_(t?.origin);if(r)return r;const n=_(e.origin),o=function(e,t){if("string"!=typeof e)return null;const r=e.trim();if(!r)return null;try{return _(new URL(r).origin)}catch{if(!t)return null;try{return _(new URL(r,t).origin)}catch{return null}}}(t?.href,n);return o||(n||void 0)}function _(e){if("string"!=typeof e)return null;const t=e.trim();return t&&"null"!==t.toLowerCase()?t:null}function p(e,t){if(!e)return null;const r=e.trim();if(!r)return null;const n=r.replace(/^['"]|['"]$/g,"");if(!n)return null;const o=n.toLowerCase();if("self"===o){const e=_(t);return e?{type:"origin",value:e}:{type:"pathname",value:"/recipe-tree"}}if("*"===o)return{type:"wildcard"};if(/^\*\.[^*]+/.test(n)){const e=n.slice(2).toLowerCase();return e?{type:"hostname-pattern",value:e}:null}if(n.startsWith("//"))try{return{type:"origin",value:new URL(n,t||"http:").origin}}catch{return null}if(/^[a-zA-Z]+:\/\//.test(n))try{const e=new URL(n);return n.endsWith("/"),{type:"href",value:e.href}}catch{return null}if(n.startsWith("/"))return{type:"pathname",value:n};if(n.includes("://"))try{return{type:"href",value:new URL(n).href}}catch{return null}return n.includes(".")?{type:"hostname",value:n.toLowerCase()}:{type:"pathname",value:n.startsWith("/")?n:`/${n}`}}function d(e,t){if(!e||!t)return!1;const r=e.toLowerCase(),n=t.toLowerCase().replace(/^\.+/,"");return!!n&&(r===n||r.endsWith(`.${n}`))}const E=[];function A(){const e=Date.now()-6e4;for(;E.length&&E[0]<e;)E.shift()}function y(){A();const e=E.length;return e>5?"down":e>0?"slow":"ok"}let g;function R(){if("undefined"==typeof document)return;const e=y();g||(g=document.createElement("div"),g.id="api-status-indicator",g.style.position="fixed",g.style.bottom="10px",g.style.right="10px",g.style.padding="4px 8px",g.style.background="rgba(0,0,0,0.7)",g.style.color="#fff",g.style.borderRadius="4px",g.style.zIndex="10000",g.style.display="none",document.body.appendChild(g)),"ok"===e?g.style.display="none":(g.textContent="slow"===e?"API lenta":"API caída",g.style.display="block")}var h={recordFailure:function(){E.push(Date.now()),A(),R()},recordSuccess:function(){A(),R()},getState:y,getBackoff:function(){const e=y();return"down"===e?5e3:"slow"===e?1e3:0}};async function T(e,t={}){const{timeout:r=8e3,retries:n=3,backoff:o=300,signal:i,...a}=t;for(let t=0;t<=n;t++){const s=new AbortController,l=setTimeout(()=>s.abort(),r);i&&(i.aborted?s.abort():i.addEventListener("abort",()=>s.abort(),{once:!0}));try{const t=await fetch(e,{...a,signal:s.signal});return clearTimeout(l),h.recordSuccess(),t}catch(e){if(clearTimeout(l),h.recordFailure(),i?.aborted||t===n)throw e;const r=o*Math.pow(2,t);await new Promise(e=>setTimeout(e,r))}}}const L=new Map;!function(e){n=e,r&&r.addEventListener("message",({data:e})=>{const{type:t,key:o,entry:i}=e||{};if("request-bundles"!==t)t&&o&&("set"===t&&i?n.set(o,i):"delete"===t&&n.delete(o));else{if(!n)return;n.forEach((e,t)=>{t.startsWith("bundle_")&&r.postMessage({type:"set",key:t,entry:e})})}})}(L),r&&r.postMessage({type:"request-bundles"});const w="undefined"!=typeof localStorage;function m(e){try{return JSON.parse(e)}catch{return null}}function S(e,t){if(w)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:r,lastModified:n,lang:o,source:i,fallback:a}){return JSON.stringify({value:e,expiresAt:t,etag:r,lastModified:n,lang:o,source:i,fallback:a})}(t))}catch{}}function b(e,n,o=void 0,i={}){if(void 0===o){const r=e.split("_")[0];o=t[r]}const a=null==o?null:Date.now()+o,{etag:s=null,lastModified:l=null,lang:c=null,source:u=null,fallback:f=null}=i,_={value:n,expiresAt:a,updatedAt:(new Date).toISOString(),etag:s,lastModified:l,lang:c,source:u,fallback:f};L.set(e,_),S(e,{value:n,expiresAt:a,etag:s,lastModified:l,lang:c,source:u,fallback:f}),function(e,t){r&&r.postMessage({type:"set",key:e,entry:t})}(e,_)}function U(e,t=!1){let r=L.get(e);if(!r){const t=function(e){if(!w)return null;const t=localStorage.getItem(e);if(!t)return null;const r=m(t);return r||(localStorage.removeItem(e),null)}(e);if(t){const{value:n,expiresAt:o=null,etag:i=null,lastModified:a=null,lang:s=null,source:l=null,fallback:c=null}=t;r={value:n,expiresAt:o,updatedAt:(new Date).toISOString(),etag:i,lastModified:a,lang:s,source:l,fallback:c},L.set(e,r)}}return r?r.expiresAt&&Date.now()>r.expiresAt?(L.delete(e),w&&localStorage.removeItem(e),o(e),null):t?r:r.value:null}!function(){if(!w)return;const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t),n=m(localStorage.getItem(r));if(!n)continue;const{expiresAt:o}=n;o&&Date.now()>o&&e.push(r)}e.forEach(e=>{localStorage.removeItem(e),o(e)})}();const C=new Map;function O(e,t={},r=null,n=null,o){const i=C.get(e);i&&i.controller?.abort(),r&&!n&&(n=U(r,!0));const a={...t.headers||{}};n?.etag&&(a["If-None-Match"]=n.etag),n?.lastModified&&(a["If-Modified-Since"]=n.lastModified);const s=o?null:new AbortController,l=o??t.signal??s?.signal;return function(e,t,r){return C.set(e,{promise:t,controller:r}),t.finally(()=>C.delete(e)),t}(e,T(e,{...t,headers:a,signal:l}).then(async e=>304===e.status&&n?new Response(JSON.stringify(n.value),{status:200,headers:{"X-Cache":"HIT",ETag:n.etag||"","Last-Modified":n.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),s).then(e=>e.clone())}const N=Object.prototype.hasOwnProperty;function I(e){return null==e?[]:Array.isArray(e)?e:[e]}function F(e,t){const r=e&&"object"==typeof e&&!Array.isArray(e)?{...e}:{errors:[]};Array.isArray(r.errors)||(r.errors=I(r.errors));const n=function(e,t){if(e&&"string"==typeof e.traceId&&e.traceId)return e.traceId;if(t&&"object"==typeof t&&!Array.isArray(t)){if("string"==typeof t.traceId&&t.traceId)return t.traceId;const e=t.meta&&"object"==typeof t.meta?t.meta.traceId:null;if("string"==typeof e&&e)return e}return null}(r,t);return n?r.traceId=n:N.call(r,"traceId")||(r.traceId=null),r}function P(e,t,r){return{data:e,meta:F(t,r)}}function D(e){if(null==e)return P(null,{errors:[]},e);if("object"!=typeof e||e instanceof Response)return P(e,{errors:[]},e);if(Array.isArray(e))return P(e,{errors:[]},e);if(N.call(e,"data")){const t=N.call(e,"meta")&&"object"==typeof e.meta?{...e.meta,errors:I(e.meta?.errors)}:{errors:[]};return P(e.data,t,e)}if(N.call(e,"meta")){return P(null,"object"==typeof e.meta?{...e.meta,errors:I(e.meta?.errors)}:{errors:[]},e)}const{errors:t,...r}=e;return P(r,{errors:I(t)},e)}const v=new Map;function M(){return"sessionStorage"===function(){const e=l();return e?.priceCacheStrategy||"sessionStorage"}()}function G(e){return`price_${e}`}function B(e){if(!M()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(G(e));if(!t)return null;try{const{value:r,expires:n}=JSON.parse(t);return n&&Date.now()>n?(sessionStorage.removeItem(G(e)),null):r}catch{return sessionStorage.removeItem(G(e)),null}}async function j(e){if(!Array.isArray(e)||0===e.length)return new Map;const t=l();if("redis"===(t?.priceCacheStrategy||"sessionStorage")){const t=`/backend/api/itemBundle.php?ids=${e.join(",")}`,r=await fetch(t);if(!r.ok)throw new Error("Price fetch failed");const n=await r.json().catch(()=>null),{data:o,meta:i}=D(n),a=Array.isArray(o)?o:[];!Array.isArray(o)&&Array.isArray(i?.errors)&&i.errors.length&&console.warn("itemBundle precios devolvió errores",i.errors);const s=new Map;return a.forEach(e=>{const t=e.market||{};s.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),s}{const r=["id","buy_price","sell_price"].join(","),n=Boolean(t?.FEATURE_MARKET_CSV_EXTERNAL)?t?.MARKET_CSV_URL||"https://api.datawars2.ie/gw2/v1/items/csv":function(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,""),n=String(t).replace(/^\/+/,"");return r?n?`${r}/${n}`:r||"/":n?`/${n}`:"/"}(t?.API_BASE_URL||"/api","/market.csv"),o=new URLSearchParams;o.set("fields",r),o.set("ids",e.join(","));const i=`${n}?${o.toString()}`,a=await fetch(i);if(!a.ok)throw new Error("Price fetch failed");const s=(await a.text()).trim().split("\n"),l=s[0].split(","),c=new Map;for(let e=1;e<s.length;e++){if(!s[e])continue;const t=s[e].split(","),r={};l.forEach((e,n)=>{const o=t[n];r[e]=void 0!==o?isNaN(o)?o:Number(o):null}),null!=r.id&&c.set(r.id,{buy_price:r.buy_price||0,sell_price:r.sell_price||0})}return c}}async function k(e=[]){const t=new Map,r=[];if(e.forEach(e=>{if(e=Number(e),v.has(e))return void t.set(e,v.get(e));const n=B(e);n?(v.set(e,n),t.set(e,n)):r.push(e)}),r.length)try{(await j(r)).forEach((e,r)=>{v.set(r,e),function(e,t){if(M()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(G(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(r,e),t.set(r,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!t.has(e)&&v.has(e)&&t.set(e,v.get(e)),t.has(e)||t.set(e,{buy_price:0,sell_price:0})}),t}const K=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function H(e){if(null==e)return null;const t=Number(e);return Number.isFinite(t)?t:null}function W(e){return K(e)?{...e}:null}function $(e){const t=W(e),r=function(e){const t=H(e?.unitBuyPrice??e?.unit_buy_price),r=H(e?.unitSellPrice??e?.unit_sell_price);return{buy:t??H(e?.buy_price??e?.buyPrice??e?.buys?.unit_price),sell:r??H(e?.sell_price??e?.sellPrice??e?.sells?.unit_price)}}(e||{}),n=function(e){return{buy:H(e?.buy??e?.totalBuy??e?.total_buy),sell:H(e?.sell??e?.totalSell??e?.total_sell),crafted:H(e?.crafted??e?.totalCrafted??e?.total_crafted)}}(e||{}),o=Number.isFinite(r.buy)||Number.isFinite(r.sell),i=Number.isFinite(n.buy)||Number.isFinite(n.sell)||Number.isFinite(n.crafted);return{unit:r,totals:n,raw:t,hasData:Boolean(o||i),source:"string"==typeof e?.source?e.source:null,updatedAt:e?.lastChanged??e?.last_changed??e?.lastUpdated??e?.updatedAt??null}}const x=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function V(e){const t=x(e)?e:{},r=function(e){const t=W(e)||{};return t.stale="boolean"==typeof e?.stale&&e.stale,t.lang="string"==typeof e?.lang?e.lang:"es",t}(t.meta),n=x(t.data)?t.data:t,o=function(e){return Array.isArray(e)?e.filter(K).map(e=>({...e})):K(e)?[{...e}]:[]}(n.recipes??n.recipe??n);return{recipes:o,primary:o.length>0?o[0]:null,meta:r}}function X(e){return $(e)}let Y=null,J=null;function z(e){if("string"!=typeof e)return null;const t=e.trim();return t?t.toLowerCase():null}function q(){try{const e=l(),t=z(e?.LANG);if(t)return t;const r=z(e?.DEFAULT_LANG);if(r)return r}catch(e){}return"es"}function Z(e,t){if(e&&"function"==typeof e.postMessage&&t)try{e.postMessage({type:"setLang",lang:t})}catch(e){}}function Q(e=q()){const t=z(e);t&&t!==Y&&("undefined"!=typeof navigator&&navigator?.serviceWorker&&(Z(navigator.serviceWorker.controller,t),("undefined"!=typeof navigator&&navigator?.serviceWorker?(J||(J=navigator.serviceWorker.ready.then(e=>e?.active??null).catch(()=>null)),J):Promise.resolve(null)).then(e=>{e&&Z(e,t)})),Y=t)}function ee(e,t={}){const r=q();Q(r);const n=function(e,t){if(!t)return e;try{const r=/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e),n=r?void 0:"undefined"!=typeof window&&window?.location?.origin?window.location.origin:"http://localhost",o=new URL(e,n);return o.searchParams.has("lang")||o.searchParams.set("lang",t),r?o.toString():`${o.pathname}${o.search}${o.hash}`}catch(t){return e}}(e,r),{headers:o,...i}=t||{},a=function(e,t){if(!t)return e||void 0;const r=new Headers(e||void 0);return r.has("Accept-Language")||r.set("Accept-Language",t),r.set("X-Client-Language",t),r}(o,r);return{url:n,options:a?{...i,headers:a}:{...i},lang:r}}function te(e,t){return`bundle_${"string"==typeof t&&t?t:q()}_${e}`}function re(e,t){if("undefined"==typeof window||!window)return;Array.isArray(window.__bundleFallbacks__)||(window.__bundleFallbacks__=[]);const r=t&&t.message?t.message:String(t||"")||"unknown",n={ids:Array.isArray(e)?e.map(e=>String(e)):[],message:r,timestamp:(new Date).toISOString()};window.__bundleFallbacks__.push(n),window.__bundleFallbacks__.length>50&&window.__bundleFallbacks__.shift(),window.__lastBundleFallback__=n}function ne(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,""),n=String(t).replace(/^\/+/,"");return r?n?`${r}/${n}`:r||"/":`/${n}`}function oe(e,t,r){const{data:n,meta:o}=D(e),i=Array.isArray(n)?n:[];return!Array.isArray(n)&&Array.isArray(o?.errors)&&o.errors.length&&console.warn("dataBundle devolvió errores",o.errors),i.length&&i.forEach(e=>{const n=String(e.id),o=te(n,r),i={recipe:V({data:e?.recipe??null}),prices:X(e?.market??null)},a={...e,adapters:i};t.set(n,a),b(o,a,void 0,{lang:r}),"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"function"==typeof CustomEvent&&window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:a}))}),i.length>0}async function ie(e=[]){if(!Array.isArray(e)||0===e.length)return[];const t=q(),r=new Map,n=[];if(e.forEach(e=>{const o=String(e),i=U(te(o,t));i?r.set(o,i):n.push(o)}),n.length>0){const{API_BASE_URL:e,FEATURE_ITEM_API_ROLLOUT:o}=l(),i=Boolean(o);for(let o=0;o<n.length;o+=35){const a=n.slice(o,o+35),s=a.map(e=>`ids[]=${e}`).join("&");let l=!1;if(i){const{url:n,options:o}=ee(`${ne(e,"/items/bundle")}?${s}`);try{const e=await T(n,o);if(!e.ok)throw new Error(`Respuesta ${e.status} inválida en bundle API`);const i=await e.json().catch(()=>null);if(!i)throw new Error("Payload JSON no válido en bundle API");oe(i,r,t),l=!0}catch(e){l=!1,console.warn("Fallo en bundle API, usando PHP como fallback",e),re(a,e)}}if(!i||!l)try{const{url:e,options:n}=ee(`/backend/api/dataBundle.php?${s}`),o=await T(e,n);if(o.ok){oe(await o.json().catch(()=>null),r,t)}else console.error("Error en getItemBundles: respuesta no válida")}catch(e){console.error("Error en getItemBundles:",e)}a.forEach(e=>{const t=String(e);r.has(t)||r.set(t,null)})}}return e.map(e=>{const t=String(e);return r.get(t)||null})}async function ae(e){const t=Array.isArray(e)?e:[e],r=await ie(t);if(Array.isArray(e))return r.map(e=>e?.recipe?[e.recipe]:[]);const n=r[0]?.recipe;return n?[n]:[]}async function se(e){const t=q(),r=function(e,t){return`recipe_${"string"==typeof t&&t?t:q()}_${e}`}(e,t),n=U(r,!0);try{const{API_BASE_URL:o}=l(),{url:i,options:a}=ee(`${o}/recipes/${e}`),s=await O(i,a,r,n);if(!s.ok)return null;const c=await s.json();if(!c)return null;c.lastUpdated=(new Date).toISOString();const u=s.headers.get("ETag");return b(r,c,void 0,{etag:u,lastModified:s.headers.get("Last-Modified"),lang:t}),c}catch(e){return console.error("Error en getRecipeDetails:",e),null}}async function le(e){if(Array.isArray(e)){return(await ie(e)).map(e=>e?.item||null)}const t=await ie([e]);return t[0]?.item||null}async function ce(e){if(Array.isArray(e)){const t=await k(e);return e.map(e=>{const r=t.get(e)||{};return{buys:{unit_price:r.buy_price||0},sells:{unit_price:r.sell_price||0}}})}const t=await async function(e){if(e=Number(e),v.has(e))return v.get(e);const t=B(e);return t?(v.set(e,t),t):(await k([e])).get(e)}(e);return{buys:{unit_price:t?.buy_price||0},sells:{unit_price:t?.sell_price||0}}}const ue={getItemBundles:ie,getRecipesForItem:ae,getRecipeDetails:se,getItemDetails:le,getItemPrices:ce};function fe(e=("undefined"!=typeof window?window:void 0)){if(!e)return ue;const t={...e.RecipeService||{},...ue};return e.RecipeService=t,Object.entries(ue).forEach(([t,r])=>{"function"!=typeof e[t]&&(e[t]=r)}),t}"undefined"!=typeof window&&fe(window);return fe("undefined"!=typeof window?window:void 0),e.getItemBundles=ie,e.getItemDetails=le,e.getItemPrices=ce,e.getRecipeDetails=se,e.getRecipesForItem=ae,e.registerRecipeServiceGlobals=fe,e}({});
