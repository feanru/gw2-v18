import{i as e,v as t,w as r,x as n,y as o,t as a,z as i,A as l,B as s,n as c,C as d,D as u,b as w}from"./utils.min.js";import{g as m}from"./config.min.js";import"./services.min.js";let g,p,f,y,_,b,h,E,k,A,S;const I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0;let P;async function T(){return P||(P=Promise.all([import("./items-core.min.js"),import("./utils.min.js").then(function(e){return e.a1}),import("./services.min.js"),import("./utils.min.js").then(function(e){return e.a2})]).then(([e,t,r,n])=>{({prepareIngredientTreeData:g,CraftIngredient:p,setIngredientObjs:f,setTotalsFromAggregate:y,findIngredientsById:_,cancelItemRequests:b,recalcAll:h}=e),({preloadPrices:A,getPrice:S}=t),({getItemBundles:E}=r),({update:k}=n),"undefined"==typeof window||window.RecipeService||console.error("Servicios de recetas no disponibles: window.RecipeService no está definido.")})),P}let v=0,R=null,B=null;function F(){if(R){try{R()}catch(e){console.warn("Error deteniendo actualizador de precios",e)}R=null}}async function j(e){if(!Array.isArray(e)||0===e.length)return[];await T();try{return await E(e)}catch(e){return console.error("Error cargando ítems",e),[]}}async function C(e,t,c,d={}){r(),window.hideError?.();let w=!1;const{bucket:m=null}=d||{},g=()=>n(),p=g();let _=null;const b=R;let h=!1;const E=()=>{if(!h&&(h=!0,b)){try{b()}catch(e){console.warn("Error deteniendo actualizador previo",e)}R===b&&(R=null)}},A=async(r,n,o)=>{if(w)return;w=!0;const i=n?.stale??_?.stale??null;E(),F(),function(e,t=null,r=null,n=null){const o={reason:e||"unknown",meta:t?{...t}:null,stale:Boolean(t?.stale),error:r?String(r?.message||r):void 0,timestamp:(new Date).toISOString()};if("function"==typeof k)try{k("aggregate-fallback",o)}catch(e){console.warn("No se pudo registrar el fallback en el estado",e)}I&&(Array.isArray(I.__aggregateFallbacks__)||(I.__aggregateFallbacks__=[]),I.__aggregateFallbacks__.push(o),I.__lastAggregateFallback__=o),a({type:"aggregateFallback",bucket:n,meta:{stale:o.stale,reason:o.reason},error:o.error})}(r,n,o,m),await O(e,t,c,{bucket:m,fromFallback:!0,fallbackReason:r,stale:i})};try{window.showSkeleton?.(t),B=new AbortController;const r=function(){const e=I?.__TEST_FETCH_ITEM_AGGREGATE__;return"function"==typeof e?e:u}(),n=await r(e,{signal:B.signal});if(304===n?.status&&n.fromCache)return _=n.meta||null,window.hideSkeleton?.(t),o(n.meta),void a({type:"aggregateNotModified",bucket:m,meta:{stale:n.meta?.stale??null}});E(),F();const d=i(n),{item:w,market:b,tree:h,meta:k}=d;if(_=k||null,c!==v)return;if(!w)return void await A("missing-item",k);if((Array.isArray(k?.errors)?k.errors.filter(Boolean):[]).length)return void await A("meta-errors",k);const S=l(h);f(S?[S]:[]),y(b);const P=b?.unitBuyPrice??S?.buy_price??0,T=b?.unitSellPrice??S?.sell_price??0;window._mainBuyPrice=P||0,window._mainSellPrice=T||0,window._mainRecipeOutputCount=S?.recipe?.output_item_count||S?.output||1,await window.initItemUI(w,{buy_price:window._mainBuyPrice,sell_price:window._mainSellPrice}),await(window.safeRenderTable?.()),window.hideSkeleton?.(t),o(k);const R=g()-p;s({bucket:m,stale:k?.stale??null,duration:R}),a({type:"aggregateSuccess",bucket:m,metrics:{durationMs:R},meta:{stale:k?.stale??null}})}catch(e){if("AbortError"===e?.name)return;if(E(),window.hideSkeleton?.(t),console.error("Error cargando agregado de ítem",e),window.showError?.("No se pudo cargar el agregado del ítem."),r(),c!==v)return;a({type:"aggregateError",bucket:m,meta:{stale:_?.stale??null},error:String(e?.message||e)}),await A("aggregate-error",_,e)}}async function O(e,t,n,o={}){await T(),r(),window.hideError?.();let i=null,l=null;const s=function(){const e=I?.__TEST_FETCH_WITH_RETRY__;return"function"==typeof e?e:w}(),{bucket:u=null,fromFallback:y=!1,fallbackReason:b=null,stale:h=null}=o||{};a({type:"legacyLoadStart",bucket:u,meta:{fromFallback:Boolean(y),fallbackReason:b,aggregateStale:h}});try{window.showSkeleton?.(t),B=new AbortController;const{API_BASE_URL:r,FEATURE_ITEM_API_ROLLOUT:o}=m(),w=Boolean(o);let h=null,E=null;if(w){const t=function(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,"");return`${r?`${r}/items`:"/items"}/${String(t).trim()}`}(r,e);try{const e=await s(t,{signal:B.signal});if(404===e.status)console.warn("Item API devolvió 404, usando fallback PHP");else{if(!e.ok)throw new Error(`Error ${e.status} obteniendo detalles del ítem desde API`);{const t=e.headers.get("content-type")||"";if(!t.includes("application/json"))throw new Error(`Respuesta no válida: ${t}`);const r=await e.json().catch(()=>null);if(!r)throw new Error("Payload JSON no válido en item API");h=e,E=r}}}catch(e){if("AbortError"===e?.name)throw e;console.warn("Fallo en item API, usando PHP como fallback",e),h=null,E=null}}if(!h){if(h=await s(`/backend/api/itemDetails.php?itemId=${e}`,{signal:B.signal}),404===h.status)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(t);if(!h.ok)throw new Error(`Error ${h.status} obteniendo detalles del ítem`);const r=h.headers.get("content-type")||"";if(!r.includes("application/json"))throw new Error(`Respuesta no válida: ${r}`);E=await h.json().catch(()=>null)}const{data:A,meta:I}=c(E);a({type:"legacyLoad",bucket:u,meta:{stale:I?.stale??null,fromFallback:Boolean(y),fallbackReason:b}});const P=A?.item||null,T=A?.recipe||null,F=A?.market||null,j=A?.nested_recipe||null;if(!P){const e=I?.errors?.[0]||"El ítem no existe";return window.showError?.(e),void window.hideSkeleton?.(t)}if(n!==v)return;if(l=Array.isArray(F)||!F?{}:{...F},Array.isArray(F)||null==l.buy_price||null==l.sell_price)try{const t=await S(e);t&&(l={...l,...t})}catch(e){console.warn("No se pudo recuperar el precio de respaldo",e)}if(l.buy_price=l.buy_price??0,l.sell_price=l.sell_price??0,window._mainBuyPrice=l.buy_price,window._mainSellPrice=l.sell_price,!T)return f([]),void window.initItemUI(P,l);T&&j&&(T.nested_recipe=j),window._mainRecipeOutputCount=T.output_item_count||1,setTimeout(async()=>{if(n!==v)return;let t;try{t=await g(e,T)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),f([]),void window.initItemUI(P,l)}Array.isArray(t)||(t=[]);const r=Array.isArray(T?.ingredients)&&T.ingredients.length>0&&0===t.length;let o=null;if(r){const e="No se pudo construir el árbol de ingredientes. Mostrando el ítem sin receta.";o="Sin receta disponible (no se pudo procesar la receta).",window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(e,"error"):console.warn(e)}i=new p({id:P.id,name:P.name,icon:P.icon,rarity:P.rarity,count:1,buy_price:l?.buy_price||0,sell_price:l?.sell_price||0,is_craftable:!r,recipe:r?null:T,children:r?[]:t}),i.recalc(window.globalQty||1,null),f([i]),await window.initItemUI(P,l),await(window.safeRenderTable?.()),o&&window.showError?.(o);const a=new Set;!function e(t,r){r.add(t.id),t.children&&t.children.forEach(t=>e(t,r))}(i,a),R&&R();const s=Array.from(a),c=async e=>{if(!document.getElementById("seccion-crafting"))return void requestAnimationFrame(()=>c(e));const t=[];e.forEach((e,r)=>{const n=_(window.ingredientObjs,Number(r));n.length&&n.forEach(r=>{r.buy_price=e.buy_price||0,r.sell_price=e.sell_price||0,r===window.ingredientObjs[0]&&(window._mainBuyPrice=r.buy_price,window._mainSellPrice=r.sell_price),t.push(r)})}),await(window.safeRenderTable?.());const r=window.getTotals?.();r&&(k("totales-crafting-global",r),k("totales-crafting-unit",r)),t.forEach(e=>k(e._uid,e))};R=d(s,c)},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(t),a({type:"legacyError",bucket:u,meta:{fromFallback:Boolean(y),fallbackReason:b},error:String(e?.message||e)})}finally{B=null}}async function U(r,n={}){await T();const o=++v;if(B&&(B.abort(),B=null),b(),!r)return window.hideSkeleton?.(document.getElementById("item-skeleton")),void window.showError?.("ID de ítem no válido");const a=document.getElementById("item-skeleton"),i=e("usePrecomputed"),{PRECOMPUTED_CANARY_THRESHOLD:l}=m(),s=t(),c=s<l,d=!0===n?.forceLegacy;i&&c&&!d?await C(r,a,o,{bucket:s}):await O(r,a,o,{bucket:s,fromFallback:Boolean(d)})}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),t=parseInt(e.get("id"),10);t?U(t):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{U as loadItem,O as loadItemLegacy,j as loadItems};
