import{g as t}from"../config.min.js";import{n as e}from"../utils.min.js";import"../services.min.js";function n(t,e){const n=("string"==typeof t?t.trim():"").replace(/\/+$/,""),r=String(e||"").replace(/^\/+/,"");return n?r?`${n}/${r}`:n||"/":r?`/${r}`:"/"}function r(t){if(!t)return[];if(Array.isArray(t))return t;if(Array.isArray(t?.data))return t.data;if(t?.data&&"object"==typeof t.data)return Object.values(t.data).filter(t=>null!=t);const n=e(t);return Array.isArray(n.data)?n.data:[]}function i(t,e){if(!t||"function"!=typeof t.set)return 0;const n=r(e);let i=0;return n.forEach(e=>{e&&"number"==typeof e.id&&(t.set(e.id,e),i+=1)}),i}function s(t,e){if(!t||"function"!=typeof t.set)return 0;const n=r(e);let i=0;return n.forEach(e=>{if(!e)return;const n=Number.isFinite(e.id)?e.id:Number.parseInt(e.id,10);if(!Number.isInteger(n)||n<=0)return;const r=e.buy_price??e.buys?.unit_price??null,s=e.sell_price??e.sells?.unit_price??null;t.set(n,{id:n,buy_price:Number.isFinite(r)?r:null,sell_price:Number.isFinite(s)?s:null}),i+=1}),i}const a={FETCH_GUARD_MODE:"enforce",FETCH_GUARD_WHITELIST:["self","/recipe-tree","https://www.google-analytics.com","https://region1.google-analytics.com","https://www.googletagmanager.com"],FETCH_GUARD_REPORT_URL:null,CONNECT_ALLOWLIST:[]};let o,c,l=null,u=!1;function p(t){const e=t&&"object"==typeof t?t:{},n=function(t){const e=new Set,n=t=>{t&&e.add(t)},r=t=>{if(null!=t)if(Array.isArray(t))t.forEach(r);else if("string"!=typeof t)try{n(String(t))}catch{}else t.split(",").map(t=>t.trim()).filter(Boolean).forEach(n)};return r(a.FETCH_GUARD_WHITELIST),r(t),Array.from(e)}(e.FETCH_GUARD_WHITELIST),r={...e,FETCH_GUARD_MODE:"string"==typeof e.FETCH_GUARD_MODE?e.FETCH_GUARD_MODE:a.FETCH_GUARD_MODE,FETCH_GUARD_WHITELIST:n,FETCH_GUARD_REPORT_URL:Object.prototype.hasOwnProperty.call(e,"FETCH_GUARD_REPORT_URL")?e.FETCH_GUARD_REPORT_URL:a.FETCH_GUARD_REPORT_URL,CONNECT_ALLOWLIST:Array.isArray(e.CONNECT_ALLOWLIST)?[...e.CONNECT_ALLOWLIST]:[...a.CONNECT_ALLOWLIST]};self.__RUNTIME_CONFIG__={...self.__RUNTIME_CONFIG__||{},...r},u=!0}function f(){return l||(l=Promise.all([import("../utils.min.js").then(function(t){return t.a0}),import("../utils.min.js").then(function(t){return t._})]).then(([t,e])=>{const n="undefined"!=typeof self&&self?.__TEST_OVERRIDES__?self.__TEST_OVERRIDES__:null;o=n?.fetchWithCache||t.fetchWithCache,c=n?.normalizeApiResponse||e.normalizeApiResponse})),l}function _(t,e,n,r=null){if(!t)return null;const i=e.get(t.id);if(!i)return null;const s=n.get(t.id)||{},a=Array.isArray(t.components)&&t.components.length>0;let o=[];return a&&(o=t.components.map(t=>{if("Recipe"===t.type)return _(t,e,n,i.id);if("Item"===t.type){const r=e.get(t.id);if(!r)return null;const s=n.get(t.id)||{};return{id:r.id,name:r.name,icon:r.icon,rarity:r.rarity,count:t.quantity,buy_price:s.buy_price??null,sell_price:s.sell_price??null,crafted_price:null,is_craftable:!1,recipe:null,children:[],_parentId:i.id}}return null}).filter(Boolean)),{id:i.id,name:i.name,icon:i.icon,rarity:i.rarity,count:t.quantity,buy_price:s.buy_price??null,sell_price:s.sell_price??null,crafted_price:null,is_craftable:a,recipe:t.recipe||null,children:o,_parentId:r}}function m(t,e){if(!t||"object"!=typeof t)return{id:null,output_item_id:e??null,output_item_count:1,ingredients:[]};const n=Array.isArray(t.ingredients)?t.ingredients.map(t=>({item_id:t?.item_id??null,count:t?.count??0})):[];return{id:t.id??null,output_item_id:t.output_item_id??e??null,output_item_count:t.output_item_count??1,ingredients:n}}self.onmessage=async e=>{const r=e.data||{},{type:a}=r;if("runtimeConfig"===a)return p(r.config),void await f();u||p(null),await f();const{mainItemId:l,mainRecipeData:y}=r;try{const e=await async function(e,r){let a=await async function(t){try{const e=await o(`/recipe-tree/${t}`);return e.ok?await e.json():null}catch(t){return null}}(e),l=new Map,u=new Map;if(!a||!Array.isArray(a.components)||0===a.components.length){const t=await async function(t,e){if(!e||!Array.isArray(e.ingredients)||0===e.ingredients.length)return null;const n=new Map,r=new Map,i=new Map,s=async t=>{if(!Array.isArray(t)||0===t.length)return;const e=[];if(t.forEach(t=>{const n=Number(t);!Number.isInteger(n)||n<=0||i.has(n)||e.push(n)}),0!==e.length)for(let t=0;t<e.length;t+=25){const s=e.slice(t,t+25),a=s.map(t=>`ids[]=${t}`).join("&");try{const t=await o(`/backend/api/dataBundle.php?${a}`);if(!t.ok)continue;const e=await t.json().catch(()=>null),{data:s,meta:l}=c(e),u=Array.isArray(s)?s:[];!Array.isArray(s)&&Array.isArray(l?.errors)&&l.errors.length&&console.warn("dataBundle (worker) devolviÃ³ errores",l.errors),u.length&&u.forEach(t=>{t&&"number"==typeof t.id&&(i.set(t.id,t),t.item&&n.set(t.id,t.item),!t.market||null==t.market.buy_price&&null==t.market.sell_price||r.set(t.id,{id:t.id,buy_price:null!=t.market.buy_price?t.market.buy_price:null,sell_price:null!=t.market.sell_price?t.market.sell_price:null}))})}catch(t){}finally{s.forEach(t=>{i.has(t)||i.set(t,null)})}}},a=async(t,e,n,r)=>{if(!Number.isInteger(e)||e<=0)return null;await s([e]);const o=`${e}`;if(r.has(o))return{id:e,quantity:n??1,recipe:m(t,e),components:[],type:"Recipe"};r.add(o);const c=m(t,e),l=Array.isArray(c.ingredients)?c.ingredients:[],u=l.map(t=>Number.isInteger(t?.item_id)?t.item_id:null).filter(t=>t);u.length>0&&await s(u);const p=[];for(const t of l){const e=Number(t?.item_id);if(!Number.isInteger(e)||e<=0)continue;const n=Number.isFinite(t?.count)?t.count:0,s=i.get(e);if(s&&s.recipe&&Array.isArray(s.recipe.ingredients)&&s.recipe.ingredients.length>0){const t=await a(s.recipe,e,n,r);t&&(t.type="Recipe",p.push(t))}else p.push({type:"Item",id:e,quantity:n})}return r.delete(o),{id:e,quantity:n??1,recipe:c,components:p,type:"Recipe"}};await s([t]);const l=await a(e,t,e.output_item_count??1,new Set);return l?{root:l,allItemsDetailsMap:n,marketDataMap:r}:null}(e,r);if(!t)return[];a=t.root,l=t.allItemsDetailsMap,u=t.marketDataMap}if(!a)return[];const p=function(t){const e=new Set;return function t(n){n&&"object"==typeof n&&(Number.isInteger(n.id)&&e.add(n.id),Array.isArray(n.components)&&n.components.forEach(n=>{n&&("Recipe"===n.type?t(n):"Item"===n.type&&Number.isInteger(n.id)&&e.add(n.id))}))}(t),e}(a);await async function(e,r){const s=Array.from(e).filter(t=>!r.has(t));if(0===s.length)return;const{API_BASE_URL:a,LANG:c}=t(),l="string"==typeof c&&c.trim()?c.trim():"es";for(let t=0;t<s.length;t+=200){const e=s.slice(t,t+200),c=new URLSearchParams;c.set("ids",e.join(",")),l&&c.set("lang",l);const u=`${n(a,"/items")}?${c.toString()}`;try{const t=await o(u);if(!t.ok)continue;const e=await t.json().catch(()=>null);i(r,e)}catch(t){}}}(p,l),await async function(e,r){const i=Array.from(e).filter(t=>Number.isInteger(t)&&t>0);if(0===i.length)return;const{API_BASE_URL:a,MARKET_CSV_URL:c,FEATURE_MARKET_CSV_EXTERNAL:l,FEATURE_MARKET_CSV_EXTERNAL_WORKER:u}=t(),p=(null!=u?Boolean(u):Boolean(l))?"string"==typeof c&&c.trim()?c.trim():"https://api.datawars2.ie/gw2/v1/items/csv":n(a,"/market.csv"),f=new URLSearchParams;f.set("ids",i.join(","));try{const t=`${p}?${f.toString()}`,e=await o(t);if(e.ok){const t=await e.text();!function(t,e){if(!t||"function"!=typeof t.set||"string"!=typeof e)return 0;const n=e.trim();if(!n)return 0;const r=n.split("\n");if(r.length<=1)return 0;const i=r[0].split(",").map(t=>t.trim());let s=0;for(let e=1;e<r.length;e+=1){const n=r[e];if(!n)continue;const a=n.split(","),o={};i.forEach((t,e)=>{const n=a[e];"id"===t?o.id=n?parseInt(n,10):null:o[t]="buy_price"===t||"sell_price"===t?""!==n&&void 0!==n?parseInt(n,10):null:n}),o.id&&(t.set(o.id,{id:o.id,buy_price:Number.isFinite(o.buy_price)?o.buy_price:null,sell_price:Number.isFinite(o.sell_price)?o.sell_price:null}),s+=1)}}(r,t)}}catch(t){}const _=i.filter(t=>!r.has(t));if(0===_.length)return;for(let t=0;t<_.length;t+=200){const e=_.slice(t,t+200),i=new URLSearchParams;i.set("ids",e.join(","));const c=`${n(a,"/prices")}?${i.toString()}`;try{const t=await o(c);if(!t.ok)continue;const e=await t.json().catch(()=>null);if(!e)continue;const n=e&&"object"==typeof e&&Object.prototype.hasOwnProperty.call(e,"data")?e.data:e;s(r,n)}catch(t){}}}(p,u);const f=_(a,l,u,null);return f&&f.children||[]}(l,y);self.postMessage({tree:e})}catch(t){const e="string"==typeof t?.message&&t.message?t.message:String(t||"Unknown error");self.postMessage({error:e})}};
