import{p as e,g as t,a as n,f as r,b as i,c as a,d as s}from"./utils.min.js";import{g as o}from"./config.min.js";const l=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function u(e){if(null==e)return null;const t=Number(e);return Number.isFinite(t)?t:null}function c(e){return l(e)?{...e}:null}function d(e){const t=c(e)||{};return t.stale="boolean"==typeof e?.stale&&e.stale,t.lang="string"==typeof e?.lang?e.lang:"es",t}function f(e){return l(e)?{...e}:null}function p(e){const t=c(e),n=function(e){const t=u(e?.unitBuyPrice??e?.unit_buy_price),n=u(e?.unitSellPrice??e?.unit_sell_price);return{buy:t??u(e?.buy_price??e?.buyPrice??e?.buys?.unit_price),sell:n??u(e?.sell_price??e?.sellPrice??e?.sells?.unit_price)}}(e||{}),r=function(e){return{buy:u(e?.buy??e?.totalBuy??e?.total_buy),sell:u(e?.sell??e?.totalSell??e?.total_sell),crafted:u(e?.crafted??e?.totalCrafted??e?.total_crafted)}}(e||{}),i=Number.isFinite(n.buy)||Number.isFinite(n.sell),a=Number.isFinite(r.buy)||Number.isFinite(r.sell)||Number.isFinite(r.crafted);return{unit:n,totals:r,raw:t,hasData:Boolean(i||a),source:"string"==typeof e?.source?e.source:null,updatedAt:e?.lastChanged??e?.last_changed??e?.lastUpdated??e?.updatedAt??null}}function y(e,t=null){const n=e=>Number.isFinite(e)?e:null,r=e?.unit||{},i=t?.unit||{},a=e?.totals||{},s=t?.totals||{},o={buy:n(r.buy)??n(i.buy),sell:n(r.sell)??n(i.sell)},l={buy:n(a.buy)??n(s.buy),sell:n(a.sell)??n(s.sell),crafted:n(a.crafted)??n(s.crafted)},u=Number.isFinite(o.buy)||Number.isFinite(o.sell)||Number.isFinite(l.buy)||Number.isFinite(l.sell)||Number.isFinite(l.crafted);return{unit:o,totals:l,raw:e?.raw??t?.raw??null,hasData:u,source:e?.source??t?.source??null,updatedAt:e?.updatedAt??t?.updatedAt??null}}function g(e){return Array.isArray(e)?e.filter(l).map(e=>({...e})):l(e)?[{...e}]:[]}function m(e){return l(e)?{...e}:null}function w(e){const t=l(e)?e:{},n=l(t.data)?t.data:{},r=d(t.meta),i=f(n.item);let a=null;l(n.market)?a={...n.market}:l(n.totals)&&(a={...n.totals});return{item:i,market:a,tree:null!=n.tree?n.tree:null,meta:r,prices:p(a),recipes:g(n.recipes??n.recipe??null),legacy:m(n.legacy??null)}}let b=null,_=null;function h(e){if("string"!=typeof e)return null;const t=e.trim();return t?t.toLowerCase():null}function A(){try{const e=o(),t=h(e?.LANG);if(t)return t;const n=h(e?.DEFAULT_LANG);if(n)return n}catch(e){}return"es"}function v(e,t){if(e&&"function"==typeof e.postMessage&&t)try{e.postMessage({type:"setLang",lang:t})}catch(e){}}function F(e=A()){const t=h(e);t&&t!==b&&("undefined"!=typeof navigator&&navigator?.serviceWorker&&(v(navigator.serviceWorker.controller,t),("undefined"!=typeof navigator&&navigator?.serviceWorker?(_||(_=navigator.serviceWorker.ready.then(e=>e?.active??null).catch(()=>null)),_):Promise.resolve(null)).then(e=>{e&&v(e,t)})),b=t)}function k(e,t={}){const n=A();F(n);const r=function(e,t){if(!t)return e;try{const n=/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e),r=n?void 0:"undefined"!=typeof window&&window?.location?.origin?window.location.origin:"http://localhost",i=new URL(e,r);return i.searchParams.has("lang")||i.searchParams.set("lang",t),n?i.toString():`${i.pathname}${i.search}${i.hash}`}catch(t){return e}}(e,n),{headers:i,...a}=t||{},s=function(e,t){if(!t)return e||void 0;const n=new Headers(e||void 0);return n.has("Accept-Language")||n.set("Accept-Language",t),n.set("X-Client-Language",t),n}(i,n);return{url:r,options:s?{...a,headers:s}:{...a},lang:n}}const E=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function I(e){const t=E(e)?e:{},n=d(t.meta),r=E(t.data)?t.data:t,i=g(r.recipes??r.recipe??r);return{recipes:i,primary:i.length>0?i[0]:null,meta:n}}function S(e){return p(e)}function P(e,t){return`bundle_${"string"==typeof t&&t?t:A()}_${e}`}function $(e,t){if("undefined"==typeof window||!window)return;Array.isArray(window.__bundleFallbacks__)||(window.__bundleFallbacks__=[]);const n=t&&t.message?t.message:String(t||"")||"unknown",r={ids:Array.isArray(e)?e.map(e=>String(e)):[],message:n,timestamp:(new Date).toISOString()};window.__bundleFallbacks__.push(r),window.__bundleFallbacks__.length>50&&window.__bundleFallbacks__.shift(),window.__lastBundleFallback__=r}function N(e,t){const n=("string"==typeof e?e.trim():"").replace(/\/+$/,""),r=String(t).replace(/^\/+/,"");return n?r?`${n}/${r}`:n||"/":`/${r}`}function R(e,t,n){const{data:r,meta:a}=s(e),o=Array.isArray(r)?r:[];return!Array.isArray(r)&&Array.isArray(a?.errors)&&a.errors.length&&console.warn("dataBundle devolvi칩 errores",a.errors),o.length&&o.forEach(e=>{const r=String(e.id),a=P(r,n),s={recipe:I({data:e?.recipe??null}),prices:S(e?.market??null)},o={...e,adapters:s};t.set(r,o),i(a,o,void 0,{lang:n}),"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"function"==typeof CustomEvent&&window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:o}))}),o.length>0}async function L(e=[]){if(!Array.isArray(e)||0===e.length)return[];const t=A(),r=new Map,i=[];if(e.forEach(e=>{const a=String(e),s=n(P(a,t));s?r.set(a,s):i.push(a)}),i.length>0){const{API_BASE_URL:e,FEATURE_ITEM_API_ROLLOUT:n}=o(),s=Boolean(n);for(let n=0;n<i.length;n+=35){const o=i.slice(n,n+35),l=o.map(e=>`ids[]=${e}`).join("&");let u=!1;if(s){const{url:n,options:i}=k(`${N(e,"/items/bundle")}?${l}`);try{const e=await a(n,i);if(!e.ok)throw new Error(`Respuesta ${e.status} inv치lida en bundle API`);const s=await e.json().catch(()=>null);if(!s)throw new Error("Payload JSON no v치lido en bundle API");R(s,r,t),u=!0}catch(e){u=!1,console.warn("Fallo en bundle API, usando PHP como fallback",e),$(o,e)}}if(!s||!u)try{const{url:e,options:n}=k(`/backend/api/dataBundle.php?${l}`),i=await a(e,n);if(i.ok){R(await i.json().catch(()=>null),r,t)}else console.error("Error en getItemBundles: respuesta no v치lida")}catch(e){console.error("Error en getItemBundles:",e)}o.forEach(e=>{const t=String(e);r.has(t)||r.set(t,null)})}}return e.map(e=>{const t=String(e);return r.get(t)||null})}async function B(e){const t=Array.isArray(e)?e:[e],n=await L(t);if(Array.isArray(e))return n.map(e=>e?.recipe?[e.recipe]:[]);const r=n[0]?.recipe;return r?[r]:[]}async function j(e){const t=A(),a=function(e,t){return`recipe_${"string"==typeof t&&t?t:A()}_${e}`}(e,t),s=n(a,!0);try{const{API_BASE_URL:n}=o(),{url:l,options:u}=k(`${n}/recipes/${e}`),c=await r(l,u,a,s);if(!c.ok)return null;const d=await c.json();if(!d)return null;d.lastUpdated=(new Date).toISOString();const f=c.headers.get("ETag"),p=c.headers.get("Last-Modified");return i(a,d,void 0,{etag:f,lastModified:p,lang:t}),d}catch(e){return console.error("Error en getRecipeDetails:",e),null}}async function D(e){if(Array.isArray(e)){return(await L(e)).map(e=>e?.item||null)}const t=await L([e]);return t[0]?.item||null}async function U(n){if(Array.isArray(n)){const t=await e(n);return n.map(e=>{const n=t.get(e)||{};return{buys:{unit_price:n.buy_price||0},sells:{unit_price:n.sell_price||0}}})}const r=await t(n);return{buys:{unit_price:r?.buy_price||0},sells:{unit_price:r?.sell_price||0}}}const O={getItemBundles:L,getRecipesForItem:B,getRecipeDetails:j,getItemDetails:D,getItemPrices:U};function C(e=("undefined"!=typeof window?window:void 0)){if(!e)return O;const t={...e.RecipeService||{},...O};return e.RecipeService=t,Object.entries(O).forEach(([t,n])=>{"function"!=typeof e[t]&&(e[t]=n)}),t}"undefined"!=typeof window&&C(window);var M=Object.freeze({__proto__:null,getItemBundles:L,getItemDetails:D,getItemPrices:U,getRecipeDetails:j,getRecipesForItem:B,registerRecipeServiceGlobals:C});export{p as a,L as b,D as c,d,f as e,g as f,A as g,m as h,S as i,y as m,k as p,M as r,w as t};
