var RecipeServiceBundle=function(e){"use strict";const t={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},n="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let r=null;function o(e){n&&n.postMessage({type:"delete",key:e})}const i={API_BASE_URL:"/api",CDN_BASE_URL:"",DEFAULT_LANG:"es",FALLBACK_LANGS:["en"],MARKET_CSV_URL:"https://api.datawars2.ie/gw2/v1/items/csv",GW2_API_KEY:"",priceCacheStrategy:"sessionStorage",FEATURE_USE_PRECOMPUTED:!1,FEATURE_MARKET_CSV_EXTERNAL:!0,FEATURE_MARKET_CSV_EXTERNAL_WORKER:!1,FEATURE_DONES_AGGREGATE:!1,PRECOMPUTED_CANARY_THRESHOLD:1,FETCH_GUARD_MODE:"enforce",FETCH_GUARD_WHITELIST:[],CONNECT_ALLOWLIST:[],FETCH_GUARD_REPORT_URL:null,FEATURE_ITEM_API_ROLLOUT:!1};function a(e,t=!1){if("boolean"==typeof e)return e;if(null==e)return t;if("number"==typeof e)return Number.isNaN(e)?t:0!==e;const n=String(e).trim().toLowerCase();return n?!!["1","true","yes","on"].includes(n)||!["0","false","no","off"].includes(n)&&t:t}function s(e,t){if(t&&"object"==typeof t){if(Object.prototype.hasOwnProperty.call(t,"API_BASE_URL")&&null!=t.API_BASE_URL&&(e.API_BASE_URL=t.API_BASE_URL),Object.prototype.hasOwnProperty.call(t,"CDN_BASE_URL")&&null!=t.CDN_BASE_URL&&(e.CDN_BASE_URL=t.CDN_BASE_URL),Object.prototype.hasOwnProperty.call(t,"DEFAULT_LANG")&&t.DEFAULT_LANG&&(e.DEFAULT_LANG=t.DEFAULT_LANG),Object.prototype.hasOwnProperty.call(t,"LANG")&&t.LANG&&(e.DEFAULT_LANG=t.LANG),Object.prototype.hasOwnProperty.call(t,"MARKET_CSV_URL")&&t.MARKET_CSV_URL&&(e.MARKET_CSV_URL=t.MARKET_CSV_URL),Object.prototype.hasOwnProperty.call(t,"GW2_API_KEY")&&null!=t.GW2_API_KEY&&(e.GW2_API_KEY=t.GW2_API_KEY),Object.prototype.hasOwnProperty.call(t,"priceCacheStrategy")&&t.priceCacheStrategy?e.priceCacheStrategy=t.priceCacheStrategy:Object.prototype.hasOwnProperty.call(t,"PRICE_CACHE_STRATEGY")&&t.PRICE_CACHE_STRATEGY&&(e.priceCacheStrategy=t.PRICE_CACHE_STRATEGY),Object.prototype.hasOwnProperty.call(t,"FEATURE_USE_PRECOMPUTED")&&(e.FEATURE_USE_PRECOMPUTED=t.FEATURE_USE_PRECOMPUTED),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL")?e.FEATURE_MARKET_CSV_EXTERNAL=t.FEATURE_MARKET_CSV_EXTERNAL:Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_INTERNAL")&&(e.FEATURE_MARKET_CSV_EXTERNAL=!a(t.FEATURE_MARKET_CSV_INTERNAL,!0)),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL_WORKER")&&(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=t.FEATURE_MARKET_CSV_EXTERNAL_WORKER),Object.prototype.hasOwnProperty.call(t,"FEATURE_DONES_AGGREGATE")&&(e.FEATURE_DONES_AGGREGATE=t.FEATURE_DONES_AGGREGATE),Object.prototype.hasOwnProperty.call(t,"FEATURE_ITEM_API_ROLLOUT")&&(e.FEATURE_ITEM_API_ROLLOUT=t.FEATURE_ITEM_API_ROLLOUT),Object.prototype.hasOwnProperty.call(t,"PRECOMPUTED_CANARY_THRESHOLD")&&(e.PRECOMPUTED_CANARY_THRESHOLD=t.PRECOMPUTED_CANARY_THRESHOLD),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_MODE")&&"string"==typeof t.FETCH_GUARD_MODE&&(e.FETCH_GUARD_MODE=t.FETCH_GUARD_MODE),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_WHITELIST")){const n=t.FETCH_GUARD_WHITELIST;if(Array.isArray(n))e.FETCH_GUARD_WHITELIST=[...n];else if("string"==typeof n){const t=n.split(",").map(e=>e.trim()).filter(Boolean);e.FETCH_GUARD_WHITELIST=t}}if(Object.prototype.hasOwnProperty.call(t,"CONNECT_ALLOWLIST")&&Array.isArray(t.CONNECT_ALLOWLIST)&&(e.CONNECT_ALLOWLIST=[...t.CONNECT_ALLOWLIST]),Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANGS")){const n=t.FALLBACK_LANGS;Array.isArray(n)?e.FALLBACK_LANGS=[...n]:"string"==typeof n&&(e.FALLBACK_LANGS=n.split(",").map(e=>e.trim()).filter(Boolean))}else if(Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANG")){const n=t.FALLBACK_LANG;"string"==typeof n&&(e.FALLBACK_LANGS=n.split(",").map(e=>e.trim()).filter(Boolean))}if(Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_REPORT_URL")){const n=t.FETCH_GUARD_REPORT_URL;null!=n&&"string"!=typeof n||(e.FETCH_GUARD_REPORT_URL=n)}}}function l(){const e={...i,FETCH_GUARD_WHITELIST:[...i.FETCH_GUARD_WHITELIST],CONNECT_ALLOWLIST:[...i.CONNECT_ALLOWLIST]},t=("undefined"!=typeof globalThis?globalThis.window&&"object"==typeof globalThis.window?globalThis.window:globalThis.self&&"object"==typeof globalThis.self?globalThis.self:globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0)||("undefined"!=typeof globalThis?globalThis:void 0),n=t&&"object"==typeof t.Config?t.Config:null,r=t&&"object"==typeof t.__RUNTIME_CONFIG__?t.__RUNTIME_CONFIG__:null,o=t&&"object"==typeof t.__SECURE_RUNTIME_CONFIG__?t.__SECURE_RUNTIME_CONFIG__:null,l=function({legacy:e,runtime:t,secureRuntime:n,globalScope:r}){const o=[n&&(n.DEBUG_RUNTIME??n.DEBUG),t&&(t.DEBUG_RUNTIME??t.DEBUG),e&&(e.DEBUG_RUNTIME??e.DEBUG),r&&(r.__RUNTIME_DEBUG__??r.__DEBUG__)];for(const e of o)if(void 0!==e)return a(e,!1);if(r&&r.location&&"string"==typeof r.location.search){const e=String(r.location.search||"");if(e)try{const t=new URLSearchParams(e.startsWith("?")?e.slice(1):e),n=["debugRuntime","runtimeDebug","debug-config"];for(const e of n)if(t.has(e)){const n=t.get(e);return a(null==n||n,!0)}}catch(t){if(/[?&](debugRuntime|runtimeDebug|debug-config)(?:=|&|$)/i.test(e))return!0}}return!1}({legacy:n,runtime:r,secureRuntime:o,globalScope:t});s(e,n),s(e,r),s(e,o),e.FEATURE_USE_PRECOMPUTED=a(e.FEATURE_USE_PRECOMPUTED,i.FEATURE_USE_PRECOMPUTED),e.FEATURE_MARKET_CSV_EXTERNAL=a(e.FEATURE_MARKET_CSV_EXTERNAL,i.FEATURE_MARKET_CSV_EXTERNAL),e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=a(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER,i.FEATURE_MARKET_CSV_EXTERNAL_WORKER),e.FEATURE_ITEM_API_ROLLOUT=a(e.FEATURE_ITEM_API_ROLLOUT,i.FEATURE_ITEM_API_ROLLOUT);const c=Number(e.PRECOMPUTED_CANARY_THRESHOLD);e.PRECOMPUTED_CANARY_THRESHOLD=Number.isFinite(c)?Math.min(Math.max(c,0),100):i.PRECOMPUTED_CANARY_THRESHOLD;const u=Array.isArray(e.FALLBACK_LANGS)?e.FALLBACK_LANGS:"string"==typeof e.FALLBACK_LANGS?e.FALLBACK_LANGS.split(","):[];if(null!=e.CDN_BASE_URL&&""!==e.CDN_BASE_URL){const t=String(e.CDN_BASE_URL).trim().replace(/\/$/,"");e.CDN_BASE_URL=t}else e.CDN_BASE_URL="";const f=String(e.DEFAULT_LANG||i.DEFAULT_LANG).trim().toLowerCase();e.FALLBACK_LANGS=[...new Set(u.map(e=>"string"==typeof e?e.trim().toLowerCase():"").filter(e=>e&&e!==f))],e.LANG=e.DEFAULT_LANG||i.DEFAULT_LANG;const _=String(e.LANG||"").trim().toLowerCase();return e.FALLBACK_LANGS=e.FALLBACK_LANGS.filter(e=>e&&e!==_),function({debugMode:e,legacy:t,runtime:n,secureRuntime:r}){if(!e||"undefined"==typeof console||null===console)return;const o=new Date,i={legacyConfig:Boolean(t),runtimeConfig:Boolean(n),secureRuntimeConfig:Boolean(r),runtimeLoadedAt:n&&Object.prototype.hasOwnProperty.call(n,"__loadedAt")?n.__loadedAt:null,configInitializedAt:o.toISOString()};if(!n)return void console.warn("[runtime-config][debug] runtime-env.js was not available during config initialization.",i);if(!Object.prototype.hasOwnProperty.call(n,"__loadedAt"))return void console.warn('[runtime-config][debug] runtime-env.js missing "__loadedAt" marker; verify load order.',i);const a="string"==typeof n.__loadedAt?Date.parse(n.__loadedAt):Number.isFinite(n.__loadedAt)?Number(n.__loadedAt):Number.NaN;if(Number.isNaN(a))return void console.warn('[runtime-config][debug] runtime-env.js has an invalid "__loadedAt" timestamp.',i);const s=o.getTime()-a;i.runtimeLoadedDeltaMs=s,s<-50?console.warn("[runtime-config][debug] runtime-env.js appears to have executed after config.js. Ensure /runtime-env.js loads first.",i):console.info("[runtime-config][debug] runtime configuration applied successfully.",{...i,lang:n.LANG,flags:n.FLAGS})}({debugMode:l,legacy:n,runtime:r,secureRuntime:o}),e}const c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:null,u="__GW2_FETCH_GUARD_INSTALLED__";if(c&&"function"==typeof c.fetch&&!c[u]){const e=c.fetch;let t=f(c)||"http://localhost";const n=()=>{const e=f(c);e&&t!==e&&(t=e);const n=function(){try{return l()}catch{return null}}(),r=function(e){if("string"!=typeof e)return"off";const t=e.trim().toLowerCase();if(!t)return"off";const n=t.replace(/[_\s]+/g,"-");if(["off","disabled","disable","none","0","false"].includes(n))return"off";if(["enforce","block","blocked","deny","enforced","strict","on","true"].includes(n))return"enforce";if(["report-only","report","monitor","monitoring","warn","warning"].includes(n))return"report-only";return"off"}(n?.FETCH_GUARD_MODE),o=function(e){if("string"!=typeof e)return null;const t=e.trim();return t||null}(n?.FETCH_GUARD_REPORT_URL),i=function(e,t){const n=new Set,r=e=>{e&&(Array.isArray(e)?e.forEach(r):n.add(e))},o=e=>{if(e||0===e)if(Array.isArray(e))e.forEach(o);else if("string"!=typeof e)try{const n=p(String(e),t);r(n)}catch{}else e.split(",").forEach(e=>{const n=p(e.trim(),t);r(n)})},i=[e?.API_BASE_URL,e?.MARKET_CSV_URL,"/api","api","/backend/api","backend/api","/recipe-tree","https://api.guildwars2.com","https://api.datawars2.ie"],a=e?.FETCH_GUARD_WHITELIST,s=function(e){if(Array.isArray(e))return e.length>0;if(null==e)return!1;if("string"==typeof e)return e.split(",").some(e=>e.trim());return!0}(a);o(i),o(a),o(e?.fetchGuardWhitelist),o(e?.fetchWhitelist),o(e?.FETCH_WHITELIST),s||o(e?.CONNECT_ALLOWLIST);return Array.from(n)}(n,e);return{mode:r,reportUrl:o,whitelist:i,locationOrigin:e}},r=(e,n,r)=>{if("off"===r.mode)return;const o=`[fetchGuard] ${e}: ${n}`;try{"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(o)}catch{}if(!r.reportUrl)return;let i;try{i=JSON.stringify({source:"fetchGuard",reason:e,targetUrl:n,mode:r.mode,timestamp:Date.now(),locationOrigin:r.locationOrigin})}catch{i=null}if(i){try{if("function"==typeof c.navigator?.sendBeacon)return void c.navigator.sendBeacon(r.reportUrl,i)}catch{}try{if("function"==typeof c.Image){const e=encodeURIComponent(i),n=function(e,t,n){if(!e)return null;try{const r=new URL(e,n);return r.searchParams.append("payload",t),r.href}catch{try{const n=e.includes("?")?"&":"?";return`${e}${n}payload=${t}`}catch{return null}}}(r.reportUrl,e,t);if(!n)return;const o=new c.Image;try{"referrerPolicy"in o&&(o.referrerPolicy="no-referrer")}catch{}const a=function(e){const t="__FETCH_GUARD_REPORT_IMAGES__";if(!e[t])try{Object.defineProperty(e,t,{value:new Set,configurable:!0,enumerable:!1,writable:!1})}catch{e[t]=new Set}return e[t]}(c);a.add(o);const s=()=>a.delete(o);try{o.onload=s,o.onerror=s}catch{}o.src=n}}catch{}}},o=function(o,i){const a=n(),s=function(e,t){if(!e&&""!==e)return null;const n=e=>{try{return new URL(e,t)}catch{return null}};if("undefined"!=typeof URL)try{if(e instanceof URL)return e}catch{}if("undefined"!=typeof Request)try{if(e instanceof Request)return n(e.url)}catch{}if("string"==typeof e)return n(e);if(e&&"string"==typeof e.url)return n(e.url);return null}(o,t);if(!s||"off"===a.mode||function(e,t){if(!e)return!1;const n="string"==typeof e.hostname?e.hostname.toLowerCase():"",r="string"==typeof e.origin?e.origin:"";let o="";if(r&&"null"!==r)try{o=new URL(r).hostname.toLowerCase()}catch{const e=r.toLowerCase(),t=e.indexOf("://");o=t>=0?e.slice(t+3):e}for(const r of t)switch(r.type){case"wildcard":return!0;case"origin":if(e.origin===r.value)return!0;break;case"href":if(e.href.startsWith(r.value))return!0;break;case"hostname":if(n===r.value)return!0;if(o&&o===r.value)return!0;break;case"hostname-pattern":if(d(n,r.value))return!0;if(d(o,r.value))return!0;break;case"pathname":if(e.pathname.startsWith(r.value))return!0}return!1}(s,a.whitelist))return e.call(this,o,i);let l;var c;c=s,l=c?.pathname.includes("/backend/")?"Legacy backend fetch detected":function(e,t){return!!e&&(!!t&&("null"!==e.origin&&e.origin!==t))}(s,a.locationOrigin)?"External fetch detected":"Blocked fetch detected";const u=function(e,t){if(e?.href)return e.href;if("string"==typeof t)return t;if(t&&"string"==typeof t.url)return t.url;return"unknown target"}(s,o);return r(l,u,a),"enforce"===a.mode?Promise.reject(function(e,t){const n=new Error(`[fetchGuard] ${e}: ${t}`);return n.name="FetchGuardError",n.reason=e,n.url=t,n}(l,u)):e.call(this,o,i)};o.originalFetch=e,c.fetch=o,c[u]=!0}function f(e){if(!e||"object"!=typeof e)return;const t=e.location&&"object"==typeof e.location?e.location:null,n=_(t?.origin);if(n)return n;const r=_(e.origin),o=function(e,t){if("string"!=typeof e)return null;const n=e.trim();if(!n)return null;try{return _(new URL(n).origin)}catch{if(!t)return null;try{return _(new URL(n,t).origin)}catch{return null}}}(t?.href,r);return o||(r||void 0)}function _(e){if("string"!=typeof e)return null;const t=e.trim();return t&&"null"!==t.toLowerCase()?t:null}function p(e,t){if(!e)return null;const n=e.trim();if(!n)return null;const r=n.replace(/^['"]|['"]$/g,"");if(!r)return null;const o=r.toLowerCase();if("self"===o){const e=_(t);return e?{type:"origin",value:e}:{type:"pathname",value:"/recipe-tree"}}if("*"===o)return{type:"wildcard"};if(/^\*\.[^*]+/.test(r)){const e=r.slice(2).toLowerCase();return e?{type:"hostname-pattern",value:e}:null}if(r.startsWith("//"))try{return{type:"origin",value:new URL(r,t||"http:").origin}}catch{return null}if(/^[a-zA-Z]+:\/\//.test(r))try{const e=new URL(r);return r.endsWith("/"),{type:"href",value:e.href}}catch{return null}if(r.startsWith("/"))return{type:"pathname",value:r};if(r.includes("://"))try{return{type:"href",value:new URL(r).href}}catch{return null}return r.includes(".")?{type:"hostname",value:r.toLowerCase()}:{type:"pathname",value:r.startsWith("/")?r:`/${r}`}}function d(e,t){if(!e||!t)return!1;const n=e.toLowerCase(),r=t.toLowerCase().replace(/^\.+/,"");return!!r&&(n===r||n.endsWith(`.${r}`))}const E=[];function A(){const e=Date.now()-6e4;for(;E.length&&E[0]<e;)E.shift()}function y(){A();const e=E.length;return e>5?"down":e>0?"slow":"ok"}let g;function R(){if("undefined"==typeof document)return;const e=y();g||(g=document.createElement("div"),g.id="api-status-indicator",g.style.position="fixed",g.style.bottom="10px",g.style.right="10px",g.style.padding="4px 8px",g.style.background="rgba(0,0,0,0.7)",g.style.color="#fff",g.style.borderRadius="4px",g.style.zIndex="10000",g.style.display="none",document.body.appendChild(g)),"ok"===e?g.style.display="none":(g.textContent="slow"===e?"API lenta":"API caída",g.style.display="block")}var h={recordFailure:function(){E.push(Date.now()),A(),R()},recordSuccess:function(){A(),R()},getState:y,getBackoff:function(){const e=y();return"down"===e?5e3:"slow"===e?1e3:0}};async function T(e,t={}){const{timeout:n=8e3,retries:r=3,backoff:o=300,signal:i,...a}=t;for(let t=0;t<=r;t++){const s=new AbortController,l=setTimeout(()=>s.abort(),n);i&&(i.aborted?s.abort():i.addEventListener("abort",()=>s.abort(),{once:!0}));try{const t=await fetch(e,{...a,signal:s.signal});return clearTimeout(l),h.recordSuccess(),t}catch(e){if(clearTimeout(l),h.recordFailure(),i?.aborted||t===r)throw e;const n=o*Math.pow(2,t);await new Promise(e=>setTimeout(e,n))}}}const L=new Map;!function(e){r=e,n&&n.addEventListener("message",({data:e})=>{const{type:t,key:o,entry:i}=e||{};if("request-bundles"!==t)t&&o&&("set"===t&&i?r.set(o,i):"delete"===t&&r.delete(o));else{if(!r)return;r.forEach((e,t)=>{t.startsWith("bundle_")&&n.postMessage({type:"set",key:t,entry:e})})}})}(L),n&&n.postMessage({type:"request-bundles"});const w="undefined"!=typeof localStorage;function m(e){try{return JSON.parse(e)}catch{return null}}function S(e,t){if(w)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:n,lastModified:r,lang:o,source:i,fallback:a}){return JSON.stringify({value:e,expiresAt:t,etag:n,lastModified:r,lang:o,source:i,fallback:a})}(t))}catch{}}function b(e,r,o=void 0,i={}){if(void 0===o){const n=e.split("_")[0];o=t[n]}const a=null==o?null:Date.now()+o,{etag:s=null,lastModified:l=null,lang:c=null,source:u=null,fallback:f=null}=i,_={value:r,expiresAt:a,updatedAt:(new Date).toISOString(),etag:s,lastModified:l,lang:c,source:u,fallback:f};L.set(e,_),S(e,{value:r,expiresAt:a,etag:s,lastModified:l,lang:c,source:u,fallback:f}),function(e,t){n&&n.postMessage({type:"set",key:e,entry:t})}(e,_)}function U(e,t=!1){let n=L.get(e);if(!n){const t=function(e){if(!w)return null;const t=localStorage.getItem(e);if(!t)return null;const n=m(t);return n||(localStorage.removeItem(e),null)}(e);if(t){const{value:r,expiresAt:o=null,etag:i=null,lastModified:a=null,lang:s=null,source:l=null,fallback:c=null}=t;n={value:r,expiresAt:o,updatedAt:(new Date).toISOString(),etag:i,lastModified:a,lang:s,source:l,fallback:c},L.set(e,n)}}return n?n.expiresAt&&Date.now()>n.expiresAt?(L.delete(e),w&&localStorage.removeItem(e),o(e),null):t?n:n.value:null}!function(){if(!w)return;const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),r=m(localStorage.getItem(n));if(!r)continue;const{expiresAt:o}=r;o&&Date.now()>o&&e.push(n)}e.forEach(e=>{localStorage.removeItem(e),o(e)})}();const C=new Map;function O(e,t={},n=null,r=null,o){const i=C.get(e);i&&i.controller?.abort(),n&&!r&&(r=U(n,!0));const a={...t.headers||{}};r?.etag&&(a["If-None-Match"]=r.etag),r?.lastModified&&(a["If-Modified-Since"]=r.lastModified);const s=o?null:new AbortController,l=o??t.signal??s?.signal;return function(e,t,n){return C.set(e,{promise:t,controller:n}),t.finally(()=>C.delete(e)),t}(e,T(e,{...t,headers:a,signal:l}).then(async e=>304===e.status&&r?new Response(JSON.stringify(r.value),{status:200,headers:{"X-Cache":"HIT",ETag:r.etag||"","Last-Modified":r.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),s).then(e=>e.clone())}const N=Object.prototype.hasOwnProperty;function I(e){return null==e?[]:Array.isArray(e)?e:[e]}function F(e){if(null==e)return{data:null,meta:{errors:[]}};if("object"!=typeof e||e instanceof Response)return{data:e,meta:{errors:[]}};if(Array.isArray(e))return{data:e,meta:{errors:[]}};if(N.call(e,"data")){const t=N.call(e,"meta")&&"object"==typeof e.meta?{...e.meta,errors:I(e.meta?.errors)}:{errors:[]};return{data:e.data,meta:t}}if(N.call(e,"meta")){return{data:null,meta:"object"==typeof e.meta?{...e.meta,errors:I(e.meta?.errors)}:{errors:[]}}}const{errors:t,...n}=e;return{data:n,meta:{errors:I(t)}}}const P=new Map;function D(){return"sessionStorage"===function(){const e=l();return e?.priceCacheStrategy||"sessionStorage"}()}function v(e){return`price_${e}`}function M(e){if(!D()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(v(e));if(!t)return null;try{const{value:n,expires:r}=JSON.parse(t);return r&&Date.now()>r?(sessionStorage.removeItem(v(e)),null):n}catch{return sessionStorage.removeItem(v(e)),null}}async function G(e){if(!Array.isArray(e)||0===e.length)return new Map;const t=l();if("redis"===(t?.priceCacheStrategy||"sessionStorage")){const t=`/backend/api/itemBundle.php?ids=${e.join(",")}`,n=await fetch(t);if(!n.ok)throw new Error("Price fetch failed");const r=await n.json().catch(()=>null),{data:o,meta:i}=F(r),a=Array.isArray(o)?o:[];!Array.isArray(o)&&Array.isArray(i?.errors)&&i.errors.length&&console.warn("itemBundle precios devolvió errores",i.errors);const s=new Map;return a.forEach(e=>{const t=e.market||{};s.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),s}{const n=["id","buy_price","sell_price"].join(","),r=Boolean(t?.FEATURE_MARKET_CSV_EXTERNAL)?t?.MARKET_CSV_URL||"https://api.datawars2.ie/gw2/v1/items/csv":function(e,t){const n=("string"==typeof e?e.trim():"").replace(/\/+$/,""),r=String(t).replace(/^\/+/,"");return n?r?`${n}/${r}`:n||"/":r?`/${r}`:"/"}(t?.API_BASE_URL||"/api","/market.csv"),o=new URLSearchParams;o.set("fields",n),o.set("ids",e.join(","));const i=`${r}?${o.toString()}`,a=await fetch(i);if(!a.ok)throw new Error("Price fetch failed");const s=(await a.text()).trim().split("\n"),l=s[0].split(","),c=new Map;for(let e=1;e<s.length;e++){if(!s[e])continue;const t=s[e].split(","),n={};l.forEach((e,r)=>{const o=t[r];n[e]=void 0!==o?isNaN(o)?o:Number(o):null}),null!=n.id&&c.set(n.id,{buy_price:n.buy_price||0,sell_price:n.sell_price||0})}return c}}async function B(e=[]){const t=new Map,n=[];if(e.forEach(e=>{if(e=Number(e),P.has(e))return void t.set(e,P.get(e));const r=M(e);r?(P.set(e,r),t.set(e,r)):n.push(e)}),n.length)try{(await G(n)).forEach((e,n)=>{P.set(n,e),function(e,t){if(D()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(v(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(n,e),t.set(n,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!t.has(e)&&P.has(e)&&t.set(e,P.get(e)),t.has(e)||t.set(e,{buy_price:0,sell_price:0})}),t}const j=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function k(e){if(null==e)return null;const t=Number(e);return Number.isFinite(t)?t:null}function K(e){return j(e)?{...e}:null}function H(e){const t=K(e),n=function(e){const t=k(e?.unitBuyPrice??e?.unit_buy_price),n=k(e?.unitSellPrice??e?.unit_sell_price);return{buy:t??k(e?.buy_price??e?.buyPrice??e?.buys?.unit_price),sell:n??k(e?.sell_price??e?.sellPrice??e?.sells?.unit_price)}}(e||{}),r=function(e){return{buy:k(e?.buy??e?.totalBuy??e?.total_buy),sell:k(e?.sell??e?.totalSell??e?.total_sell),crafted:k(e?.crafted??e?.totalCrafted??e?.total_crafted)}}(e||{}),o=Number.isFinite(n.buy)||Number.isFinite(n.sell),i=Number.isFinite(r.buy)||Number.isFinite(r.sell)||Number.isFinite(r.crafted);return{unit:n,totals:r,raw:t,hasData:Boolean(o||i),source:"string"==typeof e?.source?e.source:null,updatedAt:e?.lastChanged??e?.last_changed??e?.lastUpdated??e?.updatedAt??null}}const W=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function $(e){const t=W(e)?e:{},n=function(e){const t=K(e)||{};return t.stale="boolean"==typeof e?.stale&&e.stale,t.lang="string"==typeof e?.lang?e.lang:"es",t}(t.meta),r=W(t.data)?t.data:t,o=function(e){return Array.isArray(e)?e.filter(j).map(e=>({...e})):j(e)?[{...e}]:[]}(r.recipes??r.recipe??r);return{recipes:o,primary:o.length>0?o[0]:null,meta:n}}function x(e){return H(e)}let V=null,X=null;function Y(e){if("string"!=typeof e)return null;const t=e.trim();return t?t.toLowerCase():null}function J(){try{const e=l(),t=Y(e?.LANG);if(t)return t;const n=Y(e?.DEFAULT_LANG);if(n)return n}catch(e){}return"es"}function z(e,t){if(e&&"function"==typeof e.postMessage&&t)try{e.postMessage({type:"setLang",lang:t})}catch(e){}}function q(e=J()){const t=Y(e);t&&t!==V&&("undefined"!=typeof navigator&&navigator?.serviceWorker&&(z(navigator.serviceWorker.controller,t),("undefined"!=typeof navigator&&navigator?.serviceWorker?(X||(X=navigator.serviceWorker.ready.then(e=>e?.active??null).catch(()=>null)),X):Promise.resolve(null)).then(e=>{e&&z(e,t)})),V=t)}function Z(e,t={}){const n=J();q(n);const r=function(e,t){if(!t)return e;try{const n=/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e),r=n?void 0:"undefined"!=typeof window&&window?.location?.origin?window.location.origin:"http://localhost",o=new URL(e,r);return o.searchParams.has("lang")||o.searchParams.set("lang",t),n?o.toString():`${o.pathname}${o.search}${o.hash}`}catch(t){return e}}(e,n),{headers:o,...i}=t||{},a=function(e,t){if(!t)return e||void 0;const n=new Headers(e||void 0);return n.has("Accept-Language")||n.set("Accept-Language",t),n.set("X-Client-Language",t),n}(o,n);return{url:r,options:a?{...i,headers:a}:{...i},lang:n}}function Q(e,t){return`bundle_${"string"==typeof t&&t?t:J()}_${e}`}function ee(e,t){if("undefined"==typeof window||!window)return;Array.isArray(window.__bundleFallbacks__)||(window.__bundleFallbacks__=[]);const n=t&&t.message?t.message:String(t||"")||"unknown",r={ids:Array.isArray(e)?e.map(e=>String(e)):[],message:n,timestamp:(new Date).toISOString()};window.__bundleFallbacks__.push(r),window.__bundleFallbacks__.length>50&&window.__bundleFallbacks__.shift(),window.__lastBundleFallback__=r}function te(e,t){const n=("string"==typeof e?e.trim():"").replace(/\/+$/,""),r=String(t).replace(/^\/+/,"");return n?r?`${n}/${r}`:n||"/":`/${r}`}function ne(e,t,n){const{data:r,meta:o}=F(e),i=Array.isArray(r)?r:[];return!Array.isArray(r)&&Array.isArray(o?.errors)&&o.errors.length&&console.warn("dataBundle devolvió errores",o.errors),i.length&&i.forEach(e=>{const r=String(e.id),o=Q(r,n),i={recipe:$({data:e?.recipe??null}),prices:x(e?.market??null)},a={...e,adapters:i};t.set(r,a),b(o,a,void 0,{lang:n}),"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"function"==typeof CustomEvent&&window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:a}))}),i.length>0}async function re(e=[]){if(!Array.isArray(e)||0===e.length)return[];const t=J(),n=new Map,r=[];if(e.forEach(e=>{const o=String(e),i=U(Q(o,t));i?n.set(o,i):r.push(o)}),r.length>0){const{API_BASE_URL:e,FEATURE_ITEM_API_ROLLOUT:o}=l(),i=Boolean(o);for(let o=0;o<r.length;o+=35){const a=r.slice(o,o+35),s=a.map(e=>`ids[]=${e}`).join("&");let l=!1;if(i){const{url:r,options:o}=Z(`${te(e,"/items/bundle")}?${s}`);try{const e=await T(r,o);if(!e.ok)throw new Error(`Respuesta ${e.status} inválida en bundle API`);const i=await e.json().catch(()=>null);if(!i)throw new Error("Payload JSON no válido en bundle API");ne(i,n,t),l=!0}catch(e){l=!1,console.warn("Fallo en bundle API, usando PHP como fallback",e),ee(a,e)}}if(!i||!l)try{const{url:e,options:r}=Z(`/backend/api/dataBundle.php?${s}`),o=await T(e,r);if(o.ok){ne(await o.json().catch(()=>null),n,t)}else console.error("Error en getItemBundles: respuesta no válida")}catch(e){console.error("Error en getItemBundles:",e)}a.forEach(e=>{const t=String(e);n.has(t)||n.set(t,null)})}}return e.map(e=>{const t=String(e);return n.get(t)||null})}async function oe(e){const t=Array.isArray(e)?e:[e],n=await re(t);if(Array.isArray(e))return n.map(e=>e?.recipe?[e.recipe]:[]);const r=n[0]?.recipe;return r?[r]:[]}async function ie(e){const t=J(),n=function(e,t){return`recipe_${"string"==typeof t&&t?t:J()}_${e}`}(e,t),r=U(n,!0);try{const{API_BASE_URL:o}=l(),{url:i,options:a}=Z(`${o}/recipes/${e}`),s=await O(i,a,n,r);if(!s.ok)return null;const c=await s.json();if(!c)return null;c.lastUpdated=(new Date).toISOString();const u=s.headers.get("ETag");return b(n,c,void 0,{etag:u,lastModified:s.headers.get("Last-Modified"),lang:t}),c}catch(e){return console.error("Error en getRecipeDetails:",e),null}}async function ae(e){if(Array.isArray(e)){return(await re(e)).map(e=>e?.item||null)}const t=await re([e]);return t[0]?.item||null}async function se(e){if(Array.isArray(e)){const t=await B(e);return e.map(e=>{const n=t.get(e)||{};return{buys:{unit_price:n.buy_price||0},sells:{unit_price:n.sell_price||0}}})}const t=await async function(e){if(e=Number(e),P.has(e))return P.get(e);const t=M(e);return t?(P.set(e,t),t):(await B([e])).get(e)}(e);return{buys:{unit_price:t?.buy_price||0},sells:{unit_price:t?.sell_price||0}}}const le={getItemBundles:re,getRecipesForItem:oe,getRecipeDetails:ie,getItemDetails:ae,getItemPrices:se};function ce(e=("undefined"!=typeof window?window:void 0)){if(!e)return le;const t={...e.RecipeService||{},...le};return e.RecipeService=t,Object.entries(le).forEach(([t,n])=>{"function"!=typeof e[t]&&(e[t]=n)}),t}"undefined"!=typeof window&&ce(window);return ce("undefined"!=typeof window?window:void 0),e.getItemBundles=re,e.getItemDetails=ae,e.getItemPrices=se,e.getRecipeDetails=ie,e.getRecipesForItem=oe,e.registerRecipeServiceGlobals=ce,e}({});
