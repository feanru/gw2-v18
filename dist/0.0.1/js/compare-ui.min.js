import{l as t,m as e,j as n,o as a,q as o,u as l,v as i}from"./utils.min.js";import{setQtyInputValue as d,showSkeleton as r,hideSkeleton as s,showError as c,hideError as m,getQtyInputValue as u}from"./ui-helpers.min.js";import"./config.min.js";import"./services.min.js";function p(t,e=0,n=null,a=0,o=!0,l=[]){return t&&Array.isArray(t)?t.map((t,i)=>{if(!t||void 0===t.id)return console.warn("Ingrediente inválido en renderRows:",t),"";const d=0===e?i:a,r=d%2==0?"row-bg-a":"row-bg-b",s=e>0?`style="padding-left:${30*e}px"`:"",c="function"==typeof getRarityClass?getRarityClass(t.rarity):"",m=[...l,t._uid].join("-"),u=t.children&&t.children.length?`<button class="btn-expand" data-path="${m}">${t.expanded?"▴":"▾"}</button>`:"",w=e>0,f=w&&!o?'style="display:none"':"",b=`mode-${m}`,y=w?`\n      <input type="radio" name="${b}" class="chk-mode-buy" data-path="${m}" ${"buy"===t.modeForParentCrafted?"checked":""} title="Usar precio de compra para el padre">\n    `:"",h=w?`\n      <input type="radio" name="${b}" class="chk-mode-sell" data-path="${m}" ${"sell"===t.modeForParentCrafted?"checked":""} title="Usar precio de venta para el padre">\n    `:"",g=w&&t.is_craftable&&t.children&&t.children.length>0?`\n      <input type="radio" name="${b}" class="chk-mode-crafted" data-path="${m}" ${"crafted"===t.modeForParentCrafted?"checked":""} title="Usar precio de crafteo para el padre">\n    `:"",_=(()=>{if(!(t.children&&t.children.length>0&&Number(t.sell_price)>0))return"";const e=Number(t.sell_price)*t.countTotal,n=e-.15*e-Math.min(t.total_buy,t.total_sell,t.total_crafted);return`<span style='font-weight:bold;color:${n>0?"#4fc178":"#e84d4d"}'>${formatGoldColored(n)}</span>`})();return!t.buy_price&&t.sell_price,t.is_craftable&&t.children&&t.children.length,`\n      <tr data-path="${m}" class="${w?`subrow subrow-${e} child-of-${n}`:""} ${r}" ${f}>\n        <td class="th-border-left-items" ${s}><img src="${t.icon}" width="32"></td>\n        <td><a href="/item?id=${t.id}" class="item-link ${c}" target="_blank">${t.name}</a></td>\n        <td>${null!=t.countTotal?Number.isInteger(t.countTotal)?t.countTotal:t.countTotal.toFixed(2):t.count}</td>\n        <td class="item-unit-sell">${formatGoldColored(t.sell_price)} <span style="color: #c99b5b">c/u</span></td>\n        \n        <td class="item-solo-buy">\n          <div>${formatGoldColored(t.total_buy)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.buy_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${y}\n        </td>\n        \n        <td class="item-solo-sell">\n          <div>${formatGoldColored(t.total_sell)}</div>\n          <div class="item-solo-precio">${formatGoldColored(t.sell_price)} <span style="color: #c99b5b">c/u</span></div>\n          ${h}\n        </td>\n        \n        <td class="item-solo-crafted">\n          ${t.is_craftable&&t.children&&t.children.length>0&&null!==t.total_crafted?`\n            <div>${formatGoldColored(t.total_crafted)}</div>\n            <div class="item-solo-precio">${formatGoldColored(0)} <span style="color: #c99b5b">c/u</span></div>\n            ${g}`:""}\n        </td>\n        \n        <td class="item-profit">${_}</td>\n        \n        <td class="th-border-right-items">${u}</td>\n      </tr>\n      ${t.children&&t.children.length&&o&&t.expanded?p(t.children,e+1,t._uid,d,t.expanded,[...l,t._uid]):""}\n    `}).join(""):""}function w(t,e=window._mainBuyPrice,n=window._mainSellPrice){null==e&&(e=window._mainBuyPrice),null==n&&(n=window._mainSellPrice),void 0===window._mainItemExpanded&&(window._mainItemExpanded=!1);!function(t){const e=document.querySelector(".qty-global-container");e&&(t?e.classList.add("visible"):e.classList.remove("visible"))}(window.ingredientObjs&&window.ingredientObjs.length>0);const a=window._mainRecipeOutputCount&&!isNaN(window._mainRecipeOutputCount)?window._mainRecipeOutputCount:1;void 0!==u()?u():window.globalQty;const o=null!=e?e*window.globalQty:0,l=window.ingredientObjs.reduce((t,e)=>t+(Number(e.sell_price)||0),0)*window.globalQty,d=Math.min(t.totalBuy,t.totalSell,t.totalCrafted),r=[o,l,d],s=r.filter(t=>"number"==typeof t&&t>0),c=s.length?Math.min(...s):null,m=null!=c?r.indexOf(c):-1;let w="Sin datos de mercado";0===m?w="Mejor comprar (Buy)":1===m?w="Mejor vender (Sell)":2===m&&(w="Mejor craftear (Crafted)");let f="";t.totalBuy,t.totalSell,t.totalCrafted;t.totalBuy,t.totalSell,t.totalCrafted,1===a&&(f="");let b=`<div class="table-modern-totales">\n    <h3>Precio total materiales - Crafting</h3>\n    <div id="totales-crafting">      \n      <table class="table-totales" style="margin-top:12px;">\n        <tr>\n          <th><div class="tooltip-modern">Total Compra\n            <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-buy">${formatGoldColored(t.totalBuy)}</td>\n          <th><div class="tooltip-modern">Total Venta\n            <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n          </div></th>\n          <td class="item-solo-sell">${formatGoldColored(t.totalSell)}</td>\n          <th><div class="tooltip-modern">Total Crafted\n            <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n          </div></th>\n          <td class="item-solo-crafted">${formatGoldColored(t.totalCrafted)}</td>\n        </tr>\n      </table>\n    </div>\n    </div>`,y="";a>1&&(y=`<div class="table-modern-totales">\n    <div style='margin-bottom:8px;color:#a1a1aa;font-size:1em;'>Esta receta produce <b>${a}</b> unidades por crafteo. Los siguientes costos son por unidad.</div>\n      <div id="totales-crafting">\n        <table class="table-totales" style="margin-top:12px;">\n          <tr>\n            <th><div class="tooltip-modern">Total Compra\n              <span class="tooltiptext-modern">Suma total si haces PEDIDO de materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-buy">${formatGoldColored(t.totalBuy/a)}</td>\n            <th><div class="tooltip-modern">Total Venta\n              <span class="tooltiptext-modern">Suma total si COMPRAS materiales en el mercado.</span>\n            </div></th>\n            <td class="item-solo-sell">${formatGoldColored(t.totalSell/a)}</td>\n            <th><div class="tooltip-modern">Total Crafted\n              <span class="tooltiptext-modern">Suma total si CRAFTEAS todos los materiales posibles desde cero.</span>\n            </div></th>\n              <td class="item-solo-crafted">${formatGoldColored(t.totalCrafted/a)}</td>\n          </tr>\n        </table>\n      </div>\n    </div>`);let h=w;if(1===a&&(formatGoldColored(o),formatGoldColored(l),formatGoldColored(d)),a>1){const t=null!=e?e:0,o=null!=n?n:0,l=a>0?d/a:d,i=[t,o,l],r=i.filter(t=>"number"==typeof t&&t>0),s=r.length?Math.min(...r):null,c=null!=s?i.indexOf(s):-1;h="Sin datos de mercado",0===c?h="Mejor comprar (Buy)":1===c?h="Mejor vender (Sell)":2===c&&(h="Mejor craftear (Crafted)"),formatGoldColored(t),formatGoldColored(o),formatGoldColored(l)}return`\n    <h3>Comparativa de items</h3>\n\n    <table class="table-modern tabla-tarjetas">\n      <thead class="header-items table-comparison-row">\n        <tr>\n          <th class="th-border-left">Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio de venta</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n          <th>Total Crafted</th>\n          <th>Mejor Profit</th>\n          <th class="th-border-right"></th>\n        </tr>\n      </thead>\n      <tbody>\n        ${window.ingredientObjs.map(t=>`\n          ${function(t,e){const n={totalBuy:t.total_buy,totalSell:t.total_sell,totalCrafted:void 0!==t.total_crafted&&null!==t.total_crafted?t.total_crafted:i().totalCrafted};if(!t)return"";const a=!!window._mainItemExpandedMap[t.id],o=`<button class="btn-expand btn-expand-main" id="btn-expand-main-${t.id}" data-id="${t.id}">${a?"▴":"▾"}</button> <button class="btn-delete-main" data-id="${t.id}" title="Eliminar">-</button>`,l="function"==typeof getRarityClass?getRarityClass(t.rarity):"";return`\n    <tr class="row-bg-main">\n      <td class="th-border-left-items"><img src="${t.icon}" width="32"></td>\n      <td><a href="/item?id=${t.id}" class="item-link ${l}" target="_blank">${t.recipe&&t.recipe.output_item_count&&t.recipe.output_item_count>1?`<span style='color:#a1a1aa;font-size:0.95em;display:block;margin-bottom:2px;'>Receta produce <b>${t.recipe.output_item_count}</b> unidades<br>Profit mostrado es por unidad</span>`:""}${t.name}</a></td>\n      <td>${e}</td>\n      <td class="item-unit-sell">${formatGoldColored(Number(t.sell_price))} <span style="color: #c99b5b">c/u</span></td>\n      <td class="item-solo-buy"><div>${formatGoldColored(n.totalBuy)}</div></td>\n      <td class="item-solo-sell"><div>${formatGoldColored(n.totalSell)}</div></td>\n      <td class="item-solo-crafted"><div>${formatGoldColored(n.totalCrafted)}</div></td>\n      <td class="item-profit">${(()=>{const a=Number(t.sell_price)*e,o=a-.15*a-Math.min(n.totalBuy,n.totalSell,n.totalCrafted);return`<span style='font-weight:bold;color:${o>0?"#4fc178":"#e84d4d"}'>${formatGoldColored(o)}</span>`})()}</td>\n      <td class="th-border-right-items"><div style="display:flex;gap:6px;align-items:center;">${o}</div></td>\n    </tr>\n  `}(t,window.globalQty,t.total_buy,t.total_sell,t.total_crafted)}\n          ${window._mainItemExpandedMap[t.id]?p(t.children,1,t._uid,0,!0,[t._uid]):""}\n`).join("")}\n      </tbody>\n    </table>\n    \x3c!-- ${a>1?y:b} --\x3e\n    \x3c!-- Comparativa de precios oculta --\x3e\n    ${f}\n  `}async function f(t,e){const n=o(window.ingredientObjs),a=document.getElementById("item-header");a&&(a.style.display="none");const i=e||{};formatGoldColored(null!=i.buy_price?i.buy_price:0),formatGoldColored(null!=i.sell_price?i.sell_price:0),null!=i.buy_quantity&&i.buy_quantity,null!=i.sell_quantity&&i.sell_quantity,l(window.ingredientObjs,n),await y(e?.buy_price,e?.sell_price)}async function b(t,e){window._lastItemData=t,window._lastMarketData=e;const n=document.getElementById("item-skeleton");s(n),m(),await f(0,e)}async function y(t=window._mainBuyPrice,e=window._mainSellPrice){null==t&&(t=window._mainBuyPrice),null==e&&(e=window._mainSellPrice);const o=n("usePrecomputed");let l;o&&window.comparativa?.getPrecomputedTotals?l=window.comparativa.getPrecomputedTotals(window.globalQty):(await a(window.ingredientObjs,window.globalQty),l=i(),o||window.comparativa?.clearComparativaMeta?.(null)),l||(l={totalBuy:0,totalSell:0,totalCrafted:0});const r=document.getElementById("seccion-crafting");if(r){const n=w(l,t,e);!function(t){const e="undefined"!=typeof window&&"function"==typeof window.requestIdleCallback?window.requestIdleCallback.bind(window):t=>{const e=Date.now();return setTimeout(()=>t({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-e))}),0)};e(function n(a){const o=a||{timeRemaining:()=>0};for(;o.timeRemaining()>0&&t.length;){const e=t.shift();"function"==typeof e&&e()}t.length&&e(n)})}([()=>{r.innerHTML=n},()=>d()])}else d();o&&window.comparativa?.updateFreshnessBanner&&window.comparativa.updateFreshnessBanner()}window.checkTreeForInvalidIds=function t(e,n=""){if(Array.isArray(e))for(const a of e)a&&void 0!==a.id&&null!==a.id||console.warn("Ingrediente sin id válido en ruta:",n,a),Array.isArray(a.children)&&t(a.children,n+" > "+(a.name||a.id))},void 0===window._mainItemExpandedMap&&(window._mainItemExpandedMap={}),window._mainExpandBtnHandlerInstalled||(window._mainExpandBtnHandlerInstalled=!0,document.addEventListener("click",function(t){if(t.target&&t.target.classList.contains("btn-expand-main")){const e=t.target.getAttribute("data-id");if(!e)return;window._mainItemExpandedMap[e]=!window._mainItemExpandedMap[e],y(),t.stopPropagation()}}),document.addEventListener("click",function(t){if(t.target&&(t.target.classList.contains("btn-delete-main")||"function"==typeof t.target.closest&&t.target.closest(".btn-delete-main"))){let e=t.target;if(e.classList.contains("btn-delete-main")||"function"!=typeof e.closest||(e=e.closest(".btn-delete-main")),!e)return;const n=e.getAttribute("data-id");if(!n)return;window.ingredientObjs&&Array.isArray(window.ingredientObjs)&&(window.ingredientObjs=window.ingredientObjs.filter(t=>String(t.id)!==String(n)),window._mainItemExpandedMap&&delete window._mainItemExpandedMap[n]),window.comparativa?.clearComparativaMeta&&window.comparativa.clearComparativaMeta(n),y(),t.stopPropagation()}})),window._modeChangeHandlerInstalled||(window._modeChangeHandlerInstalled=!0,document.addEventListener("click",function(e){const n=e.target;if(n.matches(".chk-mode-buy, .chk-mode-sell, .chk-mode-crafted")){const e=n.getAttribute("data-path");if(!e)return;const a=e.split("-").pop(),o=t(window.ingredientObjs||[],a);if(o){let t="buy";n.classList.contains("chk-mode-sell")&&(t="sell"),n.classList.contains("chk-mode-crafted")&&(t="crafted"),"function"==typeof o.setMode?o.setMode(t):(o.modeForParentCrafted=t,o.findRoot()?.recalc(window.globalQty||1,null),y())}}})),window._expandBtnHandlerInstalled||(window._expandBtnHandlerInstalled=!0),window.ingredientObjs&&function t(e,n=""){e.forEach(e=>{e._parentId=null!==n?String(n):"",Array.isArray(e.children)&&t(e.children,e._uid)})}(window.ingredientObjs),document.addEventListener("click",function(e){if(e.target&&e.target.classList.contains("btn-expand")){const n=e.target.getAttribute("data-path");if(!n)return;const a=n.split("-").pop(),o=t(window.ingredientObjs||[],a);o&&(o.expanded=!o.expanded,y())}}),window._qtyGlobalHandlerInstalled||(window._qtyGlobalHandlerInstalled=!0,document.addEventListener("input",function(t){t.target&&"qty-global"===t.target.id&&(window._qtyInputValue=t.target.value)}),document.addEventListener("blur",function(t){if(t.target&&"qty-global"===t.target.id){const n=t.target;let a=parseInt(n.value,10);isNaN(a)||a<1?(e(1),window._qtyInputValue="1"):(e(a),window._qtyInputValue=n.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,y()}},!0),document.addEventListener("keydown",function(t){if(t.target&&"qty-global"===t.target.id&&"Enter"===t.key){t.preventDefault();const n=t.target;let a=parseInt(n.value,10);isNaN(a)||a<1?(e(1),window._qtyInputValue="1"):(e(a),window._qtyInputValue=n.value),void 0!==window._qtyInputValue&&String(window._qtyInputValue)===String(window.globalQty)&&delete window._qtyInputValue,y()}})),"undefined"!=typeof window&&(window.showSkeleton=r,window.hideSkeleton=s,window.showError=c,window.hideError=m,window.safeRenderTable=y,window.renderItemUI=f,window.installUIEvents=function(){});export{b as initItemUI,f as renderItemUI,y as safeRenderTable};
