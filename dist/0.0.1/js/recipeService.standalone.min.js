var RecipeServiceBundle=function(e){"use strict";const t={item:null,recipe:null,price:3e5,history:864e5,bundle:3e5},r="undefined"!=typeof window&&"BroadcastChannel"in window?new BroadcastChannel("cache-sync"):null;let n=null;function o(e){r&&r.postMessage({type:"delete",key:e})}const s="gw2.precomputed.bucket",i="gw2.canary.assignments",c="default";function a(e,t,r){if(e)try{null===r?e.removeItem(t):e.setItem(t,String(r))}catch{}}function l(e){if(null==e)return null;const t=Number.isFinite(e)?Number(e):Number.parseInt(e,10);if(!Number.isFinite(t))return null;const r=Math.floor(t);return r<0||r>=100?null:r}function u(e){if(!e)return null;if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?e.toISOString():null}const t=new Date(e),r=t.getTime();return Number.isFinite(r)?t.toISOString():null}function f(e){if(null==e)return null;const t=String(e).trim();if(!t)return null;return t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").replace(/[_\s]+/g,"-").toLowerCase().replace(/[^a-z0-9-]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,"")||null}function p(e={}){if("string"==typeof e)return p({scope:e});if(!e||"object"!=typeof e)return c;const t=e=>"string"==typeof e&&e?e:null,r=t(e.feature??e.flag??e.name??null);if(r){const e=f(r);if(e)return`feature:${e}`}const n=t(e.screen??e.page??null);if(n){const e=f(n);if(e)return`screen:${e}`}const o=t(e.scope);if(o){if(/^(feature|screen):/i.test(o)){const[e,t]=o.split(":",2),r=f(t);return r?`${e.toLowerCase()}:${r}`:null}return f(o)||null}return c}function A(e){const t=function(e,t=s){if(!e)return null;try{return e.getItem(t)}catch{return null}}(e,i);if(!t||"string"!=typeof t)return{version:1,buckets:{}};try{const e=JSON.parse(t);if(!e||"object"!=typeof e)return{version:1,buckets:{}};const r={},n=e.buckets&&"object"==typeof e.buckets?e.buckets:{};for(const[e,t]of Object.entries(n)){if(!e)continue;const n=l("object"==typeof t&&null!==t?t.bucket:t);if(null==n)continue;const o=u(t?.assignedAt??t?.updatedAt??null),s=u(t?.expiresAt??null),i=t?.feature?f(t.feature):null,c=t?.screen?f(t.screen):null;r[e]={bucket:n,assignedAt:o||null,expiresAt:s||null,source:t?.source?String(t.source):null,feature:i,screen:c}}return{version:Number.isFinite(e.version)?Number(e.version):1,buckets:r}}catch{return{version:1,buckets:{}}}}function _(e,t){if(!e)return;const r=JSON.stringify(t);a(e,i,r)}function d(e,{source:t=null,feature:r=null,screen:n=null,now:o=new Date,expiresAt:s=null}={}){return{bucket:e,assignedAt:u(o)||null,expiresAt:s?u(s):null,source:t||null,feature:r?f(r):null,screen:n?f(n):null}}function y(e,t){if(!e||!e.expiresAt)return!1;const r=Date.parse(e.expiresAt);return!!Number.isFinite(r)&&t>r}function E(e){if(null==e)return[];if("string"==typeof e)try{return E(JSON.parse(e))}catch{const t=l(e);return null!=t?[{scope:c,bucket:t}]:[]}if("number"==typeof e){const t=l(e);return null!=t?[{scope:c,bucket:t}]:[]}if(Array.isArray(e))return e.flatMap(e=>E(e));if("object"!=typeof e)return[];const t=[],r=["default","global"];for(const n of r)if(Object.prototype.hasOwnProperty.call(e,n)){const r=e[n];r&&"object"==typeof r&&!Array.isArray(r)?t.push(...E({scope:c,...r})):t.push(...E({scope:c,bucket:r}))}if(Object.prototype.hasOwnProperty.call(e,"features")){const r=e.features;if(r&&"object"==typeof r)for(const[e,n]of Object.entries(r))t.push(...E({feature:e,...n&&"object"==typeof n?n:{bucket:n}}))}if(Object.prototype.hasOwnProperty.call(e,"screens")||Object.prototype.hasOwnProperty.call(e,"pages")){const r=e.screens||e.pages;if(r&&"object"==typeof r)for(const[e,n]of Object.entries(r))t.push(...E({screen:e,...n&&"object"==typeof n?n:{bucket:n}}))}const n=new Set(["features","screens","pages","default","global","scope","feature","flag","name","screen","page","bucket","value","assignment","assignedAt","updatedAt","expiresAt","source","remove"]);for(const[r,o]of Object.entries(e))n.has(r)||t.push(...E({scope:r,...o&&"object"==typeof o?o:{bucket:o}}));const o=p(e),s=l(e.bucket??e.value??e.assignment??null);return(!0===e.remove||null===e.bucket||null===e.value)&&o?t.push({scope:o,remove:!0}):o&&null!=s&&t.push({scope:o,bucket:s,feature:e.feature??null,screen:e.screen??null,source:e.source??null,assignedAt:e.assignedAt??e.updatedAt??null,expiresAt:e.expiresAt??null}),t}function g(e,{source:t=null,now:r=()=>new Date}={}){const n="undefined"!=typeof window&&window&&window.localStorage?window.localStorage:"undefined"!=typeof globalThis&&globalThis.localStorage?globalThis.localStorage:null,o=function(e){const t=A(e);return t.buckets&&"object"==typeof t.buckets||(t.buckets={}),t}(n),i=r instanceof Date?r.getTime():Number(r),l=Number.isFinite(i)?i:Date.now();let u=function(e,t){let r=!1;for(const[n,o]of Object.entries(e.buckets))y(o,t)&&(delete e.buckets[n],r=!0);return r}(o,l);const f=E(e);if(!f.length)return u&&n&&_(n,o),o.buckets;const p=new Date(l),g=new Set;for(const e of f){if(!e||!e.scope)continue;if(g.has(e.scope)&&delete o.buckets[e.scope],g.add(e.scope),e.remove){o.buckets[e.scope]&&(delete o.buckets[e.scope],u=!0);continue}const r=d(e.bucket,{source:e.source||t||null,feature:e.feature||null,screen:e.screen||null,now:e.assignedAt?new Date(e.assignedAt):p,expiresAt:e.expiresAt||null});o.buckets[e.scope]=r,e.scope===c&&n&&a(n,s,e.bucket),u=!0}return u&&n&&_(n,o),o.buckets}const h={API_BASE_URL:"/api",CDN_BASE_URL:"",DEFAULT_LANG:"es",FALLBACK_LANGS:["en"],MARKET_CSV_URL:"https://api.datawars2.ie/gw2/v1/items/csv",GW2_API_KEY:"",priceCacheStrategy:"sessionStorage",FEATURE_USE_PRECOMPUTED:!1,FEATURE_MARKET_CSV_EXTERNAL:!0,FEATURE_MARKET_CSV_EXTERNAL_WORKER:!1,FEATURE_DONES_AGGREGATE:!1,PRECOMPUTED_CANARY_THRESHOLD:1,FETCH_GUARD_MODE:"enforce",FETCH_GUARD_WHITELIST:[],CONNECT_ALLOWLIST:[],FETCH_GUARD_REPORT_URL:null,FEATURE_ITEM_API_ROLLOUT:!1,CANARY_ASSIGNMENTS:{},CANARY_ROLLOUTS:null};function R(e,t=!1){if("boolean"==typeof e)return e;if(null==e)return t;if("number"==typeof e)return Number.isNaN(e)?t:0!==e;const r=String(e).trim().toLowerCase();return r?!!["1","true","yes","on"].includes(r)||!["0","false","no","off"].includes(r)&&t:t}function b(e,t){if(t&&"object"==typeof t){if(Object.prototype.hasOwnProperty.call(t,"API_BASE_URL")&&null!=t.API_BASE_URL&&(e.API_BASE_URL=t.API_BASE_URL),Object.prototype.hasOwnProperty.call(t,"CDN_BASE_URL")&&null!=t.CDN_BASE_URL&&(e.CDN_BASE_URL=t.CDN_BASE_URL),Object.prototype.hasOwnProperty.call(t,"DEFAULT_LANG")&&t.DEFAULT_LANG&&(e.DEFAULT_LANG=t.DEFAULT_LANG),Object.prototype.hasOwnProperty.call(t,"LANG")&&t.LANG&&(e.DEFAULT_LANG=t.LANG),Object.prototype.hasOwnProperty.call(t,"MARKET_CSV_URL")&&t.MARKET_CSV_URL&&(e.MARKET_CSV_URL=t.MARKET_CSV_URL),Object.prototype.hasOwnProperty.call(t,"GW2_API_KEY")&&null!=t.GW2_API_KEY&&(e.GW2_API_KEY=t.GW2_API_KEY),Object.prototype.hasOwnProperty.call(t,"priceCacheStrategy")&&t.priceCacheStrategy?e.priceCacheStrategy=t.priceCacheStrategy:Object.prototype.hasOwnProperty.call(t,"PRICE_CACHE_STRATEGY")&&t.PRICE_CACHE_STRATEGY&&(e.priceCacheStrategy=t.PRICE_CACHE_STRATEGY),Object.prototype.hasOwnProperty.call(t,"FEATURE_USE_PRECOMPUTED")&&(e.FEATURE_USE_PRECOMPUTED=t.FEATURE_USE_PRECOMPUTED),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL")?e.FEATURE_MARKET_CSV_EXTERNAL=t.FEATURE_MARKET_CSV_EXTERNAL:Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_INTERNAL")&&(e.FEATURE_MARKET_CSV_EXTERNAL=!R(t.FEATURE_MARKET_CSV_INTERNAL,!0)),Object.prototype.hasOwnProperty.call(t,"FEATURE_MARKET_CSV_EXTERNAL_WORKER")&&(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=t.FEATURE_MARKET_CSV_EXTERNAL_WORKER),Object.prototype.hasOwnProperty.call(t,"FEATURE_DONES_AGGREGATE")&&(e.FEATURE_DONES_AGGREGATE=t.FEATURE_DONES_AGGREGATE),Object.prototype.hasOwnProperty.call(t,"FEATURE_ITEM_API_ROLLOUT")&&(e.FEATURE_ITEM_API_ROLLOUT=t.FEATURE_ITEM_API_ROLLOUT),Object.prototype.hasOwnProperty.call(t,"PRECOMPUTED_CANARY_THRESHOLD")&&(e.PRECOMPUTED_CANARY_THRESHOLD=t.PRECOMPUTED_CANARY_THRESHOLD),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_MODE")&&"string"==typeof t.FETCH_GUARD_MODE&&(e.FETCH_GUARD_MODE=t.FETCH_GUARD_MODE),Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_WHITELIST")){const r=t.FETCH_GUARD_WHITELIST;if(Array.isArray(r))e.FETCH_GUARD_WHITELIST=[...r];else if("string"==typeof r){const t=r.split(",").map(e=>e.trim()).filter(Boolean);e.FETCH_GUARD_WHITELIST=t}}if(Object.prototype.hasOwnProperty.call(t,"CONNECT_ALLOWLIST")&&Array.isArray(t.CONNECT_ALLOWLIST)&&(e.CONNECT_ALLOWLIST=[...t.CONNECT_ALLOWLIST]),Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANGS")){const r=t.FALLBACK_LANGS;Array.isArray(r)?e.FALLBACK_LANGS=[...r]:"string"==typeof r&&(e.FALLBACK_LANGS=r.split(",").map(e=>e.trim()).filter(Boolean))}else if(Object.prototype.hasOwnProperty.call(t,"FALLBACK_LANG")){const r=t.FALLBACK_LANG;"string"==typeof r&&(e.FALLBACK_LANGS=r.split(",").map(e=>e.trim()).filter(Boolean))}if(Object.prototype.hasOwnProperty.call(t,"FETCH_GUARD_REPORT_URL")){const r=t.FETCH_GUARD_REPORT_URL;null!=r&&"string"!=typeof r||(e.FETCH_GUARD_REPORT_URL=r)}Object.prototype.hasOwnProperty.call(t,"CANARY_ASSIGNMENTS")&&(e.CANARY_ASSIGNMENTS=t.CANARY_ASSIGNMENTS),Object.prototype.hasOwnProperty.call(t,"CANARY_ROLLOUTS")?e.CANARY_ROLLOUTS=t.CANARY_ROLLOUTS:Object.prototype.hasOwnProperty.call(t,"CANARY_THRESHOLDS")&&(e.CANARY_ROLLOUTS=t.CANARY_THRESHOLDS)}}function T(e){if(null==e)return null;const t=Number(e);if(!Number.isFinite(t))return null;const r=Math.floor(t);return r<0?0:r>100?100:r}function L(){const e={...h,FETCH_GUARD_WHITELIST:[...h.FETCH_GUARD_WHITELIST],CONNECT_ALLOWLIST:[...h.CONNECT_ALLOWLIST]},t=("undefined"!=typeof globalThis?globalThis.window&&"object"==typeof globalThis.window?globalThis.window:globalThis.self&&"object"==typeof globalThis.self?globalThis.self:globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0)||("undefined"!=typeof globalThis?globalThis:void 0),r=t&&"object"==typeof t.Config?t.Config:null,n=t&&"object"==typeof t.__RUNTIME_CONFIG__?t.__RUNTIME_CONFIG__:null,o=t&&"object"==typeof t.__SECURE_RUNTIME_CONFIG__?t.__SECURE_RUNTIME_CONFIG__:null,s=function({legacy:e,runtime:t,secureRuntime:r,globalScope:n}){const o=[r&&(r.DEBUG_RUNTIME??r.DEBUG),t&&(t.DEBUG_RUNTIME??t.DEBUG),e&&(e.DEBUG_RUNTIME??e.DEBUG),n&&(n.__RUNTIME_DEBUG__??n.__DEBUG__)];for(const e of o)if(void 0!==e)return R(e,!1);if(n&&n.location&&"string"==typeof n.location.search){const e=String(n.location.search||"");if(e)try{const t=new URLSearchParams(e.startsWith("?")?e.slice(1):e),r=["debugRuntime","runtimeDebug","debug-config"];for(const e of r)if(t.has(e)){const r=t.get(e);return R(null==r||r,!0)}}catch(t){if(/[?&](debugRuntime|runtimeDebug|debug-config)(?:=|&|$)/i.test(e))return!0}}return!1}({legacy:r,runtime:n,secureRuntime:o,globalScope:t});b(e,r),b(e,n),b(e,o),e.FEATURE_USE_PRECOMPUTED=R(e.FEATURE_USE_PRECOMPUTED,h.FEATURE_USE_PRECOMPUTED),e.FEATURE_MARKET_CSV_EXTERNAL=R(e.FEATURE_MARKET_CSV_EXTERNAL,h.FEATURE_MARKET_CSV_EXTERNAL),e.FEATURE_MARKET_CSV_EXTERNAL_WORKER=R(e.FEATURE_MARKET_CSV_EXTERNAL_WORKER,h.FEATURE_MARKET_CSV_EXTERNAL_WORKER),e.FEATURE_ITEM_API_ROLLOUT=R(e.FEATURE_ITEM_API_ROLLOUT,h.FEATURE_ITEM_API_ROLLOUT);const i=Number(e.PRECOMPUTED_CANARY_THRESHOLD);e.PRECOMPUTED_CANARY_THRESHOLD=Number.isFinite(i)?Math.min(Math.max(i,0),100):h.PRECOMPUTED_CANARY_THRESHOLD;const a=Array.isArray(e.FALLBACK_LANGS)?e.FALLBACK_LANGS:"string"==typeof e.FALLBACK_LANGS?e.FALLBACK_LANGS.split(","):[];if(null!=e.CDN_BASE_URL&&""!==e.CDN_BASE_URL){const t=String(e.CDN_BASE_URL).trim().replace(/\/$/,"");e.CDN_BASE_URL=t}else e.CDN_BASE_URL="";const l=String(e.DEFAULT_LANG||h.DEFAULT_LANG).trim().toLowerCase();e.FALLBACK_LANGS=[...new Set(a.map(e=>"string"==typeof e?e.trim().toLowerCase():"").filter(e=>e&&e!==l))],e.LANG=e.DEFAULT_LANG||h.DEFAULT_LANG;const u=String(e.LANG||"").trim().toLowerCase();e.FALLBACK_LANGS=e.FALLBACK_LANGS.filter(e=>e&&e!==u);const f=g(e.CANARY_ASSIGNMENTS,{source:"runtime-config"});if(e.CANARY_ASSIGNMENTS=function(e){const t={};if(!e||"object"!=typeof e)return t;for(const[r,n]of Object.entries(e))r&&n&&"object"==typeof n&&(t[r]={...n});return t}(f),e.CANARY_ROLLOUTS=function(e,t){const r=T(null!=t?t:h.PRECOMPUTED_CANARY_THRESHOLD),n={scope:c,threshold:r},o={default:{...n},features:{},screens:{},scopes:{[c]:{...n}}},s=e=>{const t=T(e);null!=t&&(o.default.threshold=t,o.scopes[c]={scope:c,threshold:t})},i=(e,t)=>{const r=T(t);if(null==r)return;const n=p({feature:e});if(!n||!n.startsWith("feature:"))return;const s=n.slice(8),i={scope:n,threshold:r,name:"string"==typeof e&&e?e:s};o.features[s]=i,o.scopes[n]=i},a=(e,t)=>{const r=T(t);if(null==r)return;const n=p({screen:e});if(!n||!n.startsWith("screen:"))return;const s=n.slice(7),i={scope:n,threshold:r,name:"string"==typeof e&&e?e:s};o.screens[s]=i,o.scopes[n]=i},l=(e,t)=>{const r=T(t);if(null==r)return;const n=p(e);n&&(n!==c?n.startsWith("feature:")?i(n.slice(8),r):n.startsWith("screen:")?a(n.slice(7),r):o.scopes[n]={scope:n,threshold:r}:s(r))},u=e=>{if(null!=e)if("number"!=typeof e&&"string"!=typeof e){if(Array.isArray(e))e.forEach(u);else if("object"==typeof e){if(Object.prototype.hasOwnProperty.call(e,"default")&&s(e.default),Object.prototype.hasOwnProperty.call(e,"features")){const t=e.features;if(t&&"object"==typeof t)for(const[e,r]of Object.entries(t))r&&"object"==typeof r&&!Array.isArray(r)?i(e,r.threshold??r.value??r.bucket??r.rollout):i(e,r)}if(Object.prototype.hasOwnProperty.call(e,"screens")||Object.prototype.hasOwnProperty.call(e,"pages")){const t=e.screens||e.pages;if(t&&"object"==typeof t)for(const[e,r]of Object.entries(t))r&&"object"==typeof r&&!Array.isArray(r)?a(e,r.threshold??r.value??r.bucket??r.rollout):a(e,r)}if(Object.prototype.hasOwnProperty.call(e,"scopes")){const t=e.scopes;if(t&&"object"==typeof t)for(const[e,r]of Object.entries(t))r&&"object"==typeof r&&!Array.isArray(r)?l(e,r.threshold??r.value??r.bucket??r.rollout):l(e,r)}for(const[t,r]of Object.entries(e))["default","features","screens","pages","scopes"].includes(t)||l(t,r)}}else s(e)};return u(e),o}(e.CANARY_ROLLOUTS,e.PRECOMPUTED_CANARY_THRESHOLD),!e.CANARY_ROLLOUTS.scopes[c]){const t={scope:c,threshold:e.PRECOMPUTED_CANARY_THRESHOLD};e.CANARY_ROLLOUTS.scopes[c]=t,e.CANARY_ROLLOUTS.default=t}return function({debugMode:e,legacy:t,runtime:r,secureRuntime:n}){if(!e||"undefined"==typeof console||null===console)return;const o=new Date,s={legacyConfig:Boolean(t),runtimeConfig:Boolean(r),secureRuntimeConfig:Boolean(n),runtimeLoadedAt:r&&Object.prototype.hasOwnProperty.call(r,"__loadedAt")?r.__loadedAt:null,configInitializedAt:o.toISOString()};if(!r)return void console.warn("[runtime-config][debug] runtime-env.js was not available during config initialization.",s);if(!Object.prototype.hasOwnProperty.call(r,"__loadedAt"))return void console.warn('[runtime-config][debug] runtime-env.js missing "__loadedAt" marker; verify load order.',s);const i="string"==typeof r.__loadedAt?Date.parse(r.__loadedAt):Number.isFinite(r.__loadedAt)?Number(r.__loadedAt):Number.NaN;if(Number.isNaN(i))return void console.warn('[runtime-config][debug] runtime-env.js has an invalid "__loadedAt" timestamp.',s);const c=o.getTime()-i;s.runtimeLoadedDeltaMs=c,c<-50?console.warn("[runtime-config][debug] runtime-env.js appears to have executed after config.js. Ensure /runtime-env.js loads first.",s):console.info("[runtime-config][debug] runtime configuration applied successfully.",{...s,lang:r.LANG,flags:r.FLAGS})}({debugMode:s,legacy:r,runtime:n,secureRuntime:o}),e}const w="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:null,m="__GW2_FETCH_GUARD_INSTALLED__";if(w&&"function"==typeof w.fetch&&!w[m]){const e=w.fetch;let t=S(w)||"http://localhost";const r=()=>{const e=S(w);e&&t!==e&&(t=e);const r=function(){try{return L()}catch{return null}}(),n=function(e){if("string"!=typeof e)return"off";const t=e.trim().toLowerCase();if(!t)return"off";const r=t.replace(/[_\s]+/g,"-");if(["off","disabled","disable","none","0","false"].includes(r))return"off";if(["enforce","block","blocked","deny","enforced","strict","on","true"].includes(r))return"enforce";if(["report-only","report","monitor","monitoring","warn","warning"].includes(r))return"report-only";return"off"}(r?.FETCH_GUARD_MODE),o=function(e){if("string"!=typeof e)return null;const t=e.trim();return t||null}(r?.FETCH_GUARD_REPORT_URL),s=function(e,t){const r=new Set,n=e=>{e&&(Array.isArray(e)?e.forEach(n):r.add(e))},o=e=>{if(e||0===e)if(Array.isArray(e))e.forEach(o);else if("string"!=typeof e)try{const r=C(String(e),t);n(r)}catch{}else e.split(",").forEach(e=>{const r=C(e.trim(),t);n(r)})},s=[e?.API_BASE_URL,e?.MARKET_CSV_URL,"/api","api","/backend/api","backend/api","/recipe-tree","https://api.guildwars2.com","https://api.datawars2.ie"],i=e?.FETCH_GUARD_WHITELIST,c=function(e){if(Array.isArray(e))return e.length>0;if(null==e)return!1;if("string"==typeof e)return e.split(",").some(e=>e.trim());return!0}(i);o(s),o(i),o(e?.fetchGuardWhitelist),o(e?.fetchWhitelist),o(e?.FETCH_WHITELIST),c||o(e?.CONNECT_ALLOWLIST);return Array.from(r)}(r,e);return{mode:n,reportUrl:o,whitelist:s,locationOrigin:e}},n=(e,r,n)=>{if("off"===n.mode)return;const o=`[fetchGuard] ${e}: ${r}`;try{"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(o)}catch{}if(!n.reportUrl)return;let s;try{s=JSON.stringify({source:"fetchGuard",reason:e,targetUrl:r,mode:n.mode,timestamp:Date.now(),locationOrigin:n.locationOrigin})}catch{s=null}if(s){try{if("function"==typeof w.navigator?.sendBeacon)return void w.navigator.sendBeacon(n.reportUrl,s)}catch{}try{if("function"==typeof w.Image){const e=encodeURIComponent(s),r=function(e,t,r){if(!e)return null;try{const n=new URL(e,r);return n.searchParams.append("payload",t),n.href}catch{try{const r=e.includes("?")?"&":"?";return`${e}${r}payload=${t}`}catch{return null}}}(n.reportUrl,e,t);if(!r)return;const o=new w.Image;try{"referrerPolicy"in o&&(o.referrerPolicy="no-referrer")}catch{}const i=function(e){const t="__FETCH_GUARD_REPORT_IMAGES__";if(!e[t])try{Object.defineProperty(e,t,{value:new Set,configurable:!0,enumerable:!1,writable:!1})}catch{e[t]=new Set}return e[t]}(w);i.add(o);const c=()=>i.delete(o);try{o.onload=c,o.onerror=c}catch{}o.src=r}}catch{}}},o=function(o,s){const i=r(),c=function(e,t){if(!e&&""!==e)return null;const r=e=>{try{return new URL(e,t)}catch{return null}};if("undefined"!=typeof URL)try{if(e instanceof URL)return e}catch{}if("undefined"!=typeof Request)try{if(e instanceof Request)return r(e.url)}catch{}if("string"==typeof e)return r(e);if(e&&"string"==typeof e.url)return r(e.url);return null}(o,t);if(!c||"off"===i.mode||function(e,t){if(!e)return!1;const r="string"==typeof e.hostname?e.hostname.toLowerCase():"",n="string"==typeof e.origin?e.origin:"";let o="";if(n&&"null"!==n)try{o=new URL(n).hostname.toLowerCase()}catch{const e=n.toLowerCase(),t=e.indexOf("://");o=t>=0?e.slice(t+3):e}for(const n of t)switch(n.type){case"wildcard":return!0;case"origin":if(e.origin===n.value)return!0;break;case"href":if(e.href.startsWith(n.value))return!0;break;case"hostname":if(r===n.value)return!0;if(o&&o===n.value)return!0;break;case"hostname-pattern":if(N(r,n.value))return!0;if(N(o,n.value))return!0;break;case"pathname":if(e.pathname.startsWith(n.value))return!0}return!1}(c,i.whitelist))return e.call(this,o,s);let a;var l;l=c,a=l?.pathname.includes("/backend/")?"Legacy backend fetch detected":function(e,t){return!!e&&(!!t&&("null"!==e.origin&&e.origin!==t))}(c,i.locationOrigin)?"External fetch detected":"Blocked fetch detected";const u=function(e,t){if(e?.href)return e.href;if("string"==typeof t)return t;if(t&&"string"==typeof t.url)return t.url;return"unknown target"}(c,o);return n(a,u,i),"enforce"===i.mode?Promise.reject(function(e,t){const r=new Error(`[fetchGuard] ${e}: ${t}`);return r.name="FetchGuardError",r.reason=e,r.url=t,r}(a,u)):e.call(this,o,s)};o.originalFetch=e,w.fetch=o,w[m]=!0}function S(e){if(!e||"object"!=typeof e)return;const t=e.location&&"object"==typeof e.location?e.location:null,r=O(t?.origin);if(r)return r;const n=O(e.origin),o=function(e,t){if("string"!=typeof e)return null;const r=e.trim();if(!r)return null;try{return O(new URL(r).origin)}catch{if(!t)return null;try{return O(new URL(r,t).origin)}catch{return null}}}(t?.href,n);return o||(n||void 0)}function O(e){if("string"!=typeof e)return null;const t=e.trim();return t&&"null"!==t.toLowerCase()?t:null}function C(e,t){if(!e)return null;const r=e.trim();if(!r)return null;const n=r.replace(/^['"]|['"]$/g,"");if(!n)return null;const o=n.toLowerCase();if("self"===o){const e=O(t);return e?{type:"origin",value:e}:{type:"pathname",value:"/recipe-tree"}}if("*"===o)return{type:"wildcard"};if(/^\*\.[^*]+/.test(n)){const e=n.slice(2).toLowerCase();return e?{type:"hostname-pattern",value:e}:null}if(n.startsWith("//"))try{return{type:"origin",value:new URL(n,t||"http:").origin}}catch{return null}if(/^[a-zA-Z]+:\/\//.test(n))try{const e=new URL(n);return n.endsWith("/"),{type:"href",value:e.href}}catch{return null}if(n.startsWith("/"))return{type:"pathname",value:n};if(n.includes("://"))try{return{type:"href",value:new URL(n).href}}catch{return null}return n.includes(".")?{type:"hostname",value:n.toLowerCase()}:{type:"pathname",value:n.startsWith("/")?n:`/${n}`}}function N(e,t){if(!e||!t)return!1;const r=e.toLowerCase(),n=t.toLowerCase().replace(/^\.+/,"");return!!n&&(r===n||r.endsWith(`.${n}`))}const U=[];function I(){const e=Date.now()-6e4;for(;U.length&&U[0]<e;)U.shift()}function P(){I();const e=U.length;return e>5?"down":e>0?"slow":"ok"}let D;function v(){if("undefined"==typeof document)return;const e=P();D||(D=document.createElement("div"),D.id="api-status-indicator",D.style.position="fixed",D.style.bottom="10px",D.style.right="10px",D.style.padding="4px 8px",D.style.background="rgba(0,0,0,0.7)",D.style.color="#fff",D.style.borderRadius="4px",D.style.zIndex="10000",D.style.display="none",document.body.appendChild(D)),"ok"===e?D.style.display="none":(D.textContent="slow"===e?"API lenta":"API caída",D.style.display="block")}var F={recordFailure:function(){U.push(Date.now()),I(),v()},recordSuccess:function(){I(),v()},getState:P,getBackoff:function(){const e=P();return"down"===e?5e3:"slow"===e?1e3:0}};async function M(e,t={}){const{timeout:r=8e3,retries:n=3,backoff:o=300,signal:s,...i}=t;for(let t=0;t<=n;t++){const c=new AbortController,a=setTimeout(()=>c.abort(),r);s&&(s.aborted?c.abort():s.addEventListener("abort",()=>c.abort(),{once:!0}));try{const t=await fetch(e,{...i,signal:c.signal});return clearTimeout(a),F.recordSuccess(),t}catch(e){if(clearTimeout(a),F.recordFailure(),s?.aborted||t===n)throw e;const r=o*Math.pow(2,t);await new Promise(e=>setTimeout(e,r))}}}const G=new Map;!function(e){n=e,r&&r.addEventListener("message",({data:e})=>{const{type:t,key:o,entry:s}=e||{};if("request-bundles"!==t)t&&o&&("set"===t&&s?n.set(o,s):"delete"===t&&n.delete(o));else{if(!n)return;n.forEach((e,t)=>{t.startsWith("bundle_")&&r.postMessage({type:"set",key:t,entry:e})})}})}(G),r&&r.postMessage({type:"request-bundles"});const j="undefined"!=typeof localStorage;function k(e){try{return JSON.parse(e)}catch{return null}}function B(e,t){if(j)try{localStorage.setItem(e,function({value:e,expiresAt:t,etag:r,lastModified:n,lang:o,source:s,fallback:i}){return JSON.stringify({value:e,expiresAt:t,etag:r,lastModified:n,lang:o,source:s,fallback:i})}(t))}catch{}}function H(e,n,o=void 0,s={}){if(void 0===o){const r=e.split("_")[0];o=t[r]}const i=null==o?null:Date.now()+o,{etag:c=null,lastModified:a=null,lang:l=null,source:u=null,fallback:f=null}=s,p={value:n,expiresAt:i,updatedAt:(new Date).toISOString(),etag:c,lastModified:a,lang:l,source:u,fallback:f};G.set(e,p),B(e,{value:n,expiresAt:i,etag:c,lastModified:a,lang:l,source:u,fallback:f}),function(e,t){r&&r.postMessage({type:"set",key:e,entry:t})}(e,p)}function K(e,t=!1){let r=G.get(e);if(!r){const t=function(e){if(!j)return null;const t=localStorage.getItem(e);if(!t)return null;const r=k(t);return r||(localStorage.removeItem(e),null)}(e);if(t){const{value:n,expiresAt:o=null,etag:s=null,lastModified:i=null,lang:c=null,source:a=null,fallback:l=null}=t;r={value:n,expiresAt:o,updatedAt:(new Date).toISOString(),etag:s,lastModified:i,lang:c,source:a,fallback:l},G.set(e,r)}}return r?r.expiresAt&&Date.now()>r.expiresAt?(G.delete(e),j&&localStorage.removeItem(e),o(e),null):t?r:r.value:null}!function(){if(!j)return;const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t),n=k(localStorage.getItem(r));if(!n)continue;const{expiresAt:o}=n;o&&Date.now()>o&&e.push(r)}e.forEach(e=>{localStorage.removeItem(e),o(e)})}();const W=new Map;function $(e,t={},r=null,n=null,o){const s=W.get(e);s&&s.controller?.abort(),r&&!n&&(n=K(r,!0));const i={...t.headers||{}};n?.etag&&(i["If-None-Match"]=n.etag),n?.lastModified&&(i["If-Modified-Since"]=n.lastModified);const c=o?null:new AbortController,a=o??t.signal??c?.signal;return function(e,t,r){return W.set(e,{promise:t,controller:r}),t.finally(()=>W.delete(e)),t}(e,M(e,{...t,headers:i,signal:a}).then(async e=>304===e.status&&n?new Response(JSON.stringify(n.value),{status:200,headers:{"X-Cache":"HIT",ETag:n.etag||"","Last-Modified":n.lastModified||""}}):e).catch(e=>{if(e instanceof DOMException&&"AbortError"===e.name)throw e;throw e}),c).then(e=>e.clone())}const x=Object.prototype.hasOwnProperty;function Y(e){return null==e?[]:Array.isArray(e)?e:[e]}function V(e,t){const r=e&&"object"==typeof e&&!Array.isArray(e)?{...e}:{errors:[]};Array.isArray(r.errors)||(r.errors=Y(r.errors));const n=function(e,t){if(e&&"string"==typeof e.traceId&&e.traceId)return e.traceId;if(t&&"object"==typeof t&&!Array.isArray(t)){if("string"==typeof t.traceId&&t.traceId)return t.traceId;const e=t.meta&&"object"==typeof t.meta?t.meta.traceId:null;if("string"==typeof e&&e)return e}return null}(r,t);return n?r.traceId=n:x.call(r,"traceId")||(r.traceId=null),r}function X(e,t,r){return{data:e,meta:V(t,r)}}function J(e){if(null==e)return X(null,{errors:[]},e);if("object"!=typeof e||e instanceof Response)return X(e,{errors:[]},e);if(Array.isArray(e))return X(e,{errors:[]},e);if(x.call(e,"data")){const t=x.call(e,"meta")&&"object"==typeof e.meta?{...e.meta,errors:Y(e.meta?.errors)}:{errors:[]};return X(e.data,t,e)}if(x.call(e,"meta")){return X(null,"object"==typeof e.meta?{...e.meta,errors:Y(e.meta?.errors)}:{errors:[]},e)}const{errors:t,...r}=e;return X(r,{errors:Y(t)},e)}const z=new Map;function q(){return"sessionStorage"===function(){const e=L();return e?.priceCacheStrategy||"sessionStorage"}()}function Z(e){return`price_${e}`}function Q(e){if(!q()||"undefined"==typeof sessionStorage)return null;const t=sessionStorage.getItem(Z(e));if(!t)return null;try{const{value:r,expires:n}=JSON.parse(t);return n&&Date.now()>n?(sessionStorage.removeItem(Z(e)),null):r}catch{return sessionStorage.removeItem(Z(e)),null}}async function ee(e){if(!Array.isArray(e)||0===e.length)return new Map;const t=L();if("redis"===(t?.priceCacheStrategy||"sessionStorage")){const t=`/backend/api/itemBundle.php?ids=${e.join(",")}`,r=await fetch(t);if(!r.ok)throw new Error("Price fetch failed");const n=await r.json().catch(()=>null),{data:o,meta:s}=J(n),i=Array.isArray(o)?o:[];!Array.isArray(o)&&Array.isArray(s?.errors)&&s.errors.length&&console.warn("itemBundle precios devolvió errores",s.errors);const c=new Map;return i.forEach(e=>{const t=e.market||{};c.set(e.id,{buy_price:t.buy_price||0,sell_price:t.sell_price||0})}),c}{const r=["id","buy_price","sell_price"].join(","),n=Boolean(t?.FEATURE_MARKET_CSV_EXTERNAL)?t?.MARKET_CSV_URL||"https://api.datawars2.ie/gw2/v1/items/csv":function(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,""),n=String(t).replace(/^\/+/,"");return r?n?`${r}/${n}`:r||"/":n?`/${n}`:"/"}(t?.API_BASE_URL||"/api","/market.csv"),o=new URLSearchParams;o.set("fields",r),o.set("ids",e.join(","));const s=`${n}?${o.toString()}`,i=await fetch(s);if(!i.ok)throw new Error("Price fetch failed");const c=(await i.text()).trim().split("\n"),a=c[0].split(","),l=new Map;for(let e=1;e<c.length;e++){if(!c[e])continue;const t=c[e].split(","),r={};a.forEach((e,n)=>{const o=t[n];r[e]=void 0!==o?isNaN(o)?o:Number(o):null}),null!=r.id&&l.set(r.id,{buy_price:r.buy_price||0,sell_price:r.sell_price||0})}return l}}async function te(e=[]){const t=new Map,r=[];if(e.forEach(e=>{if(e=Number(e),z.has(e))return void t.set(e,z.get(e));const n=Q(e);n?(z.set(e,n),t.set(e,n)):r.push(e)}),r.length)try{(await ee(r)).forEach((e,r)=>{z.set(r,e),function(e,t){if(q()&&"undefined"!=typeof sessionStorage)try{sessionStorage.setItem(Z(e),JSON.stringify({value:t,expires:Date.now()+3e5}))}catch{}}(r,e),t.set(r,e)})}catch(e){console.error("Error preloading prices",e)}return e.forEach(e=>{e=Number(e),!t.has(e)&&z.has(e)&&t.set(e,z.get(e)),t.has(e)||t.set(e,{buy_price:0,sell_price:0})}),t}const re=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function ne(e){if(null==e)return null;const t=Number(e);return Number.isFinite(t)?t:null}function oe(e){return re(e)?{...e}:null}function se(e){const t=oe(e),r=function(e){const t=ne(e?.unitBuyPrice??e?.unit_buy_price),r=ne(e?.unitSellPrice??e?.unit_sell_price);return{buy:t??ne(e?.buy_price??e?.buyPrice??e?.buys?.unit_price),sell:r??ne(e?.sell_price??e?.sellPrice??e?.sells?.unit_price)}}(e||{}),n=function(e){return{buy:ne(e?.buy??e?.totalBuy??e?.total_buy),sell:ne(e?.sell??e?.totalSell??e?.total_sell),crafted:ne(e?.crafted??e?.totalCrafted??e?.total_crafted)}}(e||{}),o=Number.isFinite(r.buy)||Number.isFinite(r.sell),s=Number.isFinite(n.buy)||Number.isFinite(n.sell)||Number.isFinite(n.crafted);return{unit:r,totals:n,raw:t,hasData:Boolean(o||s),source:"string"==typeof e?.source?e.source:null,updatedAt:e?.lastChanged??e?.last_changed??e?.lastUpdated??e?.updatedAt??null}}const ie=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);function ce(e){const t=ie(e)?e:{},r=function(e){const t=oe(e)||{};return t.stale="boolean"==typeof e?.stale&&e.stale,t.lang="string"==typeof e?.lang?e.lang:"es",t}(t.meta),n=ie(t.data)?t.data:t,o=function(e){return Array.isArray(e)?e.filter(re).map(e=>({...e})):re(e)?[{...e}]:[]}(n.recipes??n.recipe??n);return{recipes:o,primary:o.length>0?o[0]:null,meta:r}}function ae(e){return se(e)}let le=null,ue=null;function fe(e){if("string"!=typeof e)return null;const t=e.trim();return t?t.toLowerCase():null}function pe(){try{const e=L(),t=fe(e?.LANG);if(t)return t;const r=fe(e?.DEFAULT_LANG);if(r)return r}catch(e){}return"es"}function Ae(e,t){if(e&&"function"==typeof e.postMessage&&t)try{e.postMessage({type:"setLang",lang:t})}catch(e){}}function _e(e=pe()){const t=fe(e);t&&t!==le&&("undefined"!=typeof navigator&&navigator?.serviceWorker&&(Ae(navigator.serviceWorker.controller,t),("undefined"!=typeof navigator&&navigator?.serviceWorker?(ue||(ue=navigator.serviceWorker.ready.then(e=>e?.active??null).catch(()=>null)),ue):Promise.resolve(null)).then(e=>{e&&Ae(e,t)})),le=t)}function de(e,t={}){const r=pe();_e(r);const n=function(e,t){if(!t)return e;try{const r=/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e),n=r?void 0:"undefined"!=typeof window&&window?.location?.origin?window.location.origin:"http://localhost",o=new URL(e,n);return o.searchParams.has("lang")||o.searchParams.set("lang",t),r?o.toString():`${o.pathname}${o.search}${o.hash}`}catch(t){return e}}(e,r),{headers:o,...s}=t||{},i=function(e,t){if(!t)return e||void 0;const r=new Headers(e||void 0);return r.has("Accept-Language")||r.set("Accept-Language",t),r.set("X-Client-Language",t),r}(o,r);return{url:n,options:i?{...s,headers:i}:{...s},lang:r}}function ye(e,t){return`bundle_${"string"==typeof t&&t?t:pe()}_${e}`}function Ee(e){return`bundle_${e}`}function ge(e,t){if("undefined"==typeof window||!window)return;Array.isArray(window.__bundleFallbacks__)||(window.__bundleFallbacks__=[]);const r=t&&t.message?t.message:String(t||"")||"unknown",n={ids:Array.isArray(e)?e.map(e=>String(e)):[],message:r,timestamp:(new Date).toISOString()};window.__bundleFallbacks__.push(n),window.__bundleFallbacks__.length>50&&window.__bundleFallbacks__.shift(),window.__lastBundleFallback__=n}function he(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,""),n=String(t).replace(/^\/+/,"");return r?n?`${r}/${n}`:r||"/":`/${n}`}function Re(e,t,r){const{data:n,meta:o}=J(e),s=Array.isArray(n)?n:[];return!Array.isArray(n)&&Array.isArray(o?.errors)&&o.errors.length&&console.warn("dataBundle devolvió errores",o.errors),s.length&&s.forEach(e=>{const n=String(e.id),o=ye(n,r),s=Ee(n),i={recipe:ce({data:e?.recipe??null}),prices:ae(e?.market??null)},c={...e,adapters:i};t.set(n,c),H(o,c,void 0,{lang:r}),H(s,c,void 0,{lang:r}),"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"function"==typeof CustomEvent&&window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:c}))}),s.length>0}async function be(e=[]){if(!Array.isArray(e)||0===e.length)return[];const t=pe(),r=new Map,n=[];if(e.forEach(e=>{const o=String(e),s=ye(o,t);let i=K(s);if(!i){const e=K(Ee(o),!0);!e||e.lang&&e.lang!==t||(i=e.value,i&&H(s,i,void 0,{lang:t}))}i?r.set(o,i):n.push(o)}),n.length>0){const{API_BASE_URL:e,FEATURE_ITEM_API_ROLLOUT:o}=L(),s=Boolean(o);for(let o=0;o<n.length;o+=35){const i=n.slice(o,o+35),c=i.map(e=>`ids[]=${e}`).join("&");let a=!1;if(s){const{url:n,options:o}=de(`${he(e,"/items/bundle")}?${c}`);try{const e=await M(n,o);if(!e.ok)throw new Error(`Respuesta ${e.status} inválida en bundle API`);const s=await e.json().catch(()=>null);if(!s)throw new Error("Payload JSON no válido en bundle API");Re(s,r,t),a=!0}catch(e){a=!1,console.warn("Fallo en bundle API, usando PHP como fallback",e),ge(i,e)}}if(!s||!a)try{const{url:e,options:n}=de(`/backend/api/dataBundle.php?${c}`),o=await M(e,n);if(o.ok){Re(await o.json().catch(()=>null),r,t)}else console.error("Error en getItemBundles: respuesta no válida")}catch(e){console.error("Error en getItemBundles:",e)}i.forEach(e=>{const t=String(e);r.has(t)||r.set(t,null)})}}return e.map(e=>{const t=String(e);return r.get(t)||null})}async function Te(e){const t=Array.isArray(e)?e:[e],r=await be(t);if(Array.isArray(e))return r.map(e=>e?.recipe?[e.recipe]:[]);const n=r[0]?.recipe;return n?[n]:[]}async function Le(e){const t=pe(),r=function(e,t){return`recipe_${"string"==typeof t&&t?t:pe()}_${e}`}(e,t),n=K(r,!0);try{const{API_BASE_URL:o}=L(),{url:s,options:i}=de(`${o}/recipes/${e}`),c=await $(s,i,r,n);if(!c.ok)return null;const a=await c.json();if(!a)return null;a.lastUpdated=(new Date).toISOString();const l=c.headers.get("ETag");return H(r,a,void 0,{etag:l,lastModified:c.headers.get("Last-Modified"),lang:t}),a}catch(e){return console.error("Error en getRecipeDetails:",e),null}}async function we(e){if(Array.isArray(e)){return(await be(e)).map(e=>e?.item||null)}const t=await be([e]);return t[0]?.item||null}async function me(e){if(Array.isArray(e)){const t=await te(e);return e.map(e=>{const r=t.get(e)||{};return{buys:{unit_price:r.buy_price||0},sells:{unit_price:r.sell_price||0}}})}const t=await async function(e){if(e=Number(e),z.has(e))return z.get(e);const t=Q(e);return t?(z.set(e,t),t):(await te([e])).get(e)}(e);return{buys:{unit_price:t?.buy_price||0},sells:{unit_price:t?.sell_price||0}}}const Se={getItemBundles:be,getRecipesForItem:Te,getRecipeDetails:Le,getItemDetails:we,getItemPrices:me};function Oe(e=("undefined"!=typeof window?window:void 0)){if(!e)return Se;const t={...e.RecipeService||{},...Se};return e.RecipeService=t,Object.entries(Se).forEach(([t,r])=>{"function"!=typeof e[t]&&(e[t]=r)}),t}"undefined"!=typeof window&&Oe(window);return Oe("undefined"!=typeof window?window:void 0),e.getItemBundles=be,e.getItemDetails=we,e.getItemPrices=me,e.getRecipeDetails=Le,e.getRecipesForItem=Te,e.registerRecipeServiceGlobals=Oe,e}({});
