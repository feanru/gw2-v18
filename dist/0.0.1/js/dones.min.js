import{showSkeleton as e,hideSkeleton as n}from"./ui-helpers.min.js";import{c as t,t as a,j as r,p as o,b as i,a as s,k as l,r as c}from"./utils.min.js";import{g as d,p as u}from"./services.min.js";import"./config.min.js";const m=["priceMap","iconMap","rarityMap","itemMap"],p=new Map;function f(e){const n=Number(e);return Number.isFinite(n)?n:null}function g(e,n){const t=new Map;return e&&"object"==typeof e?(Object.entries(e).forEach(([e,a])=>{const r=n(e,a);r&&t.set(r.id,r)}),t):t}async function b(e,n,a={}){const r=new URLSearchParams;r.set("ids",e.join(",")),Array.isArray(a.fields)&&a.fields.length>0&&r.set("fields",a.fields.join(",")),Number.isFinite(Number(a.page))&&Number(a.page)>0&&r.set("page",Math.floor(Number(a.page))),Number.isFinite(Number(a.pageSize))&&Number(a.pageSize)>0&&r.set("pageSize",Math.floor(Number(a.pageSize)));const{url:o,options:i}=u(`/api/aggregate/bundle?${r.toString()}`,{signal:a.signal}),s=await t(o,i);if(!s.ok)throw new Error(`Error ${s.status} al consultar el agregado de bundle`);const l=s.headers?.get?.("content-type")||s.headers?.get?.("Content-Type")||"";if(!String(l).toLowerCase().includes("application/json"))throw new Error("Respuesta no válida del agregado de bundle");const c=await s.json().catch(()=>null);if(!c||"object"!=typeof c)throw new Error("Datos no válidos del agregado de bundle");return c}async function y(e=[],n={}){const t=Array.from(new Set((Array.isArray(e)?e:[e]).map(e=>f(e)).filter(e=>Number.isFinite(e)&&e>0))),a=d(),r=function(e){const n="string"==typeof e&&e?e:d();return p.has(n)||p.set(n,{items:new Map,prices:new Map,meta:null,warnings:[],errors:[],expiresAt:0}),p.get(n)}(a),o=Number.isFinite(Number(n.ttl))&&Number(n.ttl)>0?Number(n.ttl):12e4,i=Date.now(),s=!0===n.skipCache,l=new Map,c=new Map;t.forEach(e=>{r.items.has(e)&&l.set(e,r.items.get(e)),r.prices.has(e)&&c.set(e,r.prices.get(e))});const u=s||i>=r.expiresAt,y=u?t:t.filter(e=>!l.has(e)||!c.has(e));if(!s&&!u&&0===y.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:l,pricesMap:c,meta:r.meta,warnings:Array.isArray(r.warnings)?[...r.warnings]:[],errors:Array.isArray(r.errors)?[...r.errors]:[],missingIds:[]};if(0===t.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:new Map,pricesMap:new Map,meta:r.meta,warnings:Array.isArray(r.warnings)?[...r.warnings]:[],errors:Array.isArray(r.errors)?[...r.errors]:[],missingIds:[]};const h=u?t:y,w=Array.isArray(n.fields)&&n.fields.length>0?n.fields:m,E=Number.isFinite(Number(n.pageSize))&&Number(n.pageSize)>0?Math.floor(Number(n.pageSize)):50,A=[];let N=1,_=1;do{const e=await b(h,0,{signal:n.signal,page:N,pageSize:E,fields:w});A.push(e);const t=e?.meta?.pagination||null;if(t&&Number.isFinite(Number(t.totalPages))&&(_=Math.max(1,Number(t.totalPages))),!t||!t.hasNext)break;const a=Number.isFinite(Number(t.page))?Number(t.page)+1:N+1;if(a<=N||a>_)break;N=a}while(N<=_);const M={},L={},v={},C={},I=[],S=new Set;let T=null;A.forEach(e=>{if(!e||"object"!=typeof e)return;e.priceMap&&"object"==typeof e.priceMap&&Object.assign(M,e.priceMap),e.iconMap&&"object"==typeof e.iconMap&&Object.assign(L,e.iconMap),e.rarityMap&&"object"==typeof e.rarityMap&&Object.assign(v,e.rarityMap),e.itemMap&&"object"==typeof e.itemMap&&Object.assign(C,e.itemMap),Array.isArray(e.errors)?e.errors.forEach(e=>I.push(e)):e.errors&&I.push(e.errors);const n=e.meta||null;n&&(T=n,Array.isArray(n.warnings)&&n.warnings.filter(Boolean).forEach(e=>S.add(e)))});const F={priceMap:M,iconMap:L,rarityMap:v,itemMap:C,meta:T||null,errors:I};F.meta&&S.size>0&&(F.meta={...F.meta,warnings:Array.from(S)});const D=g(F.iconMap,(e,n)=>{const t=f(e);return t?{id:t,icon:n??null}:null}),k=g(F.rarityMap,(e,n)=>{const t=f(e);return t?{id:t,rarity:n??null}:null}),P=g(F.itemMap,(e,n)=>function(e,n,t,a){const r=f(e);if(!r)return null;const o=n&&"object"==typeof n?n:{},i=t?.get(r)??null,s=a?.get(r)??null;return{id:r,name:"string"==typeof o.name?o.name:null,icon:o.icon??i?.icon??null,rarity:o.rarity??s?.rarity??null,type:"string"==typeof o.type?o.type:null}}(e,n,D,k));0===P.size&&h.forEach(e=>{const n=D.get(e)??null,t=k.get(e)??null;(n||t)&&P.set(e,{id:e,name:null,icon:n?.icon??null,rarity:t?.rarity??null,type:null})});const x=g(F.priceMap,(e,n)=>function(e,n){const t=f(e);if(!t)return null;const a=n&&"object"==typeof n?n:{},r=e=>{if(null==e)return null;const n=Number(e);return Number.isFinite(n)&&n>=0?n:null},o=r(a.buy_price??a.buyPrice??a.buy),i=r(a.sell_price??a.sellPrice??a.sell);return null==o&&null==i?{id:t,buy_price:null,sell_price:null}:{id:t,buy_price:o,sell_price:i}}(e,n));u&&h.forEach(e=>{r.items.delete(e),r.prices.delete(e)});const j=u?new Map:new Map(l);P.forEach((e,n)=>{j.set(n,e),r.items.set(n,e)});const O=u?new Map:new Map(c);x.forEach((e,n)=>{O.set(n,e),r.prices.set(n,e)});const V=F.meta||null,z=Array.isArray(V?.warnings)?[...V.warnings]:[],B=[];Array.isArray(F.errors)?B.push(...F.errors):F.errors&&B.push(F.errors),r.meta=V,r.warnings=z,r.errors=B,r.expiresAt=i+o;const G=h.filter(e=>!P.has(e)||!x.has(e)),R=Array.from(new Set([...G,...t.filter(e=>!j.has(e)||!O.has(e))]));return{ok:0===R.length&&0===B.length,partial:R.length>0||B.length>0,fromCache:!1,itemsMap:j,pricesMap:O,meta:V,warnings:z,errors:B,missingIds:R}}var h=[{id:19673,name:"Don de la Magia",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19721,name:"Pegote de ectoplasma",count:250}],manualIngredients:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",manualIngredients:[{id:24357,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24351,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]},{id:19626,name:"Don de la Suerte",mainIngredients:[{id:19721,name:"Pegote de ectoplasma",count:250},{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19673,name:"Don de la Magia",type:"crafting_material",count:1,components:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",type:"crafting_material",count:1,components:[{id:24351,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24357,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]}]}];document.getElementById("dones-content");const w=document.getElementById("dones-skeleton"),E=document.getElementById("error-message");window.showSkeleton=e,window.hideSkeleton=n;const A={19676:1e4},N="sin precio",_=`${N} (fuera del mercado)`,M=`${N} (vinculado a cuenta)`,L=new Map([[19675,"account"],[19925,"market"],[20796,"market"],[19633,"market"],[19634,"market"],[19641,"market"],[19642,"market"],[19628,"market"],[20799,"account"]]),v=Object.freeze({ALL:"all",SPECIAL:"special",TRIBUTO:"tributo",DRACONIC:"draconic",LEGENDARY:"legendary"}),C=new Set(Object.values(v));function I(e){const n=new Set,t=e=>{if("string"==typeof e&&C.has(e))return e===v.ALL?(n.clear(),void n.add(v.ALL)):void(n.has(v.ALL)||n.add(e))};if(null==e)t(v.ALL);else if("string"==typeof e)t(e);else if(Array.isArray(e))e.forEach(t);else if(e instanceof Set)e.forEach(t);else if("object"==typeof e){const{base:n,include:a,contexts:r,all:o,includeAll:i,special:s,tributo:l,draconic:c,legendary:d}=e;!0===o||!0===i?t(v.ALL):("string"==typeof n&&t(n),Array.isArray(a)&&a.forEach(t),Array.isArray(r)&&r.forEach(t),s&&t(v.SPECIAL),l&&t(v.TRIBUTO),c&&t(v.DRACONIC),d&&t(v.LEGENDARY))}return 0===n.size&&n.add(v.ALL),n}function S(e){return e instanceof Set&&0!==e.size?e.has(v.ALL)?v.ALL:Array.from(e).sort().join("+"):v.ALL}const T=(e="")=>{if(!e)return!1;const n=e.toLowerCase();return n.startsWith("don de ")||n.startsWith("don del ")||n.startsWith("don de la ")},F=e=>{if("string"!=typeof e||!e)return!1;if((()=>{const{isGiftName:e}=window?.DonesCore||{};return"function"==typeof e?e:T})()(e))return!0;const n=e.toLowerCase();return n.includes("tributo")||n.includes("bendición")};let D=null,k=!1;const P={promise:null,expiresAt:0,payload:{items:new Map,prices:new Map},pendingExtraIds:new Set,loadedContexts:new Set,contextKey:null};function x(e=null){let n=null;return e instanceof Set?n=e:null!=e?n=I(e):P.loadedContexts instanceof Set&&(n=P.loadedContexts),n instanceof Set&&0!==n.size&&(!!n.has(v.ALL)||n.has(v.LEGENDARY))}let j=null;function O(e){const n=Number(e);return Number.isFinite(n)?(j||function(){j=new Map;const e=window.LegendaryData;if(!e)return;const n=new Set,t=e=>{if(!e||n.has(e))return;n.add(e);const a=Number(e.id);Number.isFinite(a)&&!j.has(a)&&j.set(a,{id:a,name:e.name||null,icon:e.icon||null,rarity:e.rarity||null,type:e.type||null}),Array.isArray(e.components)&&e.components.forEach(t)},a=e=>{e&&Object.values(e).forEach(e=>t(e))};a(e.LEGENDARY_ITEMS),a(e.LEGENDARY_ITEMS_3GEN)}(),j?.get(n)||null):null}function V(e,n=new Set){if(!e)return n;if(!(n&&n instanceof Set))return V(e,new Set);if(Array.isArray(e))return e.forEach(e=>V(e,n)),n;if("object"==typeof e){if(Object.prototype.hasOwnProperty.call(e,"id")){const t=Number(e.id);Number.isFinite(t)&&n.add(t)}Object.values(e).forEach(e=>V(e,n))}return n}function z(e,n=null,t=null){const a=Number(e);if(!Number.isFinite(a))return null;const r=x(t)?O(a):null,o=n?.name??n?.localized_name??n?.display_name??n?.description??null,i=n?.icon??null,s={id:a,name:r?.name??o??null,icon:r?.icon??i??null,rarity:r?.rarity??n?.rarity??null,type:r?.type??n?.type??null};return null==s.name&&null==s.icon&&null==s.rarity&&null==s.type?null:s}function B(e){const n={};return e&&e instanceof Map?(e.forEach((e,t)=>{n[t]=e}),n):n}function G(e){const n=Number(e);if(!Number.isFinite(n))return null;const t=P.payload;if(t?.items instanceof Map&&t.items.has(n))return t.items.get(n);const a=s(`item_${n}`);if(a){const e=z(n,a,P.loadedContexts instanceof Set?P.loadedContexts:null);return e&&t?.items instanceof Map&&t.items.set(n,e),e}const r=z(n,null,P.loadedContexts instanceof Set?P.loadedContexts:null);return r&&t?.items instanceof Map&&t.items.set(n,r),r}function R(e,n,t={}){try{if("undefined"==typeof window)return;Array.isArray(window.__donesPreloadLog__)||(window.__donesPreloadLog__=[]);const a=n instanceof Set?n:I(n),r={type:e,context:S(a),timestamp:(new Date).toISOString(),legendary:x(a),...t};window.__donesPreloadLog__.push(r),window.__donesPreloadLog__.length>100&&window.__donesPreloadLog__.shift()}catch(e){console.warn("No se pudo registrar el evento de precarga de dones",e)}}async function $(e=[],n=v.ALL){const t=Date.now(),l=I(n),c=S(l),d=Array.isArray(e)&&e.length>0,u=P.payload,m=u?.items instanceof Map?u.items:null,p=u?.prices instanceof Map?u.prices:null,f=Boolean(m&&p),g=d?V(e,new Set):new Set,b=new Set;g.size>0&&g.forEach(e=>{const n=Number(e);Number.isFinite(n)&&(f&&m.has(n)&&p.has(n)||b.add(n))});const h=t>=P.expiresAt,w=P.loadedContexts instanceof Set?P.loadedContexts:new Set,E=(()=>{if(w.has(v.ALL))return!0;if(l.has(v.ALL))return!1;for(const e of l)if(!w.has(e))return!1;return w.size>0})(),N=h||!f||!E||b.size>0;if(!N&&u){try{a?.({type:"donesPreloadReuse",meta:{context:c,items:m?.size??0,prices:p?.size??0,extra:g.size}})}catch(e){console.warn("No se pudo registrar telemetría de reutilización de preloads",e)}return R("reuse",l,{items:m?.size??0,prices:p?.size??0,extraIds:Array.from(g),missingExtraIds:Array.from(b),ttlExpired:h}),u}if(P.pendingExtraIds instanceof Set||(P.pendingExtraIds=new Set),g.size>0){(N?g:b).forEach(e=>{Number.isFinite(e)&&P.pendingExtraIds.add(Number(e))})}return P.promise?P.promise.then(()=>$(e,l)):(P.promise=(async()=>{const e=oe(l);P.pendingExtraIds instanceof Set&&(P.pendingExtraIds.forEach(n=>e.add(n)),P.pendingExtraIds.clear());const n=Array.from(e),d=window.RecipeService||{},u=new Map,m=e=>(u.has(e)||u.set(e,{id:e,item:null,market:null}),u.get(e)),p=r("donesAggregate"),f={meta:null,errors:[],warnings:[],missingIds:[],used:!1,fromCache:!1};let h=null;if(p)try{const e=await y(n);f.used=!0,f.meta=e?.meta||null,f.errors=Array.isArray(e?.errors)?[...e.errors]:[],f.warnings=Array.isArray(e?.warnings)?[...e.warnings]:[],f.missingIds=Array.isArray(e?.missingIds)?e.missingIds.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],f.fromCache=Boolean(e?.fromCache),e?.itemsMap instanceof Map&&e.itemsMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;m(t).item=e}),e?.pricesMap instanceof Map&&e.pricesMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;const a=m(t);a.market={...a.market||{},buy_price:e?.buy_price??null,sell_price:e?.sell_price??null}})}catch(e){h=e,console.error("Error al precargar datos del agregado de dones",e)}p&&f.warnings.length&&!f.fromCache&&console.warn("Advertencias del agregado de dones",f.warnings);const w=H(l),E=new Set;let N=p?null:"flag-disabled";p?h?(N="aggregate-error",n.forEach(e=>{const n=Number(e);Number.isFinite(n)&&E.add(n)})):(n.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=u.get(n)||null;t?.item||E.add(n);if(!(Object.prototype.hasOwnProperty.call(A,n)||w.has(n))){const e=t?.market||null;Boolean(e&&(null!=e.buy_price&&Number.isFinite(Number(e.buy_price))||null!=e.sell_price&&Number.isFinite(Number(e.sell_price))||null!=e.buys?.unit_price||null!=e.sells?.unit_price))||E.add(n)}}),f.missingIds.forEach(e=>E.add(e)),E.size>0&&f.missingIds.length>0&&(N="missing-data"),!N&&f.errors.length>0&&(N="aggregate-errors")):n.forEach(e=>{const n=Number(e);Number.isFinite(n)&&E.add(n)});const _=Array.from(E);if(_.length>0){!function(e,n=null,t=null,r={}){if("undefined"==typeof window||!window)return null;Array.isArray(window.__donesAggregateFallbacks__)||(window.__donesAggregateFallbacks__=[]);const o=(Array.isArray(r?.ids)?r.ids:[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)),i=Array.isArray(r?.errors)?r.errors.map(e=>"string"==typeof e?e:String(e||"")):void 0,s={reason:e,meta:n?{...n}:null,stale:Boolean(n?.stale),ids:o,errors:i,error:t?String(t?.message||t):void 0,timestamp:(new Date).toISOString()};window.__donesAggregateFallbacks__.push(s),window.__donesAggregateFallbacks__.length>50&&window.__donesAggregateFallbacks__.shift(),window.__lastDonesAggregateFallback__=s;try{a?.({type:"donesAggregateFallback",meta:{reason:s.reason,stale:s.stale,missing:o.length},error:s.error})}catch(e){console.warn("No se pudo registrar telemetría de fallback de dones",e)}}(N||(h?"aggregate-error":"legacy-required"),f.meta,h,{ids:_,errors:f.errors})}if(_.length>0)if("function"==typeof d.getItemBundles)try{const e=await d.getItemBundles(_);_.forEach((n,t)=>{const a=Number(n);if(!Number.isFinite(a))return;const r=Array.isArray(e)?e[t]:null;if(!r)return;const o=m(a);r.item&&(o.item=r.item),r.market&&(o.market=o.market?{...r.market,...o.market}:r.market)})}catch(e){console.error("Error al precargar bundles de dones",e)}else{const[e=[],n=[]]=await Promise.all(["function"==typeof d.getItemDetails?d.getItemDetails(_):Promise.resolve([]),"function"==typeof d.getItemPrices?d.getItemPrices(_):Promise.resolve([])]).catch(e=>(console.error("Error al precargar datos de dones",e),[[],[]]));_.forEach((t,a)=>{const r=Number(t);if(!Number.isFinite(r))return;const o=Array.isArray(e)?e[a]:null,i=Array.isArray(n)?n[a]:null,s=i?{buy_price:i?.buys?.unit_price??null,sell_price:i?.sells?.unit_price??null}:null,l=m(r);o&&(l.item=o),s&&(l.market=l.market?{...s,...l.market}:s)})}n.forEach(e=>{const n=Number(e);Number.isFinite(n)&&m(n)});const M=[];n.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=u.get(n)||null;if(Object.prototype.hasOwnProperty.call(A,n)||w.has(n))return;const a=t?.market||null;Boolean(a&&(null!=a.buy_price&&Number.isFinite(Number(a.buy_price))||null!=a.sell_price&&Number.isFinite(Number(a.sell_price))||null!=a.buys?.unit_price||null!=a.sells?.unit_price))||M.push(n)});let L=new Map;if(M.length>0)try{L=await o(M)}catch(e){console.error("Error al precargar precios de dones",e),L=new Map}const C=new Map,I=new Map;n.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=u.get(n)||null,a=z(n,t?.item||null,l);if(a)C.set(n,a),i(`item_${n}`,a,6e5);else{const e=s(`item_${n}`);if(e){const t=z(n,e,l);t&&C.set(n,t)}}const r=L.get(n)||null;let o=r?.buy_price??null,c=r?.sell_price??null;const d=t?.market||null;if(d&&(null==o&&null!=d.buy_price&&(o=d.buy_price),null==o&&null!=d.buys?.unit_price&&(o=d.buys.unit_price),null==c&&null!=d.sell_price&&(c=d.sell_price),null==c&&null!=d.sells?.unit_price&&(c=d.sells.unit_price)),Object.prototype.hasOwnProperty.call(A,n)){const e=A[n];o=e,c=e}I.set(n,{buy_price:null!=o?o:null,sell_price:null!=c?c:null})}),n.forEach(e=>{const n=Number(e);if(Number.isFinite(n)){if(!C.has(n)){const e=z(n,null,l);e&&C.set(n,e)}if(!I.has(n))if(Object.prototype.hasOwnProperty.call(A,n)){const e=A[n];I.set(n,{buy_price:e,sell_price:e})}else I.set(n,{buy_price:null,sell_price:null})}}),P.payload={items:C,prices:I},P.expiresAt=t+216e5,P.loadedContexts=l.has(v.ALL)?new Set([v.ALL]):new Set(l),P.contextKey=c;try{a?.({type:"donesPreloadFetch",meta:{context:c,ids:n.length,extras:g.size,aggregateUsed:f.used,aggregateFromCache:f.fromCache,fallback:_.length}})}catch(e){console.warn("No se pudo registrar telemetría de precarga de dones",e)}return R("fetch",l,{ids:n,extraIds:Array.from(g),missingExtraIds:Array.from(b),aggregateUsed:f.used,aggregateFromCache:f.fromCache,fallback:_}),P.payload})().catch(e=>(console.error("Error general al precargar datos de dones",e),P.payload)).finally(()=>{P.promise=null}),P.promise)}function H(e=null){return D||(D=new Map(L)),!k&&x(e)&&(k=function(e){const n=window.LegendaryData;if(!n)return!1;const{LEGENDARY_ITEMS:t,LEGENDARY_ITEMS_3GEN:a}=n;if(!t&&!a)return!1;const r=new Set,o=n=>{if(!n)return;const t=Number(n.id);if(Number.isFinite(t)){if(r.has(t))return;r.add(t),F(n.name)&&e.set(t,"gift")}Array.isArray(n.components)&&n.components.forEach(o)},i=e=>{e&&Object.values(e).forEach(e=>{e&&Array.isArray(e.components)&&e.components.forEach(o)})};return i(t),i(a),!0}(D)),D}function Y(e=null){return Array.from(H(e).entries())}let U=null;function W(e){if(!e||"object"!=typeof e)return;const n=Number(e.id);if(Number.isFinite(n)){const t=G(n);t&&(e.name=t.name??e.name,e.icon=t.icon??e.icon,e.rarity=t.rarity??e.rarity,e.type=t.type??e.type);const a=function(e){const n=Number(e);if(!Number.isFinite(n))return null;if(Object.prototype.hasOwnProperty.call(A,n)){const e=A[n];return{buy_price:e,sell_price:e}}const t=P.payload;return t?.prices instanceof Map&&t.prices.has(n)?t.prices.get(n):null}(n);a&&(null==e.buy_price&&null!=a.buy_price&&(e.buy_price=a.buy_price),null==e.sell_price&&null!=a.sell_price&&(e.sell_price=a.sell_price))}Array.isArray(e.children)&&e.children.forEach(e=>W(e))}async function q(e,n=v.ALL){const{ingredientTree:t}=await async function(e,n=v.ALL){const t=await $(e,n);U||(U=new Worker(new URL("./workers/donesWorker.js",import.meta.url),{type:"module"}));const a={rootIngredients:e,skipEntries:Y(n),preloadedItems:B(t?.items),preloadedPrices:B(t?.prices),preloadContext:S(I(n))};return new Promise((e,n)=>{const t=n=>{U.removeEventListener("message",t),U.removeEventListener("error",r),e(n.data)},r=e=>{U.removeEventListener("message",t),U.removeEventListener("error",r),n(e)};U.addEventListener("message",t),U.addEventListener("error",r),U.postMessage(a)})}(e,n),a=Array.isArray(t)?t:[];a.forEach(e=>W(e));const{updatedTree:r,totals:o}=await function(e,n){return c({ingredientTree:e,globalQty:n})}(a,1);return l(r,null),{tree:r,totals:o}}function K(e,n=0,t=null){const a=n>0?`padding-left:${32*n}px;`:"",r=function(e,n,t,a=null){const r=Number(e),o=H(a);if(!Number.isFinite(r))return{skip:!0,reason:"synthetic",label:_};if(o.has(r)){const e=o.get(r);return{skip:!0,reason:e,label:"account"===e?M:_}}return F(n)?(o.set(r,"gift"),{skip:!0,reason:"gift",label:_}):("string"==typeof t?t.toLowerCase():"").includes("account")?(o.set(r,"account"),{skip:!0,reason:"account",label:M}):{skip:!1,reason:null,label:null}}(e.id,e.name,e.type,t),o=r.skip,i=r.label||_,s=Number.isFinite(e.buy_price)&&e.buy_price>0,l=Number.isFinite(e.sell_price)&&e.sell_price>0,c=Number.isFinite(e.total_buy)&&e.total_buy>0,d=Number.isFinite(e.total_sell)&&e.total_sell>0,u=!o&&(s||l)||c||d,m=o?i:s?formatGoldColored(e.buy_price):"-",p=o?i:l?formatGoldColored(e.sell_price):"-",f=c?formatGoldColored(e.total_buy):"-",g=d?formatGoldColored(e.total_sell):"-";let b=`<tr>\n    <td style='${a}'>${e.icon?`<img src='${e.icon}' style='height:28px;'>`:"-"}</td>\n    <td>${e.name}</td>\n    <td>${Math.round(e.count)}</td>\n    <td>${m}</td>\n    <td>${p}</td>\n    <td>${f}</td>\n    <td>${g}</td>\n  </tr>`,y=!1;if(Array.isArray(e.children))for(const a of e.children){const e=K(a,n+1,t);b+=e.html,e.hasValue&&(y=!0)}const h=u||y;return{html:b,hasNoMarket:!h,hasValue:h,childContributedValue:y}}function Q(e,n){return n?"<span class='total-sin-precio'>Sin precio (faltan componentes valorados)</span>":Number.isFinite(e)&&e>0?formatGoldColored(e):"-"}async function J(e,n,t=v.ALL){const a=n||document.getElementById("dones-content");a.innerHTML="",E.style.display="none";try{await $([e],t);const n=G(e.id);let r=n?.name||e.name,o=n?.icon||null;if(!o){const n=e.manualIngredients&&e.manualIngredients[0]||e.mainIngredients&&e.mainIngredients[0]||null;if(n){await $([n],t);const e=G(n.id);e?.icon&&(o=e.icon)}}let i="";const s=e.name?e.name.toLowerCase():"",l=s.includes("suerte")||s.includes("magia")||s.includes("poder");if(l){if(e.mainIngredients&&e.mainIngredients.length>0){i+="<table class='table-modern-dones tabla-tarjetas'>\n          <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,a=0,r=!1;for(const o of e.mainIngredients){const e=await ie(o,0,t);i+=e.html,e.hasValue||(r=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(a+=e.totalSell)}if(i+="</tbody></table>",r||n>0||a>0){const e=Q(n,r);i+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n            <div class='precio-totales-dones'>\n              <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n              <div class='total-dones'><b>Total Venta estimado:</b> ${Q(a,r)}</div>\n            </div>\n          </div>`}}return void(a.innerHTML+=i)}if(l||(i+=`<h2 style='margin-top:18px;'><img src='${o}' style='height:32px;vertical-align:middle;'> ${r}</h2>`),e.mainIngredients&&e.mainIngredients.length>0){i+="<table class='table-modern-dones tabla-tarjetas'>\n        <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,a=0,r=!1;for(const o of e.mainIngredients){const e=await ie(o,0,t);i+=e.html,e.hasValue||(r=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(a+=e.totalSell)}if(i+="</tbody></table>",r||n>0||a>0){const e=Q(n,r);i+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n          <div class='precio-totales-dones'>\n            <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n            <div class='total-dones'><b>Total Venta estimado:</b> ${Q(a,r)}</div>\n          </div>\n        </div>`}}if(l)return;a.innerHTML+=i}catch(e){E.innerText=e.message,E.style.display="block"}}async function X(){const{LEGENDARY_ITEMS:e}=window.LegendaryData||{},n=[],t=new Set;for(const a of Object.values(e)){if(!a.components)continue;const e=a.components.find(e=>{if(!e.name)return!1;const n=e.name.toLowerCase();return n.startsWith("don de")&&!n.includes("la suerte")&&!n.includes("del dominio")});e&&!t.has(e.id)&&(t.add(e.id),n.push({id:e.id,name:e.name,mainIngredients:e.components||[],manualIngredients:[]}))}return n.sort((e,n)=>e.name.localeCompare(n.name,"es")),n}function Z(){return h.filter(e=>e.name&&e.name.toLowerCase().includes("suerte"))}async function ee(){const{LEGENDARY_ITEMS_3GEN:e}=window.LegendaryData||{};for(const n of Object.values(e)){const e=n.components?.find(e=>(e.name?.toLowerCase()||"").includes("tributo dracónico"));if(e)return e}throw new Error("No se encontró el Tributo Dracónico en legendaryItems3gen")}const ne={special:!1,tributo:!1,draco:!1,gen1:!1};window.DonesPages={loadSpecialDons:async function(){if(ne.special)return;ne.special=!0;const t=v.SPECIAL,a=Z();await $(a,t),await async function(t=null,a=v.SPECIAL){const r=document.getElementById("dones-content"),o=w;e(o),r.innerHTML="";const i=Array.isArray(t)&&t.length>0?t:Z();await $(i,a);for(const e of i){const n=document.createElement("div");r.appendChild(n),await J(e,n,a)}n(o)}(a,t)},loadTributo:async function(){if(ne.tributo)return;ne.tributo=!0;const t=v.TRIBUTO,a=se();await $([a],t),await async function(t=v.TRIBUTO,a=null){const r=document.getElementById("tributo-content"),o=document.getElementById("tributo-skeleton");if(!r||!o)return;e(o),r.innerHTML="";try{const e=a||se();await $([e],t);let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let o=0,i=0,s=!1;for(const a of e.components){const e=await ie(a,0,t);n+=e.html,e.hasValue||(s=!0),Number.isFinite(e.totalBuy)&&(o+=e.totalBuy),Number.isFinite(e.totalSell)&&(i+=e.totalSell)}n+="</tbody></table>";if(s||o>0||i>0){const e=Q(o,s);n+=`<div class='table-modern-totales' style='margin-bottom:18px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${Q(i,s)}</div>\n        </div>\n      </div>`}r.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Místico:",e),r.innerHTML='<div class="error-message">Error al cargar el Tributo Místico.</div>'}finally{n(o)}}(t,a)},loadDraconicTribute:async function(){if(ne.draco)return;ne.draco=!0;const t=v.DRACONIC,a=await ee();await $([a],t),await async function(t=v.DRACONIC,a=null){const r=document.getElementById("tributo-draconico-content"),o=document.getElementById("tributo-draconico-skeleton");if(r&&o){e(o),r.innerHTML="";try{const e=a||await ee();await $([e],t);let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let o=0,i=0,s=!1;for(const a of e.components){const e=await ie(a,0,t);n+=e.html,e.hasValue||(s=!0),Number.isFinite(e.totalBuy)&&(o+=e.totalBuy),Number.isFinite(e.totalSell)&&(i+=e.totalSell)}if(n+="</tbody></table>",s||o>0||i>0){n+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${Q(o,s)}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${Q(i,s)}</div>\n        </div>\n      </div>`}r.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Dracónico:",e),r.innerHTML='<div class="error-message">Error al cargar el Tributo Dracónico.</div>'}finally{n(o)}}}(t,a)},loadDones1Gen:async function(){if(ne.gen1)return;ne.gen1=!0;const t=v.LEGENDARY,a=await X();await $(a,t),await async function(t=v.LEGENDARY,a=null){const r=document.getElementById("dones-1ra-gen-content"),o=document.getElementById("dones-1ra-gen-skeleton");if(r&&o){e(o),r.innerHTML="";try{const i=a||await X();await $(i,t);const s=document.createElement("div");s.className="don1gen-nav-btns don1gen-grid";const l=document.createElement("div");l.id="don1gen-result",i.forEach(a=>{const r=document.createElement("button");r.className="dones-btn",r.textContent=a.name,r.addEventListener("click",async()=>{s.querySelectorAll("button").forEach(e=>e.classList.remove("active")),r.classList.add("active"),l.innerHTML="",e(o),await J(a,l,t),n(o)}),s.appendChild(r)}),r.appendChild(s),r.appendChild(l)}catch(e){console.error("Error al renderizar dones de 1ra Gen:",e),r.innerHTML='<div class="error-message">Error al cargar los dones.</div>'}finally{n(o)}}}(t,a)}};const te={name:"Tributo Místico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19976,name:"Moneda mística",count:250}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]},ae={name:"Tributo dracónico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:38,components:[{id:19976,name:"Moneda mística",count:38},{id:19721,name:"Pegote de ectoplasma",count:38},{id:19925,name:"Esquirla de obsidiana",count:38},{id:20796,name:"Piedra filosofal",count:228}]},{id:92687,name:"Piedra imán dracónica amalgamada",count:5}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]},re=Object.freeze({[v.SPECIAL]:()=>V(Z(),new Set),[v.TRIBUTO]:()=>V(te,new Set),[v.DRACONIC]:()=>V(ae,new Set),[v.LEGENDARY]:()=>{const e=new Set;return function(e){const n=window.LegendaryData;if(!n)return;const t=new Set;var a;(a=n.LEGENDARY_ITEMS)&&Object.values(a).forEach(n=>{n&&Array.isArray(n.components)&&n.components.forEach(n=>{if(!n||!n.name)return;const a=n.name.toLowerCase();if(!a.startsWith("don de")||a.includes("la suerte")||a.includes("del dominio"))return;const r=Number(n.id);Number.isFinite(r)&&!t.has(r)&&(t.add(r),V(n,e))})})}(e),e}});function oe(e=v.ALL){const n=I(e),t=new Set,a=e=>{e instanceof Set&&e.forEach(e=>{const n=Number(e);Number.isFinite(n)&&t.add(n)})};return n.has(v.ALL)?(a(re[v.SPECIAL]?.()),a(re[v.TRIBUTO]?.()),a(re[v.DRACONIC]?.()),a(re[v.LEGENDARY]?.()),t):(n.forEach(e=>{const n=re[e];"function"==typeof n&&a(n())}),0===t.size?oe(v.ALL):t)}async function ie(e,n=0,t=v.ALL){const{tree:a}=await q([e],t),r=a[0];if(!Array.isArray(r.children)||0===r.children.length){const e=Number.isFinite(r.count)?r.count:0,n=Number.isFinite(r.buy_price)?r.buy_price:0,t=Number.isFinite(r.sell_price)?r.sell_price:0;r.total_buy=n*e,r.total_sell=t*e}const{html:o,hasNoMarket:i,hasValue:s}=K(r,n,t);return{html:o,totalBuy:Number.isFinite(r.total_buy)?r.total_buy:null,totalSell:Number.isFinite(r.total_sell)?r.total_sell:null,hasNoMarket:i,hasValue:s}}function se(){const e={id:"TRIBUTO_MISTICO_ROOT",name:te.name,count:1,components:[]};return te.mainIngredients.forEach(n=>{e.components.push({...n})}),te.dons.forEach(n=>{const t=n.name.toLowerCase().includes("magia condensada")||n.name.toLowerCase().includes("poder condensado")?2:1,a={id:n.name.replace(/\s+/g,"_").toUpperCase(),name:n.name,count:t,components:[]};n.subdons.forEach(e=>{const n={id:e.name.replace(/\s+/g,"_").toUpperCase(),name:e.name,count:1,components:[]};e.ingredients.forEach(e=>{n.components.push({...e})}),a.components.push(n)}),e.components.push(a)}),e}
