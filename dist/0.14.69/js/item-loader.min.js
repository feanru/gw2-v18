import{i as e,u as r,v as t,w as n,x as o,y as a,z as i,A as l,t as s,n as c,B as d,C as u,b as w}from"./utils.min.js";import{g as m}from"./config.min.js";import"./services.min.js";let g,p,f,y,_,b,h,E,k,A,S;const I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0;let P;async function T(){return P||(P=Promise.all([import("./items-core.min.js"),import("./utils.min.js").then(function(e){return e.$}),import("./services.min.js"),import("./utils.min.js").then(function(e){return e.a1})]).then(([e,r,t,n])=>{({prepareIngredientTreeData:g,CraftIngredient:p,setIngredientObjs:f,setTotalsFromAggregate:y,findIngredientsById:_,cancelItemRequests:b,recalcAll:h}=e),({preloadPrices:A,getPrice:S}=r),({getItemBundles:E}=t),({update:k}=n),"undefined"==typeof window||window.RecipeService||console.error("Servicios de recetas no disponibles: window.RecipeService no está definido.")})),P}let R=0,v=null,B=null;async function F(e){if(!Array.isArray(e)||0===e.length)return[];await T();try{return await E(e)}catch(e){return console.error("Error cargando ítems",e),[]}}async function j(e,r,c,d={}){if(t(),window.hideError?.(),v){try{v()}catch(e){console.warn("Error deteniendo actualizador de precios",e)}v=null}let w=!1;const{bucket:m=null}=d||{},g=()=>n(),p=g();let _=null;const b=async(t,n,o)=>{if(w)return;w=!0;const a=n?.stale??_?.stale??null;!function(e,r=null,t=null,n=null){const o={reason:e||"unknown",meta:r?{...r}:null,stale:Boolean(r?.stale),error:t?String(t?.message||t):void 0,timestamp:(new Date).toISOString()};if("function"==typeof k)try{k("aggregate-fallback",o)}catch(e){console.warn("No se pudo registrar el fallback en el estado",e)}I&&(Array.isArray(I.__aggregateFallbacks__)||(I.__aggregateFallbacks__=[]),I.__aggregateFallbacks__.push(o),I.__lastAggregateFallback__=o),s({type:"aggregateFallback",bucket:n,meta:{stale:o.stale,reason:o.reason},error:o.error})}(t,n,o,m),await C(e,r,c,{bucket:m,fromFallback:!0,fallbackReason:t,stale:a})};try{window.showSkeleton?.(r),B=new AbortController;const t=function(){const e=I?.__TEST_FETCH_ITEM_AGGREGATE__;return"function"==typeof e?e:u}(),n=await t(e,{signal:B.signal}),d=o(n),{item:w,market:h,tree:E,meta:k}=d;if(_=k||null,c!==R)return;if(!w)return void await b("missing-item",k);if((Array.isArray(k?.errors)?k.errors.filter(Boolean):[]).length)return void await b("meta-errors",k);const A=a(E);f(A?[A]:[]),y(h);const S=h?.unitBuyPrice??A?.buy_price??0,P=h?.unitSellPrice??A?.sell_price??0;window._mainBuyPrice=S||0,window._mainSellPrice=P||0,window._mainRecipeOutputCount=A?.recipe?.output_item_count||A?.output||1,await window.initItemUI(w,{buy_price:window._mainBuyPrice,sell_price:window._mainSellPrice}),await(window.safeRenderTable?.()),window.hideSkeleton?.(r),i(k);const T=g()-p;l({bucket:m,stale:k?.stale??null,duration:T}),s({type:"aggregateSuccess",bucket:m,metrics:{durationMs:T},meta:{stale:k?.stale??null}})}catch(e){if("AbortError"===e?.name)return;if(window.hideSkeleton?.(r),console.error("Error cargando agregado de ítem",e),window.showError?.("No se pudo cargar el agregado del ítem."),t(),c!==R)return;s({type:"aggregateError",bucket:m,meta:{stale:_?.stale??null},error:String(e?.message||e)}),await b("aggregate-error",_,e)}}async function C(e,r,n,o={}){await T(),t(),window.hideError?.();let a=null,i=null;const l=function(){const e=I?.__TEST_FETCH_WITH_RETRY__;return"function"==typeof e?e:w}(),{bucket:u=null,fromFallback:y=!1,fallbackReason:b=null,stale:h=null}=o||{};s({type:"legacyLoadStart",bucket:u,meta:{fromFallback:Boolean(y),fallbackReason:b,aggregateStale:h}});try{window.showSkeleton?.(r),B=new AbortController;const{API_BASE_URL:t,FEATURE_ITEM_API_ROLLOUT:o}=m(),w=Boolean(o);let h=null,E=null;if(w){const r=function(e,r){const t=("string"==typeof e?e.trim():"").replace(/\/+$/,"");return`${t?`${t}/items`:"/items"}/${String(r).trim()}`}(t,e);try{const e=await l(r,{signal:B.signal});if(404===e.status)console.warn("Item API devolvió 404, usando fallback PHP");else{if(!e.ok)throw new Error(`Error ${e.status} obteniendo detalles del ítem desde API`);{const r=e.headers.get("content-type")||"";if(!r.includes("application/json"))throw new Error(`Respuesta no válida: ${r}`);const t=await e.json().catch(()=>null);if(!t)throw new Error("Payload JSON no válido en item API");h=e,E=t}}}catch(e){if("AbortError"===e?.name)throw e;console.warn("Fallo en item API, usando PHP como fallback",e),h=null,E=null}}if(!h){if(h=await l(`/backend/api/itemDetails.php?itemId=${e}`,{signal:B.signal}),404===h.status)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(r);if(!h.ok)throw new Error(`Error ${h.status} obteniendo detalles del ítem`);const t=h.headers.get("content-type")||"";if(!t.includes("application/json"))throw new Error(`Respuesta no válida: ${t}`);E=await h.json().catch(()=>null)}const{data:A,meta:I}=c(E);s({type:"legacyLoad",bucket:u,meta:{stale:I?.stale??null,fromFallback:Boolean(y),fallbackReason:b}});const P=A?.item||null,T=A?.recipe||null,F=A?.market||null,j=A?.nested_recipe||null;if(!P){const e=I?.errors?.[0]||"El ítem no existe";return window.showError?.(e),void window.hideSkeleton?.(r)}if(n!==R)return;if(i=Array.isArray(F)||!F?{}:{...F},Array.isArray(F)||null==i.buy_price||null==i.sell_price)try{const r=await S(e);r&&(i={...i,...r})}catch(e){console.warn("No se pudo recuperar el precio de respaldo",e)}if(i.buy_price=i.buy_price??0,i.sell_price=i.sell_price??0,window._mainBuyPrice=i.buy_price,window._mainSellPrice=i.sell_price,!T)return f([]),void window.initItemUI(P,i);T&&j&&(T.nested_recipe=j),window._mainRecipeOutputCount=T.output_item_count||1,setTimeout(async()=>{if(n!==R)return;let r;try{r=await g(e,T)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),f([]),void window.initItemUI(P,i)}Array.isArray(r)||(r=[]);const t=Array.isArray(T?.ingredients)&&T.ingredients.length>0&&0===r.length;let o=null;if(t){const e="No se pudo construir el árbol de ingredientes. Mostrando el ítem sin receta.";o="Sin receta disponible (no se pudo procesar la receta).",window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(e,"error"):console.warn(e)}a=new p({id:P.id,name:P.name,icon:P.icon,rarity:P.rarity,count:1,buy_price:i?.buy_price||0,sell_price:i?.sell_price||0,is_craftable:!t,recipe:t?null:T,children:t?[]:r}),a.recalc(window.globalQty||1,null),f([a]),await window.initItemUI(P,i),await(window.safeRenderTable?.()),o&&window.showError?.(o);const l=new Set;!function e(r,t){t.add(r.id),r.children&&r.children.forEach(r=>e(r,t))}(a,l),v&&v();const s=Array.from(l),c=async e=>{if(!document.getElementById("seccion-crafting"))return void requestAnimationFrame(()=>c(e));const r=[];e.forEach((e,t)=>{const n=_(window.ingredientObjs,Number(t));n.length&&n.forEach(t=>{t.buy_price=e.buy_price||0,t.sell_price=e.sell_price||0,t===window.ingredientObjs[0]&&(window._mainBuyPrice=t.buy_price,window._mainSellPrice=t.sell_price),r.push(t)})}),await(window.safeRenderTable?.());const t=window.getTotals?.();t&&(k("totales-crafting-global",t),k("totales-crafting-unit",t)),r.forEach(e=>k(e._uid,e))};v=d(s,c)},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(r),s({type:"legacyError",bucket:u,meta:{fromFallback:Boolean(y),fallbackReason:b},error:String(e?.message||e)})}finally{B=null}}async function O(t,n={}){await T();const o=++R;if(B&&(B.abort(),B=null),b(),!t)return window.hideSkeleton?.(document.getElementById("item-skeleton")),void window.showError?.("ID de ítem no válido");const a=document.getElementById("item-skeleton"),i=e("usePrecomputed"),{PRECOMPUTED_CANARY_THRESHOLD:l}=m(),s=r(),c=s<l,d=!0===n?.forceLegacy;i&&c&&!d?await j(t,a,o,{bucket:s}):await C(t,a,o,{bucket:s,fromFallback:Boolean(d)})}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),r=parseInt(e.get("id"),10);r?O(r):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{O as loadItem,C as loadItemLegacy,F as loadItems};
