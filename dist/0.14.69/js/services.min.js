import{p as e,g as n,a as t,f as r,s as i,b as a,n as s}from"./utils.min.js";import{g as o}from"./config.min.js";import"./services.min.js";function c(e,n){if("undefined"==typeof window||!window)return;Array.isArray(window.__bundleFallbacks__)||(window.__bundleFallbacks__=[]);const t=n&&n.message?n.message:String(n||"")||"unknown",r={ids:Array.isArray(e)?e.map(e=>String(e)):[],message:t,timestamp:(new Date).toISOString()};window.__bundleFallbacks__.push(r),window.__bundleFallbacks__.length>50&&window.__bundleFallbacks__.shift(),window.__lastBundleFallback__=r}function l(e,n){const t=("string"==typeof e?e.trim():"").replace(/\/+$/,""),r=String(n).replace(/^\/+/,"");return t?r?`${t}/${r}`:t||"/":`/${r}`}function u(e,n){const{data:t,meta:r}=s(e),a=Array.isArray(t)?t:[];return!Array.isArray(t)&&Array.isArray(r?.errors)&&r.errors.length&&console.warn("dataBundle devolvi칩 errores",r.errors),a.length&&a.forEach(e=>{const t=String(e.id);n.set(t,e),i(`bundle_${t}`,e),"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&"function"==typeof CustomEvent&&window.dispatchEvent(new CustomEvent("bundleItemRefreshed",{detail:e}))}),a.length>0}async function d(e=[]){if(!Array.isArray(e)||0===e.length)return[];const n=new Map,r=[];if(e.forEach(e=>{const i=String(e),a=t(`bundle_${i}`);a?n.set(i,a):r.push(i)}),r.length>0){const{API_BASE_URL:e,FEATURE_ITEM_API_ROLLOUT:t}=o(),i=Boolean(t);for(let t=0;t<r.length;t+=35){const s=r.slice(t,t+35),o=s.map(e=>`ids[]=${e}`).join("&");let d=!1;if(i){const t=`${l(e,"/items/bundle")}?${o}`;try{const e=await a(t);if(!e.ok)throw new Error(`Respuesta ${e.status} inv치lida en bundle API`);const r=await e.json().catch(()=>null);if(!r)throw new Error("Payload JSON no v치lido en bundle API");u(r,n),d=!0}catch(e){d=!1,console.warn("Fallo en bundle API, usando PHP como fallback",e),c(s,e)}}if(!i||!d)try{const e=await a(`/backend/api/dataBundle.php?${o}`);if(e.ok){u(await e.json().catch(()=>null),n)}else console.error("Error en getItemBundles: respuesta no v치lida")}catch(e){console.error("Error en getItemBundles:",e)}s.forEach(e=>{const t=String(e);n.has(t)||n.set(t,null)})}}return e.map(e=>{const t=String(e);return n.get(t)||null})}async function f(e){const n=Array.isArray(e)?e:[e],t=await d(n);if(Array.isArray(e))return t.map(e=>e?.recipe?[e.recipe]:[]);const r=t[0]?.recipe;return r?[r]:[]}async function w(e){const n=`recipe_${e}`,a=t(n,!0);try{const{API_BASE_URL:t}=o(),s=await r(`${t}/recipes/${e}`,{},n,a);if(!s.ok)return null;const c=await s.json();if(!c)return null;c.lastUpdated=(new Date).toISOString();const l=s.headers.get("ETag"),u=s.headers.get("Last-Modified");return i(n,c,void 0,{etag:l,lastModified:u}),c}catch(e){return console.error("Error en getRecipeDetails:",e),null}}async function p(e){if(Array.isArray(e)){return(await d(e)).map(e=>e?.item||null)}const n=await d([e]);return n[0]?.item||null}async function _(t){if(Array.isArray(t)){const n=await e(t);return t.map(e=>{const t=n.get(e)||{};return{buys:{unit_price:t.buy_price||0},sells:{unit_price:t.sell_price||0}}})}const r=await n(t);return{buys:{unit_price:r?.buy_price||0},sells:{unit_price:r?.sell_price||0}}}const y={getItemBundles:d,getRecipesForItem:f,getRecipeDetails:w,getItemDetails:p,getItemPrices:_};function g(e=("undefined"!=typeof window?window:void 0)){if(!e)return y;const n={...e.RecipeService||{},...y};return e.RecipeService=n,Object.entries(y).forEach(([n,t])=>{"function"!=typeof e[n]&&(e[n]=t)}),n}"undefined"!=typeof window&&g(window);export{d as getItemBundles,p as getItemDetails,_ as getItemPrices,w as getRecipeDetails,f as getRecipesForItem,g as registerRecipeServiceGlobals};
