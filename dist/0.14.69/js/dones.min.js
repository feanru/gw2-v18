import{showSkeleton as e,hideSkeleton as n}from"./ui-helpers.min.js";import{b as t,i as a,p as o,s as r,a as i,h as s,t as l,r as c}from"./utils.min.js";import"./config.min.js";import"./services.min.js";const d={items:new Map,prices:new Map,meta:null,warnings:[],errors:[],expiresAt:0};function u(e){const n=Number(e);return Number.isFinite(n)?n:null}function m(e,n){const t=new Map;return e&&"object"==typeof e?(Object.entries(e).forEach(([e,a])=>{const o=n(e,a);o&&t.set(o.id,o)}),t):t}async function p(e=[],n={}){const a=Array.from(new Set((Array.isArray(e)?e:[e]).map(e=>u(e)).filter(e=>Number.isFinite(e)&&e>0))),o=Number.isFinite(Number(n.ttl))&&Number(n.ttl)>0?Number(n.ttl):12e4,r=Date.now(),i=!0===n.skipCache,s=new Map,l=new Map;a.forEach(e=>{d.items.has(e)&&s.set(e,d.items.get(e)),d.prices.has(e)&&l.set(e,d.prices.get(e))});const c=i||r>=d.expiresAt,p=c?a:a.filter(e=>!s.has(e)||!l.has(e));if(!i&&!c&&0===p.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:s,pricesMap:l,meta:d.meta,warnings:Array.isArray(d.warnings)?[...d.warnings]:[],errors:Array.isArray(d.errors)?[...d.errors]:[],missingIds:[]};if(0===a.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:new Map,pricesMap:new Map,meta:d.meta,warnings:Array.isArray(d.warnings)?[...d.warnings]:[],errors:Array.isArray(d.errors)?[...d.errors]:[],missingIds:[]};const g=c?a:p,b=await async function(e,n={}){const a=new URLSearchParams;a.set("ids",e.join(",")),a.set("lang","es");const o=await t(`/api/aggregate/bundle?${a.toString()}`,{signal:n.signal});if(!o.ok)throw new Error(`Error ${o.status} al consultar el agregado de bundle`);const r=o.headers?.get?.("content-type")||o.headers?.get?.("Content-Type")||"";if(!String(r).toLowerCase().includes("application/json"))throw new Error("Respuesta no válida del agregado de bundle");const i=await o.json().catch(()=>null);if(!i||"object"!=typeof i)throw new Error("Datos no válidos del agregado de bundle");return i}(g,n),f=m(b.iconMap,(e,n)=>{const t=u(e);return t?{id:t,icon:n??null}:null}),y=m(b.rarityMap,(e,n)=>{const t=u(e);return t?{id:t,rarity:n??null}:null}),h=m(b.itemMap,(e,n)=>function(e,n,t,a){const o=u(e);if(!o)return null;const r=n&&"object"==typeof n?n:{},i=t?.get(o)??null,s=a?.get(o)??null;return{id:o,name:"string"==typeof r.name?r.name:null,icon:r.icon??i?.icon??null,rarity:r.rarity??s?.rarity??null,type:"string"==typeof r.type?r.type:null}}(e,n,f,y));0===h.size&&g.forEach(e=>{const n=f.get(e)??null,t=y.get(e)??null;(n||t)&&h.set(e,{id:e,name:null,icon:n?.icon??null,rarity:t?.rarity??null,type:null})});const w=m(b.priceMap,(e,n)=>function(e,n){const t=u(e);if(!t)return null;const a=n&&"object"==typeof n?n:{},o=e=>{if(null==e)return null;const n=Number(e);return Number.isFinite(n)&&n>=0?n:null},r=o(a.buy_price??a.buyPrice??a.buy),i=o(a.sell_price??a.sellPrice??a.sell);return null==r&&null==i?{id:t,buy_price:null,sell_price:null}:{id:t,buy_price:r,sell_price:i}}(e,n));c&&g.forEach(e=>{d.items.delete(e),d.prices.delete(e)});const E=c?new Map:new Map(s);h.forEach((e,n)=>{E.set(n,e),d.items.set(n,e)});const _=c?new Map:new Map(l);w.forEach((e,n)=>{_.set(n,e),d.prices.set(n,e)});const N=b.meta||null,v=Array.isArray(N?.warnings)?[...N.warnings]:[],M=[];Array.isArray(b.errors)?M.push(...b.errors):b.errors&&M.push(b.errors),d.meta=N,d.warnings=v,d.errors=M,d.expiresAt=r+o;const A=g.filter(e=>!h.has(e)||!w.has(e)),T=Array.from(new Set([...A,...a.filter(e=>!E.has(e)||!_.has(e))]));return{ok:0===T.length&&0===M.length,partial:T.length>0||M.length>0,fromCache:!1,itemsMap:E,pricesMap:_,meta:N,warnings:v,errors:M,missingIds:T}}var g=[{id:19673,name:"Don de la Magia",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19721,name:"Pegote de ectoplasma",count:250}],manualIngredients:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",manualIngredients:[{id:24357,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24351,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]},{id:19626,name:"Don de la Suerte",mainIngredients:[{id:19721,name:"Pegote de ectoplasma",count:250},{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19673,name:"Don de la Magia",type:"crafting_material",count:1,components:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",type:"crafting_material",count:1,components:[{id:24351,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24357,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]}]}];document.getElementById("dones-content");const b=document.getElementById("dones-skeleton"),f=document.getElementById("error-message");window.showSkeleton=e,window.hideSkeleton=n;const y={19676:1e4},h="sin precio",w=`${h} (fuera del mercado)`,E=`${h} (vinculado a cuenta)`,_=new Map([[19675,"account"],[19925,"market"],[20796,"market"],[19633,"market"],[19634,"market"],[19641,"market"],[19642,"market"],[19628,"market"],[20799,"account"]]),N=(e="")=>{if(!e)return!1;const n=e.toLowerCase();return n.startsWith("don de ")||n.startsWith("don del ")||n.startsWith("don de la ")},v=e=>{if("string"!=typeof e||!e)return!1;if((()=>{const{isGiftName:e}=window?.DonesCore||{};return"function"==typeof e?e:N})()(e))return!0;const n=e.toLowerCase();return n.includes("tributo")||n.includes("bendición")};let M=null,A=!1;const T={promise:null,expiresAt:0,payload:{items:new Map,prices:new Map},pendingExtraIds:new Set};let I=null;function C(e){const n=Number(e);return Number.isFinite(n)?(I||function(){I=new Map;const e=window.LegendaryData;if(!e)return;const n=new Set,t=e=>{if(!e||n.has(e))return;n.add(e);const a=Number(e.id);Number.isFinite(a)&&!I.has(a)&&I.set(a,{id:a,name:e.name||null,icon:e.icon||null,rarity:e.rarity||null,type:e.type||null}),Array.isArray(e.components)&&e.components.forEach(t)},a=e=>{e&&Object.values(e).forEach(e=>t(e))};a(e.LEGENDARY_ITEMS),a(e.LEGENDARY_ITEMS_3GEN)}(),I?.get(n)||null):null}function F(e,n=new Set){if(!e)return n;if(!(n&&n instanceof Set))return F(e,new Set);if(Array.isArray(e))return e.forEach(e=>F(e,n)),n;if("object"==typeof e){if(Object.prototype.hasOwnProperty.call(e,"id")){const t=Number(e.id);Number.isFinite(t)&&n.add(t)}Object.values(e).forEach(e=>F(e,n))}return n}function k(){const e=new Set;return F(g,e),F(W,e),F(Y,e),function(e){const n=window.LegendaryData;if(!n)return;const t=new Set;var a;(a=n.LEGENDARY_ITEMS)&&Object.values(a).forEach(n=>{n&&Array.isArray(n.components)&&n.components.forEach(n=>{if(!n||!n.name)return;const a=n.name.toLowerCase();if(!a.startsWith("don de")||a.includes("la suerte")||a.includes("del dominio"))return;const o=Number(n.id);Number.isFinite(o)&&!t.has(o)&&(t.add(o),F(n,e))})})}(e),e}function D(e,n=null){const t=Number(e);if(!Number.isFinite(t))return null;const a=C(t),o=n?.name??n?.localized_name??n?.display_name??null,r=n?.icon??null,i={id:t,name:a?.name??o??null,icon:a?.icon??r??null,rarity:a?.rarity??n?.rarity??null,type:a?.type??n?.type??null};return null==i.name&&null==i.icon&&null==i.rarity&&null==i.type?null:i}function S(e){const n={};return e&&e instanceof Map?(e.forEach((e,t)=>{n[t]=e}),n):n}function L(e){const n=Number(e);if(!Number.isFinite(n))return null;const t=T.payload;if(t?.items instanceof Map&&t.items.has(n))return t.items.get(n);const a=i(`item_${n}`);if(a){const e=D(n,a);return e&&t?.items instanceof Map&&t.items.set(n,e),e}const o=D(n,null);return o&&t?.items instanceof Map&&t.items.set(n,o),o}async function V(e=[]){const n=Date.now(),t=Array.isArray(e)&&e.length>0,s=T.payload,c=s?.items instanceof Map?s.items:null,d=s?.prices instanceof Map?s.prices:null,u=Boolean(c&&d),m=t?F(e,new Set):new Set,g=new Set;m.size>0&&m.forEach(e=>{const n=Number(e);Number.isFinite(n)&&(u&&c.has(n)&&d.has(n)||g.add(n))});const b=n>=T.expiresAt||!u||g.size>0;if(!b&&s)return s;if(T.pendingExtraIds instanceof Set||(T.pendingExtraIds=new Set),m.size>0){(b?m:g).forEach(e=>{Number.isFinite(e)&&T.pendingExtraIds.add(Number(e))})}return T.promise?T.promise.then(()=>V(e)):(T.promise=(async()=>{const e=k();T.pendingExtraIds instanceof Set&&(T.pendingExtraIds.forEach(n=>e.add(n)),T.pendingExtraIds.clear());const t=Array.from(e),s=window.RecipeService||{},c=new Map,d=e=>(c.has(e)||c.set(e,{id:e,item:null,market:null}),c.get(e)),u=a("donesAggregate"),m={meta:null,errors:[],warnings:[],missingIds:[],used:!1,fromCache:!1};let g=null;if(u)try{const e=await p(t);m.used=!0,m.meta=e?.meta||null,m.errors=Array.isArray(e?.errors)?[...e.errors]:[],m.warnings=Array.isArray(e?.warnings)?[...e.warnings]:[],m.missingIds=Array.isArray(e?.missingIds)?e.missingIds.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],m.fromCache=Boolean(e?.fromCache),e?.itemsMap instanceof Map&&e.itemsMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;d(t).item=e}),e?.pricesMap instanceof Map&&e.pricesMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;const a=d(t);a.market={...a.market||{},buy_price:e?.buy_price??null,sell_price:e?.sell_price??null}})}catch(e){g=e,console.error("Error al precargar datos del agregado de dones",e)}u&&m.warnings.length&&!m.fromCache&&console.warn("Advertencias del agregado de dones",m.warnings);const b=P(),f=new Set;let h=u?null:"flag-disabled";u?g?(h="aggregate-error",t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&f.add(n)})):(t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null;t?.item||f.add(n);if(!(Object.prototype.hasOwnProperty.call(y,n)||b.has(n))){const e=t?.market||null;Boolean(e&&(null!=e.buy_price&&Number.isFinite(Number(e.buy_price))||null!=e.sell_price&&Number.isFinite(Number(e.sell_price))||null!=e.buys?.unit_price||null!=e.sells?.unit_price))||f.add(n)}}),m.missingIds.forEach(e=>f.add(e)),f.size>0&&m.missingIds.length>0&&(h="missing-data"),!h&&m.errors.length>0&&(h="aggregate-errors")):t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&f.add(n)});const w=Array.from(f);if(w.length>0){!function(e,n=null,t=null,a={}){if("undefined"==typeof window||!window)return null;Array.isArray(window.__donesAggregateFallbacks__)||(window.__donesAggregateFallbacks__=[]);const o=(Array.isArray(a?.ids)?a.ids:[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)),r=Array.isArray(a?.errors)?a.errors.map(e=>"string"==typeof e?e:String(e||"")):void 0,i={reason:e,meta:n?{...n}:null,stale:Boolean(n?.stale),ids:o,errors:r,error:t?String(t?.message||t):void 0,timestamp:(new Date).toISOString()};window.__donesAggregateFallbacks__.push(i),window.__donesAggregateFallbacks__.length>50&&window.__donesAggregateFallbacks__.shift(),window.__lastDonesAggregateFallback__=i;try{l?.({type:"donesAggregateFallback",meta:{reason:i.reason,stale:i.stale,missing:o.length},error:i.error})}catch(e){console.warn("No se pudo registrar telemetría de fallback de dones",e)}}(h||(g?"aggregate-error":"legacy-required"),m.meta,g,{ids:w,errors:m.errors})}if(w.length>0)if("function"==typeof s.getItemBundles)try{const e=await s.getItemBundles(w);w.forEach((n,t)=>{const a=Number(n);if(!Number.isFinite(a))return;const o=Array.isArray(e)?e[t]:null;if(!o)return;const r=d(a);o.item&&(r.item=o.item),o.market&&(r.market=r.market?{...o.market,...r.market}:o.market)})}catch(e){console.error("Error al precargar bundles de dones",e)}else{const[e=[],n=[]]=await Promise.all(["function"==typeof s.getItemDetails?s.getItemDetails(w):Promise.resolve([]),"function"==typeof s.getItemPrices?s.getItemPrices(w):Promise.resolve([])]).catch(e=>(console.error("Error al precargar datos de dones",e),[[],[]]));w.forEach((t,a)=>{const o=Number(t);if(!Number.isFinite(o))return;const r=Array.isArray(e)?e[a]:null,i=Array.isArray(n)?n[a]:null,s=i?{buy_price:i?.buys?.unit_price??null,sell_price:i?.sells?.unit_price??null}:null,l=d(o);r&&(l.item=r),s&&(l.market=l.market?{...s,...l.market}:s)})}t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&d(n)});const E=[];t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null;if(Object.prototype.hasOwnProperty.call(y,n)||b.has(n))return;const a=t?.market||null;Boolean(a&&(null!=a.buy_price&&Number.isFinite(Number(a.buy_price))||null!=a.sell_price&&Number.isFinite(Number(a.sell_price))||null!=a.buys?.unit_price||null!=a.sells?.unit_price))||E.push(n)});let _=new Map;if(E.length>0)try{_=await o(E)}catch(e){console.error("Error al precargar precios de dones",e),_=new Map}const N=new Map,v=new Map;return t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null,a=D(n,t?.item||null);if(a)N.set(n,a),r(`item_${n}`,a,864e5);else{const e=i(`item_${n}`);if(e){const t=D(n,e);t&&N.set(n,t)}}const o=_.get(n)||null;let s=o?.buy_price??null,l=o?.sell_price??null;const d=t?.market||null;if(d&&(null==s&&null!=d.buy_price&&(s=d.buy_price),null==s&&null!=d.buys?.unit_price&&(s=d.buys.unit_price),null==l&&null!=d.sell_price&&(l=d.sell_price),null==l&&null!=d.sells?.unit_price&&(l=d.sells.unit_price)),Object.prototype.hasOwnProperty.call(y,n)){const e=y[n];s=e,l=e}v.set(n,{buy_price:null!=s?s:null,sell_price:null!=l?l:null})}),t.forEach(e=>{const n=Number(e);if(Number.isFinite(n)){if(!N.has(n)){const e=D(n,null);e&&N.set(n,e)}if(!v.has(n))if(Object.prototype.hasOwnProperty.call(y,n)){const e=y[n];v.set(n,{buy_price:e,sell_price:e})}else v.set(n,{buy_price:null,sell_price:null})}}),T.payload={items:N,prices:v},T.expiresAt=n+216e5,T.payload})().catch(e=>(console.error("Error general al precargar datos de dones",e),T.payload)).finally(()=>{T.promise=null}),T.promise)}function P(){return M||(M=new Map(_)),A||(A=function(e){const n=window.LegendaryData;if(!n)return!1;const{LEGENDARY_ITEMS:t,LEGENDARY_ITEMS_3GEN:a}=n;if(!t&&!a)return!1;const o=new Set,r=n=>{if(!n)return;const t=Number(n.id);if(Number.isFinite(t)){if(o.has(t))return;o.add(t),v(n.name)&&e.set(t,"gift")}Array.isArray(n.components)&&n.components.forEach(r)},i=e=>{e&&Object.values(e).forEach(e=>{e&&Array.isArray(e.components)&&e.components.forEach(r)})};return i(t),i(a),!0}(M)),M}let j=null;function $(e){if(!e||"object"!=typeof e)return;const n=Number(e.id);if(Number.isFinite(n)){const t=L(n);t&&(e.name=t.name??e.name,e.icon=t.icon??e.icon,e.rarity=t.rarity??e.rarity,e.type=t.type??e.type);const a=function(e){const n=Number(e);if(!Number.isFinite(n))return null;if(Object.prototype.hasOwnProperty.call(y,n)){const e=y[n];return{buy_price:e,sell_price:e}}const t=T.payload;return t?.prices instanceof Map&&t.prices.has(n)?t.prices.get(n):null}(n);a&&(null==e.buy_price&&null!=a.buy_price&&(e.buy_price=a.buy_price),null==e.sell_price&&null!=a.sell_price&&(e.sell_price=a.sell_price))}Array.isArray(e.children)&&e.children.forEach(e=>$(e))}async function B(e){const{ingredientTree:n}=await async function(e){const n=await V(e);j||(j=new Worker(new URL("./workers/donesWorker.js",import.meta.url),{type:"module"}));const t={rootIngredients:e,skipEntries:Array.from(P().entries()),preloadedItems:S(n?.items),preloadedPrices:S(n?.prices)};return new Promise((e,n)=>{const a=n=>{j.removeEventListener("message",a),j.removeEventListener("error",o),e(n.data)},o=e=>{j.removeEventListener("message",a),j.removeEventListener("error",o),n(e)};j.addEventListener("message",a),j.addEventListener("error",o),j.postMessage(t)})}(e),t=Array.isArray(n)?n:[];t.forEach(e=>$(e));const{updatedTree:a,totals:o}=await function(e,n){return c({ingredientTree:e,globalQty:n})}(t,1);return s(a,null),{tree:a,totals:o}}function G(e,n=0){const t=n>0?`padding-left:${32*n}px;`:"",a=function(e,n,t){const a=Number(e),o=P();if(!Number.isFinite(a))return{skip:!0,reason:"synthetic",label:w};if(o.has(a)){const e=o.get(a);return{skip:!0,reason:e,label:"account"===e?E:w}}return v(n)?(o.set(a,"gift"),{skip:!0,reason:"gift",label:w}):("string"==typeof t?t.toLowerCase():"").includes("account")?(o.set(a,"account"),{skip:!0,reason:"account",label:E}):{skip:!1,reason:null,label:null}}(e.id,e.name,e.type),o=a.skip,r=a.label||w,i=Number.isFinite(e.buy_price)&&e.buy_price>0,s=Number.isFinite(e.sell_price)&&e.sell_price>0,l=Number.isFinite(e.total_buy)&&e.total_buy>0,c=Number.isFinite(e.total_sell)&&e.total_sell>0,d=!o&&(i||s)||l||c,u=o?r:i?formatGoldColored(e.buy_price):"-",m=o?r:s?formatGoldColored(e.sell_price):"-",p=l?formatGoldColored(e.total_buy):"-",g=c?formatGoldColored(e.total_sell):"-";let b=`<tr>\n    <td style='${t}'>${e.icon?`<img src='${e.icon}' style='height:28px;'>`:"-"}</td>\n    <td>${e.name}</td>\n    <td>${Math.round(e.count)}</td>\n    <td>${u}</td>\n    <td>${m}</td>\n    <td>${p}</td>\n    <td>${g}</td>\n  </tr>`,f=!1;if(Array.isArray(e.children))for(const t of e.children){const e=G(t,n+1);b+=e.html,e.hasValue&&(f=!0)}const y=d||f;return{html:b,hasNoMarket:!y,hasValue:y,childContributedValue:f}}function O(e,n){return n?"<span class='total-sin-precio'>Sin precio (faltan componentes valorados)</span>":Number.isFinite(e)&&e>0?formatGoldColored(e):"-"}async function x(e,n){const t=n||document.getElementById("dones-content");t.innerHTML="",f.style.display="none";try{await V([e]);const n=L(e.id);let a=n?.name||e.name,o=n?.icon||null;if(!o){const n=e.manualIngredients&&e.manualIngredients[0]||e.mainIngredients&&e.mainIngredients[0]||null;if(n){await V([n]);const e=L(n.id);e?.icon&&(o=e.icon)}}let r="";const i=e.name?e.name.toLowerCase():"",s=i.includes("suerte")||i.includes("magia")||i.includes("poder");if(s){if(e.mainIngredients&&e.mainIngredients.length>0){r+="<table class='table-modern-dones tabla-tarjetas'>\n          <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,t=0,a=!1;for(const o of e.mainIngredients){const e=await q(o,0);r+=e.html,e.hasValue||(a=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(t+=e.totalSell)}if(r+="</tbody></table>",a||n>0||t>0){const e=O(n,a);r+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n            <div class='precio-totales-dones'>\n              <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n              <div class='total-dones'><b>Total Venta estimado:</b> ${O(t,a)}</div>\n            </div>\n          </div>`}}return void(t.innerHTML+=r)}if(s||(r+=`<h2 style='margin-top:18px;'><img src='${o}' style='height:32px;vertical-align:middle;'> ${a}</h2>`),e.mainIngredients&&e.mainIngredients.length>0){r+="<table class='table-modern-dones tabla-tarjetas'>\n        <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,t=0,a=!1;for(const o of e.mainIngredients){const e=await q(o,0);r+=e.html,e.hasValue||(a=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(t+=e.totalSell)}if(r+="</tbody></table>",a||n>0||t>0){const e=O(n,a);r+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n          <div class='precio-totales-dones'>\n            <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n            <div class='total-dones'><b>Total Venta estimado:</b> ${O(t,a)}</div>\n          </div>\n        </div>`}}if(s)return;t.innerHTML+=r}catch(e){f.innerText=e.message,f.style.display="block"}}async function H(){const t=document.getElementById("dones-1ra-gen-content"),a=document.getElementById("dones-1ra-gen-skeleton");if(t&&a){e(a),t.innerHTML="";try{const o=await async function(){const{LEGENDARY_ITEMS:e}=window.LegendaryData||{},n=[],t=new Set;for(const a of Object.values(e)){if(!a.components)continue;const e=a.components.find(e=>{if(!e.name)return!1;const n=e.name.toLowerCase();return n.startsWith("don de")&&!n.includes("la suerte")&&!n.includes("del dominio")});e&&!t.has(e.id)&&(t.add(e.id),n.push({id:e.id,name:e.name,mainIngredients:e.components||[],manualIngredients:[]}))}return n.sort((e,n)=>e.name.localeCompare(n.name,"es")),n}(),r=document.createElement("div");r.className="don1gen-nav-btns don1gen-grid";const i=document.createElement("div");i.id="don1gen-result",o.forEach(t=>{const o=document.createElement("button");o.className="dones-btn",o.textContent=t.name,o.addEventListener("click",async()=>{r.querySelectorAll("button").forEach(e=>e.classList.remove("active")),o.classList.add("active"),i.innerHTML="",e(a),await x(t,i),n(a)}),r.appendChild(o)}),t.appendChild(r),t.appendChild(i)}catch(e){console.error("Error al renderizar dones de 1ra Gen:",e),t.innerHTML='<div class="error-message">Error al cargar los dones.</div>'}finally{n(a)}}}async function z(){const t=document.getElementById("tributo-draconico-content"),a=document.getElementById("tributo-draconico-skeleton");if(t&&a){e(a),t.innerHTML="";try{const e=await async function(){const{LEGENDARY_ITEMS_3GEN:e}=window.LegendaryData||{};for(const n of Object.values(e)){const e=n.components?.find(e=>(e.name?.toLowerCase()||"").includes("tributo dracónico"));if(e)return e}throw new Error("No se encontró el Tributo Dracónico en legendaryItems3gen")}();let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let a=0,o=0,r=!1;for(const t of e.components){const e=await q(t,0);n+=e.html,e.hasValue||(r=!0),Number.isFinite(e.totalBuy)&&(a+=e.totalBuy),Number.isFinite(e.totalSell)&&(o+=e.totalSell)}n+="</tbody></table>";if(r||a>0||o>0){const e=O(a,r);n+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${O(o,r)}</div>\n        </div>\n      </div>`}t.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Dracónico:",e),t.innerHTML='<div class="error-message">Error al cargar el Tributo Dracónico.</div>'}finally{n(a)}}}const R={special:!1,tributo:!1,draco:!1,gen1:!1};window.DonesPages={loadSpecialDons:async function(){R.special||(R.special=!0,await async function(){const t=document.getElementById("dones-content"),a=b;e(a),t.innerHTML="";const o=g.filter(e=>e.name&&e.name.toLowerCase().includes("suerte"));for(const e of o){const n=document.createElement("div");t.appendChild(n),await x(e,n)}n(a)}())},loadTributo:async function(){R.tributo||(R.tributo=!0,await async function(){const t=document.getElementById("tributo-content"),a=document.getElementById("tributo-skeleton");if(!t||!a)return;e(a),t.innerHTML="";try{const e=function(){const e={id:"TRIBUTO_MISTICO_ROOT",name:W.name,count:1,components:[]};return W.mainIngredients.forEach(n=>{e.components.push({...n})}),W.dons.forEach(n=>{const t=n.name.toLowerCase().includes("magia condensada")||n.name.toLowerCase().includes("poder condensado")?2:1,a={id:n.name.replace(/\s+/g,"_").toUpperCase(),name:n.name,count:t,components:[]};n.subdons.forEach(e=>{const n={id:e.name.replace(/\s+/g,"_").toUpperCase(),name:e.name,count:1,components:[]};e.ingredients.forEach(e=>{n.components.push({...e})}),a.components.push(n)}),e.components.push(a)}),e}();let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let a=0,o=0,r=!1;for(const t of e.components){const e=await q(t,0);n+=e.html,e.hasValue||(r=!0),Number.isFinite(e.totalBuy)&&(a+=e.totalBuy),Number.isFinite(e.totalSell)&&(o+=e.totalSell)}n+="</tbody></table>";if(r||a>0||o>0){const e=O(a,r);n+=`<div class='table-modern-totales' style='margin-bottom:18px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${O(o,r)}</div>\n        </div>\n      </div>`}t.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Místico:",e),t.innerHTML='<div class="error-message">Error al cargar el Tributo Místico.</div>'}finally{n(a)}}())},loadDraconicTribute:async function(){R.draco||(R.draco=!0,await z())},loadDones1Gen:async function(){R.gen1||(R.gen1=!0,await H())}};const W={name:"Tributo Místico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19976,name:"Moneda mística",count:250}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]},Y={name:"Tributo dracónico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:38,components:[{id:19976,name:"Moneda mística",count:38},{id:19721,name:"Pegote de ectoplasma",count:38},{id:19925,name:"Esquirla de obsidiana",count:38},{id:20796,name:"Piedra filosofal",count:228}]},{id:92687,name:"Piedra imán dracónica amalgamada",count:5}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]};async function q(e,n=0){const{tree:t}=await B([e]),a=t[0];if(!Array.isArray(a.children)||0===a.children.length){const e=Number.isFinite(a.count)?a.count:0,n=Number.isFinite(a.buy_price)?a.buy_price:0,t=Number.isFinite(a.sell_price)?a.sell_price:0;a.total_buy=n*e,a.total_sell=t*e}const{html:o,hasNoMarket:r,hasValue:i}=G(a,n);return{html:o,totalBuy:Number.isFinite(a.total_buy)?a.total_buy:null,totalSell:Number.isFinite(a.total_sell)?a.total_sell:null,hasNoMarket:r,hasValue:i}}
