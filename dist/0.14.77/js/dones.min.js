import{showSkeleton as e,hideSkeleton as n}from"./ui-helpers.min.js";import{b as t,i as a,p as r,s as o,a as i,h as s,t as l,r as c}from"./utils.min.js";import"./config.min.js";import"./services.min.js";const d=["priceMap","iconMap","rarityMap","itemMap"],u={items:new Map,prices:new Map,meta:null,warnings:[],errors:[],expiresAt:0};function m(e){const n=Number(e);return Number.isFinite(n)?n:null}function p(e,n){const t=new Map;return e&&"object"==typeof e?(Object.entries(e).forEach(([e,a])=>{const r=n(e,a);r&&t.set(r.id,r)}),t):t}async function g(e,n={}){const a=new URLSearchParams;a.set("ids",e.join(",")),a.set("lang","es"),Array.isArray(n.fields)&&n.fields.length>0&&a.set("fields",n.fields.join(",")),Number.isFinite(Number(n.page))&&Number(n.page)>0&&a.set("page",Math.floor(Number(n.page))),Number.isFinite(Number(n.pageSize))&&Number(n.pageSize)>0&&a.set("pageSize",Math.floor(Number(n.pageSize)));const r=await t(`/api/aggregate/bundle?${a.toString()}`,{signal:n.signal});if(!r.ok)throw new Error(`Error ${r.status} al consultar el agregado de bundle`);const o=r.headers?.get?.("content-type")||r.headers?.get?.("Content-Type")||"";if(!String(o).toLowerCase().includes("application/json"))throw new Error("Respuesta no válida del agregado de bundle");const i=await r.json().catch(()=>null);if(!i||"object"!=typeof i)throw new Error("Datos no válidos del agregado de bundle");return i}async function b(e=[],n={}){const t=Array.from(new Set((Array.isArray(e)?e:[e]).map(e=>m(e)).filter(e=>Number.isFinite(e)&&e>0))),a=Number.isFinite(Number(n.ttl))&&Number(n.ttl)>0?Number(n.ttl):12e4,r=Date.now(),o=!0===n.skipCache,i=new Map,s=new Map;t.forEach(e=>{u.items.has(e)&&i.set(e,u.items.get(e)),u.prices.has(e)&&s.set(e,u.prices.get(e))});const l=o||r>=u.expiresAt,c=l?t:t.filter(e=>!i.has(e)||!s.has(e));if(!o&&!l&&0===c.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:i,pricesMap:s,meta:u.meta,warnings:Array.isArray(u.warnings)?[...u.warnings]:[],errors:Array.isArray(u.errors)?[...u.errors]:[],missingIds:[]};if(0===t.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:new Map,pricesMap:new Map,meta:u.meta,warnings:Array.isArray(u.warnings)?[...u.warnings]:[],errors:Array.isArray(u.errors)?[...u.errors]:[],missingIds:[]};const b=l?t:c,f=Array.isArray(n.fields)&&n.fields.length>0?n.fields:d,y=Number.isFinite(Number(n.pageSize))&&Number(n.pageSize)>0?Math.floor(Number(n.pageSize)):50,h=[];let w=1,E=1;do{const e=await g(b,{signal:n.signal,page:w,pageSize:y,fields:f});h.push(e);const t=e?.meta?.pagination||null;if(t&&Number.isFinite(Number(t.totalPages))&&(E=Math.max(1,Number(t.totalPages))),!t||!t.hasNext)break;const a=Number.isFinite(Number(t.page))?Number(t.page)+1:w+1;if(a<=w||a>E)break;w=a}while(w<=E);const N={},_={},M={},v={},A=[],T=new Set;let I=null;h.forEach(e=>{if(!e||"object"!=typeof e)return;e.priceMap&&"object"==typeof e.priceMap&&Object.assign(N,e.priceMap),e.iconMap&&"object"==typeof e.iconMap&&Object.assign(_,e.iconMap),e.rarityMap&&"object"==typeof e.rarityMap&&Object.assign(M,e.rarityMap),e.itemMap&&"object"==typeof e.itemMap&&Object.assign(v,e.itemMap),Array.isArray(e.errors)?e.errors.forEach(e=>A.push(e)):e.errors&&A.push(e.errors);const n=e.meta||null;n&&(I=n,Array.isArray(n.warnings)&&n.warnings.filter(Boolean).forEach(e=>T.add(e)))});const F={priceMap:N,iconMap:_,rarityMap:M,itemMap:v,meta:I||null,errors:A};F.meta&&T.size>0&&(F.meta={...F.meta,warnings:Array.from(T)});const C=p(F.iconMap,(e,n)=>{const t=m(e);return t?{id:t,icon:n??null}:null}),k=p(F.rarityMap,(e,n)=>{const t=m(e);return t?{id:t,rarity:n??null}:null}),S=p(F.itemMap,(e,n)=>function(e,n,t,a){const r=m(e);if(!r)return null;const o=n&&"object"==typeof n?n:{},i=t?.get(r)??null,s=a?.get(r)??null;return{id:r,name:"string"==typeof o.name?o.name:null,icon:o.icon??i?.icon??null,rarity:o.rarity??s?.rarity??null,type:"string"==typeof o.type?o.type:null}}(e,n,C,k));0===S.size&&b.forEach(e=>{const n=C.get(e)??null,t=k.get(e)??null;(n||t)&&S.set(e,{id:e,name:null,icon:n?.icon??null,rarity:t?.rarity??null,type:null})});const D=p(F.priceMap,(e,n)=>function(e,n){const t=m(e);if(!t)return null;const a=n&&"object"==typeof n?n:{},r=e=>{if(null==e)return null;const n=Number(e);return Number.isFinite(n)&&n>=0?n:null},o=r(a.buy_price??a.buyPrice??a.buy),i=r(a.sell_price??a.sellPrice??a.sell);return null==o&&null==i?{id:t,buy_price:null,sell_price:null}:{id:t,buy_price:o,sell_price:i}}(e,n));l&&b.forEach(e=>{u.items.delete(e),u.prices.delete(e)});const L=l?new Map:new Map(i);S.forEach((e,n)=>{L.set(n,e),u.items.set(n,e)});const j=l?new Map:new Map(s);D.forEach((e,n)=>{j.set(n,e),u.prices.set(n,e)});const V=F.meta||null,P=Array.isArray(V?.warnings)?[...V.warnings]:[],B=[];Array.isArray(F.errors)?B.push(...F.errors):F.errors&&B.push(F.errors),u.meta=V,u.warnings=P,u.errors=B,u.expiresAt=r+a;const $=b.filter(e=>!S.has(e)||!D.has(e)),G=Array.from(new Set([...$,...t.filter(e=>!L.has(e)||!j.has(e))]));return{ok:0===G.length&&0===B.length,partial:G.length>0||B.length>0,fromCache:!1,itemsMap:L,pricesMap:j,meta:V,warnings:P,errors:B,missingIds:G}}var f=[{id:19673,name:"Don de la Magia",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19721,name:"Pegote de ectoplasma",count:250}],manualIngredients:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",manualIngredients:[{id:24357,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24351,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]},{id:19626,name:"Don de la Suerte",mainIngredients:[{id:19721,name:"Pegote de ectoplasma",count:250},{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19673,name:"Don de la Magia",type:"crafting_material",count:1,components:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",type:"crafting_material",count:1,components:[{id:24351,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24357,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]}]}];document.getElementById("dones-content");const y=document.getElementById("dones-skeleton"),h=document.getElementById("error-message");window.showSkeleton=e,window.hideSkeleton=n;const w={19676:1e4},E="sin precio",N=`${E} (fuera del mercado)`,_=`${E} (vinculado a cuenta)`,M=new Map([[19675,"account"],[19925,"market"],[20796,"market"],[19633,"market"],[19634,"market"],[19641,"market"],[19642,"market"],[19628,"market"],[20799,"account"]]),v=(e="")=>{if(!e)return!1;const n=e.toLowerCase();return n.startsWith("don de ")||n.startsWith("don del ")||n.startsWith("don de la ")},A=e=>{if("string"!=typeof e||!e)return!1;if((()=>{const{isGiftName:e}=window?.DonesCore||{};return"function"==typeof e?e:v})()(e))return!0;const n=e.toLowerCase();return n.includes("tributo")||n.includes("bendición")};let T=null,I=!1;const F={promise:null,expiresAt:0,payload:{items:new Map,prices:new Map},pendingExtraIds:new Set};let C=null;function k(e){const n=Number(e);return Number.isFinite(n)?(C||function(){C=new Map;const e=window.LegendaryData;if(!e)return;const n=new Set,t=e=>{if(!e||n.has(e))return;n.add(e);const a=Number(e.id);Number.isFinite(a)&&!C.has(a)&&C.set(a,{id:a,name:e.name||null,icon:e.icon||null,rarity:e.rarity||null,type:e.type||null}),Array.isArray(e.components)&&e.components.forEach(t)},a=e=>{e&&Object.values(e).forEach(e=>t(e))};a(e.LEGENDARY_ITEMS),a(e.LEGENDARY_ITEMS_3GEN)}(),C?.get(n)||null):null}function S(e,n=new Set){if(!e)return n;if(!(n&&n instanceof Set))return S(e,new Set);if(Array.isArray(e))return e.forEach(e=>S(e,n)),n;if("object"==typeof e){if(Object.prototype.hasOwnProperty.call(e,"id")){const t=Number(e.id);Number.isFinite(t)&&n.add(t)}Object.values(e).forEach(e=>S(e,n))}return n}function D(){const e=new Set;return S(f,e),S(q,e),S(U,e),function(e){const n=window.LegendaryData;if(!n)return;const t=new Set;var a;(a=n.LEGENDARY_ITEMS)&&Object.values(a).forEach(n=>{n&&Array.isArray(n.components)&&n.components.forEach(n=>{if(!n||!n.name)return;const a=n.name.toLowerCase();if(!a.startsWith("don de")||a.includes("la suerte")||a.includes("del dominio"))return;const r=Number(n.id);Number.isFinite(r)&&!t.has(r)&&(t.add(r),S(n,e))})})}(e),e}function L(e,n=null){const t=Number(e);if(!Number.isFinite(t))return null;const a=k(t),r=n?.name??n?.localized_name??n?.display_name??null,o=n?.icon??null,i={id:t,name:a?.name??r??null,icon:a?.icon??o??null,rarity:a?.rarity??n?.rarity??null,type:a?.type??n?.type??null};return null==i.name&&null==i.icon&&null==i.rarity&&null==i.type?null:i}function j(e){const n={};return e&&e instanceof Map?(e.forEach((e,t)=>{n[t]=e}),n):n}function V(e){const n=Number(e);if(!Number.isFinite(n))return null;const t=F.payload;if(t?.items instanceof Map&&t.items.has(n))return t.items.get(n);const a=i(`item_${n}`);if(a){const e=L(n,a);return e&&t?.items instanceof Map&&t.items.set(n,e),e}const r=L(n,null);return r&&t?.items instanceof Map&&t.items.set(n,r),r}async function P(e=[]){const n=Date.now(),t=Array.isArray(e)&&e.length>0,s=F.payload,c=s?.items instanceof Map?s.items:null,d=s?.prices instanceof Map?s.prices:null,u=Boolean(c&&d),m=t?S(e,new Set):new Set,p=new Set;m.size>0&&m.forEach(e=>{const n=Number(e);Number.isFinite(n)&&(u&&c.has(n)&&d.has(n)||p.add(n))});const g=n>=F.expiresAt||!u||p.size>0;if(!g&&s)return s;if(F.pendingExtraIds instanceof Set||(F.pendingExtraIds=new Set),m.size>0){(g?m:p).forEach(e=>{Number.isFinite(e)&&F.pendingExtraIds.add(Number(e))})}return F.promise?F.promise.then(()=>P(e)):(F.promise=(async()=>{const e=D();F.pendingExtraIds instanceof Set&&(F.pendingExtraIds.forEach(n=>e.add(n)),F.pendingExtraIds.clear());const t=Array.from(e),s=window.RecipeService||{},c=new Map,d=e=>(c.has(e)||c.set(e,{id:e,item:null,market:null}),c.get(e)),u=a("donesAggregate"),m={meta:null,errors:[],warnings:[],missingIds:[],used:!1,fromCache:!1};let p=null;if(u)try{const e=await b(t);m.used=!0,m.meta=e?.meta||null,m.errors=Array.isArray(e?.errors)?[...e.errors]:[],m.warnings=Array.isArray(e?.warnings)?[...e.warnings]:[],m.missingIds=Array.isArray(e?.missingIds)?e.missingIds.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],m.fromCache=Boolean(e?.fromCache),e?.itemsMap instanceof Map&&e.itemsMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;d(t).item=e}),e?.pricesMap instanceof Map&&e.pricesMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;const a=d(t);a.market={...a.market||{},buy_price:e?.buy_price??null,sell_price:e?.sell_price??null}})}catch(e){p=e,console.error("Error al precargar datos del agregado de dones",e)}u&&m.warnings.length&&!m.fromCache&&console.warn("Advertencias del agregado de dones",m.warnings);const g=B(),f=new Set;let y=u?null:"flag-disabled";u?p?(y="aggregate-error",t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&f.add(n)})):(t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null;t?.item||f.add(n);if(!(Object.prototype.hasOwnProperty.call(w,n)||g.has(n))){const e=t?.market||null;Boolean(e&&(null!=e.buy_price&&Number.isFinite(Number(e.buy_price))||null!=e.sell_price&&Number.isFinite(Number(e.sell_price))||null!=e.buys?.unit_price||null!=e.sells?.unit_price))||f.add(n)}}),m.missingIds.forEach(e=>f.add(e)),f.size>0&&m.missingIds.length>0&&(y="missing-data"),!y&&m.errors.length>0&&(y="aggregate-errors")):t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&f.add(n)});const h=Array.from(f);if(h.length>0){!function(e,n=null,t=null,a={}){if("undefined"==typeof window||!window)return null;Array.isArray(window.__donesAggregateFallbacks__)||(window.__donesAggregateFallbacks__=[]);const r=(Array.isArray(a?.ids)?a.ids:[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)),o=Array.isArray(a?.errors)?a.errors.map(e=>"string"==typeof e?e:String(e||"")):void 0,i={reason:e,meta:n?{...n}:null,stale:Boolean(n?.stale),ids:r,errors:o,error:t?String(t?.message||t):void 0,timestamp:(new Date).toISOString()};window.__donesAggregateFallbacks__.push(i),window.__donesAggregateFallbacks__.length>50&&window.__donesAggregateFallbacks__.shift(),window.__lastDonesAggregateFallback__=i;try{l?.({type:"donesAggregateFallback",meta:{reason:i.reason,stale:i.stale,missing:r.length},error:i.error})}catch(e){console.warn("No se pudo registrar telemetría de fallback de dones",e)}}(y||(p?"aggregate-error":"legacy-required"),m.meta,p,{ids:h,errors:m.errors})}if(h.length>0)if("function"==typeof s.getItemBundles)try{const e=await s.getItemBundles(h);h.forEach((n,t)=>{const a=Number(n);if(!Number.isFinite(a))return;const r=Array.isArray(e)?e[t]:null;if(!r)return;const o=d(a);r.item&&(o.item=r.item),r.market&&(o.market=o.market?{...r.market,...o.market}:r.market)})}catch(e){console.error("Error al precargar bundles de dones",e)}else{const[e=[],n=[]]=await Promise.all(["function"==typeof s.getItemDetails?s.getItemDetails(h):Promise.resolve([]),"function"==typeof s.getItemPrices?s.getItemPrices(h):Promise.resolve([])]).catch(e=>(console.error("Error al precargar datos de dones",e),[[],[]]));h.forEach((t,a)=>{const r=Number(t);if(!Number.isFinite(r))return;const o=Array.isArray(e)?e[a]:null,i=Array.isArray(n)?n[a]:null,s=i?{buy_price:i?.buys?.unit_price??null,sell_price:i?.sells?.unit_price??null}:null,l=d(r);o&&(l.item=o),s&&(l.market=l.market?{...s,...l.market}:s)})}t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&d(n)});const E=[];t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null;if(Object.prototype.hasOwnProperty.call(w,n)||g.has(n))return;const a=t?.market||null;Boolean(a&&(null!=a.buy_price&&Number.isFinite(Number(a.buy_price))||null!=a.sell_price&&Number.isFinite(Number(a.sell_price))||null!=a.buys?.unit_price||null!=a.sells?.unit_price))||E.push(n)});let N=new Map;if(E.length>0)try{N=await r(E)}catch(e){console.error("Error al precargar precios de dones",e),N=new Map}const _=new Map,M=new Map;return t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null,a=L(n,t?.item||null);if(a)_.set(n,a),o(`item_${n}`,a,864e5);else{const e=i(`item_${n}`);if(e){const t=L(n,e);t&&_.set(n,t)}}const r=N.get(n)||null;let s=r?.buy_price??null,l=r?.sell_price??null;const d=t?.market||null;if(d&&(null==s&&null!=d.buy_price&&(s=d.buy_price),null==s&&null!=d.buys?.unit_price&&(s=d.buys.unit_price),null==l&&null!=d.sell_price&&(l=d.sell_price),null==l&&null!=d.sells?.unit_price&&(l=d.sells.unit_price)),Object.prototype.hasOwnProperty.call(w,n)){const e=w[n];s=e,l=e}M.set(n,{buy_price:null!=s?s:null,sell_price:null!=l?l:null})}),t.forEach(e=>{const n=Number(e);if(Number.isFinite(n)){if(!_.has(n)){const e=L(n,null);e&&_.set(n,e)}if(!M.has(n))if(Object.prototype.hasOwnProperty.call(w,n)){const e=w[n];M.set(n,{buy_price:e,sell_price:e})}else M.set(n,{buy_price:null,sell_price:null})}}),F.payload={items:_,prices:M},F.expiresAt=n+216e5,F.payload})().catch(e=>(console.error("Error general al precargar datos de dones",e),F.payload)).finally(()=>{F.promise=null}),F.promise)}function B(){return T||(T=new Map(M)),I||(I=function(e){const n=window.LegendaryData;if(!n)return!1;const{LEGENDARY_ITEMS:t,LEGENDARY_ITEMS_3GEN:a}=n;if(!t&&!a)return!1;const r=new Set,o=n=>{if(!n)return;const t=Number(n.id);if(Number.isFinite(t)){if(r.has(t))return;r.add(t),A(n.name)&&e.set(t,"gift")}Array.isArray(n.components)&&n.components.forEach(o)},i=e=>{e&&Object.values(e).forEach(e=>{e&&Array.isArray(e.components)&&e.components.forEach(o)})};return i(t),i(a),!0}(T)),T}let $=null;function G(e){if(!e||"object"!=typeof e)return;const n=Number(e.id);if(Number.isFinite(n)){const t=V(n);t&&(e.name=t.name??e.name,e.icon=t.icon??e.icon,e.rarity=t.rarity??e.rarity,e.type=t.type??e.type);const a=function(e){const n=Number(e);if(!Number.isFinite(n))return null;if(Object.prototype.hasOwnProperty.call(w,n)){const e=w[n];return{buy_price:e,sell_price:e}}const t=F.payload;return t?.prices instanceof Map&&t.prices.has(n)?t.prices.get(n):null}(n);a&&(null==e.buy_price&&null!=a.buy_price&&(e.buy_price=a.buy_price),null==e.sell_price&&null!=a.sell_price&&(e.sell_price=a.sell_price))}Array.isArray(e.children)&&e.children.forEach(e=>G(e))}async function O(e){const{ingredientTree:n}=await async function(e){const n=await P(e);$||($=new Worker(new URL("./workers/donesWorker.js",import.meta.url),{type:"module"}));const t={rootIngredients:e,skipEntries:Array.from(B().entries()),preloadedItems:j(n?.items),preloadedPrices:j(n?.prices)};return new Promise((e,n)=>{const a=n=>{$.removeEventListener("message",a),$.removeEventListener("error",r),e(n.data)},r=e=>{$.removeEventListener("message",a),$.removeEventListener("error",r),n(e)};$.addEventListener("message",a),$.addEventListener("error",r),$.postMessage(t)})}(e),t=Array.isArray(n)?n:[];t.forEach(e=>G(e));const{updatedTree:a,totals:r}=await function(e,n){return c({ingredientTree:e,globalQty:n})}(t,1);return s(a,null),{tree:a,totals:r}}function x(e,n=0){const t=n>0?`padding-left:${32*n}px;`:"",a=function(e,n,t){const a=Number(e),r=B();if(!Number.isFinite(a))return{skip:!0,reason:"synthetic",label:N};if(r.has(a)){const e=r.get(a);return{skip:!0,reason:e,label:"account"===e?_:N}}return A(n)?(r.set(a,"gift"),{skip:!0,reason:"gift",label:N}):("string"==typeof t?t.toLowerCase():"").includes("account")?(r.set(a,"account"),{skip:!0,reason:"account",label:_}):{skip:!1,reason:null,label:null}}(e.id,e.name,e.type),r=a.skip,o=a.label||N,i=Number.isFinite(e.buy_price)&&e.buy_price>0,s=Number.isFinite(e.sell_price)&&e.sell_price>0,l=Number.isFinite(e.total_buy)&&e.total_buy>0,c=Number.isFinite(e.total_sell)&&e.total_sell>0,d=!r&&(i||s)||l||c,u=r?o:i?formatGoldColored(e.buy_price):"-",m=r?o:s?formatGoldColored(e.sell_price):"-",p=l?formatGoldColored(e.total_buy):"-",g=c?formatGoldColored(e.total_sell):"-";let b=`<tr>\n    <td style='${t}'>${e.icon?`<img src='${e.icon}' style='height:28px;'>`:"-"}</td>\n    <td>${e.name}</td>\n    <td>${Math.round(e.count)}</td>\n    <td>${u}</td>\n    <td>${m}</td>\n    <td>${p}</td>\n    <td>${g}</td>\n  </tr>`,f=!1;if(Array.isArray(e.children))for(const t of e.children){const e=x(t,n+1);b+=e.html,e.hasValue&&(f=!0)}const y=d||f;return{html:b,hasNoMarket:!y,hasValue:y,childContributedValue:f}}function H(e,n){return n?"<span class='total-sin-precio'>Sin precio (faltan componentes valorados)</span>":Number.isFinite(e)&&e>0?formatGoldColored(e):"-"}async function z(e,n){const t=n||document.getElementById("dones-content");t.innerHTML="",h.style.display="none";try{await P([e]);const n=V(e.id);let a=n?.name||e.name,r=n?.icon||null;if(!r){const n=e.manualIngredients&&e.manualIngredients[0]||e.mainIngredients&&e.mainIngredients[0]||null;if(n){await P([n]);const e=V(n.id);e?.icon&&(r=e.icon)}}let o="";const i=e.name?e.name.toLowerCase():"",s=i.includes("suerte")||i.includes("magia")||i.includes("poder");if(s){if(e.mainIngredients&&e.mainIngredients.length>0){o+="<table class='table-modern-dones tabla-tarjetas'>\n          <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,t=0,a=!1;for(const r of e.mainIngredients){const e=await Q(r,0);o+=e.html,e.hasValue||(a=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(t+=e.totalSell)}if(o+="</tbody></table>",a||n>0||t>0){const e=H(n,a);o+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n            <div class='precio-totales-dones'>\n              <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n              <div class='total-dones'><b>Total Venta estimado:</b> ${H(t,a)}</div>\n            </div>\n          </div>`}}return void(t.innerHTML+=o)}if(s||(o+=`<h2 style='margin-top:18px;'><img src='${r}' style='height:32px;vertical-align:middle;'> ${a}</h2>`),e.mainIngredients&&e.mainIngredients.length>0){o+="<table class='table-modern-dones tabla-tarjetas'>\n        <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,t=0,a=!1;for(const r of e.mainIngredients){const e=await Q(r,0);o+=e.html,e.hasValue||(a=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(t+=e.totalSell)}if(o+="</tbody></table>",a||n>0||t>0){const e=H(n,a);o+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n          <div class='precio-totales-dones'>\n            <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n            <div class='total-dones'><b>Total Venta estimado:</b> ${H(t,a)}</div>\n          </div>\n        </div>`}}if(s)return;t.innerHTML+=o}catch(e){h.innerText=e.message,h.style.display="block"}}async function R(){const t=document.getElementById("dones-1ra-gen-content"),a=document.getElementById("dones-1ra-gen-skeleton");if(t&&a){e(a),t.innerHTML="";try{const r=await async function(){const{LEGENDARY_ITEMS:e}=window.LegendaryData||{},n=[],t=new Set;for(const a of Object.values(e)){if(!a.components)continue;const e=a.components.find(e=>{if(!e.name)return!1;const n=e.name.toLowerCase();return n.startsWith("don de")&&!n.includes("la suerte")&&!n.includes("del dominio")});e&&!t.has(e.id)&&(t.add(e.id),n.push({id:e.id,name:e.name,mainIngredients:e.components||[],manualIngredients:[]}))}return n.sort((e,n)=>e.name.localeCompare(n.name,"es")),n}(),o=document.createElement("div");o.className="don1gen-nav-btns don1gen-grid";const i=document.createElement("div");i.id="don1gen-result",r.forEach(t=>{const r=document.createElement("button");r.className="dones-btn",r.textContent=t.name,r.addEventListener("click",async()=>{o.querySelectorAll("button").forEach(e=>e.classList.remove("active")),r.classList.add("active"),i.innerHTML="",e(a),await z(t,i),n(a)}),o.appendChild(r)}),t.appendChild(o),t.appendChild(i)}catch(e){console.error("Error al renderizar dones de 1ra Gen:",e),t.innerHTML='<div class="error-message">Error al cargar los dones.</div>'}finally{n(a)}}}async function W(){const t=document.getElementById("tributo-draconico-content"),a=document.getElementById("tributo-draconico-skeleton");if(t&&a){e(a),t.innerHTML="";try{const e=await async function(){const{LEGENDARY_ITEMS_3GEN:e}=window.LegendaryData||{};for(const n of Object.values(e)){const e=n.components?.find(e=>(e.name?.toLowerCase()||"").includes("tributo dracónico"));if(e)return e}throw new Error("No se encontró el Tributo Dracónico en legendaryItems3gen")}();let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let a=0,r=0,o=!1;for(const t of e.components){const e=await Q(t,0);n+=e.html,e.hasValue||(o=!0),Number.isFinite(e.totalBuy)&&(a+=e.totalBuy),Number.isFinite(e.totalSell)&&(r+=e.totalSell)}n+="</tbody></table>";if(o||a>0||r>0){const e=H(a,o);n+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${H(r,o)}</div>\n        </div>\n      </div>`}t.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Dracónico:",e),t.innerHTML='<div class="error-message">Error al cargar el Tributo Dracónico.</div>'}finally{n(a)}}}const Y={special:!1,tributo:!1,draco:!1,gen1:!1};window.DonesPages={loadSpecialDons:async function(){Y.special||(Y.special=!0,await async function(){const t=document.getElementById("dones-content"),a=y;e(a),t.innerHTML="";const r=f.filter(e=>e.name&&e.name.toLowerCase().includes("suerte"));for(const e of r){const n=document.createElement("div");t.appendChild(n),await z(e,n)}n(a)}())},loadTributo:async function(){Y.tributo||(Y.tributo=!0,await async function(){const t=document.getElementById("tributo-content"),a=document.getElementById("tributo-skeleton");if(!t||!a)return;e(a),t.innerHTML="";try{const e=function(){const e={id:"TRIBUTO_MISTICO_ROOT",name:q.name,count:1,components:[]};return q.mainIngredients.forEach(n=>{e.components.push({...n})}),q.dons.forEach(n=>{const t=n.name.toLowerCase().includes("magia condensada")||n.name.toLowerCase().includes("poder condensado")?2:1,a={id:n.name.replace(/\s+/g,"_").toUpperCase(),name:n.name,count:t,components:[]};n.subdons.forEach(e=>{const n={id:e.name.replace(/\s+/g,"_").toUpperCase(),name:e.name,count:1,components:[]};e.ingredients.forEach(e=>{n.components.push({...e})}),a.components.push(n)}),e.components.push(a)}),e}();let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let a=0,r=0,o=!1;for(const t of e.components){const e=await Q(t,0);n+=e.html,e.hasValue||(o=!0),Number.isFinite(e.totalBuy)&&(a+=e.totalBuy),Number.isFinite(e.totalSell)&&(r+=e.totalSell)}n+="</tbody></table>";if(o||a>0||r>0){const e=H(a,o);n+=`<div class='table-modern-totales' style='margin-bottom:18px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${H(r,o)}</div>\n        </div>\n      </div>`}t.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Místico:",e),t.innerHTML='<div class="error-message">Error al cargar el Tributo Místico.</div>'}finally{n(a)}}())},loadDraconicTribute:async function(){Y.draco||(Y.draco=!0,await W())},loadDones1Gen:async function(){Y.gen1||(Y.gen1=!0,await R())}};document.dispatchEvent(new Event("donespages:ready"));const q={name:"Tributo Místico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19976,name:"Moneda mística",count:250}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]},U={name:"Tributo dracónico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:38,components:[{id:19976,name:"Moneda mística",count:38},{id:19721,name:"Pegote de ectoplasma",count:38},{id:19925,name:"Esquirla de obsidiana",count:38},{id:20796,name:"Piedra filosofal",count:228}]},{id:92687,name:"Piedra imán dracónica amalgamada",count:5}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]};async function Q(e,n=0){const{tree:t}=await O([e]),a=t[0];if(!Array.isArray(a.children)||0===a.children.length){const e=Number.isFinite(a.count)?a.count:0,n=Number.isFinite(a.buy_price)?a.buy_price:0,t=Number.isFinite(a.sell_price)?a.sell_price:0;a.total_buy=n*e,a.total_sell=t*e}const{html:r,hasNoMarket:o,hasValue:i}=x(a,n);return{html:r,totalBuy:Number.isFinite(a.total_buy)?a.total_buy:null,totalSell:Number.isFinite(a.total_sell)?a.total_sell:null,hasNoMarket:o,hasValue:i}}
