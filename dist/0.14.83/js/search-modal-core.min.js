import{F as e,b as t,G as n}from"./utils.min.js";import"./config.min.js";import"./services.min.js";const i=n();function s(e,t=!1){return{src:e,isFallback:Boolean(t)}}function o(e){if(!e)return{src:"",isFallback:!1};if("string"==typeof e)return{src:e,isFallback:!1};if("object"==typeof e){return{src:"string"==typeof e.src&&e.src?e.src:"string"==typeof e.url?e.url:"",isFallback:Boolean(e.isFallback)}}return{src:"",isFallback:!1}}function r({iconCache:t={},rarityCache:n={},requestItemsFn:o=e,logger:r=console}={}){const a=r&&"function"==typeof r.warn?r:null;return async function(e=[]){if(!Array.isArray(e)||!e.length)return[];let r;try{r=await o(e)}catch(t){if(a){const n=t&&t.message?t.message:String(t);a.warn(`[search-modal] failed to load icons for ids ${e.join(", ")}: ${n}`)}return[...e]}const l=[];return r.forEach((o,r)=>{const a=e[r];if(o&&void 0!==o.id){const e=o&&o.icon?o.icon:i,r=!(o&&o.icon);t[o.id]=s(e,r),n[o.id]=o.rarity}else void 0!==a&&l.push(a)}),l.length&&l.forEach(e=>{void 0===t[e]&&(t[e]=s(i,!0)),void 0===n[e]&&(n[e]=null)}),l.length&&a&&a.warn(`[search-modal] icons missing for ids: ${l.join(", ")}`),l}}function a({resultsEl:e=null,onSelect:t=function(){},iconCache:n={},rarityCache:i={},formatPrice:s=null,getRarityClass:r=null}={}){const a="function"==typeof r?r:()=>"";return function(r=[],l=!1){if(!e)return;if(e.innerHTML="",!r.length&&l)return void(e.innerHTML='<div class="error-message">No se encontraron ítems.</div>');const c=document.createDocumentFragment();r.forEach(e=>{const r=document.createElement("div");r.className="item-card",r.onclick=n=>t(e.id,n);const{src:l,isFallback:d}=o(n[e.id]);if(l){const e=document.createElement("img");e.src=l,e.alt=d?"Icono no disponible":"";const t=["item-icon"];d&&t.push("item-icon--placeholder"),e.className=t.join(" "),r.appendChild(e)}const u=a(i[e.id]),m=document.createElement("div");m.className=u?`item-name ${u}`:"item-name",m.textContent=e?.name_es||"",r.appendChild(m);const p=s?s(e?.buy_price):e?.buy_price||0,f=s?s(e?.sell_price):e?.sell_price||0,y=document.createElement("div");y.className="item-price",y.style.display="none",y.textContent=`Compra: ${p} | Venta: ${f}`,r.appendChild(y),c.appendChild(r)}),e.appendChild(c)}}function l(n={}){const{onSelect:i=function(e){},formatPrice:s=null,useSuggestions:o=!1}=n,l=document.getElementById("modal-search-input"),c=document.getElementById("modal-suggestions"),d=document.getElementById("modal-results"),u=document.getElementById("modal-skeleton"),m=document.getElementById("modal-error-message");let p=[];const f={},y={};function g(e){const t=Number(e);return Number.isNaN(t)?e:t}function h(e){u&&u.classList.toggle("hidden",!e)}async function _(){const e=sessionStorage.getItem("itemList");if(e)p=JSON.parse(e).map(e=>({...e,id:g(e.id)}));else{m&&(m.style.display="none");try{const[e,n]=await Promise.all([t("https://api.datawars2.ie/gw2/v1/items/json?fields=id,name_es"),t("https://api.datawars2.ie/gw2/v1/items/csv?fields=buy_price,sell_price,buy_quantity,sell_quantity,last_updated,1d_buy_sold,1d_sell_sold,2d_buy_sold,2d_sell_sold,7d_buy_sold,7d_sell_sold,1m_buy_sold,1m_sell_sold")]),[i,s]=await Promise.all([e.json(),n.text()]),o=s.trim().split("\n"),r=o[0].split(","),a=o.slice(1).map(e=>{const t=e.split(","),n={};return r.forEach((e,i)=>{n[e]="last_updated"===e?t[i]||"-":""!==t[i]?parseInt(t[i],10):null}),{...n,id:g(n.id)}}),l={};a.forEach(e=>{l[g(e.id)]=e}),p=i.map(e=>{const t=g(e.id);return{...e,id:t,...l[t]||{}}}),sessionStorage.setItem("itemList",JSON.stringify(p))}catch(e){n="No se pudieron cargar los ítems.",m&&(m.textContent=n,m.style.display="block")}var n}}const C="function"==typeof getRarityClass?getRarityClass:()=>"",b=a({resultsEl:d,onSelect:i,iconCache:f,rarityCache:y,formatPrice:s,getRarityClass:C});const v=r({iconCache:f,rarityCache:y,requestItemsFn:e,logger:console});function E(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}l&&l.addEventListener("input",function(e,t){let n;return function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)}}(async function(){const e=this.value.trim().toLowerCase();if(e.length<3)return o&&c&&(c.style.display="none"),d&&(d.innerHTML=""),void h(!1);h(!0);const t=E(e);let n=p.filter(e=>e.name_es&&E(e.name_es).includes(t));n=n.slice(0,30);const s=n.filter(e=>!f[g(e.id)]).map(e=>g(e.id));s.length&&await v(s),h(!1),function(e){if(!o)return void(c&&(c.innerHTML="",c.style.display="none"));if(!c)return;if(c.innerHTML="",!e.length)return void(c.style.display="none");const t=document.createDocumentFragment();e.forEach(e=>{const n=document.createElement("li");n.textContent=e.name_es,n.onclick=()=>i(e.id),t.appendChild(n)}),c.appendChild(t),c.style.display="block"}(n),b(n,!0)},250)),async function(){h(!0),await _(),b([]),h(!1)}()}"undefined"!=typeof window&&(window.initSearchModal=l),"undefined"!=typeof module&&module.exports&&(module.exports.initSearchModal=l,module.exports.createIconFetcher=r,module.exports.createResultRenderer=a,module.exports.normalizeIconCacheEntry=o);export{r as createIconFetcher,a as createResultRenderer,o as normalizeIconCacheEntry};
