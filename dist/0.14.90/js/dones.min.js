import{showSkeleton as e,hideSkeleton as n}from"./ui-helpers.min.js";import{c as t,j as a,p as r,b as o,a as i,k as s,t as l,r as c}from"./utils.min.js";import{g as d,p as u}from"./services.min.js";import"./config.min.js";const m=["priceMap","iconMap","rarityMap","itemMap"],p=new Map;function g(e){const n=Number(e);return Number.isFinite(n)?n:null}function b(e,n){const t=new Map;return e&&"object"==typeof e?(Object.entries(e).forEach(([e,a])=>{const r=n(e,a);r&&t.set(r.id,r)}),t):t}async function f(e,n,a={}){const r=new URLSearchParams;r.set("ids",e.join(",")),Array.isArray(a.fields)&&a.fields.length>0&&r.set("fields",a.fields.join(",")),Number.isFinite(Number(a.page))&&Number(a.page)>0&&r.set("page",Math.floor(Number(a.page))),Number.isFinite(Number(a.pageSize))&&Number(a.pageSize)>0&&r.set("pageSize",Math.floor(Number(a.pageSize)));const{url:o,options:i}=u(`/api/aggregate/bundle?${r.toString()}`,{signal:a.signal}),s=await t(o,i);if(!s.ok)throw new Error(`Error ${s.status} al consultar el agregado de bundle`);const l=s.headers?.get?.("content-type")||s.headers?.get?.("Content-Type")||"";if(!String(l).toLowerCase().includes("application/json"))throw new Error("Respuesta no válida del agregado de bundle");const c=await s.json().catch(()=>null);if(!c||"object"!=typeof c)throw new Error("Datos no válidos del agregado de bundle");return c}async function y(e=[],n={}){const t=Array.from(new Set((Array.isArray(e)?e:[e]).map(e=>g(e)).filter(e=>Number.isFinite(e)&&e>0))),a=d(),r=function(e){const n="string"==typeof e&&e?e:d();return p.has(n)||p.set(n,{items:new Map,prices:new Map,meta:null,warnings:[],errors:[],expiresAt:0}),p.get(n)}(a),o=Number.isFinite(Number(n.ttl))&&Number(n.ttl)>0?Number(n.ttl):12e4,i=Date.now(),s=!0===n.skipCache,l=new Map,c=new Map;t.forEach(e=>{r.items.has(e)&&l.set(e,r.items.get(e)),r.prices.has(e)&&c.set(e,r.prices.get(e))});const u=s||i>=r.expiresAt,y=u?t:t.filter(e=>!l.has(e)||!c.has(e));if(!s&&!u&&0===y.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:l,pricesMap:c,meta:r.meta,warnings:Array.isArray(r.warnings)?[...r.warnings]:[],errors:Array.isArray(r.errors)?[...r.errors]:[],missingIds:[]};if(0===t.length)return{ok:!0,partial:!1,fromCache:!0,itemsMap:new Map,pricesMap:new Map,meta:r.meta,warnings:Array.isArray(r.warnings)?[...r.warnings]:[],errors:Array.isArray(r.errors)?[...r.errors]:[],missingIds:[]};const h=u?t:y,w=Array.isArray(n.fields)&&n.fields.length>0?n.fields:m,E=Number.isFinite(Number(n.pageSize))&&Number(n.pageSize)>0?Math.floor(Number(n.pageSize)):50,N=[];let _=1,M=1;do{const e=await f(h,0,{signal:n.signal,page:_,pageSize:E,fields:w});N.push(e);const t=e?.meta?.pagination||null;if(t&&Number.isFinite(Number(t.totalPages))&&(M=Math.max(1,Number(t.totalPages))),!t||!t.hasNext)break;const a=Number.isFinite(Number(t.page))?Number(t.page)+1:_+1;if(a<=_||a>M)break;_=a}while(_<=M);const v={},A={},T={},I={},F=[],C=new Set;let k=null;N.forEach(e=>{if(!e||"object"!=typeof e)return;e.priceMap&&"object"==typeof e.priceMap&&Object.assign(v,e.priceMap),e.iconMap&&"object"==typeof e.iconMap&&Object.assign(A,e.iconMap),e.rarityMap&&"object"==typeof e.rarityMap&&Object.assign(T,e.rarityMap),e.itemMap&&"object"==typeof e.itemMap&&Object.assign(I,e.itemMap),Array.isArray(e.errors)?e.errors.forEach(e=>F.push(e)):e.errors&&F.push(e.errors);const n=e.meta||null;n&&(k=n,Array.isArray(n.warnings)&&n.warnings.filter(Boolean).forEach(e=>C.add(e)))});const S={priceMap:v,iconMap:A,rarityMap:T,itemMap:I,meta:k||null,errors:F};S.meta&&C.size>0&&(S.meta={...S.meta,warnings:Array.from(C)});const D=b(S.iconMap,(e,n)=>{const t=g(e);return t?{id:t,icon:n??null}:null}),L=b(S.rarityMap,(e,n)=>{const t=g(e);return t?{id:t,rarity:n??null}:null}),j=b(S.itemMap,(e,n)=>function(e,n,t,a){const r=g(e);if(!r)return null;const o=n&&"object"==typeof n?n:{},i=t?.get(r)??null,s=a?.get(r)??null;return{id:r,name:"string"==typeof o.name?o.name:null,icon:o.icon??i?.icon??null,rarity:o.rarity??s?.rarity??null,type:"string"==typeof o.type?o.type:null}}(e,n,D,L));0===j.size&&h.forEach(e=>{const n=D.get(e)??null,t=L.get(e)??null;(n||t)&&j.set(e,{id:e,name:null,icon:n?.icon??null,rarity:t?.rarity??null,type:null})});const V=b(S.priceMap,(e,n)=>function(e,n){const t=g(e);if(!t)return null;const a=n&&"object"==typeof n?n:{},r=e=>{if(null==e)return null;const n=Number(e);return Number.isFinite(n)&&n>=0?n:null},o=r(a.buy_price??a.buyPrice??a.buy),i=r(a.sell_price??a.sellPrice??a.sell);return null==o&&null==i?{id:t,buy_price:null,sell_price:null}:{id:t,buy_price:o,sell_price:i}}(e,n));u&&h.forEach(e=>{r.items.delete(e),r.prices.delete(e)});const P=u?new Map:new Map(l);j.forEach((e,n)=>{P.set(n,e),r.items.set(n,e)});const B=u?new Map:new Map(c);V.forEach((e,n)=>{B.set(n,e),r.prices.set(n,e)});const $=S.meta||null,G=Array.isArray($?.warnings)?[...$.warnings]:[],O=[];Array.isArray(S.errors)?O.push(...S.errors):S.errors&&O.push(S.errors),r.meta=$,r.warnings=G,r.errors=O,r.expiresAt=i+o;const x=h.filter(e=>!j.has(e)||!V.has(e)),H=Array.from(new Set([...x,...t.filter(e=>!P.has(e)||!B.has(e))]));return{ok:0===H.length&&0===O.length,partial:H.length>0||O.length>0,fromCache:!1,itemsMap:P,pricesMap:B,meta:$,warnings:G,errors:O,missingIds:H}}var h=[{id:19673,name:"Don de la Magia",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19721,name:"Pegote de ectoplasma",count:250}],manualIngredients:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",manualIngredients:[{id:24357,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24351,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]},{id:19626,name:"Don de la Suerte",mainIngredients:[{id:19721,name:"Pegote de ectoplasma",count:250},{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19673,name:"Don de la Magia",type:"crafting_material",count:1,components:[{id:24295,name:"Vial de sangre poderosa",count:250},{id:24283,name:"Vesícula de veneno poderoso",count:250},{id:24300,name:"Tótem elaborado",count:250},{id:24277,name:"Montón de polvo cristalino",count:250}]},{id:19672,name:"Don del Poder",type:"crafting_material",count:1,components:[{id:24351,name:"Colmillo feroz",count:250},{id:24289,name:"Escama blindada",count:250},{id:24357,name:"Garra despiadada",count:250},{id:24358,name:"Hueso antiguo",count:250}]}]}];document.getElementById("dones-content");const w=document.getElementById("dones-skeleton"),E=document.getElementById("error-message");window.showSkeleton=e,window.hideSkeleton=n;const N={19676:1e4},_="sin precio",M=`${_} (fuera del mercado)`,v=`${_} (vinculado a cuenta)`,A=new Map([[19675,"account"],[19925,"market"],[20796,"market"],[19633,"market"],[19634,"market"],[19641,"market"],[19642,"market"],[19628,"market"],[20799,"account"]]),T=(e="")=>{if(!e)return!1;const n=e.toLowerCase();return n.startsWith("don de ")||n.startsWith("don del ")||n.startsWith("don de la ")},I=e=>{if("string"!=typeof e||!e)return!1;if((()=>{const{isGiftName:e}=window?.DonesCore||{};return"function"==typeof e?e:T})()(e))return!0;const n=e.toLowerCase();return n.includes("tributo")||n.includes("bendición")};let F=null,C=!1;const k={promise:null,expiresAt:0,payload:{items:new Map,prices:new Map},pendingExtraIds:new Set};let S=null;function D(e){const n=Number(e);return Number.isFinite(n)?(S||function(){S=new Map;const e=window.LegendaryData;if(!e)return;const n=new Set,t=e=>{if(!e||n.has(e))return;n.add(e);const a=Number(e.id);Number.isFinite(a)&&!S.has(a)&&S.set(a,{id:a,name:e.name||null,icon:e.icon||null,rarity:e.rarity||null,type:e.type||null}),Array.isArray(e.components)&&e.components.forEach(t)},a=e=>{e&&Object.values(e).forEach(e=>t(e))};a(e.LEGENDARY_ITEMS),a(e.LEGENDARY_ITEMS_3GEN)}(),S?.get(n)||null):null}function L(e,n=new Set){if(!e)return n;if(!(n&&n instanceof Set))return L(e,new Set);if(Array.isArray(e))return e.forEach(e=>L(e,n)),n;if("object"==typeof e){if(Object.prototype.hasOwnProperty.call(e,"id")){const t=Number(e.id);Number.isFinite(t)&&n.add(t)}Object.values(e).forEach(e=>L(e,n))}return n}function j(){const e=new Set;return L(h,e),L(Q,e),L(J,e),function(e){const n=window.LegendaryData;if(!n)return;const t=new Set;var a;(a=n.LEGENDARY_ITEMS)&&Object.values(a).forEach(n=>{n&&Array.isArray(n.components)&&n.components.forEach(n=>{if(!n||!n.name)return;const a=n.name.toLowerCase();if(!a.startsWith("don de")||a.includes("la suerte")||a.includes("del dominio"))return;const r=Number(n.id);Number.isFinite(r)&&!t.has(r)&&(t.add(r),L(n,e))})})}(e),e}function V(e,n=null){const t=Number(e);if(!Number.isFinite(t))return null;const a=D(t),r=n?.name??n?.localized_name??n?.display_name??null,o=n?.icon??null,i={id:t,name:a?.name??r??null,icon:a?.icon??o??null,rarity:a?.rarity??n?.rarity??null,type:a?.type??n?.type??null};return null==i.name&&null==i.icon&&null==i.rarity&&null==i.type?null:i}function P(e){const n={};return e&&e instanceof Map?(e.forEach((e,t)=>{n[t]=e}),n):n}function B(e){const n=Number(e);if(!Number.isFinite(n))return null;const t=k.payload;if(t?.items instanceof Map&&t.items.has(n))return t.items.get(n);const a=i(`item_${n}`);if(a){const e=V(n,a);return e&&t?.items instanceof Map&&t.items.set(n,e),e}const r=V(n,null);return r&&t?.items instanceof Map&&t.items.set(n,r),r}async function $(e=[]){const n=Date.now(),t=Array.isArray(e)&&e.length>0,s=k.payload,c=s?.items instanceof Map?s.items:null,d=s?.prices instanceof Map?s.prices:null,u=Boolean(c&&d),m=t?L(e,new Set):new Set,p=new Set;m.size>0&&m.forEach(e=>{const n=Number(e);Number.isFinite(n)&&(u&&c.has(n)&&d.has(n)||p.add(n))});const g=n>=k.expiresAt||!u||p.size>0;if(!g&&s)return s;if(k.pendingExtraIds instanceof Set||(k.pendingExtraIds=new Set),m.size>0){(g?m:p).forEach(e=>{Number.isFinite(e)&&k.pendingExtraIds.add(Number(e))})}return k.promise?k.promise.then(()=>$(e)):(k.promise=(async()=>{const e=j();k.pendingExtraIds instanceof Set&&(k.pendingExtraIds.forEach(n=>e.add(n)),k.pendingExtraIds.clear());const t=Array.from(e),s=window.RecipeService||{},c=new Map,d=e=>(c.has(e)||c.set(e,{id:e,item:null,market:null}),c.get(e)),u=a("donesAggregate"),m={meta:null,errors:[],warnings:[],missingIds:[],used:!1,fromCache:!1};let p=null;if(u)try{const e=await y(t);m.used=!0,m.meta=e?.meta||null,m.errors=Array.isArray(e?.errors)?[...e.errors]:[],m.warnings=Array.isArray(e?.warnings)?[...e.warnings]:[],m.missingIds=Array.isArray(e?.missingIds)?e.missingIds.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],m.fromCache=Boolean(e?.fromCache),e?.itemsMap instanceof Map&&e.itemsMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;d(t).item=e}),e?.pricesMap instanceof Map&&e.pricesMap.forEach((e,n)=>{const t=Number(n);if(!Number.isFinite(t))return;const a=d(t);a.market={...a.market||{},buy_price:e?.buy_price??null,sell_price:e?.sell_price??null}})}catch(e){p=e,console.error("Error al precargar datos del agregado de dones",e)}u&&m.warnings.length&&!m.fromCache&&console.warn("Advertencias del agregado de dones",m.warnings);const g=G(),b=new Set;let f=u?null:"flag-disabled";u?p?(f="aggregate-error",t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&b.add(n)})):(t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null;t?.item||b.add(n);if(!(Object.prototype.hasOwnProperty.call(N,n)||g.has(n))){const e=t?.market||null;Boolean(e&&(null!=e.buy_price&&Number.isFinite(Number(e.buy_price))||null!=e.sell_price&&Number.isFinite(Number(e.sell_price))||null!=e.buys?.unit_price||null!=e.sells?.unit_price))||b.add(n)}}),m.missingIds.forEach(e=>b.add(e)),b.size>0&&m.missingIds.length>0&&(f="missing-data"),!f&&m.errors.length>0&&(f="aggregate-errors")):t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&b.add(n)});const h=Array.from(b);if(h.length>0){!function(e,n=null,t=null,a={}){if("undefined"==typeof window||!window)return null;Array.isArray(window.__donesAggregateFallbacks__)||(window.__donesAggregateFallbacks__=[]);const r=(Array.isArray(a?.ids)?a.ids:[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)),o=Array.isArray(a?.errors)?a.errors.map(e=>"string"==typeof e?e:String(e||"")):void 0,i={reason:e,meta:n?{...n}:null,stale:Boolean(n?.stale),ids:r,errors:o,error:t?String(t?.message||t):void 0,timestamp:(new Date).toISOString()};window.__donesAggregateFallbacks__.push(i),window.__donesAggregateFallbacks__.length>50&&window.__donesAggregateFallbacks__.shift(),window.__lastDonesAggregateFallback__=i;try{l?.({type:"donesAggregateFallback",meta:{reason:i.reason,stale:i.stale,missing:r.length},error:i.error})}catch(e){console.warn("No se pudo registrar telemetría de fallback de dones",e)}}(f||(p?"aggregate-error":"legacy-required"),m.meta,p,{ids:h,errors:m.errors})}if(h.length>0)if("function"==typeof s.getItemBundles)try{const e=await s.getItemBundles(h);h.forEach((n,t)=>{const a=Number(n);if(!Number.isFinite(a))return;const r=Array.isArray(e)?e[t]:null;if(!r)return;const o=d(a);r.item&&(o.item=r.item),r.market&&(o.market=o.market?{...r.market,...o.market}:r.market)})}catch(e){console.error("Error al precargar bundles de dones",e)}else{const[e=[],n=[]]=await Promise.all(["function"==typeof s.getItemDetails?s.getItemDetails(h):Promise.resolve([]),"function"==typeof s.getItemPrices?s.getItemPrices(h):Promise.resolve([])]).catch(e=>(console.error("Error al precargar datos de dones",e),[[],[]]));h.forEach((t,a)=>{const r=Number(t);if(!Number.isFinite(r))return;const o=Array.isArray(e)?e[a]:null,i=Array.isArray(n)?n[a]:null,s=i?{buy_price:i?.buys?.unit_price??null,sell_price:i?.sells?.unit_price??null}:null,l=d(r);o&&(l.item=o),s&&(l.market=l.market?{...s,...l.market}:s)})}t.forEach(e=>{const n=Number(e);Number.isFinite(n)&&d(n)});const w=[];t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null;if(Object.prototype.hasOwnProperty.call(N,n)||g.has(n))return;const a=t?.market||null;Boolean(a&&(null!=a.buy_price&&Number.isFinite(Number(a.buy_price))||null!=a.sell_price&&Number.isFinite(Number(a.sell_price))||null!=a.buys?.unit_price||null!=a.sells?.unit_price))||w.push(n)});let E=new Map;if(w.length>0)try{E=await r(w)}catch(e){console.error("Error al precargar precios de dones",e),E=new Map}const _=new Map,M=new Map;return t.forEach(e=>{const n=Number(e);if(!Number.isFinite(n))return;const t=c.get(n)||null,a=V(n,t?.item||null);if(a)_.set(n,a),o(`item_${n}`,a,6e5);else{const e=i(`item_${n}`);if(e){const t=V(n,e);t&&_.set(n,t)}}const r=E.get(n)||null;let s=r?.buy_price??null,l=r?.sell_price??null;const d=t?.market||null;if(d&&(null==s&&null!=d.buy_price&&(s=d.buy_price),null==s&&null!=d.buys?.unit_price&&(s=d.buys.unit_price),null==l&&null!=d.sell_price&&(l=d.sell_price),null==l&&null!=d.sells?.unit_price&&(l=d.sells.unit_price)),Object.prototype.hasOwnProperty.call(N,n)){const e=N[n];s=e,l=e}M.set(n,{buy_price:null!=s?s:null,sell_price:null!=l?l:null})}),t.forEach(e=>{const n=Number(e);if(Number.isFinite(n)){if(!_.has(n)){const e=V(n,null);e&&_.set(n,e)}if(!M.has(n))if(Object.prototype.hasOwnProperty.call(N,n)){const e=N[n];M.set(n,{buy_price:e,sell_price:e})}else M.set(n,{buy_price:null,sell_price:null})}}),k.payload={items:_,prices:M},k.expiresAt=n+216e5,k.payload})().catch(e=>(console.error("Error general al precargar datos de dones",e),k.payload)).finally(()=>{k.promise=null}),k.promise)}function G(){return F||(F=new Map(A)),C||(C=function(e){const n=window.LegendaryData;if(!n)return!1;const{LEGENDARY_ITEMS:t,LEGENDARY_ITEMS_3GEN:a}=n;if(!t&&!a)return!1;const r=new Set,o=n=>{if(!n)return;const t=Number(n.id);if(Number.isFinite(t)){if(r.has(t))return;r.add(t),I(n.name)&&e.set(t,"gift")}Array.isArray(n.components)&&n.components.forEach(o)},i=e=>{e&&Object.values(e).forEach(e=>{e&&Array.isArray(e.components)&&e.components.forEach(o)})};return i(t),i(a),!0}(F)),F}let O=null;function x(e){if(!e||"object"!=typeof e)return;const n=Number(e.id);if(Number.isFinite(n)){const t=B(n);t&&(e.name=t.name??e.name,e.icon=t.icon??e.icon,e.rarity=t.rarity??e.rarity,e.type=t.type??e.type);const a=function(e){const n=Number(e);if(!Number.isFinite(n))return null;if(Object.prototype.hasOwnProperty.call(N,n)){const e=N[n];return{buy_price:e,sell_price:e}}const t=k.payload;return t?.prices instanceof Map&&t.prices.has(n)?t.prices.get(n):null}(n);a&&(null==e.buy_price&&null!=a.buy_price&&(e.buy_price=a.buy_price),null==e.sell_price&&null!=a.sell_price&&(e.sell_price=a.sell_price))}Array.isArray(e.children)&&e.children.forEach(e=>x(e))}async function H(e){const{ingredientTree:n}=await async function(e){const n=await $(e);O||(O=new Worker(new URL("./workers/donesWorker.js",import.meta.url),{type:"module"}));const t={rootIngredients:e,skipEntries:Array.from(G().entries()),preloadedItems:P(n?.items),preloadedPrices:P(n?.prices)};return new Promise((e,n)=>{const a=n=>{O.removeEventListener("message",a),O.removeEventListener("error",r),e(n.data)},r=e=>{O.removeEventListener("message",a),O.removeEventListener("error",r),n(e)};O.addEventListener("message",a),O.addEventListener("error",r),O.postMessage(t)})}(e),t=Array.isArray(n)?n:[];t.forEach(e=>x(e));const{updatedTree:a,totals:r}=await function(e,n){return c({ingredientTree:e,globalQty:n})}(t,1);return s(a,null),{tree:a,totals:r}}function z(e,n=0){const t=n>0?`padding-left:${32*n}px;`:"",a=function(e,n,t){const a=Number(e),r=G();if(!Number.isFinite(a))return{skip:!0,reason:"synthetic",label:M};if(r.has(a)){const e=r.get(a);return{skip:!0,reason:e,label:"account"===e?v:M}}return I(n)?(r.set(a,"gift"),{skip:!0,reason:"gift",label:M}):("string"==typeof t?t.toLowerCase():"").includes("account")?(r.set(a,"account"),{skip:!0,reason:"account",label:v}):{skip:!1,reason:null,label:null}}(e.id,e.name,e.type),r=a.skip,o=a.label||M,i=Number.isFinite(e.buy_price)&&e.buy_price>0,s=Number.isFinite(e.sell_price)&&e.sell_price>0,l=Number.isFinite(e.total_buy)&&e.total_buy>0,c=Number.isFinite(e.total_sell)&&e.total_sell>0,d=!r&&(i||s)||l||c,u=r?o:i?formatGoldColored(e.buy_price):"-",m=r?o:s?formatGoldColored(e.sell_price):"-",p=l?formatGoldColored(e.total_buy):"-",g=c?formatGoldColored(e.total_sell):"-";let b=`<tr>\n    <td style='${t}'>${e.icon?`<img src='${e.icon}' style='height:28px;'>`:"-"}</td>\n    <td>${e.name}</td>\n    <td>${Math.round(e.count)}</td>\n    <td>${u}</td>\n    <td>${m}</td>\n    <td>${p}</td>\n    <td>${g}</td>\n  </tr>`,f=!1;if(Array.isArray(e.children))for(const t of e.children){const e=z(t,n+1);b+=e.html,e.hasValue&&(f=!0)}const y=d||f;return{html:b,hasNoMarket:!y,hasValue:y,childContributedValue:f}}function R(e,n){return n?"<span class='total-sin-precio'>Sin precio (faltan componentes valorados)</span>":Number.isFinite(e)&&e>0?formatGoldColored(e):"-"}async function W(e,n){const t=n||document.getElementById("dones-content");t.innerHTML="",E.style.display="none";try{await $([e]);const n=B(e.id);let a=n?.name||e.name,r=n?.icon||null;if(!r){const n=e.manualIngredients&&e.manualIngredients[0]||e.mainIngredients&&e.mainIngredients[0]||null;if(n){await $([n]);const e=B(n.id);e?.icon&&(r=e.icon)}}let o="";const i=e.name?e.name.toLowerCase():"",s=i.includes("suerte")||i.includes("magia")||i.includes("poder");if(s){if(e.mainIngredients&&e.mainIngredients.length>0){o+="<table class='table-modern-dones tabla-tarjetas'>\n          <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,t=0,a=!1;for(const r of e.mainIngredients){const e=await K(r,0);o+=e.html,e.hasValue||(a=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(t+=e.totalSell)}if(o+="</tbody></table>",a||n>0||t>0){const e=R(n,a);o+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n            <div class='precio-totales-dones'>\n              <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n              <div class='total-dones'><b>Total Venta estimado:</b> ${R(t,a)}</div>\n            </div>\n          </div>`}}return void(t.innerHTML+=o)}if(s||(o+=`<h2 style='margin-top:18px;'><img src='${r}' style='height:32px;vertical-align:middle;'> ${a}</h2>`),e.mainIngredients&&e.mainIngredients.length>0){o+="<table class='table-modern-dones tabla-tarjetas'>\n        <thead class='header-items'><tr><th>Ícono</th><th>Nombre</th><th>Cantidad</th><th>Precio Compra (u)</th><th>Precio Venta (u)</th><th>Total Compra</th><th>Total Venta</th></tr></thead><tbody>";let n=0,t=0,a=!1;for(const r of e.mainIngredients){const e=await K(r,0);o+=e.html,e.hasValue||(a=!0),Number.isFinite(e.totalBuy)&&(n+=e.totalBuy),Number.isFinite(e.totalSell)&&(t+=e.totalSell)}if(o+="</tbody></table>",a||n>0||t>0){const e=R(n,a);o+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n          <div class='precio-totales-dones'>\n            <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n            <div class='total-dones'><b>Total Venta estimado:</b> ${R(t,a)}</div>\n          </div>\n        </div>`}}if(s)return;t.innerHTML+=o}catch(e){E.innerText=e.message,E.style.display="block"}}async function Y(){const t=document.getElementById("dones-1ra-gen-content"),a=document.getElementById("dones-1ra-gen-skeleton");if(t&&a){e(a),t.innerHTML="";try{const r=await async function(){const{LEGENDARY_ITEMS:e}=window.LegendaryData||{},n=[],t=new Set;for(const a of Object.values(e)){if(!a.components)continue;const e=a.components.find(e=>{if(!e.name)return!1;const n=e.name.toLowerCase();return n.startsWith("don de")&&!n.includes("la suerte")&&!n.includes("del dominio")});e&&!t.has(e.id)&&(t.add(e.id),n.push({id:e.id,name:e.name,mainIngredients:e.components||[],manualIngredients:[]}))}return n.sort((e,n)=>e.name.localeCompare(n.name,"es")),n}(),o=document.createElement("div");o.className="don1gen-nav-btns don1gen-grid";const i=document.createElement("div");i.id="don1gen-result",r.forEach(t=>{const r=document.createElement("button");r.className="dones-btn",r.textContent=t.name,r.addEventListener("click",async()=>{o.querySelectorAll("button").forEach(e=>e.classList.remove("active")),r.classList.add("active"),i.innerHTML="",e(a),await W(t,i),n(a)}),o.appendChild(r)}),t.appendChild(o),t.appendChild(i)}catch(e){console.error("Error al renderizar dones de 1ra Gen:",e),t.innerHTML='<div class="error-message">Error al cargar los dones.</div>'}finally{n(a)}}}async function q(){const t=document.getElementById("tributo-draconico-content"),a=document.getElementById("tributo-draconico-skeleton");if(t&&a){e(a),t.innerHTML="";try{const e=await async function(){const{LEGENDARY_ITEMS_3GEN:e}=window.LegendaryData||{};for(const n of Object.values(e)){const e=n.components?.find(e=>(e.name?.toLowerCase()||"").includes("tributo dracónico"));if(e)return e}throw new Error("No se encontró el Tributo Dracónico en legendaryItems3gen")}();let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let a=0,r=0,o=!1;for(const t of e.components){const e=await K(t,0);n+=e.html,e.hasValue||(o=!0),Number.isFinite(e.totalBuy)&&(a+=e.totalBuy),Number.isFinite(e.totalSell)&&(r+=e.totalSell)}n+="</tbody></table>";if(o||a>0||r>0){const e=R(a,o);n+=`<div class='table-modern-totales' style='margin-bottom:50px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${R(r,o)}</div>\n        </div>\n      </div>`}t.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Dracónico:",e),t.innerHTML='<div class="error-message">Error al cargar el Tributo Dracónico.</div>'}finally{n(a)}}}const U={special:!1,tributo:!1,draco:!1,gen1:!1};window.DonesPages={loadSpecialDons:async function(){U.special||(U.special=!0,await async function(){const t=document.getElementById("dones-content"),a=w;e(a),t.innerHTML="";const r=h.filter(e=>e.name&&e.name.toLowerCase().includes("suerte"));for(const e of r){const n=document.createElement("div");t.appendChild(n),await W(e,n)}n(a)}())},loadTributo:async function(){U.tributo||(U.tributo=!0,await async function(){const t=document.getElementById("tributo-content"),a=document.getElementById("tributo-skeleton");if(!t||!a)return;e(a),t.innerHTML="";try{const e=function(){const e={id:"TRIBUTO_MISTICO_ROOT",name:Q.name,count:1,components:[]};return Q.mainIngredients.forEach(n=>{e.components.push({...n})}),Q.dons.forEach(n=>{const t=n.name.toLowerCase().includes("magia condensada")||n.name.toLowerCase().includes("poder condensado")?2:1,a={id:n.name.replace(/\s+/g,"_").toUpperCase(),name:n.name,count:t,components:[]};n.subdons.forEach(e=>{const n={id:e.name.replace(/\s+/g,"_").toUpperCase(),name:e.name,count:1,components:[]};e.ingredients.forEach(e=>{n.components.push({...e})}),a.components.push(n)}),e.components.push(a)}),e}();let n=`<h2>${e.name}</h2>`;n+="<table class='table-modern-dones tabla-tarjetas'>\n      <thead class='header-items'>\n        <tr>\n          <th>Ícono</th>\n          <th>Nombre</th>\n          <th>Cantidad</th>\n          <th>Precio Compra (u)</th>\n          <th>Precio Venta (u)</th>\n          <th>Total Compra</th>\n          <th>Total Venta</th>\n        </tr>\n      </thead>\n      <tbody>";let a=0,r=0,o=!1;for(const t of e.components){const e=await K(t,0);n+=e.html,e.hasValue||(o=!0),Number.isFinite(e.totalBuy)&&(a+=e.totalBuy),Number.isFinite(e.totalSell)&&(r+=e.totalSell)}n+="</tbody></table>";if(o||a>0||r>0){const e=R(a,o);n+=`<div class='table-modern-totales' style='margin-bottom:18px;'>\n        <div class='precio-totales-dones'>\n          <div class='total-dones'><b>Total Compra estimado:</b> ${e}</div>\n          <div class='total-dones'><b>Total Venta estimado:</b> ${R(r,o)}</div>\n        </div>\n      </div>`}t.innerHTML=n}catch(e){console.error("Error al renderizar Tributo Místico:",e),t.innerHTML='<div class="error-message">Error al cargar el Tributo Místico.</div>'}finally{n(a)}}())},loadDraconicTribute:async function(){U.draco||(U.draco=!0,await q())},loadDones1Gen:async function(){U.gen1||(U.gen1=!0,await Y())}};const Q={name:"Tributo Místico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:77,components:[{id:19976,name:"Moneda mística",count:250},{id:19721,name:"Pegote de ectoplasma",count:250},{id:19925,name:"Esquirla de obsidiana",count:250},{id:20796,name:"Piedra filosofal",count:1500}]},{id:19976,name:"Moneda mística",count:250}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]},J={name:"Tributo dracónico",mainIngredients:[{id:19675,name:"Trébol místico",type:"account_bound",count:38,components:[{id:19976,name:"Moneda mística",count:38},{id:19721,name:"Pegote de ectoplasma",count:38},{id:19925,name:"Esquirla de obsidiana",count:38},{id:20796,name:"Piedra filosofal",count:228}]},{id:92687,name:"Piedra imán dracónica amalgamada",count:5}],dons:[{name:"Don de magia condensada",subdons:[{name:"Don de sangre",ingredients:[{id:24295,name:"Vial de sangre poderosa",count:100},{id:24294,name:"Vial de sangre potente",count:250},{id:24293,name:"Vial de sangre espesa",count:50},{id:24292,name:"Vial de sangre",count:50}]},{name:"Don de veneno",ingredients:[{id:24283,name:"Vesícula de veneno poderoso",count:100},{id:24282,name:"Vesícula de veneno potente",count:250},{id:24281,name:"Vesícula de veneno llena",count:50},{id:24280,name:"Vesícula de veneno",count:50}]},{name:"Don de tótems",ingredients:[{id:24300,name:"Tótem elaborado",count:100},{id:24299,name:"Tótem intrincado",count:250},{id:24298,name:"Tótem grabado",count:50},{id:24297,name:"Tótem",count:50}]},{name:"Don de polvo",ingredients:[{id:24277,name:"Montón de polvo cristalino",count:100},{id:24276,name:"Montón de polvo incandescente",count:250},{id:24275,name:"Montón de polvo luminoso",count:50},{id:24274,name:"Montón de polvo radiante",count:50}]}]},{name:"Don de poder condensado",subdons:[{name:"Don de garras",ingredients:[{id:24351,name:"Garra despiadada",count:100},{id:24350,name:"Garra grande",count:250},{id:24349,name:"Garra afilada",count:50},{id:24348,name:"Garra",count:50}]},{name:"Don de escamas",ingredients:[{id:24289,name:"Escama blindada",count:100},{id:24288,name:"Escama grande",count:250},{id:24287,name:"Escama suave",count:50},{id:24286,name:"Escama",count:50}]},{name:"Don de huesos",ingredients:[{id:24358,name:"Hueso antiguo",count:100},{id:24341,name:"Hueso grande",count:250},{id:24345,name:"Hueso pesado",count:50},{id:24344,name:"Hueso",count:50}]},{name:"Don de colmillos",ingredients:[{id:24357,name:"Colmillo feroz",count:100},{id:24356,name:"Colmillo grande",count:250},{id:24355,name:"Colmillo afilado",count:50},{id:24354,name:"Colmillo",count:50}]}]}]};async function K(e,n=0){const{tree:t}=await H([e]),a=t[0];if(!Array.isArray(a.children)||0===a.children.length){const e=Number.isFinite(a.count)?a.count:0,n=Number.isFinite(a.buy_price)?a.buy_price:0,t=Number.isFinite(a.sell_price)?a.sell_price:0;a.total_buy=n*e,a.total_sell=t*e}const{html:r,hasNoMarket:o,hasValue:i}=z(a,n);return{html:r,totalBuy:Number.isFinite(a.total_buy)?a.total_buy:null,totalSell:Number.isFinite(a.total_sell)?a.total_sell:null,hasNoMarket:o,hasValue:i}}
