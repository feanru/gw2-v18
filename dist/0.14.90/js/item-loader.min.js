import{j as e,w as t,x as r,y as n,z as a,t as o,A as i,B as l,d as s,C as c,E as d,s as u,c as w}from"./utils.min.js";import{g as m}from"./config.min.js";import{d as g,e as p,a as f,f as y,h as b,t as _,i as h,m as k}from"./services.min.js";const E=e=>null!=e&&"object"==typeof e&&!Array.isArray(e);let A,S,I,R,T,P,v,j,B,F,C;const O="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0;let U;async function D(){return U||(U=Promise.all([import("./items-core.min.js"),import("./utils.min.js").then(function(e){return e.a1}),import("./services.min.js").then(function(e){return e.r}),import("./utils.min.js").then(function(e){return e.a3})]).then(([e,t,r,n])=>{({prepareIngredientTreeData:A,CraftIngredient:S,setIngredientObjs:I,setTotalsFromAggregate:R,findIngredientsById:T,cancelItemRequests:P,recalcAll:v}=e),({preloadPrices:F,getPrice:C}=t),({getItemBundles:j}=r),({update:B}=n),"undefined"==typeof window||window.RecipeService||console.error("Servicios de recetas no disponibles: window.RecipeService no está definido.")})),U}let L=0,N=null,$=null;function H(){if(N){try{N()}catch(e){console.warn("Error deteniendo actualizador de precios",e)}N=null}}async function M(e){if(!Array.isArray(e)||0===e.length)return[];await D();try{return await j(e)}catch(e){return console.error("Error cargando ítems",e),[]}}function q(e,t="api-response"){if(!e||"object"!=typeof e)return;const r=e.canaryAssignments??e.canaryAssignment??null;if(r)try{u(r,{source:t})}catch(e){"undefined"!=typeof console&&console&&"function"==typeof console.warn&&console.warn("No se pudieron sincronizar las asignaciones canary desde el backend",e)}}async function x(e,t,s,c={}){r(),window.hideError?.();let u=!1;const{bucket:w=null}=c||{},m=()=>n(),g=m();let p=null;const y=N;let b=!1;const h=()=>{if(!b&&(b=!0,y)){try{y()}catch(e){console.warn("Error deteniendo actualizador previo",e)}N===y&&(N=null)}},k=async(r,n,a)=>{if(u)return;u=!0;const i=n?.stale??p?.stale??null;h(),H(),function(e,t=null,r=null,n=null){const a={reason:e||"unknown",meta:t?{...t}:null,stale:Boolean(t?.stale),error:r?String(r?.message||r):void 0,timestamp:(new Date).toISOString()};if("function"==typeof B)try{B("aggregate-fallback",a)}catch(e){console.warn("No se pudo registrar el fallback en el estado",e)}O&&(Array.isArray(O.__aggregateFallbacks__)||(O.__aggregateFallbacks__=[]),O.__aggregateFallbacks__.push(a),O.__lastAggregateFallback__=a),o({type:"aggregateFallback",bucket:n,meta:{stale:a.stale,reason:a.reason},error:a.error})}(r,n,a,w),await z(e,t,s,{bucket:w,fromFallback:!0,fallbackReason:r,stale:i})};try{window.showSkeleton?.(t),$=new AbortController;const r=function(){const e=O?.__TEST_FETCH_ITEM_AGGREGATE__;return"function"==typeof e?e:d}(),n=await r(e,{signal:$.signal}),c=n?.model||_({data:n?.data,meta:n?.meta});if(304===n?.status&&n.fromCache)return p=c?.meta||n?.meta||null,q(p,"aggregate-cache"),window.hideSkeleton?.(t),a(c?.meta),void o({type:"aggregateNotModified",bucket:w,meta:{stale:c?.meta?.stale??null}});h(),H();const{item:u,market:y,tree:b,meta:E,prices:A}=c;if(p=E||null,q(E,"aggregate"),s!==L)return;if(!u)return void await k("missing-item",E);if((Array.isArray(E?.errors)?E.errors.filter(Boolean):[]).length)return void await k("meta-errors",E);const S=i(b);I(S?[S]:[]);const T=A?.hasData?A:f(y);R({buy:T?.totals?.buy??y?.buy??null,sell:T?.totals?.sell??y?.sell??null,crafted:T?.totals?.crafted??y?.crafted??null});const P=T?.unit?.buy??S?.buy_price??0,v=T?.unit?.sell??S?.sell_price??0;window._mainBuyPrice=P||0,window._mainSellPrice=v||0,window._mainRecipeOutputCount=S?.recipe?.output_item_count||S?.output||1,await window.initItemUI(u,{buy_price:window._mainBuyPrice,sell_price:window._mainSellPrice}),await(window.safeRenderTable?.()),window.hideSkeleton?.(t),a(E);const j=m()-g;l({bucket:w,stale:E?.stale??null,duration:j}),o({type:"aggregateSuccess",bucket:w,metrics:{durationMs:j},meta:{stale:E?.stale??null}})}catch(e){if("AbortError"===e?.name)return;if(h(),window.hideSkeleton?.(t),console.error("Error cargando agregado de ítem",e),window.showError?.("No se pudo cargar el agregado del ítem."),r(),s!==L)return;o({type:"aggregateError",bucket:w,meta:{stale:p?.stale??null},error:String(e?.message||e)}),await k("aggregate-error",p,e)}}async function z(e,t,n,a={}){await D(),r(),window.hideError?.();let i=null,l=null;const d=function(){const e=O?.__TEST_FETCH_WITH_RETRY__;return"function"==typeof e?e:w}(),{bucket:u=null,fromFallback:_=!1,fallbackReason:R=null,stale:P=null}=a||{};o({type:"legacyLoadStart",bucket:u,meta:{fromFallback:Boolean(_),fallbackReason:R,aggregateStale:P}});try{window.showSkeleton?.(t),$=new AbortController;const{API_BASE_URL:r,FEATURE_ITEM_API_ROLLOUT:a}=m(),w=Boolean(a);let P=null,v=null;if(w){const t=function(e,t){const r=("string"==typeof e?e.trim():"").replace(/\/+$/,"");return`${r?`${r}/items`:"/items"}/${String(t).trim()}`}(r,e);try{const e=await d(t,{signal:$.signal});if(404===e.status)console.warn("Item API devolvió 404, usando fallback PHP");else{if(!e.ok)throw new Error(`Error ${e.status} obteniendo detalles del ítem desde API`);{const t=e.headers.get("content-type")||"";if(!t.includes("application/json"))throw new Error(`Respuesta no válida: ${t}`);const r=await e.json().catch(()=>null);if(!r)throw new Error("Payload JSON no válido en item API");P=e,v=r}}}catch(e){if("AbortError"===e?.name)throw e;console.warn("Fallo en item API, usando PHP como fallback",e),P=null,v=null}}if(!P){if(P=await d(`/backend/api/itemDetails.php?itemId=${e}`,{signal:$.signal}),404===P.status)return window.showError?.("El ítem no existe"),void window.hideSkeleton?.(t);if(!P.ok)throw new Error(`Error ${P.status} obteniendo detalles del ítem`);const r=P.headers.get("content-type")||"";if(!r.includes("application/json"))throw new Error(`Respuesta no válida: ${r}`);v=await P.json().catch(()=>null)}const{data:j,meta:F}=s(v);q(F,"legacy");const O=function(e){const t=E(e)?e:{},r=g(t.meta),n=E(t.data)?t.data:t,a=p(n.item),o=E(n.market)?{...n.market}:null,i=f(o),l=y(n.recipes??n.recipe??null),s=n.nested_recipe&&"object"==typeof n.nested_recipe?{...n.nested_recipe}:null,c=b(n.legacy??null);return{item:a,market:o,prices:i,recipes:l,primaryRecipe:l.length>0?l[0]:null,nestedRecipe:s,legacy:c,meta:r}}({data:j,meta:F});o({type:"legacyLoad",bucket:u,meta:{stale:O?.meta?.stale??null,fromFallback:Boolean(_),fallbackReason:R}});const U=O.item,D=O.primaryRecipe,H=O.nestedRecipe;if(!U){const e=O?.meta?.errors?.[0]||F?.errors?.[0]||"El ítem no existe";return window.showError?.(e),void window.hideSkeleton?.(t)}if(n!==L)return;const M=Array.isArray(O.market)||!O.market?{}:{...O.market};let x=O.prices;if(!x?.hasData)try{const t=await C(e);if(t){const e=h(t);x=k(x,e)}}catch(e){console.warn("No se pudo recuperar el precio de respaldo",e)}const z=x?.hasData?x:f(M);if(l={...M,buy_price:z?.unit?.buy??M.buy_price??0,sell_price:z?.unit?.sell??M.sell_price??0},window._mainBuyPrice=l.buy_price??0,window._mainSellPrice=l.sell_price??0,!D)return I([]),void window.initItemUI(U,l);D&&H&&(D.nested_recipe=H),window._mainRecipeOutputCount=D.output_item_count||1,setTimeout(async()=>{if(n!==L)return;let t;try{t=await A(e,D)}catch(e){return console.error("Error preparando ingredientes",e),window.showError?.("Error al preparar los ingredientes"),I([]),void window.initItemUI(U,l)}Array.isArray(t)||(t=[]);const r=Array.isArray(D?.ingredients)&&D.ingredients.length>0&&0===t.length;let a=null;if(r){const e="No se pudo construir el árbol de ingredientes. Mostrando el ítem sin receta.";a="Sin receta disponible (no se pudo procesar la receta).",window.StorageUtils&&"function"==typeof window.StorageUtils.showToast?window.StorageUtils.showToast(e,"error"):console.warn(e)}i=new S({id:U.id,name:U.name,icon:U.icon,rarity:U.rarity,count:1,buy_price:l?.buy_price||0,sell_price:l?.sell_price||0,is_craftable:!r,recipe:r?null:D,children:r?[]:t}),i.recalc(window.globalQty||1,null),I([i]),await window.initItemUI(U,l),await(window.safeRenderTable?.()),a&&window.showError?.(a);const o=new Set;!function e(t,r){r.add(t.id),t.children&&t.children.forEach(t=>e(t,r))}(i,o),N&&N();const s=Array.from(o),d=async e=>{if(!document.getElementById("seccion-crafting"))return void requestAnimationFrame(()=>d(e));const t=[];e.forEach((e,r)=>{const n=T(window.ingredientObjs,Number(r));n.length&&n.forEach(r=>{r.buy_price=e.buy_price||0,r.sell_price=e.sell_price||0,r===window.ingredientObjs[0]&&(window._mainBuyPrice=r.buy_price,window._mainSellPrice=r.sell_price),t.push(r)})}),await(window.safeRenderTable?.());const r=window.getTotals?.();r&&(B("totales-crafting-global",r),B("totales-crafting-unit",r)),t.forEach(e=>B(e._uid,e))};N=c(s,d)},0)}catch(e){if("AbortError"===e.name)return;console.error("Error cargando ítem",e),window.showError?.("Error al cargar los datos del ítem"),window.hideSkeleton?.(t),o({type:"legacyError",bucket:u,meta:{fromFallback:Boolean(_),fallbackReason:R},error:String(e?.message||e)})}finally{$=null}}async function G(r,n={}){await D();const a=++L;if($&&($.abort(),$=null),P(),!r)return window.hideSkeleton?.(document.getElementById("item-skeleton")),void window.showError?.("ID de ítem no válido");const o=document.getElementById("item-skeleton"),i=e("usePrecomputed"),{PRECOMPUTED_CANARY_THRESHOLD:l}=m(),s=t(),c=s<l,d=!0===n?.forceLegacy;i&&c&&!d?await x(r,o,a,{bucket:s}):await z(r,o,a,{bucket:s,fromFallback:Boolean(d)})}document.addEventListener("DOMContentLoaded",()=>{const e=()=>{const e=new URLSearchParams(window.location.search),t=parseInt(e.get("id"),10);t?G(t):window.showError?.("ID de ítem no válido")};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,0)});export{G as loadItem,z as loadItemLegacy,M as loadItems};
