function e(e=""){if("undefined"==typeof window)return console.error(`[ERROR] Servicios de recetas no disponibles${e?` (${e})`:""}: entorno sin window.`),!1;const t=window.RecipeService||{},i="function"==typeof t.getItemBundles||"function"==typeof window.getItemBundles,n="function"==typeof t.getRecipesForItem||"function"==typeof window.getRecipesForItem;return!(!i||!n)||(console.error(`[ERROR] Servicios de recetas no disponibles${e?` (${e})`:""}.`,{hasGetItemBundles:i,hasGetRecipesForItem:n}),!1)}function t(){if("undefined"==typeof window)return{};const e=window.RecipeService||{};return{...e,getItemBundles:e.getItemBundles||window.getItemBundles,getRecipesForItem:e.getRecipesForItem||window.getRecipesForItem,getRecipeDetails:e.getRecipeDetails||window.getRecipeDetails,getItemDetails:e.getItemDetails||window.getItemDetails,getItemPrices:e.getItemPrices||window.getItemPrices}}window.transformRecipeToIngredient=async function(i,n=1){if(!e("transformRecipeToIngredient"))return null;const{getItemBundles:r}=t();try{if(!i||!i.output_item_id)return console.error("[ERROR] Receta inválida o sin output_item_id:",i),null;const e=[i.output_item_id,...(i.ingredients||[]).map(e=>e.item_id)],t=await r(e),o=new Map;t.forEach(e=>{e&&o.set(e.id,e)});const c=o.get(i.output_item_id);if(!c||!c.item)return console.warn(`[WARN] No se pudo obtener detalles para el ítem ${i.output_item_id}`),null;const s=c.market||{},a={id:i.output_item_id,name:c.item.name||"Ítem desconocido",icon:c.item.icon||"",rarity:c.item.rarity,count:n,buy_price:s.buy_price||0,sell_price:s.sell_price||0,is_craftable:"GuildConsumable"!==i.type,recipe:{id:i.id,type:i.type,output_item_count:i.output_item_count||1,min_rating:i.min_rating,disciplines:i.disciplines||[]},children:[]};return a.id&&a.name?(i.ingredients&&i.ingredients.length>0&&(a.children=i.ingredients.map(e=>{const t=o.get(e.item_id)||{},i=t.item||{},n=t.market||{};return{id:e.item_id,name:i.name||"Ítem desconocido",icon:i.icon||"",rarity:i.rarity,count:e.count,buy_price:n.buy_price||0,sell_price:n.sell_price||0,is_craftable:!!t.recipe,children:[]}})),a):(console.error("[ERROR] Estructura de ingrediente inválida:",a),null)}catch(e){return console.error("Error en transformRecipeToIngredient:",e),null}},window.getAndTransformRecipes=async function(i){if(!e("getAndTransformRecipes"))return[];const{getRecipesForItem:n}=t();try{const e=await n(i);if(!e||0===e.length)return[];return(await Promise.all(e.map(e=>window.transformRecipeToIngredient(e)))).filter(Boolean)}catch(e){return console.error("Error en getAndTransformRecipes:",e),[]}},window.loadIngredientTree=async function(i,n=0,r=3){if(!e("loadIngredientTree"))return i;const{getRecipesForItem:o,getItemBundles:c}=t();if(n>=r||!i.is_craftable)return i;try{const e=await o(i.id);if(0===e.length)return i;const t=e[0];return t?(i.children=await Promise.all(t.ingredients.map(async e=>{const t=await o(e.item_id);let i=null;if(t.length>0){const n=t[0];n&&(i=await transformRecipeToIngredient(n,e.count))}if(!i){const t=(await c([e.item_id]))[0]||{},n=t.item||{},r=t.market||{};i={id:e.item_id,name:n.name||"",icon:n.icon||"",rarity:n.rarity,count:e.count,buy_price:r.buy_price||0,sell_price:r.sell_price||0,is_craftable:!1,children:[]}}return i.is_craftable?await loadIngredientTree(i,n+1,r):i})),i):i}catch(e){return console.error(`Error cargando ingrediente ${i.id}:`,e),i}};
