{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { API_Recipes_Entry_Next } from './api'\n\nfunction compact<T>(arr: Array<T | false | null | undefined>): Array<T> {\n  return arr.filter(Boolean) as Array<T>\n}\n\nexport type BasicItemComponent = { id: number; type: 'Item'; quantity: number }\nexport type BasicCurrencyComponent = { id: number; type: 'Currency'; quantity: number }\nexport type BasicGuildUpgradeComponent = { id: number; type: 'GuildUpgrade'; quantity: number }\nexport type Prerequisites = Array<{ type: 'Recipe'; id: number }>\n\nexport interface NestedRecipe extends TransformedRecipe {\n  components: Array<\n    NestedRecipe | BasicItemComponent | BasicCurrencyComponent | BasicGuildUpgradeComponent\n  >\n}\n\ninterface TransformedRecipe {\n  id: number\n  type: 'Recipe'\n  quantity: number\n  output: number\n  min_rating: number | null\n  disciplines: Array<string>\n  upgrade_id?: number\n  output_range?: string\n  achievement_id?: number\n  merchant?: { name: string; locations: Array<string> }\n  prerequisites: Prerequisites\n  multipleRecipeCount: number\n  daily_purchase_cap?: number\n  weekly_purchase_cap?: number\n}\n\ninterface TransformedRecipeInternal extends TransformedRecipe {\n  components?: Array<\n    | TransformedRecipeInternal\n    | BasicItemComponent\n    | BasicCurrencyComponent\n    | BasicGuildUpgradeComponent\n  >\n}\n\n// Cache nested recipes by recipe id so that repeated calls for the same recipe\n// can reuse previously computed structures. If the underlying recipe data\n// changes, the cache should be cleared by calling `nestedRecipeCache.clear()`.\nconst nestedRecipeCache = new Map<number, NestedRecipe>()\n\nexport function nestRecipes(\n  apiRecipes: Array<API_Recipes_Entry_Next>,\n  decorationMap: Record<string, number> = {},\n): Array<NestedRecipe> {\n  const recipes = apiRecipes.map(transformRecipe)\n\n  // Transform arrays into Maps to avoid repeated linear searches\n  const recipesMap = new Map<number, TransformedRecipeInternal>()\n  const recipeUpgradesMap = new Map<number, number>()\n\n  recipes.forEach((r) => {\n    recipesMap.set(r.id, r)\n    if (r.upgrade_id !== undefined) {\n      recipeUpgradesMap.set(r.upgrade_id, r.id)\n    }\n  })\n\n  const decorationsMap = new Map<number, number>()\n  Object.entries(decorationMap).forEach(([k, v]) => {\n    decorationsMap.set(Number(k), v)\n  })\n\n  // Nest all recipes\n  for (const [key, recipe] of recipesMap) {\n    recipesMap.set(\n      key,\n      nestRecipe(recipe, recipesMap, recipeUpgradesMap, decorationsMap, new Set()),\n    )\n  }\n\n  return compact(Array.from(recipesMap.values())).filter((recipe) => recipe.components) as Array<NestedRecipe>\n}\n\nfunction transformRecipe(recipe: API_Recipes_Entry_Next): TransformedRecipeInternal {\n  const components = recipe.ingredients.map((ingredient) => ({\n    id: ingredient.id,\n    type: ingredient.type,\n    quantity: ingredient.count,\n  }))\n\n  return {\n    id: recipe.output_item_id,\n    type: 'Recipe',\n    quantity: 1,\n    output: recipe.output_item_count,\n    components: components,\n    prerequisites: recipe.id ? [{ type: 'Recipe', id: recipe.id }] : [],\n    min_rating: recipe.min_rating !== undefined ? recipe.min_rating : null,\n    disciplines: recipe.disciplines || [],\n    upgrade_id: recipe.output_upgrade_id,\n    output_range: recipe.output_item_count_range,\n    achievement_id: recipe.achievement_id,\n    merchant: recipe.merchant,\n    multipleRecipeCount: recipe.multipleRecipeCount,\n    daily_purchase_cap: recipe.daily_purchase_cap ? recipe.daily_purchase_cap : 0,\n    weekly_purchase_cap: recipe.weekly_purchase_cap ? recipe.weekly_purchase_cap : 0,\n  }\n}\n\nfunction nestRecipe(\n  recipe: TransformedRecipeInternal,\n  recipesMap: Map<number, TransformedRecipeInternal>,\n  recipeUpgradesMap: Map<number, number>,\n  decorationsMap: Map<number, number>,\n  visited: Set<number>,\n) {\n  const cached = nestedRecipeCache.get(recipe.id)\n  if (cached) {\n    return cached as unknown as TransformedRecipeInternal\n  }\n\n  const nextVisited = new Set(visited)\n  nextVisited.add(recipe.id)\n  recipe.quantity = recipe.quantity || 1\n\n  const components = (recipe.components || []).map((component) => {\n    const isGuildUpgrade = component.type === 'GuildUpgrade'\n    const id = isGuildUpgrade ? recipeUpgradesMap.get(component.id) || component.id : component.id\n    const componentRecipe = recipesMap.get(id)\n    const condensedLeyLineEssenceIds = [91224, 91137, 91222, 91171]\n\n    if (component.type === 'Currency') {\n      return component\n    }\n\n    if (!componentRecipe) {\n      if (!isGuildUpgrade) {\n        return component\n      }\n\n      const decorationsItem = decorationsMap.get(component.id)\n      return decorationsItem\n        ? { id: decorationsItem, type: 'Item' as const, quantity: component.quantity }\n        : { id: component.id, type: 'GuildUpgrade' as const, quantity: component.quantity }\n    }\n\n    if (nextVisited.has(id)) {\n      const globalConsole = (globalThis as any).console\n      globalConsole?.warn(`Circular dependency detected: ${recipe.id} -> ${id}`)\n      return component\n    }\n\n    if (condensedLeyLineEssenceIds.includes(recipe.id) && condensedLeyLineEssenceIds.includes(id)) {\n      return component\n    }\n\n    const nestedComponent = nestRecipe(\n      componentRecipe,\n      recipesMap,\n      recipeUpgradesMap,\n      decorationsMap,\n      nextVisited,\n    )\n\n    return { ...nestedComponent, quantity: component.quantity }\n  })\n\n  recipe.components = compact(components)\n\n  if (recipe.components && recipe.components.length === 0) {\n    recipe.components = undefined\n  }\n\n  const result = recipe as unknown as NestedRecipe\n  nestedRecipeCache.set(recipe.id, result)\n  return recipe\n}\n\n"],"mappings":"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","names":[]}